---
phase: 03-calibration-wiring
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/cron/calibration-audit/route.ts
  - src/app/api/outcomes/route.ts
autonomous: true

must_haves:
  truths:
    - "calibration-audit cron compiles without TypeScript errors"
    - "calibration-audit cron handler runs and returns a JSON response (either 'skipped' or 'completed')"
    - "calibration-audit cron logs an ECE-related message to stdout (either the ECE value or the skip reason)"
    - "POST /api/outcomes accepts a valid payload and returns 201 with the created outcome"
    - "GET /api/outcomes returns paginated outcome history for authenticated user"
  artifacts:
    - path: "src/app/api/cron/calibration-audit/route.ts"
      provides: "Monthly calibration audit cron"
      exports: ["GET"]
    - path: "src/app/api/outcomes/route.ts"
      provides: "Outcomes POST + GET endpoints"
      exports: ["POST", "GET"]
  key_links:
    - from: "src/app/api/cron/calibration-audit/route.ts"
      to: "src/lib/engine/calibration.ts"
      via: "generateCalibrationReport, fetchOutcomePairs, fitPlattScaling, invalidatePlattCache"
      pattern: "import.*generateCalibrationReport.*from.*calibration"
    - from: "src/app/api/outcomes/route.ts"
      to: "outcomes table"
      via: "supabase.from('outcomes')"
      pattern: "from.*outcomes"
---

<objective>
Verify the calibration-audit cron and outcomes endpoint work correctly end-to-end.

Purpose: CAL-03 and CAL-04 require verification that existing infrastructure works. The calibration-audit cron and outcomes endpoint were already built but have never been verified against the current codebase state. This plan confirms they compile, run, and produce correct output. If any issues are found, fix them in-place.

Output: Verified (and potentially patched) cron and endpoint routes
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-calibration-wiring/03-RESEARCH.md
@src/app/api/cron/calibration-audit/route.ts
@src/app/api/outcomes/route.ts
@src/lib/engine/calibration.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify calibration-audit cron compiles and fix any issues</name>
  <files>src/app/api/cron/calibration-audit/route.ts</files>
  <action>
1. Run `npx tsc --noEmit` and check for any errors in `src/app/api/cron/calibration-audit/route.ts`. This verifies all imports resolve correctly (verifyCronAuth, createServiceClient, generateCalibrationReport, fetchOutcomePairs, fitPlattScaling, invalidatePlattCache).

2. Review the cron handler logic for correctness:
   - It should call `generateCalibrationReport({ sinceDays: 90 })` to get the ECE report
   - It should check `report.totalSamples < MIN_SAMPLES` and return `status: "skipped"` if insufficient data
   - It should log the ECE value (either the value itself or the skip message)
   - It should re-fit Platt parameters and invalidate the cache when sufficient data exists
   - It should return structured JSON response

3. If any compilation errors exist, fix them. Common issues:
   - Import paths may have changed if files were moved
   - The `verifyCronAuth` helper may have a different signature
   - Type mismatches from updated calibration.ts exports

4. Verify the cron is scheduled in `vercel.json` (it should be at `"0 4 1 * *"` — monthly, 1st of month at 4 AM). Just confirm, do not modify.

5. If everything compiles clean, no changes are needed — this task is verification, not construction.
  </action>
  <verify>Run `npx tsc --noEmit 2>&1 | grep -i "calibration-audit"` — should produce no errors. If there are errors, they should be fixed and the check re-run. Also confirm: `grep "calibration-audit" vercel.json` shows the cron is scheduled.</verify>
  <done>calibration-audit cron compiles without errors, all imports resolve, handler logic is correct, cron is scheduled in vercel.json.</done>
</task>

<task type="auto">
  <name>Task 2: Verify outcomes endpoint compiles and works correctly</name>
  <files>src/app/api/outcomes/route.ts</files>
  <action>
1. Run `npx tsc --noEmit` and check for any errors in `src/app/api/outcomes/route.ts`. This verifies the Zod schema, Supabase client imports, and pagination utilities all resolve correctly.

2. Review the endpoint logic for correctness:
   - **POST**: Validates input via `OutcomeInputSchema.safeParse()`, verifies authenticated user owns the analysis, calculates delta between predicted and actual scores, inserts into `outcomes` table with unique constraint handling (409 on duplicate).
   - **GET**: Returns paginated outcome history for the authenticated user with cursor-based pagination.

3. Check that the `outcomes` table columns referenced in the insert match what exists in `database.types.ts`:
   - `analysis_id`, `user_id`, `actual_views`, `actual_likes`, `actual_shares`, `actual_engagement_rate`, `predicted_score`, `actual_score`, `delta`, `platform`, `platform_post_url`, `reported_at`
   - Verify these columns exist in `src/types/database.types.ts` under the `outcomes` table definition.

4. If any compilation errors or column mismatches exist, fix them.

5. Verify the pagination utilities (`decodeCursor`, `encodeCursor`, `parsePaginationParams`) are importable from `@/lib/pagination`. If missing, check what pagination pattern is used elsewhere in the codebase and fix the import.

6. If everything compiles clean, no changes are needed — this task is verification, not construction.
  </action>
  <verify>Run `npx tsc --noEmit 2>&1 | grep -i "outcomes"` — should produce no errors. Check `grep -c "outcomes" src/types/database.types.ts` — should show the outcomes table exists in the type definitions.</verify>
  <done>outcomes endpoint compiles without errors, all imports resolve, POST and GET handlers are correct, outcomes table columns match database.types.ts.</done>
</task>

</tasks>

<verification>
1. `pnpm build` exits 0 with no TypeScript errors across the entire project
2. `grep "calibration-audit" vercel.json` confirms cron is scheduled
3. `grep -c "outcomes" src/types/database.types.ts` confirms outcomes table exists in types (should be > 0)
4. Both route files (`calibration-audit/route.ts` and `outcomes/route.ts`) export the correct HTTP method handlers
</verification>

<success_criteria>
- calibration-audit cron compiles clean and is scheduled in vercel.json
- outcomes endpoint compiles clean and exports POST + GET handlers
- All imports in both files resolve correctly
- No TypeScript errors in the full build
- Any discovered issues are fixed in-place
</success_criteria>

<output>
After completion, create `.planning/phases/03-calibration-wiring/03-02-SUMMARY.md`
</output>
