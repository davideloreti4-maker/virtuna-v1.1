---
phase: 03-competitor-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/competitors-utils.ts
  - src/stores/competitors-store.ts
  - src/components/competitors/competitor-sparkline.tsx
  - src/components/competitors/growth-delta.tsx
  - src/components/competitors/competitor-card.tsx
  - src/app/(app)/competitors/page.tsx
  - src/app/(app)/competitors/competitors-client.tsx
autonomous: true

must_haves:
  truths:
    - "User sees all tracked competitors in a card grid showing avatar, handle, follower count, total likes, video count, engagement rate, growth velocity delta, and sparkline trend"
    - "Competitor cards show green/red growth velocity indicator when snapshot data is available"
    - "Sparkline mini-charts render follower trend from last 14 days of snapshots"
    - "Cards display '--' for missing engagement rate or velocity when data is insufficient"
  artifacts:
    - path: "src/lib/competitors-utils.ts"
      provides: "formatCount, computeGrowthVelocity, computeEngagementRate utilities"
      exports: ["formatCount", "computeGrowthVelocity", "computeEngagementRate"]
    - path: "src/stores/competitors-store.ts"
      provides: "Zustand store for view toggle (grid/table) with persist"
      exports: ["useCompetitorsStore"]
    - path: "src/components/competitors/competitor-sparkline.tsx"
      provides: "Recharts sparkline mini-chart (80x32px, zero chrome)"
      exports: ["CompetitorSparkline"]
    - path: "src/components/competitors/growth-delta.tsx"
      provides: "Green/red velocity badge indicator"
      exports: ["GrowthDelta"]
    - path: "src/components/competitors/competitor-card.tsx"
      provides: "Competitor card with all stats, sparkline, and delta"
      exports: ["CompetitorCard"]
    - path: "src/app/(app)/competitors/page.tsx"
      provides: "Server component fetching competitors + snapshots via Supabase RLS"
      exports: ["default"]
    - path: "src/app/(app)/competitors/competitors-client.tsx"
      provides: "Client component rendering card grid with view toggle state"
      exports: ["CompetitorsClient"]
  key_links:
    - from: "src/app/(app)/competitors/page.tsx"
      to: "supabase.from('user_competitors').select(...)"
      via: "Server component Supabase query with RLS"
      pattern: "from\\(['\"]user_competitors['\"]\\)"
    - from: "src/app/(app)/competitors/page.tsx"
      to: "src/app/(app)/competitors/competitors-client.tsx"
      via: "Props passing (competitors + snapshots)"
      pattern: "CompetitorsClient"
    - from: "src/components/competitors/competitor-card.tsx"
      to: "src/lib/competitors-utils.ts"
      via: "Import formatCount, computeGrowthVelocity, computeEngagementRate"
      pattern: "from ['\"]@/lib/competitors-utils['\"]"
    - from: "src/components/competitors/competitor-card.tsx"
      to: "src/components/competitors/competitor-sparkline.tsx"
      via: "Sparkline rendering inside card"
      pattern: "CompetitorSparkline"
---

<objective>
Build the competitor dashboard card grid view with server-side data fetching, utility functions, and all card sub-components (sparkline, growth delta indicator).

Purpose: This is the primary view of Phase 3 -- users land on /competitors and see all their tracked competitors in a rich card grid showing key stats at a glance.

Output: Working /competitors page with card grid showing avatar, handle, follower count, total likes, video count, engagement rate, growth velocity delta, and sparkline trend for each competitor.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/database.types.ts
@src/lib/supabase/server.ts
@src/components/ui/card.tsx
@src/components/ui/avatar.tsx
@src/components/ui/badge.tsx
@src/stores/sidebar-store.ts
@src/app/(app)/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create utility functions, Zustand store, and sparkline/growth-delta components</name>
  <files>
    src/lib/competitors-utils.ts
    src/stores/competitors-store.ts
    src/components/competitors/competitor-sparkline.tsx
    src/components/competitors/growth-delta.tsx
  </files>
  <action>
    **1. Create `src/lib/competitors-utils.ts`:**

    Three pure utility functions:

    - `formatCount(count: number | null): string` -- Format large numbers: null -> "--", >= 1M -> "X.XM", >= 1K -> "X.XK", else toLocaleString(). Handle BIGINT values (number type from database).

    - `computeGrowthVelocity(snapshots: { follower_count: number; snapshot_date: string }[]): { percentage: number; direction: "up" | "down" | "flat" } | null` -- Sort snapshots by date descending. Find latest and a snapshot >= 6 days ago. Compute percentage delta. Return null if < 2 snapshots or no snapshot old enough. Threshold: > 0.5% = up, < -0.5% = down, else flat. Round to 1 decimal.

    - `computeEngagementRate(videos: { views: number | null; likes: number | null; comments: number | null; shares: number | null }[]): number | null` -- Filter videos with views > 0. Sum (likes + comments + shares) / sum(views) * 100. Return null if no valid videos.

    **2. Create `src/stores/competitors-store.ts`:**

    Minimal Zustand store with persist middleware, matching `sidebar-store.ts` pattern:
    ```typescript
    type ViewMode = "grid" | "table";
    interface CompetitorsUIState {
      viewMode: ViewMode;
      setViewMode: (mode: ViewMode) => void;
    }
    ```
    Persist key: `"virtuna-competitors-view"`. Default: `"grid"`.

    **3. Create `src/components/competitors/competitor-sparkline.tsx`:**

    "use client" component. Props: `data: { value: number }[]`, `color?: string` (default "var(--color-accent)"), `width?: number` (default 80), `height?: number` (default 32).

    Use Recharts: `<ResponsiveContainer>` wrapping `<LineChart>` with single `<Line>` -- `type="monotone"`, `dataKey="value"`, `dot={false}`, `isAnimationActive={false}`, `strokeWidth={1.5}`. NO XAxis, YAxis, CartesianGrid, Tooltip. Return null if data.length < 2.

    **4. Create `src/components/competitors/growth-delta.tsx`:**

    "use client" component. Props: `percentage: number`, `direction: "up" | "down" | "flat"`.

    Use existing `<Badge>` component:
    - direction "up": `variant="success"`, show `+X.X%` with `ArrowUp` icon from lucide-react (size 12)
    - direction "down": `variant="error"`, show `-X.X%` with `ArrowDown` icon from lucide-react (size 12)
    - direction "flat": `variant="default"`, show `0.0%`

    Keep it compact -- inline-flex with icon + text.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify all files type-check. Confirm imports resolve: Recharts, Zustand, Badge, lucide-react.
  </verify>
  <done>
    Four files created and type-checking: competitors-utils.ts exports 3 utility functions, competitors-store.ts exports useCompetitorsStore with grid/table toggle, competitor-sparkline.tsx renders a zero-chrome Recharts LineChart, growth-delta.tsx renders a colored Badge with arrow icon.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create competitor card, server component page, and client component with card grid</name>
  <files>
    src/components/competitors/competitor-card.tsx
    src/app/(app)/competitors/page.tsx
    src/app/(app)/competitors/competitors-client.tsx
  </files>
  <action>
    **1. Create `src/components/competitors/competitor-card.tsx`:**

    "use client" component. Define a `CompetitorCardData` interface for the props:
    ```typescript
    interface CompetitorCardData {
      id: string;
      tiktok_handle: string;
      display_name: string | null;
      avatar_url: string | null;
      follower_count: number | null;
      heart_count: number | null;
      video_count: number | null;
      snapshots: { follower_count: number; snapshot_date: string }[];
      videos: { views: number | null; likes: number | null; comments: number | null; shares: number | null }[];
    }
    ```
    Export both `CompetitorCard` and `CompetitorCardData`.

    Layout using existing `<Card>` and `<CardContent>`:
    - Top row: `<Avatar>` (src=avatar_url, fallback=first 2 chars of handle uppercase, size="md") + handle (@handle) + display_name (if present, muted)
    - Stats grid (3 cols): Followers (formatCount), Total Likes (formatCount), Videos (formatCount). Each stat: label in `text-foreground-muted text-xs`, value in `text-foreground text-sm font-medium`.
    - Bottom row: GrowthDelta (from computeGrowthVelocity of snapshots, show nothing if null) + CompetitorSparkline (data from snapshots mapped to { value: follower_count }, show nothing if < 2). Engagement rate as a separate small stat: label "Eng. Rate", value from computeEngagementRate or "--".

    Use existing Card styling (bg-transparent, border-border, 12px radius, inset shadow via Card component). Add `cursor-pointer` for future click navigation to detail page.

    **2. Create `src/app/(app)/competitors/page.tsx`:**

    Server component. Set metadata: `title: "Competitors | Virtuna"`, `description: "Track and analyze your TikTok competitors."`.

    Data fetching:
    - `const supabase = await createClient()` (from `@/lib/supabase/server`)
    - `const { data: { user } } = await supabase.auth.getUser()` -- return null if no user (AuthGuard handles redirect)
    - Query `user_competitors` with nested select on `competitor_profiles (id, tiktok_handle, display_name, avatar_url, follower_count, following_count, heart_count, video_count, last_scraped_at, scrape_status)`, ordered by `added_at` descending
    - Extract `competitorIds` from results. Guard empty array (skip snapshot query if no competitors).
    - Query `competitor_snapshots` with `.in("competitor_id", competitorIds)`, `.gte("snapshot_date", fourteenDaysAgo)` (14 days back from now, ISO date string), `.select("competitor_id, follower_count, snapshot_date")`, ordered by `snapshot_date` ascending
    - Query `competitor_videos` with `.in("competitor_id", competitorIds)`, `.select("competitor_id, views, likes, comments, shares")` -- needed for engagement rate calculation. Only fetch metric columns, not full video data.
    - Build `snapshotMap: Record<string, { follower_count: number; snapshot_date: string }[]>` grouping snapshots by competitor_id
    - Build `videosMap: Record<string, { views: number | null; likes: number | null; comments: number | null; shares: number | null }[]>` grouping videos by competitor_id
    - Pass `competitors`, `snapshotMap`, `videosMap` as props to `<CompetitorsClient>`

    **3. Create `src/app/(app)/competitors/competitors-client.tsx`:**

    "use client" component. Props: competitors (array from page query), snapshotMap, videosMap.

    Flatten the nested Supabase response: for each competitor row, extract `competitor_profiles` (it's a nested object from the join -- access as `row.competitor_profiles`). Build `CompetitorCardData` objects by merging profile data with snapshots from snapshotMap and videos from videosMap.

    Read `viewMode` from `useCompetitorsStore()`. For now, only render card grid (table view comes in Plan 02).

    Page header: "Competitors" as h1 (`text-2xl font-medium text-foreground`). Right side: placeholder for view toggle (will be added in Plan 02).

    Card grid: `grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4`. Map over flattened competitors, render `<CompetitorCard>` for each.

    If competitors array is empty, render a simple "No competitors yet" message (proper empty state component comes in Plan 02).

    Note on Supabase nested response typing: The `competitor_profiles` field from the join query returns as a single object (one-to-one through junction table), NOT an array. Access fields as `row.competitor_profiles.tiktok_handle`. If TypeScript complains about the nested type, create a local type alias for the query response shape.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify all files type-check. Navigate to /competitors in the browser (or confirm page renders without runtime errors by checking the dev server logs). Verify the page.tsx server component fetches data without errors (even with 0 competitors).
  </verify>
  <done>
    /competitors page loads with card grid. Each card shows avatar, @handle, follower count, total likes, video count, engagement rate, growth velocity delta (green/red badge), and sparkline trend. Cards display "--" for missing data. Empty array renders a placeholder message.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Navigate to /competitors -- page renders without errors
3. With competitors in database: cards show all stats (avatar, handle, followers, likes, videos, engagement rate, growth delta, sparkline)
4. With no competitors: shows placeholder empty message
5. With new competitors (< 2 snapshots): sparkline and growth delta are hidden, stats still display
6. formatCount renders "1.2M", "45.3K", "892" correctly
7. Growth delta shows green badge for positive growth, red for negative
</verification>

<success_criteria>
- Server component page fetches competitor data via Supabase RLS join query
- Client component renders responsive card grid (1 col mobile, 2 cols md, 3 cols lg)
- Competitor cards compose existing Card, Avatar, Badge components with competitor-specific data
- Sparkline renders Recharts LineChart with zero chrome at 80x32px
- Growth velocity computed from week-over-week snapshot delta
- All null/missing data handled gracefully with "--" fallback
- Zustand store persists view mode to localStorage
</success_criteria>

<output>
After completion, create `.planning/phases/03-competitor-dashboard/03-01-SUMMARY.md`
</output>
