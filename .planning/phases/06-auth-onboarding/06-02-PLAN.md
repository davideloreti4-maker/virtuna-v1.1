---
phase: 06-auth-onboarding
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(onboarding)/welcome/page.tsx
  - src/components/onboarding/connect-step.tsx
  - src/components/onboarding/goal-step.tsx
  - src/components/onboarding/preview-step.tsx
  - src/app/(onboarding)/login/actions.ts
  - src/app/(onboarding)/signup/actions.ts
  - src/app/auth/callback/route.ts
autonomous: true

must_haves:
  truths:
    - "Welcome/onboarding flow transitions between steps without layout jumps or jarring reflows"
    - "Auth errors show user-friendly messages instead of raw Supabase error strings"
    - "Wrong password shows 'Invalid email or password' not the Supabase error"
    - "Duplicate email on signup shows a clear message about existing account"
    - "OAuth callback failure redirects to login with a human-readable error message"
    - "Onboarding steps (connect, goal, preview) each have consistent spacing and card alignment"
    - "Step indicator dots are properly sized and centered"
  artifacts:
    - path: "src/app/(onboarding)/welcome/page.tsx"
      provides: "Polished onboarding flow with smooth step transitions"
    - path: "src/app/(onboarding)/login/actions.ts"
      provides: "User-friendly error message mapping for login"
    - path: "src/app/(onboarding)/signup/actions.ts"
      provides: "User-friendly error message mapping for signup"
    - path: "src/app/auth/callback/route.ts"
      provides: "Human-readable OAuth error redirect"
  key_links:
    - from: "src/app/(onboarding)/login/actions.ts"
      to: "/login?error=..."
      via: "redirect with mapped error message"
      pattern: "redirect.*login.*error"
    - from: "src/app/(onboarding)/signup/actions.ts"
      to: "/signup?error=..."
      via: "redirect with mapped error message"
      pattern: "redirect.*signup.*error"
    - from: "src/app/auth/callback/route.ts"
      to: "/login?error=..."
      via: "redirect on OAuth failure"
      pattern: "redirect.*login.*error"
---

<objective>
Polish the onboarding flow for smooth step transitions and implement graceful, user-friendly error handling across all auth actions.

Purpose: AUTH-03 requires the welcome/onboarding flow to transition smoothly between steps. AUTH-04 requires auth errors to show clear, user-friendly messages instead of raw Supabase error strings. Currently, Supabase errors like "Invalid login credentials" are passed directly to the UI -- these need mapping to friendlier messages.

Output: Polished onboarding step components, mapped auth error messages in server actions, and improved OAuth callback error handling.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/(onboarding)/welcome/page.tsx
@src/components/onboarding/connect-step.tsx
@src/components/onboarding/goal-step.tsx
@src/components/onboarding/preview-step.tsx
@src/app/(onboarding)/login/actions.ts
@src/app/(onboarding)/signup/actions.ts
@src/app/auth/callback/route.ts
@src/stores/onboarding-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Polish onboarding flow with smooth transitions and consistent step styling</name>
  <files>src/app/(onboarding)/welcome/page.tsx, src/components/onboarding/connect-step.tsx, src/components/onboarding/goal-step.tsx, src/components/onboarding/preview-step.tsx</files>
  <action>
Polish the welcome page and its 3 step components for visual consistency and smooth transitions:

**welcome/page.tsx:**
1. Update card container to match the login/signup polish (plan 06-01 uses max-w-[400px], rounded-[12px], px-8 py-10). Apply identical styling:
   - Change `max-w-sm` to `max-w-[400px]`
   - Change `rounded-xl` to `rounded-[12px]`
   - Change `p-8` to `px-8 py-10`

2. Step indicator dots: Change from `h-2 w-2` to `h-1.5 w-8 rounded-full` for pill-shaped step indicators instead of dots. This gives better visual feedback on progress. Active steps: `bg-accent`, inactive: `bg-white/[0.1]`. Keep the transition-colors class.

3. Add a CSS transition for step content to prevent layout jumps. Wrap the step rendering in a div with `min-h-[320px]` to reserve space so the card doesn't resize between steps:
   ```tsx
   <div className="min-h-[320px]">
     {step === "connect" && <ConnectStep />}
     {step === "goal" && <GoalStep />}
     {step === "preview" && <PreviewStep />}
   </div>
   ```
   The min-height prevents the card from shrinking/growing as users move between steps (connect has 2 fields, goal has 3 cards, preview has canvas -- all different heights).

4. Add loading state while hydrating: Instead of returning `null` during hydration (causes flash), show a skeleton card:
   ```tsx
   if (!_isHydrated || step === "completed") {
     return (
       <div className="w-full max-w-[400px] rounded-[12px] border border-white/[0.06] px-8 py-10"
         style={{ /* same glass styles */ }}>
         <div className="flex items-center justify-center gap-2 mb-8">
           {STEPS.map((s) => (
             <div key={s} className="h-1.5 w-8 rounded-full bg-white/[0.1]" />
           ))}
         </div>
         <div className="space-y-4 animate-pulse">
           <div className="h-6 w-48 mx-auto rounded bg-white/[0.05]" />
           <div className="h-4 w-64 mx-auto rounded bg-white/[0.05]" />
           <div className="h-[42px] w-full rounded-[8px] bg-white/[0.05]" />
           <div className="h-11 w-full rounded-lg bg-white/[0.05]" />
         </div>
       </div>
     );
   }
   ```

**connect-step.tsx:**
- Add `@ ` prefix indicator before the input. Add a `<Text size="sm" muted>` showing "@ " next to the input or use the InputField `leftIcon` prop with a Text node showing "@".
  Actually, simpler: change the placeholder from "yourhandle" to "@yourhandle" so users understand the format. The existing `handle.trim().replace(/^@/, "")` already strips the @ if typed.
- Keep all validation logic as-is -- it works correctly.

**goal-step.tsx:**
- Goal card buttons: Add `inset shadow` to the selected card for subtle depth. On the selected card's className, add inline style `boxShadow: 'rgba(255,127,80,0.1) 0 1px 0 0 inset'` for a subtle coral inset glow when selected. This ties to the accent border visually.
- Keep all selection logic and icons as-is.

**preview-step.tsx:**
- The HiveDemoCanvas container: Change `h-[280px]` to `h-[240px]` to give more balanced proportions within the card (the canvas doesn't need as much height, and this keeps the card from being taller than login/signup).
- Add a subtle loading state: When canvas is rendering, the container should have `bg-white/[0.02]` background so it's not just empty border.
- Keep the completeOnboarding handler as-is.
  </action>
  <verify>Run `pnpm build` to confirm no TypeScript errors. Verify that the welcome page card uses max-w-[400px], step indicators are pill-shaped, and min-h-[320px] wrapper is present.</verify>
  <done>Onboarding flow has consistent card sizing matching auth pages, pill-shaped step indicators, minimum height to prevent layout jumps, and a hydration skeleton instead of blank flash.</done>
</task>

<task type="auto">
  <name>Task 2: Map auth errors to user-friendly messages</name>
  <files>src/app/(onboarding)/login/actions.ts, src/app/(onboarding)/signup/actions.ts, src/app/auth/callback/route.ts</files>
  <action>
Create a shared error mapping utility and apply it to all auth server actions. This is the core of AUTH-04.

**Create error mapping in login/actions.ts (inline, no separate file needed for 2 uses):**

Add a `mapAuthError` function at the top of login/actions.ts:
```typescript
function mapLoginError(supabaseError: string): string {
  const lower = supabaseError.toLowerCase();
  if (lower.includes("invalid login credentials") || lower.includes("invalid credentials")) {
    return "Invalid email or password. Please try again.";
  }
  if (lower.includes("email not confirmed")) {
    return "Please confirm your email address before signing in. Check your inbox.";
  }
  if (lower.includes("too many requests") || lower.includes("rate limit")) {
    return "Too many sign-in attempts. Please wait a moment and try again.";
  }
  if (lower.includes("network") || lower.includes("fetch")) {
    return "Unable to connect. Please check your internet connection and try again.";
  }
  // Fallback: return a generic message instead of raw Supabase error
  return "Something went wrong. Please try again.";
}
```

In the `login` function, change:
```typescript
redirect(`/login?error=${encodeURIComponent(error.message)}&next=${encodeURIComponent(next)}`);
```
to:
```typescript
redirect(`/login?error=${encodeURIComponent(mapLoginError(error.message))}&next=${encodeURIComponent(next)}`);
```

**Add error mapping in signup/actions.ts:**

Add a `mapSignupError` function:
```typescript
function mapSignupError(supabaseError: string): string {
  const lower = supabaseError.toLowerCase();
  if (lower.includes("already registered") || lower.includes("already been registered")) {
    return "An account with this email already exists. Try signing in instead.";
  }
  if (lower.includes("password") && lower.includes("least")) {
    return "Password must be at least 6 characters long.";
  }
  if (lower.includes("valid email") || lower.includes("invalid email")) {
    return "Please enter a valid email address.";
  }
  if (lower.includes("too many requests") || lower.includes("rate limit")) {
    return "Too many attempts. Please wait a moment and try again.";
  }
  if (lower.includes("network") || lower.includes("fetch")) {
    return "Unable to connect. Please check your internet connection and try again.";
  }
  return "Something went wrong. Please try again.";
}
```

Apply it in the `signup` function's error redirect.

**Improve OAuth callback error in auth/callback/route.ts:**

Change the two `auth_callback_failed` error redirects to human-readable messages:
- When `!code` (no authorization code): redirect with error `"Sign-in was cancelled or failed. Please try again."`
- When `error` from `exchangeCodeForSession`: redirect with error `"Unable to complete sign-in. Please try again."`

These are the only two error paths in the callback route. Both should produce clear, non-technical messages.

Do NOT change:
- The redirect structure (using URL searchParams for errors is the correct Next.js pattern with server actions)
- The login detection for first-time users (onboarding_completed_at check)
- The referral cookie processing logic
- Any Supabase query logic
  </action>
  <verify>Run `pnpm build` to confirm no TypeScript errors. Verify that login/actions.ts has mapLoginError function, signup/actions.ts has mapSignupError function, and auth/callback/route.ts has updated error messages.</verify>
  <done>All auth errors are mapped to user-friendly messages. Users see "Invalid email or password" instead of "Invalid login credentials". OAuth failures show "Unable to complete sign-in" instead of "auth_callback_failed". Network errors are caught and explained clearly.</done>
</task>

</tasks>

<verification>
1. `pnpm build` completes without errors
2. Welcome page card matches login/signup dimensions (max-w-[400px], rounded-[12px])
3. Step indicators are pill-shaped (h-1.5 w-8) not dot-shaped
4. Min-height wrapper prevents card resize between steps
5. Hydration shows skeleton instead of blank
6. Login error "Invalid login credentials" maps to "Invalid email or password. Please try again."
7. Signup error for existing email maps to "An account with this email already exists."
8. OAuth callback errors use human-readable messages
9. No regressions in auth flow functionality
</verification>

<success_criteria>
- AUTH-03: Welcome/onboarding flow transitions smoothly with consistent card sizing, pill step indicators, minimum height to prevent jumps, and skeleton loading
- AUTH-04: All auth error states mapped to clear, user-friendly messages -- no raw Supabase errors exposed to users
- Login errors: invalid credentials, email not confirmed, rate limiting, network failure all have specific messages
- Signup errors: duplicate email, password too short, invalid email all have specific messages
- OAuth errors: cancelled/failed sign-in shows clear retry message
</success_criteria>

<output>
After completion, create `.planning/phases/06-auth-onboarding/06-02-SUMMARY.md`
</output>
