---
phase: 07-wire-tiergate
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(app)/referrals/page.tsx
  - src/components/referral/ReferralsUpgradeFallback.tsx
autonomous: true

must_haves:
  truths:
    - "Starter/free users visiting /referrals see an upgrade prompt instead of referral content"
    - "Pro users visiting /referrals see full referral link card and stats as before"
    - "Upgrade prompt includes a link to /pricing for conversion"
  artifacts:
    - path: "src/components/referral/ReferralsUpgradeFallback.tsx"
      provides: "Server-compatible upgrade fallback with /pricing link"
      contains: "href=\"/pricing\""
    - path: "src/app/(app)/referrals/page.tsx"
      provides: "Referrals page with FeatureGate wrapping"
      contains: "FeatureGate"
  key_links:
    - from: "src/app/(app)/referrals/page.tsx"
      to: "src/components/ui/feature-gate.tsx"
      via: "FeatureGate import and usage"
      pattern: "FeatureGate.*requiredTier.*pro"
    - from: "src/app/(app)/referrals/page.tsx"
      to: "src/lib/whop/subscription.ts"
      via: "getUserTier() call for server-side tier check"
      pattern: "getUserTier"
    - from: "src/components/referral/ReferralsUpgradeFallback.tsx"
      to: "/pricing"
      via: "Next.js Link component"
      pattern: "Link.*href.*pricing"
---

<objective>
Gate the referrals page behind Pro tier using server-side FeatureGate.

Purpose: Referrals is a Pro-only feature per the pricing table. Starter/free users should see an upgrade prompt with a /pricing link instead of referral content. This is a server component, so we use FeatureGate (not TierGate) with getUserTier().

Output: Referrals page gated for non-Pro users with a branded upgrade fallback component.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/(app)/referrals/page.tsx
@src/components/ui/feature-gate.tsx
@src/lib/whop/subscription.ts
@src/lib/whop/config.ts
@src/components/ui/upgrade-banner.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ReferralsUpgradeFallback component and wire FeatureGate into referrals page</name>
  <files>
    src/components/referral/ReferralsUpgradeFallback.tsx
    src/app/(app)/referrals/page.tsx
  </files>
  <action>
**Step 1: Create `src/components/referral/ReferralsUpgradeFallback.tsx`**

This is a server-compatible component (no "use client" needed) that shows an upgrade prompt when Starter/free users visit the referrals page. It must:
- Match the existing page header style (same heading "Referral Program", same subtitle layout)
- Show a centered card with Zap icon (from lucide-react), "Pro Feature" heading, explanation text, and a "View pricing" CTA button linking to /pricing
- Use Raycast design language: `rounded-lg border border-white/[0.06] bg-surface p-6 text-center`, coral accent `bg-[#FF7F50]` for the CTA button, `text-foreground` and `text-muted` tokens
- Use Next.js `Link` component (not `<a>`) for the /pricing link
- Import `Zap` from `lucide-react` and `Link` from `next/link`

Structure:
```tsx
import Link from "next/link";
import { Zap } from "lucide-react";

export function ReferralsUpgradeFallback() {
  return (
    <div className="max-w-4xl mx-auto px-4 py-6 sm:p-6 space-y-6">
      <div className="mb-2">
        <h1 className="text-3xl font-bold text-foreground mb-2">Referral Program</h1>
        <p className="text-muted">Invite friends to Virtuna and earn rewards for every conversion.</p>
      </div>
      <div className="rounded-lg border border-white/[0.06] bg-surface p-6 text-center">
        <div className="mx-auto mb-3 flex h-10 w-10 items-center justify-center rounded-full bg-[#FF7F50]/10">
          <Zap className="h-5 w-5 text-[#FF7F50]" />
        </div>
        <h3 className="text-sm font-medium text-white">Pro Feature</h3>
        <p className="mt-1 text-sm text-zinc-400">
          Upgrade to Pro to unlock the referral program and start earning.
        </p>
        <Link
          href="/pricing"
          className="mt-4 inline-block rounded-lg bg-[#FF7F50] px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-[#FF7F50]/90"
        >
          View pricing
        </Link>
      </div>
    </div>
  );
}
```

**Step 2: Modify `src/app/(app)/referrals/page.tsx`**

Add server-side tier gating using FeatureGate:

1. Add imports at top:
   - `import { FeatureGate } from "@/components/ui/feature-gate";`
   - `import { getUserTier } from "@/lib/whop/subscription";`
   - `import { ReferralsUpgradeFallback } from "@/components/referral/ReferralsUpgradeFallback";`

2. After the `if (!user)` redirect check, fetch the user's tier:
   ```tsx
   const tier = await getUserTier();
   ```

3. Wrap the return JSX in a FeatureGate. The entire `<div className="max-w-4xl...">` block becomes the children. Add `<ReferralsUpgradeFallback />` as the fallback prop:
   ```tsx
   return (
     <FeatureGate requiredTier="pro" userTier={tier} fallback={<ReferralsUpgradeFallback />}>
       <div className="max-w-4xl mx-auto px-4 py-6 sm:p-6 space-y-6">
         {/* existing content unchanged */}
       </div>
     </FeatureGate>
   );
   ```

**Important:** Do NOT add "use client" to the referrals page. FeatureGate is a server-compatible component (no hooks). The page stays a server component with its existing Supabase queries.

**Important:** The `getUserTier()` call should be placed AFTER the `if (!user) redirect("/")` check, because getUserTier() also calls Supabase auth internally and we already have the auth check.

**Important:** Keep all existing referral code generation and stats fetching logic between the auth check and the return statement -- this data is still needed for Pro users who pass the gate.
  </action>
  <verify>
Run `pnpm build` from the project root. It must complete with exit code 0 and no TypeScript errors. Specifically verify:
- No "use client" errors on the referrals page
- FeatureGate import resolves
- ReferralsUpgradeFallback import resolves
- getUserTier import resolves
  </verify>
  <done>
- Starter/free users visiting /referrals see the ReferralsUpgradeFallback with "Pro Feature" heading and "View pricing" link to /pricing
- Pro users visiting /referrals see the full referral link card and stats (unchanged behavior)
- The referrals page remains a server component (no "use client" directive)
- Build passes with no errors
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero errors
2. Grep for FeatureGate in referrals page: `grep -n "FeatureGate" src/app/\(app\)/referrals/page.tsx` returns matches
3. Grep for /pricing link in fallback: `grep -n "pricing" src/components/referral/ReferralsUpgradeFallback.tsx` returns matches
4. No "use client" in referrals page: `grep "use client" src/app/\(app\)/referrals/page.tsx` returns nothing
</verification>

<success_criteria>
- Referrals page gates content behind Pro tier using FeatureGate
- Starter/free users see branded upgrade fallback with /pricing link
- Pro users see full referral content without obstruction
- Page remains a server component (no "use client")
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/07-wire-tiergate/07-01-SUMMARY.md`
</output>
