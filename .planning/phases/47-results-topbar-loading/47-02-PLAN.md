---
phase: 47-results-topbar-loading
plan: 02
type: execute
wave: 2
depends_on: ["47-01"]
files_modified:
  - src/components/app/simulation/results-panel.tsx
  - src/components/app/simulation/share-button.tsx
  - src/app/(app)/layout.tsx
  - src/components/app/test-creation-flow.tsx
  - src/components/app/index.ts
autonomous: true

must_haves:
  truths:
    - "ResultsPanel wrapper is a plain scrollable div with space-y-4 GlassCard children -- NOT a nested GlassPanel"
    - "Sticky header uses bg-background/95 with Typography, not glass"
    - "Sticky footer uses Button primary variant for 'Run another test'"
    - "ShareButton uses Button ghost variant and shows toast via useToast on copy"
    - "ToastProvider wraps AppShell in the app layout"
    - "test-creation-flow.tsx inline SimulationResultsPanel replaced with shared ResultsPanel"
  artifacts:
    - path: "src/components/app/simulation/results-panel.tsx"
      provides: "Design-system ResultsPanel with GlassCard sections"
      contains: "GlassCard"
    - path: "src/components/app/simulation/share-button.tsx"
      provides: "Button ghost share with toast notification"
      contains: "useToast"
    - path: "src/app/(app)/layout.tsx"
      provides: "ToastProvider wrapping AppShell"
      contains: "ToastProvider"
  key_links:
    - from: "src/components/app/simulation/share-button.tsx"
      to: "@/components/ui/toast"
      via: "useToast import"
      pattern: "import.*useToast.*from.*toast"
    - from: "src/app/(app)/layout.tsx"
      to: "@/components/ui/toast"
      via: "ToastProvider import"
      pattern: "import.*ToastProvider.*from.*toast"
---

<objective>
Migrate the ResultsPanel wrapper and ShareButton to design system components, add ToastProvider to the app layout, and clean up the duplicate SimulationResultsPanel in test-creation-flow.tsx.

Purpose: The assembled results panel uses the migrated section cards from Plan 01, wraps them in a clean scrollable container with sticky header/footer, and enables toast notifications for the share action.

Output: ResultsPanel, ShareButton, and ToastProvider fully wired. test-creation-flow.tsx legacy duplicate removed.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/47-results-topbar-loading/47-RESEARCH.md

Source files to migrate:
@src/components/app/simulation/results-panel.tsx
@src/components/app/simulation/share-button.tsx
@src/app/(app)/layout.tsx
@src/components/app/test-creation-flow.tsx
@src/components/app/index.ts

Design system components:
@src/components/ui/toast.tsx
@src/components/ui/button.tsx
@src/components/ui/typography.tsx
@src/components/primitives/GlassCard.tsx

Prior plan output (section cards):
@.planning/phases/47-results-topbar-loading/47-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate ResultsPanel wrapper and ShareButton, add ToastProvider</name>
  <files>
    src/components/app/simulation/results-panel.tsx
    src/components/app/simulation/share-button.tsx
    src/app/(app)/layout.tsx
  </files>
  <action>
**ShareButton migration (`share-button.tsx`):**

1. Remove `useState` for `copied` state and `setTimeout` pattern.
2. Import `Button` from `@/components/ui/button` and `useToast` from `@/components/ui/toast`.
3. Replace the raw `<button>` with:
   ```tsx
   <Button variant="ghost" size="sm" onClick={handleShare}>
     <Share2 className="h-4 w-4" />
     Share
   </Button>
   ```
4. Replace the clipboard handler to use toast:
   ```tsx
   const { toast } = useToast();
   const handleShare = async () => {
     const shareUrl = `${window.location.origin}/results/${resultId}`;
     try {
       await navigator.clipboard.writeText(shareUrl);
       toast({ variant: "success", title: "Link copied to clipboard" });
     } catch {
       toast({ variant: "error", title: "Failed to copy link" });
     }
   };
   ```
5. Remove the `Check` icon import and the copied/not-copied conditional render.
6. Keep `'use client'` directive and `ShareButtonProps` interface.

**ResultsPanel migration (`results-panel.tsx`):**

1. Replace the outer container:
   - FROM: `rounded-2xl border border-zinc-800 bg-zinc-900 shadow-xl`
   - TO: `rounded-xl border border-border bg-surface shadow-xl` (plain div, NOT GlassPanel, to avoid double glass with child GlassCards)
2. Keep `max-h-[70vh] overflow-y-auto`.
3. Sticky header: replace `bg-zinc-900/95` with `bg-background/95`. Replace `<h2 className="text-sm font-medium text-zinc-400">` with `<Text size="sm" muted>Simulation Results</Text>`. Replace `border-zinc-800` with `border-border`.
4. Content section: change `space-y-8 p-6` to `space-y-4 p-4` for tighter card spacing matching stacked GlassCard layout.
5. Sticky footer: replace `bg-zinc-900/95` with `bg-background/95`, `border-zinc-800` with `border-border`. Replace the raw `<button>` with `<Button variant="primary" className="w-full">Run another test</Button>`. Remove `cn()` import if no longer needed.
6. The child components (ImpactScore, AttentionBreakdown, etc.) are already migrated in Plan 01 -- no changes needed to how they're called.

**ToastProvider in layout (`layout.tsx`):**

1. Add `'use client'` is NOT needed -- layout.tsx is a server component. However, `ToastProvider` is a client component.
2. Since the layout is a server component, wrap `ToastProvider` around `AppShell`:
   ```tsx
   import { ToastProvider } from "@/components/ui/toast";
   // ...
   <body className="min-h-screen bg-background font-sans antialiased">
     <ToastProvider>
       <AppShell>
         {children}
       </AppShell>
     </ToastProvider>
   </body>
   ```
3. Note: `ToastProvider` has `"use client"` in its own file, so it's safe to import into a server layout. BUT the layout itself currently has no `"use client"` directive. Since `ToastProvider` is a client component used as a child in JSX, this works fine with React Server Components -- client components can be rendered as children in server components.

**Token replacements:**
- All `zinc-*`, `emerald-*`, `orange-*` hardcoded classes replaced
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors.
Run `grep -rn "zinc\|emerald\|orange-500\|orange-600" src/components/app/simulation/results-panel.tsx src/components/app/simulation/share-button.tsx` -- no matches.
Verify `ToastProvider` is in layout: `grep -n "ToastProvider" "src/app/(app)/layout.tsx"` -- should show import and usage.
  </verify>
  <done>
ResultsPanel renders as a plain scrollable container with GlassCard sections, sticky header/footer using bg-background/95, Button primary for "Run another test". ShareButton uses Button ghost + useToast for clipboard feedback. ToastProvider wraps AppShell in the app layout.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean up test-creation-flow.tsx inline SimulationResultsPanel</name>
  <files>
    src/components/app/test-creation-flow.tsx
  </files>
  <action>
The `test-creation-flow.tsx` file contains an inline `SimulationResultsPanel` component (lines 160-258) and `AttentionBar` helper (lines 263-293) that duplicate the results panel logic. `dashboard-client.tsx` is the active consumer; `TestCreationFlow` is only exported from the barrel but never imported by any page.

1. Remove the inline `SimulationResultsPanel` function and `AttentionBar` function entirely (lines 156-293).
2. Import the shared `ResultsPanel` from `@/components/app/simulation/results-panel.tsx`.
3. In the `viewing-results` branch (around line 136), replace:
   ```tsx
   <SimulationResultsPanel
     impactScore={currentResult.impactScore}
     attention={currentResult.attention}
     onRunAnother={handleRunAnother}
   />
   ```
   with:
   ```tsx
   <ResultsPanel
     result={currentResult}
     onRunAnother={handleRunAnother}
   />
   ```
4. In the `simulating` branch (around line 127), replace the bare `Loader2` spinner with a simple loading state. Import `Spinner` from `@/components/ui/spinner` and `Text` from `@/components/ui/typography`:
   ```tsx
   <div className={cn("flex flex-col items-center justify-center gap-4 py-20", className)}>
     <Spinner size="lg" />
     <Text size="sm" muted>Simulating response...</Text>
   </div>
   ```
5. Remove unused imports: `Loader2` from lucide-react, `SimulationResultsPanelProps`, `AttentionBarProps`.
6. Verify the component still compiles and the barrel export in `index.ts` still works.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors.
Run `grep -rn "SimulationResultsPanel\|AttentionBar\|Loader2" src/components/app/test-creation-flow.tsx` -- no matches (all removed).
Run `grep -rn "zinc\|emerald\|amber" src/components/app/test-creation-flow.tsx` -- minimal or no matches (only cn() utility patterns).
  </verify>
  <done>
test-creation-flow.tsx uses the shared ResultsPanel component instead of its inline duplicate. The bare Loader2 spinner is replaced with the design system Spinner. ~140 lines of duplicated code removed.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes.
2. Zero hardcoded zinc/emerald/orange classes in results-panel.tsx and share-button.tsx.
3. `ToastProvider` present in app layout wrapping AppShell.
4. test-creation-flow.tsx uses shared `ResultsPanel`, no inline duplicate.
5. ShareButton uses `useToast()` instead of useState/setTimeout pattern.
</verification>

<success_criteria>
ResultsPanel wrapper renders with design tokens, ShareButton uses toast system, ToastProvider is in the app layout, and the test-creation-flow duplicate is eliminated.
</success_criteria>

<output>
After completion, create `.planning/phases/47-results-topbar-loading/47-02-SUMMARY.md`
</output>
