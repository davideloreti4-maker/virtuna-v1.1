---
phase: 47-results-topbar-loading
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/app/simulation/loading-phases.tsx
autonomous: true

must_haves:
  truths:
    - "Loading state shows skeleton shimmer placeholders in the shape of the stacked-card results layout"
    - "No phase checklist or percentage progress bar remains -- skeletons alone convey loading"
    - "Each section skeleton fades in from skeleton to content as the corresponding simulationPhase completes"
    - "A cancel button is visible below the skeleton area and returns to filling-form state on click"
  artifacts:
    - path: "src/components/app/simulation/loading-phases.tsx"
      provides: "Skeleton shimmer loading with progressive reveal"
      contains: "GlassSkeleton"
  key_links:
    - from: "src/components/app/simulation/loading-phases.tsx"
      to: "@/stores/test-store"
      via: "simulationPhase subscription"
      pattern: "useTestStore.*simulationPhase"
    - from: "src/components/app/simulation/loading-phases.tsx"
      to: "@/components/primitives"
      via: "GlassSkeleton and GlassCard imports"
      pattern: "import.*GlassSkeleton.*from.*primitives"
---

<objective>
Rewrite the LoadingPhases component from a phase checklist + progress bar to skeleton shimmer placeholders with progressive reveal, matching the final stacked-card results layout.

Purpose: Loading state provides visual continuity by showing the exact shape of the final results in skeleton form, then smoothly revealing each section as data becomes ready. This replaces the checklist pattern with a modern skeleton loading UX.

Output: Fully rewritten loading-phases.tsx with skeleton shimmer layout, progressive reveal via framer-motion AnimatePresence, and cancel button.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/47-results-topbar-loading/47-RESEARCH.md

Source file to rewrite:
@src/components/app/simulation/loading-phases.tsx

Store (for phase mapping):
@src/stores/test-store.ts

Design system components:
@src/components/primitives/GlassSkeleton.tsx
@src/components/primitives/GlassCard.tsx
@src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite LoadingPhases with skeleton shimmer and progressive reveal</name>
  <files>
    src/components/app/simulation/loading-phases.tsx
  </files>
  <action>
This is a full rewrite -- the current component (phase checklist + progress bar) is entirely replaced by skeleton shimmer placeholders.

**Step 1: Build the skeleton layout**

Create a `ResultsSkeleton` component that mirrors the stacked-card results layout from RESEARCH.md Pattern 4. Each "section" is a GlassCard with GlassSkeleton children matching the expected content shape:

```tsx
// ImpactScore skeleton
<GlassCard padding="md">
  <GlassSkeleton width="120px" height="14px" />  {/* "Impact Score" label */}
  <GlassSkeleton width="80px" height="12px" className="mt-2" />  {/* label text */}
  <GlassSkeleton width="160px" height="48px" className="mt-3" />  {/* big score number */}
</GlassCard>

// AttentionBreakdown skeleton
<GlassCard padding="md">
  <GlassSkeleton width="160px" height="14px" />  {/* "Attention" label */}
  <div className="mt-4 space-y-4">
    {[1, 2, 3].map((i) => (
      <div key={i} className="space-y-1.5">
        <div className="flex justify-between">
          <GlassSkeleton width="100px" />
          <GlassSkeleton width="40px" />
        </div>
        <GlassSkeleton shape="rectangle" height={8} />  {/* progress bar shape */}
      </div>
    ))}
  </div>
</GlassCard>

// Variants skeleton
<GlassCard padding="md">
  <GlassSkeleton width="80px" height="14px" />
  <div className="mt-3 space-y-2">
    {[1, 2].map((i) => (
      <GlassSkeleton key={i} shape="rectangle" height={64} />
    ))}
  </div>
</GlassCard>

// Insights skeleton
<GlassCard padding="md">
  <GlassSkeleton width="80px" height="14px" />
  <SkeletonText lines={3} className="mt-3" />
</GlassCard>

// Themes skeleton
<GlassCard padding="md">
  <GlassSkeleton width="120px" height="14px" />
  <div className="mt-3 space-y-2">
    {[1, 2].map((i) => (
      <GlassSkeleton key={i} shape="rectangle" height={48} />
    ))}
  </div>
</GlassCard>
```

**Step 2: Build the ProgressiveReveal wrapper**

Use framer-motion `AnimatePresence` for smooth skeleton-to-content transitions:

```tsx
import { AnimatePresence, motion } from "framer-motion";

function ProgressiveReveal({
  isReady,
  skeleton,
  children,
}: {
  isReady: boolean;
  skeleton: ReactNode;
  children: ReactNode;
}) {
  return (
    <AnimatePresence mode="wait">
      {isReady ? (
        <motion.div
          key="content"
          initial={{ opacity: 0, y: 6 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.3, ease: [0.215, 0.61, 0.355, 1] }}
        >
          {children}
        </motion.div>
      ) : (
        <motion.div
          key="skeleton"
          exit={{ opacity: 0 }}
          transition={{ duration: 0.15 }}
        >
          {skeleton}
        </motion.div>
      )}
    </AnimatePresence>
  );
}
```

**Step 3: Map simulation phases to section readiness**

Per RESEARCH.md: The progressive reveal is purely visual -- store still delivers all data at once. Map `simulationPhase` to section "readiness":
- `analyzing` complete (phase transitions to `matching`): ImpactScore section ready
- `matching` complete (phase transitions to `simulating`): AttentionBreakdown ready
- `simulating` complete (phase transitions to `generating`): Variants ready
- `generating` complete (status transitions to `viewing-results`): Insights + Themes ready

Derive readiness from `simulationPhase`:
```tsx
const simulationPhase = useTestStore((s) => s.simulationPhase);

const PHASE_ORDER: SimulationPhase[] = ["analyzing", "matching", "simulating", "generating"];
const currentIdx = simulationPhase ? PHASE_ORDER.indexOf(simulationPhase) : -1;

const isImpactReady = currentIdx >= 1;        // past "analyzing"
const isAttentionReady = currentIdx >= 2;     // past "matching"
const isVariantsReady = currentIdx >= 3;      // past "simulating"
const isInsightsReady = false;                // only when all complete (viewing-results)
```

Since during `simulating` status the actual data doesn't exist yet (it all arrives when simulation completes), the "ready" sections during loading show placeholder content -- empty GlassCards with a subtle "ready" state. When the simulation fully completes, dashboard-client.tsx switches to `viewing-results` and shows the real ResultsPanel. So the progressive reveal during loading is purely visual shimmer-to-empty-card transitions.

**Alternative approach (simpler, recommended):** Since the data only arrives all at once and the results panel replaces the loading component entirely when done, the progressive reveal during loading is best implemented as: sections reveal their skeleton shape progressively (first skeleton appears immediately, subsequent skeletons appear with staggered delays matching the phase transitions). This is a staggered skeleton entry, not skeleton-to-content.

Implement as staggered skeleton entry:
```tsx
const sections = [
  { phase: "analyzing" as const, skeleton: <ImpactScoreSkeleton /> },
  { phase: "matching" as const, skeleton: <AttentionSkeleton /> },
  { phase: "simulating" as const, skeleton: <VariantsSkeleton /> },
  { phase: "generating" as const, skeleton: <InsightsThemesSkeleton /> },
];

// Each section appears when its phase starts (not when complete)
const isVisible = (phase: SimulationPhase) => {
  return currentIdx >= PHASE_ORDER.indexOf(phase);
};
```

Each section skeleton fades in with `motion.div` when its phase activates.

**Step 4: Cancel button**

Below the skeleton area, render:
```tsx
<Button variant="secondary" onClick={cancelSimulation} className="w-full mt-4">
  Cancel
</Button>
```

Import `cancelSimulation` from `useTestStore`.

**Step 5: Assemble the component**

The final `LoadingPhases` component:
1. Reads `simulationPhase` and `cancelSimulation` from `useTestStore`
2. Renders the stacked skeleton cards with staggered entry based on current phase
3. Shows cancel button below

Remove ALL old code: the PHASES array, the phase checklist rendering, the progress bar, the emerald/zinc colors. Keep `'use client'` directive and `SimulationPhase` type import.

**Imports needed:**
- `GlassCard` from `@/components/primitives`
- `GlassSkeleton`, `SkeletonText` from `@/components/primitives/GlassSkeleton`
- `Button` from `@/components/ui/button`
- `AnimatePresence`, `motion` from `framer-motion`
- `useTestStore`, `SimulationPhase` from `@/stores/test-store`
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors.
Run `grep -rn "zinc\|emerald\|Check\|progress bar\|PHASES\[" src/components/app/simulation/loading-phases.tsx` -- no matches (all legacy code removed).
Verify the component still subscribes to `useTestStore` for `simulationPhase` and `cancelSimulation`.
  </verify>
  <done>
LoadingPhases shows skeleton shimmer cards matching the results layout shape. Skeletons appear in staggered sequence mapped to simulation phases. No checklist or progress bar remains. Cancel button is visible and functional below the skeleton area.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes.
2. No phase checklist, progress bar, or percentage text remains.
3. Skeleton placeholders match the shape of the 5 results sections (impact score, attention, variants, insights, themes).
4. Cancel button calls `cancelSimulation` from test-store.
5. Zero hardcoded zinc/emerald color classes.
6. framer-motion used for fade-in transitions.
</verification>

<success_criteria>
LoadingPhases component renders skeleton shimmer cards in the shape of the final results layout. Each skeleton section fades in as its simulation phase activates. Cancel button returns to filling-form state. No legacy checklist/progress bar remains.
</success_criteria>

<output>
After completion, create `.planning/phases/47-results-topbar-loading/47-04-SUMMARY.md`
</output>
