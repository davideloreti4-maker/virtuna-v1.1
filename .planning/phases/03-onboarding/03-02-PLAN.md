---
phase: 03-onboarding
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(app)/dashboard/dashboard-client.tsx
  - src/stores/tooltip-store.ts
  - src/components/app/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard shows personalized context based on user's selected goal (or generic if no goal)"
    - "Dashboard shows 3-4 contextual tooltips on first visit after onboarding completion"
    - "Tooltips only appear for users who have completed (or skipped) onboarding, not for all users"
    - "Dismissed tooltips do not reappear after page refresh"
    - "Sidebar TikTok selector shows connected handle when user has completed onboarding with a handle"
  artifacts:
    - path: "src/app/(app)/dashboard/dashboard-client.tsx"
      provides: "Goal-personalized context bar + 3-4 tooltips + smart onboarding detection"
      contains: "primary_goal"
    - path: "src/stores/tooltip-store.ts"
      provides: "Tooltip store with 4 tooltip IDs"
      contains: "tiktok-connect"
    - path: "src/components/app/sidebar.tsx"
      provides: "Sidebar with connected TikTok handle display"
      contains: "creator_profiles"
  key_links:
    - from: "src/app/(app)/dashboard/dashboard-client.tsx"
      to: "creator_profiles table"
      via: "Supabase query for primary_goal and onboarding_completed_at"
      pattern: "primary_goal"
    - from: "src/components/app/sidebar.tsx"
      to: "creator_profiles table"
      via: "Supabase query for tiktok_handle"
      pattern: "tiktok_handle"
---

<objective>
Wire goal-based dashboard personalization (ONBR-05), complete the tooltip system to 3-4 tooltips (ONBR-08), fix the tooltip visibility logic to respect actual onboarding completion (Pitfall 4), and wire the sidebar TikTok selector to show the connected handle.

Purpose: After onboarding, the dashboard should reflect the user's goal choice and guide them with contextual tooltips. Currently the dashboard ignores the goal, only has 2 tooltips, and shows tooltips unconditionally for all users.

Output: Personalized dashboard experience with 3-4 tooltips, goal-aware context, and wired TikTok selector.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key files to understand
@src/app/(app)/dashboard/dashboard-client.tsx
@src/stores/tooltip-store.ts
@src/components/tooltips/contextual-tooltip.tsx
@src/components/app/sidebar.tsx
@src/stores/onboarding-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix tooltip logic + add 3rd/4th tooltips + goal-personalized dashboard</name>
  <files>
    src/app/(app)/dashboard/dashboard-client.tsx
    src/stores/tooltip-store.ts
  </files>
  <action>
**tooltip-store.ts changes:**

1. Add a 4th tooltip ID to the `TooltipId` type: `"tiktok-connect"`. The full type should be:
```typescript
export type TooltipId = "hive-viz" | "test-creation" | "settings" | "tiktok-connect";
```

No other changes needed to the store -- the `isTooltipVisible` and `dismissTooltip` logic already works generically.

**dashboard-client.tsx changes:**

**A) Fix unconditional onboardingComplete flag (Pitfall 4):**

Replace the current unconditional `setOnboardingComplete(true)` useEffect (lines 63-67) with a Supabase check:

```typescript
useEffect(() => {
  if (!tooltipStore._isHydrated || tooltipStore.onboardingComplete) return;

  async function checkOnboardingStatus() {
    const supabase = createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const { data: profile } = await supabase
      .from("creator_profiles")
      .select("onboarding_completed_at")
      .eq("user_id", user.id)
      .maybeSingle();

    if (profile?.onboarding_completed_at) {
      tooltipStore.setOnboardingComplete(true);
    }
  }

  checkOnboardingStatus();
}, [tooltipStore._isHydrated]); // eslint-disable-line react-hooks/exhaustive-deps
```

This ensures tooltips only appear for users who have actually completed (or skipped) onboarding.

**B) Add goal-personalized context bar (ONBR-05):**

Add state and a Supabase fetch for the user's primary_goal:

```typescript
const [primaryGoal, setPrimaryGoal] = useState<string | null>(null);

useEffect(() => {
  async function fetchGoal() {
    const supabase = createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const { data: profile } = await supabase
      .from("creator_profiles")
      .select("primary_goal")
      .eq("user_id", user.id)
      .maybeSingle();

    if (profile?.primary_goal) {
      setPrimaryGoal(profile.primary_goal as string);
    }
  }
  fetchGoal();
}, []);
```

Combine both Supabase queries (onboarding check + goal fetch) into a single useEffect to avoid redundant requests. Query `onboarding_completed_at, primary_goal` together.

Then pass a goal-specific `location` prop to the ContextBar component. Map goals to descriptive text:
- `"monetization"` -> "Monetization Focus"
- `"viral_content"` -> "Viral Content Focus"
- `"affiliate_revenue"` -> "Affiliate Revenue Focus"
- `null` / missing -> "Switzerland" (existing default)

The ContextBar already accepts a `location` string prop. This is the minimal change to reflect the goal on the dashboard.

**C) Add 3rd and 4th tooltip placements (ONBR-08):**

Currently 2 tooltips are placed:
1. `hive-viz` wraps the HiveCanvas
2. `test-creation` wraps the ContextBar

Add 2 more tooltips in dashboard-client.tsx:

3. `settings` tooltip: Wrap the FilterPillGroup section with a ContextualTooltip:
```tsx
<ContextualTooltip
  id="settings"
  title="Filter your view"
  description="Use these filters to focus on the content categories that matter most to you"
  position="bottom"
>
  <div className="flex items-center gap-3 overflow-x-auto">
    <FilterPillGroup />
  </div>
</ContextualTooltip>
```

4. `tiktok-connect` tooltip: This tooltip targets the sidebar TikTok selector. Since the sidebar is a separate component, this tooltip will be added in Task 2 (sidebar changes).

Add the `createClient` import if not already present:
```typescript
import { createClient } from "@/lib/supabase/client";
```

Also add `useState` to the React imports if not already there.
  </action>
  <verify>
1. `npm run build` passes with no TypeScript errors
2. Read `src/stores/tooltip-store.ts` and confirm `TooltipId` includes `"tiktok-connect"`
3. Read `src/app/(app)/dashboard/dashboard-client.tsx` and confirm:
   - Supabase query for `onboarding_completed_at` and `primary_goal` exists
   - `setOnboardingComplete(true)` only called when `onboarding_completed_at` is set
   - ContextBar receives goal-based location string
   - 3 ContextualTooltip components rendered (hive-viz, test-creation, settings)
  </verify>
  <done>
Dashboard reads user's primary_goal from Supabase and displays goal-specific context. Tooltip onboardingComplete flag only set when user has actually completed onboarding. Three tooltips rendered on dashboard (hive-viz, test-creation, settings).
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire sidebar TikTok selector with handle display + 4th tooltip</name>
  <files>
    src/components/app/sidebar.tsx
  </files>
  <action>
Wire the sidebar TikTok account selector placeholder to show the user's connected TikTok handle (from onboarding), and add the 4th contextual tooltip.

**A) Fetch and display connected TikTok handle:**

Add state and a Supabase fetch for the user's tiktok_handle:

```typescript
const [tiktokHandle, setTiktokHandle] = useState<string | null>(null);

useEffect(() => {
  async function fetchHandle() {
    const supabase = createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const { data: profile } = await supabase
      .from("creator_profiles")
      .select("tiktok_handle")
      .eq("user_id", user.id)
      .maybeSingle();

    if (profile?.tiktok_handle) {
      setTiktokHandle(profile.tiktok_handle);
    }
  }
  fetchHandle();
}, []);
```

Add `useState` to the React import if not already there. The `createClient` import is already present.

**B) Update the TikTok selector display:**

Replace the static "Connect TikTok" placeholder (lines 165-172) with a dynamic display:

```tsx
<div className="mx-2 my-2">
  <div className="flex items-center gap-2 rounded-lg bg-white/[0.04] px-3 py-2">
    <div className={cn(
      "h-6 w-6 shrink-0 rounded-full flex items-center justify-center",
      tiktokHandle ? "bg-accent/20" : "bg-white/[0.1]"
    )}>
      {tiktokHandle && (
        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" className="text-accent" aria-hidden="true">
          <path d="M20 6L9 17l-5-5" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" fill="none" />
        </svg>
      )}
    </div>
    <Text as="span" size="sm" className={cn(
      "truncate",
      tiktokHandle ? "text-foreground" : "text-foreground-muted"
    )}>
      {tiktokHandle ? `@${tiktokHandle}` : "Connect TikTok"}
    </Text>
  </div>
</div>
```

**C) Add 4th tooltip wrapping the TikTok selector:**

Import ContextualTooltip and wrap the TikTok selector section:

```typescript
import { ContextualTooltip } from "@/components/tooltips/contextual-tooltip";
```

Wrap the TikTok selector `<div className="mx-2 my-2">` with:
```tsx
<ContextualTooltip
  id="tiktok-connect"
  title="Your TikTok Account"
  description="Connect your TikTok handle to unlock personalized content intelligence"
  position="right"
>
  {/* existing TikTok selector div */}
</ContextualTooltip>
```

Only show this tooltip when the handle is NOT connected (no point telling them to connect if they already did). To achieve this, conditionally render the ContextualTooltip wrapper: if `tiktokHandle` is set, render the selector div directly without the tooltip wrapper. If not set, wrap with ContextualTooltip.

Important: The sidebar needs to hydrate the tooltip store. Add tooltip store hydration if not present:
```typescript
import { useTooltipStore } from "@/stores/tooltip-store";
```
And in the component body:
```typescript
const tooltipStore = useTooltipStore();

useEffect(() => {
  if (!tooltipStore._isHydrated) {
    tooltipStore._hydrate();
  }
}, [tooltipStore]);
```
  </action>
  <verify>
1. `npm run build` passes with no TypeScript errors
2. Read `src/components/app/sidebar.tsx` and confirm:
   - Supabase query fetches `tiktok_handle` from `creator_profiles`
   - TikTok selector shows `@handle` when connected, "Connect TikTok" when not
   - ContextualTooltip wraps the selector only when handle is not connected
   - Tooltip store is hydrated
3. Verify import paths resolve: `@/components/tooltips/contextual-tooltip` and `@/stores/tooltip-store`
  </verify>
  <done>
Sidebar TikTok selector displays connected handle with visual confirmation (accent circle + checkmark). Shows "Connect TikTok" with tooltip prompt when not connected. Fourth contextual tooltip (tiktok-connect) rendered in sidebar for users without a connected handle.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build` completes without errors
2. Tooltip store has 4 tooltip IDs: hive-viz, test-creation, settings, tiktok-connect
3. Dashboard renders 3 ContextualTooltip components (hive-viz, test-creation, settings)
4. Sidebar renders 1 ContextualTooltip (tiktok-connect) for users without a handle
5. Dashboard reads primary_goal from Supabase and personalizes ContextBar
6. Tooltip onboardingComplete flag only set after checking Supabase onboarding_completed_at
7. Sidebar displays connected TikTok handle or "Connect TikTok" placeholder
</verification>

<success_criteria>
- Dashboard shows goal-personalized context bar text
- 4 total tooltips placed across dashboard and sidebar
- Tooltips only appear after actual onboarding completion
- Dismissed tooltips persist across page refresh (localStorage)
- Sidebar shows connected TikTok handle with visual indicator
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-onboarding/03-02-SUMMARY.md`
</output>
