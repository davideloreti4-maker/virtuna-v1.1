---
phase: 03-onboarding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(onboarding)/login/actions.ts
  - src/app/auth/callback/route.ts
  - src/app/auth/login/page.tsx
  - src/app/auth/signup/page.tsx
  - src/app/auth/layout.tsx
autonomous: true

must_haves:
  truths:
    - "First-time user who logs in via email/password is redirected to /welcome (not /dashboard)"
    - "First-time user who logs in via Google OAuth is redirected to /welcome (not /dashboard)"
    - "Returning user who logs in is redirected to /dashboard (not /welcome)"
    - "Old /auth/login and /auth/signup pages no longer exist"
  artifacts:
    - path: "src/app/(onboarding)/login/actions.ts"
      provides: "Login action with first-time user detection"
      contains: "creator_profiles"
    - path: "src/app/auth/callback/route.ts"
      provides: "OAuth callback with first-time user detection"
      contains: "creator_profiles"
  key_links:
    - from: "src/app/(onboarding)/login/actions.ts"
      to: "creator_profiles table"
      via: "Supabase query for onboarding_completed_at"
      pattern: "onboarding_completed_at"
    - from: "src/app/auth/callback/route.ts"
      to: "creator_profiles table"
      via: "Supabase query for existing profile"
      pattern: "creator_profiles"
---

<objective>
Wire first-time user routing so new users reach the onboarding flow at /welcome instead of being dropped on an empty dashboard. Fix both the email/password login path and the Google OAuth callback path. Also clean up the deprecated /auth/login and /auth/signup pages.

Purpose: ONBR-01 requires first-time users to be routed to onboarding. Currently, login defaults to /dashboard and OAuth callback defaults to /dashboard. Without this fix, new users never see the onboarding flow.

Output: Login action and OAuth callback both detect first-time users and redirect to /welcome. Old auth pages deleted.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key files to understand
@src/app/(onboarding)/login/actions.ts
@src/app/auth/callback/route.ts
@src/app/(onboarding)/welcome/page.tsx
@src/stores/onboarding-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add first-time user detection to login action and OAuth callback</name>
  <files>
    src/app/(onboarding)/login/actions.ts
    src/app/auth/callback/route.ts
  </files>
  <action>
**Login action (`src/app/(onboarding)/login/actions.ts`):**

After the successful `signInWithPassword` call (and before the `redirect(next)` call), check whether this is a first-time user. The logic:

1. After successful auth, query `creator_profiles` for the authenticated user
2. If no profile row exists OR `onboarding_completed_at` is null, redirect to `/welcome` instead of `next`
3. If profile exists AND `onboarding_completed_at` is set, use the existing `next` redirect (defaults to `/dashboard`)

Implementation:
```typescript
// After successful signInWithPassword, before redirect:
const { data: { user } } = await supabase.auth.getUser();
if (user) {
  const { data: profile } = await supabase
    .from("creator_profiles")
    .select("onboarding_completed_at")
    .eq("user_id", user.id)
    .maybeSingle();

  if (!profile || !profile.onboarding_completed_at) {
    redirect("/welcome");
  }
}
redirect(next);
```

Note: Use `maybeSingle()` not `single()` because first-time users may not have a profile row yet.

**OAuth callback (`src/app/auth/callback/route.ts`):**

After the successful `exchangeCodeForSession` call (line 47), before creating the redirect response, check if this is a first-time user:

1. Query `creator_profiles` for `data.user.id`
2. If no profile exists OR `onboarding_completed_at` is null, change the redirect destination from `next` to `/welcome`
3. If profile exists with `onboarding_completed_at` set, keep the original `next` destination

The redirect response is currently created on line 28 (before the session exchange). Restructure so the redirect URL is determined AFTER the first-time check:

```typescript
const { error, data } = await supabase.auth.exchangeCodeForSession(code);
if (error) { /* existing error handling */ }

// Determine redirect destination
let redirectTo = next;
if (data.user) {
  const { data: profile } = await supabase
    .from("creator_profiles")
    .select("onboarding_completed_at")
    .eq("user_id", data.user.id)
    .maybeSingle();

  if (!profile || !profile.onboarding_completed_at) {
    redirectTo = "/welcome";
  }
}

const response = NextResponse.redirect(new URL(redirectTo, origin));
// ... rest of cookie handling
```

Important: Move the `NextResponse.redirect` call to AFTER the profile check, since the redirect URL depends on the profile query result. The Supabase client cookie setup needs to use `request.cookies.getAll()` for reads and set cookies on the response after it's created.
  </action>
  <verify>
1. `npm run build` passes with no TypeScript errors
2. Read both files and confirm: login action queries creator_profiles before redirecting, OAuth callback queries creator_profiles before redirecting
3. Confirm `maybeSingle()` is used (not `single()`) to handle missing profile rows gracefully
  </verify>
  <done>
Login action redirects first-time users to /welcome and returning users to /dashboard. OAuth callback redirects first-time users to /welcome and returning users to /dashboard.
  </done>
</task>

<task type="auto">
  <name>Task 2: Delete deprecated auth pages</name>
  <files>
    src/app/auth/login/page.tsx
    src/app/auth/signup/page.tsx
    src/app/auth/layout.tsx
  </files>
  <action>
Delete the old auth pages that were superseded by the new /(onboarding)/ route group pages in Phase 1:

1. Delete `src/app/auth/login/` directory (entire directory including page.tsx)
2. Delete `src/app/auth/signup/` directory (entire directory including page.tsx)
3. Delete `src/app/auth/layout.tsx`

**Keep** `src/app/auth/callback/route.ts` -- this is the active OAuth PKCE callback route used by the new auth flow.

After deletion, verify no other files import from the deleted paths:
- Search for `@/app/auth/login` and `@/app/auth/signup` imports
- Search for `href="/auth/login"` and `href="/auth/signup"` links

If any references found, update them to point to `/login` and `/signup` respectively.

Also remove the pending todo from STATE.md: "Clean up old auth pages at /auth/login and /auth/signup (superseded by /login and /signup)" -- this is being done now.
  </action>
  <verify>
1. `npm run build` passes with no TypeScript errors
2. Confirm `src/app/auth/callback/route.ts` still exists
3. Confirm `src/app/auth/login/` and `src/app/auth/signup/` directories no longer exist
4. Confirm `src/app/auth/layout.tsx` no longer exists
5. `grep -r "auth/login\|auth/signup" src/` returns no references to old auth pages (except /auth/callback which is expected)
  </verify>
  <done>
Old /auth/login and /auth/signup pages deleted. /auth/callback route preserved. No broken references remain.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build` completes without errors
2. First-time user routing: Login action checks creator_profiles and redirects to /welcome when no completed onboarding
3. OAuth first-time routing: OAuth callback checks creator_profiles and redirects to /welcome when no completed onboarding
4. Returning user routing: Users with onboarding_completed_at redirect to /dashboard as before
5. No dead references: grep for old auth page paths returns empty
6. OAuth callback preserved: /auth/callback/route.ts still exists and functions
</verification>

<success_criteria>
- First-time email/password login redirects to /welcome
- First-time OAuth login redirects to /welcome
- Returning users redirect to /dashboard
- Old /auth/login and /auth/signup pages deleted
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-onboarding/03-01-SUMMARY.md`
</output>
