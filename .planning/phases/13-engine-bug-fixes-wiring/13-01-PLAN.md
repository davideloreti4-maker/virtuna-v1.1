---
phase: 13-engine-bug-fixes-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/cron/validate-rules/route.ts
  - src/components/app/test-creation-flow.tsx
  - src/app/api/analyze/route.ts
autonomous: true

must_haves:
  truths:
    - "validate-rules cron selects rule_contributions from DB and per-rule accuracy loop produces rulesUpdated > 0 (given sufficient data)"
    - "content_type is derived from the user's selected input mode, not hardcoded to video"
    - "Submitting video_upload mode with pending-upload or empty video_storage_path returns 400 error, not pipeline crash"
  artifacts:
    - path: "src/app/api/cron/validate-rules/route.ts"
      provides: "Fixed select query including rule_contributions column"
      contains: "rule_contributions"
    - path: "src/components/app/test-creation-flow.tsx"
      provides: "Dynamic content_type mapping from input_mode"
      contains: "content_type"
    - path: "src/app/api/analyze/route.ts"
      provides: "Video upload guard rejecting pending-upload sentinel"
      contains: "pending-upload"
  key_links:
    - from: "src/app/api/cron/validate-rules/route.ts"
      to: "analysis_results.rule_contributions"
      via: "Supabase select query"
      pattern: 'select.*rule_contributions'
    - from: "src/components/app/test-creation-flow.tsx"
      to: "src/app/api/analyze/route.ts"
      via: "payload content_type field"
      pattern: "content_type.*input_mode"
---

<objective>
Fix three independent integration bugs: (1) validate-rules cron missing rule_contributions in DB select, (2) content_type hardcoded to "video" in test-creation-flow, (3) video_upload mode with no real file crashes pipeline instead of returning 400.

Purpose: Close audit gaps that cause silent failures in production — cron produces no rule updates, all analyses stored as "video" regardless of input, and video_upload without a file crashes the pipeline.
Output: Three surgical bug fixes across three files.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/api/cron/validate-rules/route.ts
@src/components/app/test-creation-flow.tsx
@src/app/api/analyze/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix validate-rules cron select + content_type derivation</name>
  <files>src/app/api/cron/validate-rules/route.ts, src/components/app/test-creation-flow.tsx</files>
  <action>
**Bug 1 — validate-rules cron (route.ts line ~117):**

The Supabase query selects `"id, overall_score"` but does NOT include `rule_contributions`. The type cast (`as unknown as { data: AnalysisRow[] }`) pretends the column is there, but PostgREST only returns columns listed in the select string. The accuracy loop runs but `ar.rule_contributions` is always `undefined`, so `ruleAccuracy` stays empty and `rulesUpdated` is always 0.

Fix: Change `.select("id, overall_score")` to `.select("id, overall_score, rule_contributions")` on line ~117. This is the ONLY change needed — the AnalysisRow interface and downstream logic already handle the `rule_contributions` field correctly.

**Bug 2 — content_type hardcoded (test-creation-flow.tsx line ~63):**

The payload builder hardcodes `content_type: "video"` regardless of which tab the user selected. This means text-only analyses are stored as "video" type in the DB.

Fix: Replace the hardcoded `content_type: "video"` with a mapping function:
- `text` input_mode → content_type `"thread"` (text-only content, closest match in the enum)
- `tiktok_url` input_mode → content_type `"video"` (TikTok content is video)
- `video_upload` input_mode → content_type `"video"` (uploaded video)

Implementation: Add a const mapping object above the payload builder:
```typescript
const CONTENT_TYPE_MAP: Record<string, string> = {
  text: "thread",
  tiktok_url: "video",
  video_upload: "video",
};
```
Then use `content_type: CONTENT_TYPE_MAP[data.input_mode] ?? "video"` in the payload.
  </action>
  <verify>
1. `grep -n 'rule_contributions' src/app/api/cron/validate-rules/route.ts` shows the column in the select string
2. `grep -n 'content_type' src/components/app/test-creation-flow.tsx` shows dynamic mapping, NOT hardcoded "video"
3. `pnpm build` passes (no type errors)
  </verify>
  <done>
validate-rules cron includes rule_contributions in its select query. content_type is derived from input_mode via a mapping: text→thread, tiktok_url→video, video_upload→video.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add video_upload guard in analyze API route</name>
  <files>src/app/api/analyze/route.ts</files>
  <action>
**Bug 4 — video_upload with no real file:**

When `input_mode` is `video_upload`, test-creation-flow.tsx sends `video_storage_path: "pending-upload"` (a sentinel placeholder from Phase 7). The API route validation at lines ~70-80 checks if `video_storage_path` exists and is a non-empty string — `"pending-upload"` passes this check. The pipeline then crashes when Gemini tries to fetch a non-existent file.

Fix: Add a guard AFTER the existing video_storage_path validation block (after line ~80) that rejects known sentinel values:

```typescript
// Guard against placeholder/sentinel video paths that would crash the pipeline
if (body.input_mode === "video_upload") {
  const vsp = body.video_storage_path;
  if (!vsp || vsp === "pending-upload" || typeof vsp !== "string" || !vsp.startsWith("videos/")) {
    return Response.json(
      { error: "Video upload required. Please upload a video file before submitting." },
      { status: 400 }
    );
  }
}
```

The check ensures:
1. `video_storage_path` is present (not undefined/null)
2. It's not the "pending-upload" sentinel
3. It's a string type
4. It starts with "videos/" (Supabase Storage bucket path convention)

This guard runs BEFORE the Zod parse and pipeline execution, returning a clean 400 instead of a pipeline crash.

Also update/replace the existing weaker validation block at lines ~70-80 so there's no redundancy — the new guard fully subsumes the old check.
  </action>
  <verify>
1. `grep -n 'pending-upload' src/app/api/analyze/route.ts` shows the guard rejecting the sentinel
2. `pnpm build` passes
  </verify>
  <done>
Submitting video_upload mode with "pending-upload", empty string, or missing video_storage_path returns 400 with a user-friendly error message instead of crashing the pipeline.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` completes with zero errors
2. `grep -n 'select.*rule_contributions' src/app/api/cron/validate-rules/route.ts` confirms column in select
3. `grep -n 'content_type' src/components/app/test-creation-flow.tsx` confirms dynamic mapping
4. `grep -n 'pending-upload' src/app/api/analyze/route.ts` confirms video guard
</verification>

<success_criteria>
- validate-rules cron query includes rule_contributions in select string
- content_type derived from input_mode (text→thread, tiktok_url→video, video_upload→video)
- video_upload with sentinel value returns 400, not pipeline crash
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/13-engine-bug-fixes-wiring/13-01-SUMMARY.md`
</output>
