---
phase: 13-engine-bug-fixes-wiring
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/engine/deepseek.ts
  - src/lib/engine/aggregator.ts
autonomous: true

must_haves:
  truths:
    - "PredictionResult.reasoning contains DeepSeek's reasoning text, not an empty string"
    - "The reasoning text is a human-readable summary of why the prediction was made"
  artifacts:
    - path: "src/lib/engine/deepseek.ts"
      provides: "Reasoning text captured from DeepSeek response and returned"
      contains: "reasoning_summary"
    - path: "src/lib/engine/aggregator.ts"
      provides: "Reasoning field wired from DeepSeek output into PredictionResult"
      contains: "reasoning_summary"
  key_links:
    - from: "src/lib/engine/deepseek.ts"
      to: "src/lib/engine/aggregator.ts"
      via: "reasoning_summary field in DeepSeekReasoning type"
      pattern: "reasoning_summary"
    - from: "src/lib/engine/aggregator.ts"
      to: "PredictionResult.reasoning"
      via: "assignment from deepseek.reasoning_summary"
      pattern: 'reasoning.*reasoning_summary'
---

<objective>
Wire DeepSeek's reasoning text through to PredictionResult.reasoning, which is currently hardcoded to empty string.

Purpose: The reasoning field exists in PredictionResult and is persisted to the DB, but it contains "" because nobody wired the actual reasoning content from DeepSeek. Users and the DB should see WHY DeepSeek made its prediction.
Output: DeepSeek prompt requests a reasoning_summary field, schema validates it, aggregator wires it to PredictionResult.reasoning.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/engine/deepseek.ts
@src/lib/engine/aggregator.ts
@src/lib/engine/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reasoning_summary to DeepSeek schema and prompt</name>
  <files>src/lib/engine/deepseek.ts, src/lib/engine/types.ts</files>
  <action>
The DeepSeek prompt asks the model to reason through a 5-step framework, but the JSON output schema doesn't include any reasoning text field. `PredictionResult.reasoning` exists (defined in types.ts line ~138) but is set to `""` in aggregator.ts because there's nothing to wire.

**Approach:** Add a `reasoning_summary` field to the DeepSeek JSON output schema. This is a 2-3 sentence summary of the model's key reasoning (NOT the full CoT which is internal). This is cheaper and more reliable than extracting `reasoning_content` from the API response (which may not be available with all DeepSeek models/endpoints).

**Step 1 — Update DeepSeekResponseSchema (types.ts):**

Add `reasoning_summary` to the `DeepSeekResponseSchema` Zod object:
```typescript
export const DeepSeekResponseSchema = z.object({
  behavioral_predictions: BehavioralPredictionsSchema,
  component_scores: ComponentScoresSchema,
  suggestions: z.array(SuggestionSchema).min(1),
  warnings: z.array(z.string()).default([]),
  confidence: z.enum(["high", "medium", "low"]),
  reasoning_summary: z.string().min(10).max(500),
});
```

The `DeepSeekReasoning` type is inferred from this schema, so it automatically gets the new field.

**Step 2 — Update DeepSeek prompt (deepseek.ts):**

In the `buildDeepSeekPrompt` function, add `reasoning_summary` to the JSON output format specification (around line ~319-348). Add it after the `confidence` field:

```
  "reasoning_summary": "<2-3 sentences explaining the key factors driving your prediction. What makes this content likely/unlikely to perform well?>"
```

Also add instruction in Step 5 section (around line ~286):
After "Set confidence based on signal availability..." add:
```
Write a reasoning_summary (2-3 sentences) explaining the key factors driving your prediction — what makes this content likely or unlikely to perform well.
```

No other changes needed in deepseek.ts — the `parseDeepSeekResponse` function already uses `DeepSeekResponseSchema.safeParse()` which will validate the new field automatically.
  </action>
  <verify>
1. `grep -n 'reasoning_summary' src/lib/engine/types.ts` shows the field in DeepSeekResponseSchema
2. `grep -n 'reasoning_summary' src/lib/engine/deepseek.ts` shows the field in the prompt output format
3. `pnpm build` passes (type inference propagates automatically)
  </verify>
  <done>
DeepSeekResponseSchema includes `reasoning_summary: z.string()`. The prompt instructs DeepSeek to provide a 2-3 sentence reasoning summary. The `DeepSeekReasoning` type automatically includes the field via Zod inference.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire reasoning_summary into PredictionResult.reasoning</name>
  <files>src/lib/engine/aggregator.ts</files>
  <action>
In `aggregateScores()` (aggregator.ts), line ~365 hardcodes:
```typescript
reasoning: "", // DeepSeek reasoning text — not exposed in current schema
```

Now that `DeepSeekReasoning` has `reasoning_summary`, wire it through:

Replace line ~365:
```typescript
reasoning: "", // DeepSeek reasoning text — not exposed in current schema
```
with:
```typescript
reasoning: deepseek?.reasoning_summary ?? "",
```

This reads `reasoning_summary` from the parsed DeepSeek response (which is already in `deepseek` as `deepseekResult?.reasoning`). If DeepSeek was null (circuit breaker open), it falls back to empty string.

Remove the old comment since the field is now properly wired.
  </action>
  <verify>
1. `grep -n 'reasoning_summary' src/lib/engine/aggregator.ts` shows the wiring
2. `grep -v '""' src/lib/engine/aggregator.ts | grep 'reasoning:'` confirms it's not hardcoded empty
3. `pnpm build` passes
  </verify>
  <done>
PredictionResult.reasoning contains DeepSeek's reasoning_summary text (2-3 sentences explaining the prediction). Falls back to empty string only when DeepSeek is unavailable (circuit breaker open).
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` completes with zero errors
2. `grep -n 'reasoning_summary' src/lib/engine/types.ts src/lib/engine/deepseek.ts src/lib/engine/aggregator.ts` shows the field in all three files
3. `grep 'reasoning:' src/lib/engine/aggregator.ts` shows `deepseek?.reasoning_summary` not `""`
</verification>

<success_criteria>
- DeepSeekResponseSchema includes reasoning_summary field
- DeepSeek prompt requests reasoning_summary in output format
- PredictionResult.reasoning is wired to deepseek.reasoning_summary
- Fallback to "" only when DeepSeek is null (circuit breaker)
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/13-engine-bug-fixes-wiring/13-02-SUMMARY.md`
</output>
