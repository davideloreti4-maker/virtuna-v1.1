---
phase: 08-results-card-breakdown-ui
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - src/components/app/simulation/results-panel.tsx
  - src/components/app/simulation/loading-phases.tsx
  - src/stores/test-store.ts
  - src/app/(app)/dashboard/dashboard-client.tsx
  - src/components/app/test-creation-flow.tsx
  - src/components/app/index.ts
  - src/components/app/test-history-item.tsx
autonomous: true

must_haves:
  truths:
    - "ResultsPanel renders hero score, factor breakdown, behavioral predictions, suggestions, persona reactions, and warnings"
    - "VariantsSection and ThemesSection are removed from results display"
    - "Loading skeleton phases match v2 pipeline stages (analyzing, scoring) not v1 (analyzing, matching, simulating, generating)"
    - "Dashboard and TestCreationFlow pass PredictionResult directly to ResultsPanel instead of mapping to TestResult"
    - "Persona reactions show as horizontal card grid with initials avatar, quote, and sentiment accent"
    - "Warnings display as subtle alert banners above results content"
  artifacts:
    - path: "src/components/app/simulation/results-panel.tsx"
      provides: "V2 results panel consuming PredictionResult directly"
      contains: "PredictionResult"
    - path: "src/components/app/simulation/loading-phases.tsx"
      provides: "V2 loading skeletons matching new pipeline stages"
      contains: "analyzing.*scoring"
    - path: "src/stores/test-store.ts"
      provides: "V2 SimulationPhase type and cleaned up mapPredictionToTestResult"
      contains: "analyzing.*reasoning.*scoring"
    - path: "src/app/(app)/dashboard/dashboard-client.tsx"
      provides: "Dashboard wired to PredictionResult directly"
      contains: "analyzeMutation.data"
  key_links:
    - from: "src/components/app/simulation/results-panel.tsx"
      to: "PredictionResult"
      via: "result prop typed as PredictionResult"
      pattern: "import.*PredictionResult.*engine/types"
    - from: "src/app/(app)/dashboard/dashboard-client.tsx"
      to: "src/components/app/simulation/results-panel.tsx"
      via: "passes analyzeMutation.data to ResultsPanel"
      pattern: "ResultsPanel.*result.*analyzeMutation"
    - from: "src/stores/test-store.ts"
      to: "use-analyze.ts"
      via: "SimulationPhase matches AnalysisPhase"
      pattern: "analyzing.*reasoning.*scoring"
---

<objective>
Wire all v2 results components into ResultsPanel, update loading states to match v2 pipeline, add persona reactions, remove dead v1 sections, and connect dashboard/flow to PredictionResult directly.

Purpose: Complete the v2 results display by assembling all new components (from Plans 01+02), adding persona reactions and warnings, updating the loading skeleton to match v2 SSE phases, and eliminating the v1 TestResult compatibility shim.

Output: Full v2 results flow from SSE loading through results display, with dead v1 code removed.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-results-card-breakdown-ui/08-CONTEXT.md
@.planning/phases/08-results-card-breakdown-ui/08-01-SUMMARY.md
@.planning/phases/08-results-card-breakdown-ui/08-02-SUMMARY.md
@src/lib/engine/types.ts
@src/components/app/simulation/results-panel.tsx
@src/components/app/simulation/loading-phases.tsx
@src/stores/test-store.ts
@src/app/(app)/dashboard/dashboard-client.tsx
@src/components/app/test-creation-flow.tsx
@src/components/app/index.ts
@src/components/app/test-history-item.tsx
@src/hooks/queries/use-analyze.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite ResultsPanel for v2 with persona reactions and warnings</name>
  <files>
    src/components/app/simulation/results-panel.tsx
    src/components/app/index.ts
  </files>
  <action>
Rewrite ResultsPanel to consume `PredictionResult` directly instead of `TestResult`.

**Props interface:**
```typescript
interface ResultsPanelProps {
  result: PredictionResult;  // from @/lib/engine/types
  onRunAnother: () => void;
}
```

**Layout (top to bottom):**

1. **Sticky header** (keep existing pattern): "Results" label + ShareButton
   - But remove `resultId` from ShareButton (pass no props or make it optional) — v2 results don't have a string ID yet

2. **Warnings section** (new, per UI-09: "Warnings display as subtle alert banners"):
   - Only render if `result.warnings.length > 0`
   - Map each warning to a div with: `bg-warning/10 border border-warning/20 rounded-lg px-3 py-2`
   - Warning icon (AlertTriangle from lucide-react) + warning text in Text size="sm"

3. **ImpactScore** (from Plan 01):
   - `<ImpactScore overall_score={result.overall_score} confidence_label={result.confidence_label} />`

4. **FactorBreakdown** (from Plan 01, exported as `FactorBreakdown` from attention-breakdown.tsx):
   - `<FactorBreakdown factors={result.factors} />`

5. **BehavioralPredictions** (from Plan 02):
   - `<BehavioralPredictions predictions={result.behavioral_predictions} />`

6. **SuggestionsSection** (from Plan 02, exported as `SuggestionsSection` from insights-section.tsx):
   - `<SuggestionsSection suggestions={result.suggestions} />`

7. **Persona Reactions** (inline in ResultsPanel — no separate component needed for 3-4 cards):
   - Section header: "Audience Reactions" with Info icon
   - NOTE: v2 PredictionResult does NOT have persona_reactions field (it was removed from DeepSeek). For now, render a placeholder section that will be populated when personas are re-added in a lightweight format. Create a simple "Coming soon" text in a GlassCard.
   - Actually — check: the DeepSeek schema removed persona_reactions. The plan says "Persona reactions show names, quotes, sentiment, and wouldShare badge." Since the API doesn't return this data yet, add the section structure with a fallback message: "Persona reactions will appear here once the engine generates them." Style it as a muted GlassCard. This keeps the UI ready for when persona data is added.

8. **Remove v1 sections:**
   - Remove `VariantsSection` import and rendering (UI-10: "Variants section removed")
   - Remove `ThemesSection` import and rendering (UI-10: "Themes section removed")
   - Remove `AttentionBreakdown` import (replaced by FactorBreakdown)

9. **Sticky footer** (keep existing pattern): "Run another test" button

**Import updates:**
- Import `PredictionResult` from `@/lib/engine/types`
- Import `ImpactScore` from `./impact-score`
- Import `FactorBreakdown` from `./attention-breakdown`
- Import `BehavioralPredictions` from `./behavioral-predictions`
- Import `SuggestionsSection` from `./insights-section`
- Import `AlertTriangle` from `lucide-react`
- Remove imports: `TestResult` from `@/types/test`, `AttentionBreakdown`, `VariantsSection`, `ThemesSection`

**Update index.ts exports:**
- Add `export { BehavioralPredictions } from "./simulation/behavioral-predictions";`
- Add `export { FactorBreakdown } from "./simulation/attention-breakdown";`
- Add `export { SuggestionsSection } from "./simulation/insights-section";`
- Keep backward-compat exports but update names where changed
- Remove `VariantsSection` and `ThemesSection` exports
  </action>
  <verify>Run `npx tsc --noEmit --pretty src/components/app/simulation/results-panel.tsx 2>&1 | head -20` — no errors in this file</verify>
  <done>ResultsPanel renders v2 results: hero score, factors, behavioral predictions, suggestions, persona placeholder, warnings</done>
</task>

<task type="auto">
  <name>Task 2: Update loading phases, test-store, dashboard, and flow for v2</name>
  <files>
    src/components/app/simulation/loading-phases.tsx
    src/stores/test-store.ts
    src/app/(app)/dashboard/dashboard-client.tsx
    src/components/app/test-creation-flow.tsx
    src/components/app/test-history-item.tsx
  </files>
  <action>
**1. Update test-store.ts SimulationPhase and remove v1 mapping:**

Update `SimulationPhase` to match v2 SSE phases from `use-analyze.ts`:
```typescript
export type SimulationPhase = 'analyzing' | 'reasoning' | 'scoring';
```

Update `PHASE_MESSAGES`:
```typescript
export const PHASE_MESSAGES: Record<SimulationPhase, string> = {
  analyzing: 'Analyzing content with AI models...',
  reasoning: 'Processing behavioral predictions...',
  scoring: 'Calculating final scores and insights...',
};
```

Remove `mapPredictionToTestResult` function entirely (it references dead v1 fields: persona_reactions, variants, conversation_themes).

Remove `deriveAttention` function (references persona_reactions which don't exist in v2).

Remove `getImpactLabel` export (moved inline to ImpactScore in Plan 01).

Clean up imports: remove `TestType`, `TestResult`, `ImpactLabel` from `@/types/test` if no longer used. Keep `TestStatus` and `TestType` if still referenced by the store interface. Remove `PredictionResult` import if mapPredictionToTestResult is deleted.

**2. Update loading-phases.tsx to v2 skeleton structure:**

Update `PHASE_ORDER` to match v2:
```typescript
const PHASE_ORDER: SimulationPhase[] = ['analyzing', 'reasoning', 'scoring'];
```

Replace skeleton sections to mirror v2 results layout:
- Phase `'analyzing'`: ImpactScoreSkeleton (keep existing) + FactorBreakdownSkeleton (replace AttentionSkeleton: show 5 rows of label+progress bar skeletons)
- Phase `'reasoning'`: BehavioralPredictionsSkeleton (4 stat card skeletons in 2x2 grid) — replaces VariantsSkeleton
- Phase `'scoring'`: SuggestionsSkeleton (3 text block skeletons) — replaces InsightsThemesSkeleton (remove Themes skeleton entirely)

Update `SECTIONS` array to map new phases to new skeletons.

**3. Update dashboard-client.tsx to pass PredictionResult directly:**

- Remove `mapPredictionToTestResult` import from test-store
- Remove `useMemo` that creates `currentResult` via `mapPredictionToTestResult`
- Remove `setCurrentResult` from destructured test-store (or keep if other code uses it)
- Remove `submittedContent` state and `setSubmittedContent` (no longer needed for mapping)
- Pass `analyzeMutation.data` directly to `ResultsPanel`:
  ```tsx
  <ResultsPanel
    result={analyzeMutation.data}
    onRunAnother={handleRunAnother}
  />
  ```
- Update the condition: `currentStatus === "viewing-results" && analyzeMutation.data`
- Remove `useEffect` that syncs derived result to store
- Remove `currentResult` from store destructuring if no longer needed
- Keep `handleContentSubmit` — it still builds the AnalysisInput payload correctly

**4. Update test-creation-flow.tsx similarly:**

- Remove `mapPredictionToTestResult` import
- Remove `useMemo` creating `currentResult`
- Remove `submittedContent` state
- Pass `analyzeMutation.data` directly to `ResultsPanel`
- Update condition to check `analyzeMutation.data` instead of `currentResult`

**5. Update test-history-item.tsx for v2 (UI-08):**

- The current TestHistoryItem displays just a text title. For v2, add support for showing a video thumbnail when the analysis was a video analysis.
- Add optional `inputMode` and `thumbnailUrl` props:
  ```typescript
  interface TestHistoryItemProps {
    test: TestResult;
    isActive: boolean;
    onClick: () => void;
    onDelete: () => void;
    inputMode?: string;      // "text" | "tiktok_url" | "video_upload"
    thumbnailUrl?: string;    // video thumbnail URL if available
  }
  ```
- When `inputMode === "video_upload" && thumbnailUrl`, show a small 32x32 rounded thumbnail image before the text title
- Otherwise keep existing behavior
- This is prep for UI-08 ("Analysis history shows video thumbnails") — actual thumbnail data will come from the history API later
  </action>
  <verify>Run `npx tsc --noEmit 2>&1 | tail -5` — check for zero errors or only pre-existing errors unrelated to Phase 8 changes</verify>
  <done>Loading phases match v2 pipeline stages, dashboard and flow pass PredictionResult directly, v1 mapping code removed, test-history-item supports optional thumbnail</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` compiles with zero new errors
- ResultsPanel imports PredictionResult (not TestResult)
- Loading phases show 3 stages: analyzing, reasoning, scoring
- VariantsSection and ThemesSection are not rendered or exported
- mapPredictionToTestResult is deleted from test-store
- Dashboard passes analyzeMutation.data directly to ResultsPanel
- Warnings render as alert banners when present
</verification>

<success_criteria>
1. Full v2 results flow works: loading skeleton → results panel with all sections
2. VariantsSection and ThemesSection are removed (UI-10)
3. SSE loading phases match v2 pipeline stages (UI-07)
4. Dashboard and TestCreationFlow use PredictionResult directly (no TestResult shim)
5. Warnings display as subtle alert banners (UI-09)
6. Test history item supports optional video thumbnail (UI-08 prep)
</success_criteria>

<output>
After completion, create `.planning/phases/08-results-card-breakdown-ui/08-03-SUMMARY.md`
</output>
