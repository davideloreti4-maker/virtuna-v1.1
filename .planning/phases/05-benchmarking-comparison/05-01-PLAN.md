---
phase: 05-benchmarking-comparison
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(app)/competitors/compare/page.tsx
  - src/app/(app)/competitors/compare/loading.tsx
  - src/app/(app)/competitors/compare/comparison-client.tsx
  - src/components/competitors/comparison/comparison-selector.tsx
  - src/components/competitors/comparison/comparison-metric-card.tsx
  - src/components/competitors/comparison/comparison-bar-chart.tsx
  - src/components/competitors/comparison/comparison-growth-chart.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /competitors/compare and select two competitors from dropdown selectors to see side-by-side metrics"
    - "Changing competitor selection updates the URL searchParams and triggers server re-render with fresh data"
    - "User can select 'Compare with me' to benchmark their own TikTok stats against any competitor"
    - "Comparison view shows parallel columns for followers, likes, videos, engagement rate, growth rate, posting frequency, and avg views"
    - "Grouped bar chart visualizes the metric comparison and dual-line growth chart overlays follower trends"
  artifacts:
    - path: "src/app/(app)/competitors/compare/page.tsx"
      provides: "Server component fetching two competitors' data in parallel via searchParams"
      exports: ["default"]
    - path: "src/app/(app)/competitors/compare/comparison-client.tsx"
      provides: "Client shell with selector dropdowns and comparison view"
      exports: ["ComparisonClient"]
    - path: "src/components/competitors/comparison/comparison-selector.tsx"
      provides: "Dropdown selector for picking a competitor or 'Compare with me'"
      exports: ["ComparisonSelector"]
    - path: "src/components/competitors/comparison/comparison-metric-card.tsx"
      provides: "Side-by-side metric card with winner highlighting"
      exports: ["ComparisonMetricCard"]
    - path: "src/components/competitors/comparison/comparison-bar-chart.tsx"
      provides: "Grouped Recharts BarChart comparing metrics side by side"
      exports: ["ComparisonBarChart"]
    - path: "src/components/competitors/comparison/comparison-growth-chart.tsx"
      provides: "Dual-line Recharts AreaChart overlaying follower growth trends"
      exports: ["ComparisonGrowthChart"]
  key_links:
    - from: "src/app/(app)/competitors/compare/page.tsx"
      to: "competitor_profiles + competitor_snapshots + competitor_videos"
      via: "Supabase queries with Promise.all for parallel fetch"
      pattern: "Promise\\.all"
    - from: "src/app/(app)/competitors/compare/page.tsx"
      to: "src/app/(app)/competitors/compare/comparison-client.tsx"
      via: "Server component passes pre-computed props to ComparisonClient"
      pattern: "<ComparisonClient"
    - from: "src/app/(app)/competitors/compare/comparison-client.tsx"
      to: "URL searchParams"
      via: "useRouter().push() with updated searchParams on selector change"
      pattern: "router\\.push"
    - from: "src/app/(app)/competitors/compare/page.tsx"
      to: "creator_profiles.tiktok_handle"
      via: "Reading user's own handle for self-benchmarking option"
      pattern: "creator_profiles"
---

<objective>
Build the side-by-side comparison page where users select two competitors (or themselves vs. a competitor) and see parallel metric columns, a grouped bar chart, and a dual-line growth overlay chart.

Purpose: Fulfills BENCH-01 (2-competitor comparison) and BENCH-02 (self-benchmarking) requirements. Users gain actionable insight by seeing how two creators stack up across all key metrics.

Output: 7 new files -- comparison route (server + client + loading), 4 comparison UI components.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-benchmarking-comparison/05-RESEARCH.md

@src/app/(app)/competitors/[handle]/page.tsx
@src/app/(app)/competitors/page.tsx
@src/lib/competitors-utils.ts
@src/components/competitors/charts/follower-growth-chart.tsx
@src/components/competitors/charts/chart-tooltip.tsx
@src/components/competitors/charts/engagement-bar-chart.tsx
@src/app/actions/competitors/add.ts
@src/types/database.types.ts
@src/components/ui/select.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Comparison page server component and client shell</name>
  <files>
    src/app/(app)/competitors/compare/page.tsx
    src/app/(app)/competitors/compare/loading.tsx
    src/app/(app)/competitors/compare/comparison-client.tsx
    src/components/competitors/comparison/comparison-selector.tsx
  </files>
  <action>
**Create the comparison route at `/competitors/compare`.**

1. **`src/app/(app)/competitors/compare/page.tsx`** (server component):
   - Props: `searchParams: Promise<{ a?: string; b?: string }>` (same async pattern as `[handle]/page.tsx`)
   - Auth check: `createClient()` -> `getUser()` -> return null if not authenticated
   - Fetch the user's TikTok handle from `creator_profiles` for the self-benchmarking option: `supabase.from("creator_profiles").select("tiktok_handle").eq("id", user.id).single()`
   - Fetch all user's tracked competitors for the selector dropdowns: query `user_competitors` joined with `competitor_profiles` (same query as `competitors/page.tsx` but lighter -- just `id, tiktok_handle, display_name, avatar_url`)
   - If `a` or `b` searchParams are present, fetch full competitor data for each using a `fetchCompetitorData` helper function (defined in this file):
     - Look up `competitor_profiles` by `tiktok_handle` (handle from searchParam)
     - Verify `user_competitors` junction exists for this user (same auth pattern as `[handle]/page.tsx`)
     - Parallel fetch `competitor_snapshots` (ascending date) + `competitor_videos` (descending posted_at)
     - Return `{ profile, snapshots, videos }` or `null` if not found/not tracked
   - **Self-benchmarking flow:** If a searchParam value equals `"me"`, read the user's `tiktok_handle` from `creator_profiles`. Then:
     - Check if that handle already exists in `competitor_profiles`
     - If it does, check if a `user_competitors` junction row exists for this user. If not, create one with the authenticated `supabase` client (same pattern as `add.ts` line 131 -- uses the RLS-scoped client, NOT `createServiceClient`)
     - If it does NOT exist in `competitor_profiles`, call the `addCompetitor` server action (import from `@/app/actions/competitors/add`) with the user's handle -- this scrapes, upserts profile/snapshot/videos, and creates the junction row
     - After ensuring the handle is tracked, fetch data using the same `fetchCompetitorData` helper
   - Pre-compute comparison metrics server-side for both profiles using existing utility functions: `computeGrowthVelocity`, `computeEngagementRate`, `computePostingCadence`, `computeAverageViews` from `@/lib/competitors-utils`
   - Define a `ComparisonData` type: `{ handle: string; displayName: string | null; avatarUrl: string | null; followers: number | null; likes: number | null; videos: number | null; engagementRate: number | null; growthVelocity: { percentage: number; direction: "up" | "down" | "flat" } | null; postingCadence: { postsPerWeek: number; postsPerMonth: number } | null; avgViews: number | null; snapshotTimeSeries: { date: string; followers: number }[]; }`
   - Build `ComparisonData` objects for both sides from fetched data
   - Build a list of competitor options for selectors: `{ handle: string; displayName: string | null; avatarUrl: string | null }[]`
   - Render `<ComparisonClient dataA={...} dataB={...} competitors={...} selectedA={a} selectedB={b} userHandle={userHandle} />`
   - Export metadata: `{ title: "Compare | Competitors | Virtuna" }`

2. **`src/app/(app)/competitors/compare/loading.tsx`**:
   - Simple skeleton: a header bar (h-8 skeleton), two selector skeletons (h-10 each), and a 2-column grid of 6 metric card skeletons (rounded-xl, h-24 each, bg-white/[0.03] animate-pulse)

3. **`src/app/(app)/competitors/compare/comparison-client.tsx`** ("use client"):
   - Props: `dataA: ComparisonData | null`, `dataB: ComparisonData | null`, `competitors: { handle: string; displayName: string | null; avatarUrl: string | null }[]`, `selectedA?: string`, `selectedB?: string`, `userHandle: string | null`
   - Import `useRouter` from `next/navigation`
   - Two `ComparisonSelector` components side-by-side for picking competitor A and B
   - On selector change: `router.push(\`/competitors/compare?a=\${encodeURIComponent(newA)}&b=\${encodeURIComponent(newB)}\`)` -- this triggers server re-render
   - When both dataA and dataB are present, render:
     - A grid of `ComparisonMetricCard` components for: Followers, Total Likes, Videos, Engagement Rate, Growth Rate, Posting Frequency, Avg Views
     - A `ComparisonBarChart` with the key numeric metrics
     - A `ComparisonGrowthChart` overlaying both time series
   - When only one or zero sides selected, show a centered prompt: "Select two competitors to compare"
   - Layout: full width, `space-y-6`, metric cards in `grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4`

4. **`src/components/competitors/comparison/comparison-selector.tsx`** ("use client"):
   - Props: `competitors: { handle: string; displayName: string | null; avatarUrl: string | null }[]`, `value: string | undefined`, `onChange: (handle: string) => void`, `label: string` (e.g., "Competitor A"), `showSelfOption: boolean`, `selfHandle: string | null`
   - Render a `<select>` element styled with Raycast input conventions: `bg-white/[0.05] border border-white/[0.05] rounded-lg h-[42px] px-3 text-sm text-foreground`
   - Default empty option: "Select competitor..."
   - If `showSelfOption && selfHandle`: add an option at the top with value `"me"` and label `"You (@{selfHandle})"`
   - Map competitor list to `<option>` elements with `value={handle}` and display text `@{handle}` (with displayName in parens if present)
   - On change, call `onChange` with the new value
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors
- Navigate to `/competitors/compare` -- page renders with two selector dropdowns and empty state prompt
- Select two competitors via URL params (`?a=handle1&b=handle2`) -- server component fetches and renders data
  </verify>
  <done>
- Comparison page route exists at `/competitors/compare` with working server-side data fetching
- Two selector dropdowns render the user's tracked competitors
- Selecting competitors updates URL searchParams and triggers server re-render
- "Compare with me" option appears when user has a TikTok handle and triggers self-benchmarking data flow
- Pre-computed ComparisonData objects passed to client component
  </done>
</task>

<task type="auto">
  <name>Task 2: Comparison metric cards and chart components</name>
  <files>
    src/components/competitors/comparison/comparison-metric-card.tsx
    src/components/competitors/comparison/comparison-bar-chart.tsx
    src/components/competitors/comparison/comparison-growth-chart.tsx
  </files>
  <action>
**Create the visual comparison components.**

1. **`src/components/competitors/comparison/comparison-metric-card.tsx`** ("use client"):
   - Props: `label: string`, `valueA: string`, `valueB: string`, `rawA: number`, `rawB: number`, `handleA: string`, `handleB: string`
   - Renders a card with `border border-white/[0.06] rounded-xl p-4` (matches Raycast card convention, 12px radius)
   - Label at top: `text-xs text-foreground-muted mb-3`
   - Two-column grid (`grid grid-cols-2 gap-4`) with:
     - Left column: valueA in `text-lg font-semibold`, handleA below in `text-xs text-foreground-muted truncate` prefixed with `@`
     - Right column: valueB right-aligned, same styling, handleB below
   - Winner highlighting: the side with the higher `raw` value gets `text-accent` color class; loser stays `text-foreground`. If equal, both use `text-foreground`
   - Import `cn` from `@/lib/utils` for conditional class merging

2. **`src/components/competitors/comparison/comparison-bar-chart.tsx`** ("use client"):
   - Props: `dataA: ComparisonData`, `dataB: ComparisonData` (define `ComparisonData` type locally in this file -- do NOT import from `app/` into `components/` as that violates layering conventions)
   - Actually, to keep things simple, use a flat props interface:
     - `data: { metric: string; valueA: number; valueB: number }[]`
     - `handleA: string`, `handleB: string`
   - Uses Recharts `BarChart` with grouped bars (two `<Bar>` elements, NO `stackId`):
     - `<Bar dataKey="valueA" fill="var(--color-accent)" isAnimationActive={false} radius={[4, 4, 0, 0]} />`
     - `<Bar dataKey="valueB" fill="#82ca9d" isAnimationActive={false} radius={[4, 4, 0, 0]} />`
   - Include `<CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.06)" vertical={false} />`
   - `<XAxis dataKey="metric" stroke="var(--color-foreground-muted)" fontSize={12} tickLine={false} axisLine={false} />`
   - `<YAxis stroke="var(--color-foreground-muted)" fontSize={12} tickLine={false} axisLine={false} tickFormatter={formatCount} />`
   - `<Tooltip content={<ChartTooltip formatter={formatCount} />} />`
   - Legend at bottom: two colored dots with handle labels (coral for A, green for B), done as a simple flex row below the chart (not Recharts Legend)
   - Wrapped in `<ResponsiveContainer width="100%" height={300}>`
   - In the `comparison-client.tsx`, build the `data` array from the two ComparisonData objects: metrics to include are Followers, Likes, Videos, Avg Views (skip percentage-based metrics like engagement rate since they're on a different scale)
   - Wrap in a card container: `border border-white/[0.06] rounded-xl p-4` with section title "Metric Comparison" in `text-sm font-medium text-foreground mb-4`

3. **`src/components/competitors/comparison/comparison-growth-chart.tsx`** ("use client"):
   - Props: `seriesA: { date: string; followers: number }[]`, `seriesB: { date: string; followers: number }[]`, `handleA: string`, `handleB: string`
   - Merge both time series into a unified data array keyed by date: `{ date: string; followersA: number | null; followersB: number | null }[]`. Use a Map to merge by date. Dates present in only one series have null for the other.
   - Sort merged array by date ascending.
   - Recharts `AreaChart` with two `<Area>` elements:
     - Area A: `dataKey="followersA"`, `stroke="var(--color-accent)"`, `fill="url(#compGradA)"`, coral gradient
     - Area B: `dataKey="followersB"`, `stroke="#82ca9d"`, `fill="url(#compGradB)"`, green gradient
   - Define two `<linearGradient>` elements in `<defs>` (same pattern as existing `FollowerGrowthChart`), using unique IDs `compGradA` and `compGradB`
   - Same axis/grid styling as existing charts: `CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.06)" vertical={false}`, etc.
   - `<Tooltip content={<ChartTooltip formatter={formatCount} />} />`
   - `connectNulls={true}` on both Area elements so gaps in one series don't break the line
   - Legend: simple flex row with colored dots and handle labels (same as bar chart)
   - Wrapped in card container with title "Growth Comparison"
   - Show "Not enough data" centered message if both series have fewer than 2 data points
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors
- Navigate to `/competitors/compare?a=handle1&b=handle2` with two valid tracked competitors
- Verify: 7 metric cards render with values and winner highlighting
- Verify: grouped bar chart shows side-by-side bars for each metric
- Verify: growth chart overlays two area lines with distinct colors
  </verify>
  <done>
- ComparisonMetricCard renders side-by-side values with accent color on the winner
- ComparisonBarChart shows grouped (not stacked) bars for major metrics
- ComparisonGrowthChart overlays two follower time-series with coral and green fills
- All components follow Raycast dark theme: 6% borders, 12px radius, muted labels
- Charts reuse existing ChartTooltip and formatCount
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- full project compiles
2. Navigate to `/competitors/compare` -- page loads with selectors and empty state
3. Pick two competitors -- URL updates, data fetches, metric cards + charts render
4. Select "Compare with me" -- user's handle is scraped/fetched and comparison renders same as competitor-vs-competitor
5. Verify URL is shareable: copy `/competitors/compare?a=handle1&b=handle2` into a new tab -- same view renders
6. Check responsive: metric card grid adapts from 4 cols (lg) to 2 cols (sm)
</verification>

<success_criteria>
- Side-by-side comparison page works at `/competitors/compare` with searchParams-driven selection
- Self-benchmarking option appears and works (scrapes user handle on first use, fetches same data model)
- 7 metric comparison cards display with winner highlighting
- Grouped bar chart and dual-line growth chart render correctly
- All data fetched server-side, charts receive pre-computed props
</success_criteria>

<output>
After completion, create `.planning/phases/05-benchmarking-comparison/05-01-SUMMARY.md`
</output>
