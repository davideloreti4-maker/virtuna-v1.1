---
phase: 05-benchmarking-comparison
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/competitors/competitor-table.tsx
  - src/app/(app)/competitors/competitors-client.tsx
autonomous: true

must_haves:
  truths:
    - "User can click any column header in the table view to sort competitors by that metric"
    - "Clicking the same column header toggles between ascending and descending sort"
    - "Active sort column shows a directional arrow (ChevronUp/ChevronDown), inactive columns show a subtle ArrowUpDown icon"
    - "Default sort is by followers descending"
    - "Derived metrics (engagement rate, growth rate, posting cadence) are pre-computed once and sorted on pre-computed values"
    - "User sees a 'Compare' link in the dashboard header that navigates to /competitors/compare"
  artifacts:
    - path: "src/components/competitors/competitor-table.tsx"
      provides: "Sortable leaderboard table with clickable column headers"
      exports: ["CompetitorTable"]
    - path: "src/app/(app)/competitors/competitors-client.tsx"
      provides: "Dashboard with Compare navigation link"
      exports: ["CompetitorsClient"]
  key_links:
    - from: "src/components/competitors/competitor-table.tsx"
      to: "src/lib/competitors-utils.ts"
      via: "computeGrowthVelocity, computeEngagementRate, computePostingCadence imported for pre-computation"
      pattern: "import.*computeGrowthVelocity.*computeEngagementRate.*computePostingCadence"
    - from: "src/app/(app)/competitors/competitors-client.tsx"
      to: "/competitors/compare"
      via: "Link component in page header"
      pattern: "href.*competitors/compare"
---

<objective>
Add sortable column headers to the existing CompetitorTable so users can rank competitors by any metric, and add a "Compare" navigation link to the dashboard header for accessing the comparison view.

Purpose: Fulfills BENCH-03 (sortable leaderboard). The sorting transforms a static table into an interactive ranking tool. The compare link connects the dashboard to the new comparison page (from 05-01).

Output: 2 modified files -- enhanced table with sorting + dashboard header with compare link.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/components/competitors/competitor-table.tsx
@src/app/(app)/competitors/competitors-client.tsx
@src/lib/competitors-utils.ts
@src/components/competitors/competitor-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sortable column headers for CompetitorTable</name>
  <files>src/components/competitors/competitor-table.tsx</files>
  <action>
**Enhance the existing `CompetitorTable` with client-side sorting.**

The current table has static `<th>` elements. Replace them with interactive sortable headers.

1. **Define sort types** at the top of the file (below imports):
   - `type SortKey = "followers" | "likes" | "videos" | "engagement" | "growth" | "cadence";`
   - `type SortDir = "asc" | "desc";`
   - `interface SortState { key: SortKey; dir: SortDir; }`

2. **Add sort state** using `useState`:
   - `const [sort, setSort] = useState<SortState>({ key: "followers", dir: "desc" });`
   - Import `useState` and `useMemo` from React

3. **Pre-compute derived metrics** using `useMemo` to avoid recomputing on every sort toggle:
   - Create an `enrichedCompetitors` array that maps each `CompetitorCardData` to an object with all raw metric values pre-computed:
     ```
     { ...competitor, _followers: competitor.follower_count ?? 0, _likes: competitor.heart_count ?? 0, _videos: competitor.video_count ?? 0, _engagement: computeEngagementRate(competitor.videos) ?? 0, _growth: computeGrowthVelocity(competitor.snapshots)?.percentage ?? 0, _cadence: computePostingCadence(competitor.videos)?.postsPerWeek ?? 0 }
     ```
   - Depend on `[competitors]` (not on sort state -- the enrichment is sort-independent)
   - Import `computePostingCadence` from `@/lib/competitors-utils` (not currently imported)

4. **Sort the enriched array** in a separate `useMemo` depending on `[enrichedCompetitors, sort]`:
   - `const sortedCompetitors = useMemo(() => { const sorted = [...enrichedCompetitors].sort((a, b) => { const valA = a[\`_${sort.key}\`]; const valB = b[\`_${sort.key}\`]; return sort.dir === "asc" ? valA - valB : valB - valA; }); return sorted; }, [enrichedCompetitors, sort]);`
   - Use a lookup map or switch for the key -> `_key` mapping to keep it type-safe:
     ```
     const keyMap: Record<SortKey, string> = { followers: "_followers", likes: "_likes", videos: "_videos", engagement: "_engagement", growth: "_growth", cadence: "_cadence" };
     ```

5. **Create a `SortableHeader` inline component** (or define above the main component):
   - Props: `label: string`, `sortKey: SortKey`, `align?: "left" | "right"` (default "right")
   - Reads `sort` state from closure
   - On click: if already active key, toggle direction; if different key, set to desc
     ```
     onClick={() => setSort(prev => prev.key === sortKey ? { key: sortKey, dir: prev.dir === "desc" ? "asc" : "desc" } : { key: sortKey, dir: "desc" })
     ```
   - Show icon: if active, `ChevronDown` (desc) or `ChevronUp` (asc) at `size={12}`; if inactive, `ArrowUpDown` at `size={12}` with `opacity-40`
   - Import `{ ChevronDown, ChevronUp, ArrowUpDown }` from `lucide-react`
   - Styling: same as existing `<th>` but add `cursor-pointer select-none transition-colors hover:text-foreground`

6. **Replace static `<th>` elements** with `SortableHeader`:
   - Creator column stays non-sortable (keep as-is, text-left)
   - Followers: `<SortableHeader label="Followers" sortKey="followers" />`
   - Likes: `<SortableHeader label="Likes" sortKey="likes" />`
   - Videos: `<SortableHeader label="Videos" sortKey="videos" />`
   - Eng. Rate: `<SortableHeader label="Eng. Rate" sortKey="engagement" />`
   - Growth: `<SortableHeader label="Growth" sortKey="growth" align="left" />`
   - Add a new **Cadence** column before Trend: `<SortableHeader label="Cadence" sortKey="cadence" />`
   - Trend column stays non-sortable (keep as-is)

7. **Update the table body** to use `sortedCompetitors` instead of `competitors`:
   - Map over `sortedCompetitors` instead of `competitors`
   - For each row, use the pre-computed values for display:
     - Engagement rate: `s._engagement > 0 ? \`${s._engagement}%\` : "--"`
     - Growth: use the already-computed `computeGrowthVelocity` result from the original competitor (still call it in the row for the GrowthDelta component display, since it needs the full object, not just percentage)
     - **Add the Cadence cell**: display `s._cadence > 0 ? \`${s._cadence}/wk\` : "--"` in a new `<td>` with `text-right text-foreground` styling
   - Keep all other row cells unchanged (Creator, Followers count, Likes count, Videos count, Sparkline)
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors
- Render the table view on `/competitors` -- all columns visible including new Cadence column
- Click "Followers" header -- sorts descending (default). Click again -- sorts ascending. Arrow icon updates accordingly.
- Click "Eng. Rate" header -- table re-sorts by engagement rate descending
- Click "Growth" header -- table re-sorts by growth percentage
- Click "Cadence" header -- table re-sorts by posting cadence
  </verify>
  <done>
- All 6 metric columns are sortable with click-to-toggle direction
- Active sort column shows ChevronDown/ChevronUp; inactive columns show subtle ArrowUpDown
- Derived metrics (engagement, growth, cadence) are pre-computed once in useMemo, not recomputed per sort
- New Cadence column displays posts/week for each competitor
- Default sort is followers descending
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Compare link to dashboard header</name>
  <files>src/app/(app)/competitors/competitors-client.tsx</files>
  <action>
**Add a "Compare" navigation link in the competitors dashboard page header.**

1. Import `Link` from `next/link` and `{ ArrowsLeftRight }` from `@phosphor-icons/react/dist/ssr` (or use `lucide-react`'s `ArrowLeftRight` icon -- check which icon library the codebase uses more consistently; the existing competitors code uses lucide for chart icons and Phosphor for the empty state UsersThree icon; use **lucide-react**'s `ArrowLeftRight` to keep chart/table area consistent).

2. In the page header section (the `<div className="flex items-center justify-between">` that contains the h1 and Tabs), add a "Compare" link between the h1 and the Tabs:
   - Restructure: wrap the right side in a `flex items-center gap-3` container holding the Compare link and the Tabs
   - The Compare link: `<Link href="/competitors/compare" className="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-foreground-muted hover:text-foreground border border-white/[0.06] hover:bg-white/[0.02] rounded-lg transition-colors"><ArrowLeftRight size={14} /> Compare</Link>`
   - Only show the Compare link when `cards.length >= 2` (need at least 2 competitors to compare)

3. Import `ArrowLeftRight` from `lucide-react`.
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors
- Navigate to `/competitors` with 2+ competitors -- "Compare" link visible in header next to Grid/Table toggle
- Click "Compare" -- navigates to `/competitors/compare`
- With 0 or 1 competitors, the Compare link is hidden
  </verify>
  <done>
- "Compare" link appears in dashboard header when user has 2+ tracked competitors
- Clicking it navigates to the comparison page
- Link styling matches Raycast secondary button convention (6% border, 2% hover bg)
- Layout is clean: h1 left, Compare + Grid/Table toggle right
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- full project compiles
2. Navigate to `/competitors` in table view -- all column headers show sort icons
3. Click each sortable column -- data re-sorts correctly, arrow direction toggles
4. "Compare" link visible in header, navigates to `/competitors/compare`
5. Verify cadence column shows posts/week values
6. Verify sort persists within the view (not lost when toggling grid/table -- note: sort state is local to table component, resets on grid/table toggle which is expected and fine)
</verification>

<success_criteria>
- Leaderboard table supports sorting by all 6 metric columns (followers, likes, videos, engagement, growth, cadence)
- Sort direction toggles on repeated clicks with visual arrow indicator
- Derived metrics pre-computed once, not on every sort
- Compare link in dashboard header navigates to comparison page
- New Cadence column visible in table view
</success_criteria>

<output>
After completion, create `.planning/phases/05-benchmarking-comparison/05-02-SUMMARY.md`
</output>
