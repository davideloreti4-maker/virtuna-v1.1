---
phase: 01-database-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/supabase/service.ts
  - src/app/api/webhooks/whop/route.ts
  - src/app/api/cron/sync-whop/route.ts
  - supabase/seed.sql
autonomous: true

must_haves:
  truths:
    - "`createServiceClient()` exported from `src/lib/supabase/service.ts` connects using service role key and bypasses RLS"
    - "Existing Whop webhook and sync-whop cron routes import `createServiceClient` from the shared module instead of defining it locally"
    - "Rule library seed contains at least 15 rules across hook, retention, and platform categories with production-quality evaluation prompts"
    - "Seed rules include both cross-platform (null platform) and platform-specific entries"
    - "Seed data is idempotent using `ON CONFLICT DO NOTHING`"
  artifacts:
    - path: "src/lib/supabase/service.ts"
      provides: "Shared service role Supabase client"
      exports: ["createServiceClient"]
    - path: "supabase/seed.sql"
      provides: "Rule library seed data with 15+ expert rules"
      contains: "INSERT INTO rule_library"
  key_links:
    - from: "src/lib/supabase/service.ts"
      to: "src/types/database.types.ts"
      via: "import type { Database }"
      pattern: "import.*Database.*database\\.types"
    - from: "src/app/api/webhooks/whop/route.ts"
      to: "src/lib/supabase/service.ts"
      via: "import { createServiceClient }"
      pattern: "import.*createServiceClient.*lib/supabase/service"
    - from: "src/app/api/cron/sync-whop/route.ts"
      to: "src/lib/supabase/service.ts"
      via: "import { createServiceClient }"
      pattern: "import.*createServiceClient.*lib/supabase/service"
---

<objective>
Extract the duplicated `createServiceClient()` function to a shared module, refactor existing routes to import from it, and seed the rule library with 15+ expert rules containing production-quality evaluation prompts.

Purpose: The shared service client unblocks every future server-side route (cron, webhooks, admin) from needing to duplicate the client creation pattern. The seeded rule library enables Phase 2's engine to start scoring content immediately with real rules.

Output: Shared service client at `src/lib/supabase/service.ts`, refactored webhook/cron routes, seed SQL with 15+ idempotent rules.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-foundation/01-RESEARCH.md
@.planning/phases/01-database-foundation/01-01-SUMMARY.md
@src/app/api/webhooks/whop/route.ts
@src/app/api/cron/sync-whop/route.ts
@src/lib/supabase/server.ts
@src/types/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract service client and refactor existing routes</name>
  <files>
    src/lib/supabase/service.ts
    src/app/api/webhooks/whop/route.ts
    src/app/api/cron/sync-whop/route.ts
  </files>
  <action>
**1. Create `src/lib/supabase/service.ts`:**

```typescript
import { createServerClient } from "@supabase/ssr";
import type { Database } from "@/types/database.types";

/**
 * Creates a Supabase client using the service role key.
 * Bypasses RLS — use ONLY in server-side routes (cron, webhooks, admin).
 * NEVER import this in client components or browser-side code.
 */
export function createServiceClient() {
  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    {
      cookies: {
        getAll: () => [],
        setAll: () => {},
      },
    }
  );
}
```

This is the exact same pattern already used in 2 existing files, now extracted to a shared module.

**2. Refactor `src/app/api/webhooks/whop/route.ts`:**
- Remove the local `function createServiceClient()` definition (lines 7-18)
- Remove the `import { createServerClient } from "@supabase/ssr"` import (line 2)
- Remove the `import type { Database } from "@/types/database.types"` import (line 5) — only if no other usage of `Database` type in the file
- Add: `import { createServiceClient } from "@/lib/supabase/service";`
- Rest of the file stays exactly the same — it already calls `createServiceClient()` by name

**3. Refactor `src/app/api/cron/sync-whop/route.ts`:**
- Same pattern: remove local `createServiceClient`, remove `createServerClient` and `Database` imports
- Add: `import { createServiceClient } from "@/lib/supabase/service";`
- Rest of the file stays exactly the same

**Verify the refactor doesn't break anything** by checking that both files still use `createServiceClient()` calls identically and the import path resolves.
  </action>
  <verify>
```bash
# Verify the shared module exists
cat src/lib/supabase/service.ts

# Verify old local definitions are gone
grep -n "function createServiceClient" src/app/api/webhooks/whop/route.ts
grep -n "function createServiceClient" src/app/api/cron/sync-whop/route.ts
# Both should return nothing (no matches)

# Verify new imports are present
grep -n "import.*createServiceClient.*lib/supabase/service" src/app/api/webhooks/whop/route.ts
grep -n "import.*createServiceClient.*lib/supabase/service" src/app/api/cron/sync-whop/route.ts
# Both should match

# Verify TypeScript compiles
npx tsc --noEmit
```
  </verify>
  <done>
`src/lib/supabase/service.ts` exports `createServiceClient()`. Both `src/app/api/webhooks/whop/route.ts` and `src/app/api/cron/sync-whop/route.ts` import from the shared module instead of defining it locally. `npx tsc --noEmit` passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create rule library seed data with production-quality evaluation prompts</name>
  <files>supabase/seed.sql</files>
  <action>
Create `supabase/seed.sql` with 15+ expert rules across hook, retention, and platform categories. Per CONTEXT.md locked decisions: stick to what's in the architecture reference (hook rules, retention rules, platform rules), keep the seed lean, and include both cross-platform (NULL platform) and platform-specific entries.

Per RESEARCH.md recommendation: write production-quality `evaluation_prompt` values for complex rules and use `score_modifier` for simple deterministic rules. This optimizes for Phase 2 — the engine can start using rules immediately.

**Use `INSERT ... ON CONFLICT DO NOTHING` for idempotency** (seed.sql runs on `db reset`; must not fail on re-runs).

The seed needs a conflict target. Since `rule_library` has no natural UNIQUE constraint on `name`, add a comment noting that the `ON CONFLICT DO NOTHING` applies to the `id` column using fixed UUIDs for seed data. This ensures re-running seed.sql doesn't create duplicates.

**Alternative approach (simpler):** Use `name` as the unique target by adding a UNIQUE constraint on `name` in the migration. However, the migration (01-01) is already written. Instead, use fixed UUIDs for seed data so `ON CONFLICT (id) DO NOTHING` works cleanly.

**Rule categories and counts** (minimum 15 rules total):

**Hook Rules (5 rules, cross-platform):**
1. Question Hook — content opens with a direct question (`pattern: 'question_hook'`, `score_modifier: +15`)
2. Curiosity Gap — creates information gap compelling viewing (`pattern: 'curiosity_gap'`, `score_modifier: +12`)
3. Negative Bias Hook — leverages negativity bias for attention (`pattern: 'negative_bias'`, `score_modifier: +10`)
4. Bold Claim Hook — opens with a surprising/contrarian statement (`pattern: 'bold_claim'`, `score_modifier: +8`)
5. Story Hook — opens with a personal story or narrative setup (`pattern: 'story_hook'`, `score_modifier: +10`)

Each hook rule also gets a production `evaluation_prompt` for LLM scoring, e.g.:
> "Evaluate if the content opens with a compelling question that creates curiosity. Consider: Is it specific enough to feel personal? Does it target a pain point or desire? Would a scroller stop to find the answer? Score 0-10 where 10 means an irresistible question hook that demands engagement."

**Retention Rules (5 rules, cross-platform):**
1. Loop Structure — content structure that encourages rewatching (`pattern: 'loop_structure'`, `score_modifier: +12`)
2. Payoff Delay — delays the key reveal to maintain watch time (`pattern: 'payoff_delay'`, `score_modifier: +10`)
3. Pattern Interrupt — breaks expected pattern to recapture attention (`pattern: 'pattern_interrupt'`, `score_modifier: +8`)
4. Information Density — high value-per-second keeps viewers engaged (`pattern: 'info_density'`, `score_modifier: +10`)
5. Emotional Arc — content follows a clear emotional progression (`pattern: 'emotional_arc'`, `score_modifier: +12`)

Each with a production `evaluation_prompt` describing what the LLM should evaluate and how to score 0-10.

**Platform Rules (5+ rules, platform-specific):**
1. TikTok Short Duration — videos under 30 seconds (TikTok-specific, `score_modifier: +10`)
2. TikTok Trending Sound — uses a currently trending sound (TikTok-specific, `score_modifier: +15`)
3. Instagram Carousel Depth — multi-slide carousels with progressive value (Instagram-specific, `score_modifier: +8`)
4. YouTube Thumbnail Bait — title/thumbnail combination creates click gap (YouTube-specific, `score_modifier: +10`)
5. TikTok Duet/Stitch Potential — content invites duets or stitches (TikTok-specific, `score_modifier: +8`)

Each with `platform` set to the specific platform string ('tiktok', 'instagram', 'youtube') and a production `evaluation_prompt`.

**For every rule, set:**
- `weight`: 1.0 (default, Phase 2 will tune)
- `max_score`: 10.0 (standard scale)
- `accuracy_rate`: NULL (no data yet)
- `sample_count`: 0
- `is_active`: true

Use fixed UUID values for seed data (generate 15+ UUIDs). Format: clean, readable SQL with comments separating categories.
  </action>
  <verify>
```bash
# Verify seed file exists and has correct rule count
cat supabase/seed.sql | grep -c "INSERT INTO rule_library"
# Should be 1 (single INSERT with multiple VALUES)

cat supabase/seed.sql | grep -c "true)"
# Should be >= 15 (one per rule, ending with is_active = true)

# Verify idempotency
grep "ON CONFLICT" supabase/seed.sql
# Should contain ON CONFLICT DO NOTHING

# If local Supabase is running, verify seed loads:
# npx supabase db reset
# Then check: SELECT count(*) FROM rule_library; should return >= 15
```
  </verify>
  <done>
`supabase/seed.sql` contains 15+ INSERT statements for rule_library with: 5 hook rules (cross-platform), 5 retention rules (cross-platform), 5+ platform rules (TikTok/Instagram/YouTube-specific). Each rule has a production-quality `evaluation_prompt`, appropriate `score_modifier` and `pattern`, correct `weight`/`max_score` defaults, and `is_active = true`. The INSERT uses `ON CONFLICT DO NOTHING` for idempotency.
  </done>
</task>

</tasks>

<verification>
1. `src/lib/supabase/service.ts` exists and exports `createServiceClient()`
2. No local `createServiceClient` definitions remain in `src/app/api/webhooks/whop/route.ts` or `src/app/api/cron/sync-whop/route.ts`
3. Both existing routes import from `@/lib/supabase/service`
4. `supabase/seed.sql` exists with 15+ rule_library entries
5. Seed rules span hook, retention, and platform categories
6. Seed rules include both cross-platform (null platform) and platform-specific entries
7. Every rule has `evaluation_prompt` and/or `score_modifier` populated
8. Seed is idempotent (`ON CONFLICT DO NOTHING`)
9. `npx tsc --noEmit` passes with zero errors
</verification>

<success_criteria>
- `createServiceClient()` is a single shared function imported by all server routes that need RLS bypass
- Zero code duplication for the service client pattern
- Rule library has 15+ production-ready rules that Phase 2's engine can use immediately
- All TypeScript compiles with zero errors
- Seed data is safe to re-run without duplicates
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-foundation/01-02-SUMMARY.md`
</output>
