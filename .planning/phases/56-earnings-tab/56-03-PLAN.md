---
phase: 56-earnings-tab
plan: 03
type: execute
wave: 2
depends_on: ["56-01", "56-02"]
files_modified:
  - src/components/app/brand-deals/earnings-breakdown-list.tsx
  - src/components/app/brand-deals/earnings-tab.tsx
  - src/components/app/brand-deals/brand-deals-page.tsx
  - src/components/app/brand-deals/index.ts
autonomous: true

must_haves:
  truths:
    - "Earnings tab shows stat cards, chart, and breakdown list as a cohesive section"
    - "Period selector updates stat cards, chart, AND breakdown data with a fade transition"
    - "Breakdown list shows per-source earnings sorted by earnings descending with source name, clicks, conversions, and formatted earnings"
    - "Selecting the Earnings tab in BrandDealsPage renders the full EarningsTab component"
  artifacts:
    - path: "src/components/app/brand-deals/earnings-breakdown-list.tsx"
      provides: "Per-source earnings breakdown list component"
      exports: ["EarningsBreakdownList"]
    - path: "src/components/app/brand-deals/earnings-tab.tsx"
      provides: "EarningsTab container component with period state and data derivation"
      exports: ["EarningsTab"]
  key_links:
    - from: "src/components/app/brand-deals/earnings-tab.tsx"
      to: "src/components/app/brand-deals/earnings-stat-cards.tsx"
      via: "import EarningsStatCards"
      pattern: "EarningsStatCards"
    - from: "src/components/app/brand-deals/earnings-tab.tsx"
      to: "src/components/app/brand-deals/earnings-chart.tsx"
      via: "import EarningsChart"
      pattern: "EarningsChart"
    - from: "src/components/app/brand-deals/earnings-tab.tsx"
      to: "src/components/app/brand-deals/earnings-period-selector.tsx"
      via: "import EarningsPeriodSelector and Period type"
      pattern: "EarningsPeriodSelector"
    - from: "src/components/app/brand-deals/earnings-tab.tsx"
      to: "src/lib/mock-brand-deals.ts"
      via: "import MOCK_EARNINGS_SUMMARY"
      pattern: "MOCK_EARNINGS_SUMMARY"
    - from: "src/components/app/brand-deals/brand-deals-page.tsx"
      to: "src/components/app/brand-deals/earnings-tab.tsx"
      via: "import EarningsTab, replace placeholder"
      pattern: "EarningsTab"
---

<objective>
Build the EarningsBreakdownList, wire all presentational components into the EarningsTab container with period state management and fade transitions, and integrate EarningsTab into BrandDealsPage replacing the placeholder.

Purpose: Delivers EARN-08 (breakdown list), EARN-09 (formatted monetary values), EARN-04 partial (period state updating all sections with fade transition), and completes the full Earnings tab integration into the Brand Deals page.
Output: Breakdown list component, EarningsTab container, and updated BrandDealsPage/index.ts.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-earnings-tab/56-RESEARCH.md
@.planning/phases/56-earnings-tab/56-01-SUMMARY.md
@.planning/phases/56-earnings-tab/56-02-SUMMARY.md

@src/components/app/brand-deals/brand-deals-page.tsx
@src/components/app/brand-deals/index.ts
@src/lib/mock-brand-deals.ts
@src/types/brand-deals.ts
@src/lib/affiliate-utils.ts
@src/components/app/brand-deals/affiliates-tab.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EarningsBreakdownList component</name>
  <files>src/components/app/brand-deals/earnings-breakdown-list.tsx</files>
  <action>
Create the per-source earnings breakdown list at `src/components/app/brand-deals/earnings-breakdown-list.tsx`.

1. `"use client"` directive
2. Import `EarningSource` from `@/types/brand-deals`
3. Import `formatCurrency`, `formatNumber` from `@/lib/affiliate-utils`
4. Import `Avatar` from design system (`@/components/ui/avatar` or equivalent -- check how `AffiliateLinkCard` renders brand logos)

**Props interface:**
```typescript
interface EarningsBreakdownListProps {
  sources: EarningSource[];
}
```

**Layout:**
- Section header: `<h3 className="text-sm font-semibold text-foreground mb-3">Earnings Breakdown</h3>`
- Table-style layout using divs (not `<table>`), consistent with dark theme:
  - Header row: `grid grid-cols-4 gap-4 px-4 py-2 text-xs font-medium uppercase tracking-wider text-foreground-muted`
    - Columns: "Source", "Clicks", "Conversions", "Earnings"
  - Body rows: sorted by `totalEarned` descending (use `[...sources].sort((a, b) => b.totalEarned - a.totalEarned)`)
  - Each row: `grid grid-cols-4 gap-4 items-center px-4 py-3 border-b border-white/[0.04] last:border-b-0`
  - Source column: flex row with brand logo (24px round image or Avatar) + brand name text
  - Clicks column: `formatNumber(source.clicks)`
  - Conversions column: `formatNumber(source.conversions)`
  - Earnings column: `formatCurrency(source.totalEarned)` with `text-green-400 font-semibold`
- Wrap in container: `rounded-xl border border-border bg-surface-elevated overflow-hidden`
- Max height with scroll: `max-h-[320px] overflow-y-auto` on the body (not including header)
- Sources data pre-sorted ensures top earners visible first (EARN-08 says sorted by earnings descending)
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Verify the component exports `EarningsBreakdownList`.
  </verify>
  <done>
`EarningsBreakdownList` renders a table-style breakdown of per-source earnings with brand logo, source name, clicks, conversions, and formatted earnings (green text) in a scrollable container. Sources are sorted by earnings descending. All monetary values use `formatCurrency` (Intl.NumberFormat USD).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EarningsTab container and wire into BrandDealsPage</name>
  <files>
    src/components/app/brand-deals/earnings-tab.tsx
    src/components/app/brand-deals/brand-deals-page.tsx
    src/components/app/brand-deals/index.ts
  </files>
  <action>
**Part A: Create EarningsTab container** at `src/components/app/brand-deals/earnings-tab.tsx`

1. `"use client"` directive
2. Import `useState`, `useMemo` from react
3. Import `AnimatePresence`, `motion` from `motion/react`
4. Import `MOCK_EARNINGS_SUMMARY` from `@/lib/mock-brand-deals`
5. Import `EarningsStatCards` from `./earnings-stat-cards`
6. Import `EarningsPeriodSelector`, `Period` from `./earnings-period-selector`
7. Import `EarningsChart` from `./earnings-chart`
8. Import `EarningsBreakdownList` from `./earnings-breakdown-list`
9. Import `EarningsSummary` type from `@/types/brand-deals`

**Period filtering logic (inline function):**
```typescript
function filterEarningsByPeriod(summary: EarningsSummary, period: Period) {
  const breakdown = summary.monthlyBreakdown;

  // Simple slice for mock data (6 monthly entries)
  const chartData = period === "7d" ? breakdown.slice(-1)
    : period === "30d" ? breakdown.slice(-2)
    : period === "90d" ? breakdown.slice(-3)
    : breakdown;

  // Scale stat values proportionally for shorter periods
  const total = breakdown.reduce((s, d) => s + d.amount, 0);
  const periodTotal = chartData.reduce((s, d) => s + d.amount, 0);
  const ratio = total > 0 ? periodTotal / total : 1;

  return {
    chartData,
    stats: {
      totalEarned: Math.round(summary.totalEarned * ratio),
      pending: Math.round(summary.pendingPayout * ratio),
      paidOut: Math.round(summary.paidOut * ratio),
      thisMonth: summary.thisMonth, // always current month
    },
    sources: summary.topSources, // same sources for all periods (mock simplification)
  };
}
```

**Component structure:**
```tsx
export function EarningsTab() {
  const [period, setPeriod] = useState<Period>("30d");
  const filtered = useMemo(
    () => filterEarningsByPeriod(MOCK_EARNINGS_SUMMARY, period),
    [period]
  );

  return (
    <div className="space-y-6">
      <EarningsStatCards stats={filtered.stats} />

      <div className="space-y-3">
        <div className="flex items-center justify-between">
          <h3 className="text-sm font-semibold text-foreground">Earnings Over Time</h3>
          <EarningsPeriodSelector activePeriod={period} onPeriodChange={setPeriod} />
        </div>
        <AnimatePresence mode="wait">
          <motion.div
            key={period}
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            transition={{ duration: 0.2 }}
          >
            <EarningsChart data={filtered.chartData} />
          </motion.div>
        </AnimatePresence>
      </div>

      <EarningsBreakdownList sources={filtered.sources} />
    </div>
  );
}
```

The `AnimatePresence mode="wait"` with 200ms fade handles the period transition (EARN-04). The `key={period}` ensures content remounts on period change, triggering the fade out/in.

**Part B: Update BrandDealsPage** at `src/components/app/brand-deals/brand-deals-page.tsx`

1. Add import: `import { EarningsTab } from "./earnings-tab";`
2. Replace the placeholder `<div>` inside the `<Tabs.Content value="earnings">` block:
   - Remove the placeholder div with "Earnings tab content -- Phase 56" text
   - Replace with: `<EarningsTab />`

The placeholder currently looks like:
```tsx
<Tabs.Content value="earnings" forceMount={currentTab === "earnings" ? true : undefined} className="outline-none">
  <div className="flex min-h-[300px] items-center justify-center rounded-xl border border-border-subtle">
    <p className="text-foreground-muted">Earnings tab content -- Phase 56</p>
  </div>
</Tabs.Content>
```

Replace the inner `<div>` with just `<EarningsTab />`.

**Part C: Update barrel export** at `src/components/app/brand-deals/index.ts`

Add: `export { EarningsTab } from "./earnings-tab";`
  </action>
  <verify>
1. Run `npx tsc --noEmit` to verify no type errors
2. Run `pnpm dev` and navigate to `/brand-deals?tab=earnings` to verify the full tab renders
3. Verify period selector changes update the chart and stat cards with fade transition
4. Verify breakdown list appears below the chart
  </verify>
  <done>
`EarningsTab` container manages period state (default 30D), derives period-filtered data from mock fixtures, and renders `EarningsStatCards` + `EarningsPeriodSelector` + `EarningsChart` + `EarningsBreakdownList` in a cohesive layout. Period changes trigger fade out/in transitions. `BrandDealsPage` now renders `<EarningsTab />` instead of the placeholder. `index.ts` exports `EarningsTab`.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Navigate to `/brand-deals?tab=earnings` and see stat cards, chart, period selector, and breakdown list
3. Click different period pills (7D, 30D, 90D, All Time) -- all sections update with fade transition
4. Breakdown list shows 5 sources sorted by earnings descending with formatted currency
5. No placeholder text remains in the Earnings tab
6. Tab switching between Earnings/Deals/Affiliates works correctly
</verification>

<success_criteria>
- Earnings tab renders complete with all four sections (stat cards, period selector, chart, breakdown)
- Period selector updates stat card values, chart data, and breakdown sources with ~200ms fade transition
- Breakdown list shows per-source earnings with source name, clicks, conversions, and formatted earnings
- Default period is 30D
- BrandDealsPage placeholder is replaced with working EarningsTab
- No TypeScript errors
- Tab navigation between all three tabs still works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/56-earnings-tab/56-03-SUMMARY.md`
</output>
