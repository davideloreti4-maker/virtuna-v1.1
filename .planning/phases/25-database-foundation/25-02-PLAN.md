---
phase: 25-database-foundation
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - src/types/database.types.ts
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript types are generated for all 6 tables"
    - "Supabase clients are typed with Database generic"
    - "IDE autocomplete works for table operations"
  artifacts:
    - path: "src/types/database.types.ts"
      provides: "Generated TypeScript types for all tables"
      contains: "creator_profiles"
    - path: "src/lib/supabase/client.ts"
      provides: "Typed browser Supabase client"
      contains: "Database"
    - path: "src/lib/supabase/server.ts"
      provides: "Typed server Supabase client"
      contains: "Database"
  key_links:
    - from: "src/lib/supabase/client.ts"
      to: "src/types/database.types.ts"
      via: "import type { Database }"
      pattern: "import.*Database.*from.*database\\.types"
    - from: "src/lib/supabase/server.ts"
      to: "src/types/database.types.ts"
      via: "import type { Database }"
      pattern: "import.*Database.*from.*database\\.types"
---

<objective>
Generate TypeScript types from live Supabase schema and update clients to be fully typed.

Purpose: Enable type-safe database operations throughout the application. IDE autocomplete and compile-time type checking prevent runtime errors when working with v1.6 data structures.

Output: Generated types file and typed Supabase client utilities ready for use in Phases 26-30.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-database-foundation/25-01-SUMMARY.md
@src/lib/supabase/client.ts
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate TypeScript types from Supabase schema</name>
  <files>
    src/types/database.types.ts
  </files>
  <action>
1. Ensure authenticated with Supabase CLI:
   `npx supabase login` (if not already logged in)

2. Generate TypeScript types from the live schema:
   `npx supabase gen types typescript --project-id qyxvxleheckijapurisj --schema public > src/types/database.types.ts`

   If `src/types/` directory doesn't exist, create it first:
   `mkdir -p src/types`

3. Verify the generated file contains interfaces for all 6 tables:
   - creator_profiles
   - deals
   - deal_enrollments
   - wallet_transactions
   - affiliate_clicks
   - affiliate_conversions

4. The generated file should include:
   - `Database` interface with `public` schema
   - `Tables` type for each table with Row, Insert, and Update variants
   - Proper types for all columns (UUID as string, TIMESTAMPTZ as string, INTEGER as number, etc.)

Note: If auth errors occur, the Supabase access token may need to be set via `SUPABASE_ACCESS_TOKEN` env var or by running `npx supabase login` interactively.
  </action>
  <verify>
- `cat src/types/database.types.ts | head -50` shows generated types
- `grep -c "creator_profiles" src/types/database.types.ts` returns at least 1
- `grep -c "wallet_transactions" src/types/database.types.ts` returns at least 1
- File contains `export type Database =` declaration
  </verify>
  <done>
TypeScript types generated from live Supabase schema. File contains Database interface with types for all 6 v1.6 tables including Row, Insert, and Update variants.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Supabase clients with Database generic</name>
  <files>
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
  </files>
  <action>
1. Update `src/lib/supabase/client.ts`:
```typescript
import { createBrowserClient } from "@supabase/ssr";
import type { Database } from "@/types/database.types";

export function createClient() {
  return createBrowserClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
}
```

2. Update `src/lib/supabase/server.ts`:
```typescript
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";
import type { Database } from "@/types/database.types";

export async function createClient() {
  const cookieStore = await cookies();

  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            );
          } catch {
            // Server Component - ignore
          }
        },
      },
    }
  );
}
```

3. Verify TypeScript compilation:
   `npx tsc --noEmit` or `pnpm build` / `npm run build`

4. Test autocomplete manually (optional):
   - Open a file in IDE
   - Type `const supabase = createClient(); supabase.from('`
   - Table names should autocomplete: creator_profiles, deals, etc.
  </action>
  <verify>
- `grep "Database" src/lib/supabase/client.ts` shows the import and generic
- `grep "Database" src/lib/supabase/server.ts` shows the import and generic
- `npm run build` or `npx tsc --noEmit` completes without TypeScript errors
  </verify>
  <done>
Both browser and server Supabase clients are now typed with the Database generic. TypeScript will provide autocomplete for table names and type-check all database operations.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `src/types/database.types.ts` exists with Database interface
2. `src/lib/supabase/client.ts` imports and uses Database generic
3. `src/lib/supabase/server.ts` imports and uses Database generic
4. `npm run build` passes with no TypeScript errors
5. IDE provides autocomplete for `supabase.from('creator_profiles')` etc.
</verification>

<success_criteria>
- Generated types file contains interfaces for all 6 tables (creator_profiles, deals, deal_enrollments, wallet_transactions, affiliate_clicks, affiliate_conversions)
- Browser client (client.ts) uses `createBrowserClient<Database>`
- Server client (server.ts) uses `createServerClient<Database>`
- TypeScript compilation succeeds with no errors
- All v1.6 database operations will have compile-time type safety
</success_criteria>

<output>
After completion, create `.planning/phases/25-database-foundation/25-02-SUMMARY.md`
</output>
