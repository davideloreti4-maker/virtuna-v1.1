---
phase: 04-types-schema-db-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/engine/types.ts
autonomous: true

must_haves:
  truths:
    - "FeatureVector type exists as a standardized signal backbone with hookScore, audioTrending, captionScore, and all pipeline signal fields"
    - "AnalysisInput supports 3 input modes: text-only, TikTok URL, and video file upload"
    - "PredictionResult v2 includes reasoning, warnings, feature_vector, behavioral_predictions, and expanded meta fields"
    - "Deprecated v1 types (Variant, ConversationTheme, PersonaReaction interfaces) are removed from types.ts"
    - "Factor interface updated to match Gemini v2 output (rationale, improvement_tip instead of description, tips)"
  artifacts:
    - path: "src/lib/engine/types.ts"
      provides: "FeatureVector, AnalysisInput v2, ContentPayload, PredictionResult v2"
      contains: "FeatureVector"
      exports: ["FeatureVector", "AnalysisInput", "ContentPayload", "PredictionResult"]
  key_links:
    - from: "src/lib/engine/types.ts"
      to: "src/lib/engine/gemini.ts"
      via: "GeminiResponseSchema, FactorSchema shared types"
      pattern: "FactorSchema|GeminiResponseSchema"
    - from: "src/lib/engine/types.ts"
      to: "src/lib/engine/deepseek.ts"
      via: "DeepSeekResponseSchema, BehavioralPredictionsSchema shared types"
      pattern: "DeepSeekResponseSchema|BehavioralPredictions"
    - from: "src/lib/engine/types.ts"
      to: "src/lib/engine/pipeline.ts"
      via: "AnalysisInput consumed by pipeline entry point"
      pattern: "AnalysisInput"
---

<objective>
Define all v2 type definitions: FeatureVector as the standardized signal backbone, expanded AnalysisInput supporting 3 input modes (text, TikTok URL, video upload), ContentPayload as the normalized internal representation, and PredictionResult v2 with behavioral predictions, warnings, reasoning, and feature_vector. Clean up deprecated v1 types.

Purpose: Types are the contract between all pipeline stages. Phase 5 (pipeline restructure), Phase 7 (upload UI), and Phase 8 (results UI) all depend on these type definitions being correct and complete.

Output: Updated `src/lib/engine/types.ts` with all v2 types defined.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-gemini-prompt-video-analysis/02-01-SUMMARY.md
@.planning/phases/03-deepseek-prompt-model-switch/03-01-SUMMARY.md
@src/lib/engine/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define FeatureVector, ContentPayload, and expand AnalysisInput</name>
  <files>src/lib/engine/types.ts</files>
  <action>
In `src/lib/engine/types.ts`, add these new types:

**1. FeatureVector interface** — standardized signal backbone flowing between pipeline stages:
```typescript
export interface FeatureVector {
  // Gemini factor scores (0-10)
  hookScore: number;
  completionPull: number;
  rewatchPotential: number;
  shareTrigger: number;
  emotionalCharge: number;

  // Gemini video signals (0-10, null when no video)
  visualProductionQuality: number | null;
  hookVisualImpact: number | null;
  pacingScore: number | null;
  transitionQuality: number | null;

  // DeepSeek component scores (0-10)
  hookEffectiveness: number;
  retentionStrength: number;
  shareability: number;
  commentProvocation: number;
  saveWorthiness: number;
  trendAlignment: number;
  originality: number;

  // Rules engine (0-100)
  ruleScore: number;

  // Trend signals (0-100)
  trendScore: number;

  // Audio/Sound (0-1 match score, null if no match)
  audioTrendingMatch: number | null;

  // Caption/Hashtag signals
  captionScore: number;         // 0-10 estimated quality
  hashtagRelevance: number;     // 0-1 relevance score
  hashtagCount: number;         // raw count

  // Content metadata
  durationSeconds: number | null;
  hasVideo: boolean;
}
```

**2. Expand AnalysisInput** to support 3 input modes. Replace the current `AnalysisInputSchema` with:
```typescript
export const AnalysisInputSchema = z.object({
  // Input mode discriminator
  input_mode: z.enum(["text", "tiktok_url", "video_upload"]),

  // Text content (required for text mode, optional for URL/video as caption)
  content_text: z.string().max(10000).optional(),

  // TikTok URL (required for tiktok_url mode)
  tiktok_url: z.string().url().optional(),

  // Video upload reference (required for video_upload mode — Supabase Storage path)
  video_storage_path: z.string().optional(),

  // Content type (platform context)
  content_type: z.enum(["post", "reel", "story", "video", "thread"]),

  // Optional metadata
  society_id: z.string().optional(),
  niche: z.string().optional(),
  creator_handle: z.string().optional(),
}).refine(
  (data) => {
    if (data.input_mode === "text") return !!data.content_text;
    if (data.input_mode === "tiktok_url") return !!data.tiktok_url;
    if (data.input_mode === "video_upload") return !!data.video_storage_path;
    return false;
  },
  { message: "Required field missing for selected input_mode" }
);
```

**3. ContentPayload interface** — normalized internal representation after input processing:
```typescript
export interface ContentPayload {
  content_text: string;           // Always present (extracted from video/URL or user input)
  content_type: string;
  input_mode: "text" | "tiktok_url" | "video_upload";
  video_url: string | null;       // Resolved video URL (from TikTok extraction or Storage)
  hashtags: string[];             // Extracted from content_text
  duration_hint: number | null;   // Seconds, from URL metadata or user input
  niche: string | null;
  creator_handle: string | null;
  society_id: string | null;
}
```

Keep all existing Zod schemas (GeminiResponseSchema, DeepSeekResponseSchema, BehavioralPredictionsSchema, ComponentScoresSchema, FactorSchema, SuggestionSchema) untouched — they are correct from Phase 2/3.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | head -30` — expect zero errors related to FeatureVector, AnalysisInput, ContentPayload definitions (aggregator.ts will still have errors from v1 field references, that's Phase 5 work).
  </verify>
  <done>FeatureVector interface exported with all signal fields. AnalysisInput supports 3 input modes via Zod refine. ContentPayload interface exported as normalized pipeline input.</done>
</task>

<task type="auto">
  <name>Task 2: Define PredictionResult v2 and clean up deprecated types</name>
  <files>src/lib/engine/types.ts</files>
  <action>
**1. Replace PredictionResult** with v2 that includes behavioral predictions, feature_vector, warnings, and reasoning:
```typescript
export interface PredictionResult {
  // Core prediction
  overall_score: number;             // 0-100
  confidence: number;                // 0-1 numeric (ENG-07: not categorical)
  confidence_label: ConfidenceLevel; // "HIGH" | "MEDIUM" | "LOW" for UI display

  // v2 outputs
  behavioral_predictions: BehavioralPredictions;
  feature_vector: FeatureVector;
  reasoning: string;                 // DeepSeek's reasoning text
  warnings: string[];                // Fatal flaw warnings from DeepSeek Step 4

  // Factors and suggestions (from Gemini + DeepSeek)
  factors: Factor[];
  suggestions: Suggestion[];

  // Scoring breakdown
  rule_score: number;
  trend_score: number;
  gemini_score: number;              // NEW: Gemini's contribution (was 0% before)
  behavioral_score: number;          // NEW: DeepSeek behavioral contribution
  score_weights: {
    behavioral: number;  // 0.45
    gemini: number;      // 0.25
    rules: number;       // 0.20
    trends: number;      // 0.10
  };

  // Meta
  latency_ms: number;
  cost_cents: number;
  engine_version: string;
  gemini_model: string;
  deepseek_model: string | null;
  input_mode: "text" | "tiktok_url" | "video_upload";
  has_video: boolean;
}
```

**2. Update Factor interface** to match Gemini v2 output (Phase 2 changed `description` to `rationale` and `tips` to `improvement_tip`):
```typescript
export interface Factor {
  id: string;
  name: string;
  score: number;         // 0-10
  max_score: number;
  rationale: string;     // was: description
  improvement_tip: string; // was: tips: string[]
}
```

**3. Remove deprecated v1 types** — delete these interfaces and their Zod schemas:
- `PersonaReaction` interface and `PersonaReactionSchema` (personas are Phase 8 UI-only, lightweight)
- `Variant` interface and `VariantSchema` (dead v1 output per decisions)
- `ConversationTheme` interface and `ConversationThemeSchema` (dead v1 output per decisions)

**4. Remove `ml_score` from PredictionResult** — v2 formula is behavioral 45% + gemini 25% + rules 20% + trends 10%. There's no separate ML score until Phase 10.

Do NOT modify any Zod schemas for Gemini/DeepSeek responses — those are correct from Phase 2/3.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -c "error TS"` — count errors. Errors should ONLY be in aggregator.ts (references old Factor.description, Factor.tips, deprecated types) and potentially pipeline.ts/route.ts (old PredictionResult shape). These are Phase 5 work. The types.ts file itself should have zero internal errors.

Also verify exports: `grep -c "export" src/lib/engine/types.ts` should show FeatureVector, ContentPayload, BehavioralPredictions, ComponentScores, PredictionResult among exports.
  </verify>
  <done>PredictionResult v2 exported with behavioral_predictions, feature_vector, reasoning, warnings, numeric confidence, and v2 score_weights. Factor interface updated to rationale/improvement_tip. Deprecated v1 types (PersonaReaction, Variant, ConversationTheme + Zod schemas) removed.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` on types.ts specifically — zero internal errors
2. `grep "export interface FeatureVector" src/lib/engine/types.ts` — exists
3. `grep "export interface ContentPayload" src/lib/engine/types.ts` — exists
4. `grep "input_mode" src/lib/engine/types.ts` — exists in AnalysisInput
5. `grep "behavioral_predictions" src/lib/engine/types.ts` — exists in PredictionResult
6. `grep "PersonaReaction\|Variant\|ConversationTheme" src/lib/engine/types.ts` — zero matches (deprecated types removed)
7. `grep "feature_vector" src/lib/engine/types.ts` — exists in PredictionResult
8. Downstream type errors in aggregator.ts, pipeline.ts, route.ts are EXPECTED and will be fixed in Phase 5
</verification>

<success_criteria>
- FeatureVector type exists with all signal fields (Gemini factors, video signals, DeepSeek components, rules, trends, audio, caption/hashtag, metadata)
- AnalysisInput supports text, tiktok_url, video_upload modes with Zod validation
- ContentPayload is the normalized internal type with extracted hashtags and resolved video URL
- PredictionResult v2 has behavioral_predictions, feature_vector, reasoning, warnings, numeric confidence
- Factor interface matches Gemini v2 output (rationale, improvement_tip)
- All deprecated v1 types removed
- Types file compiles cleanly in isolation
</success_criteria>

<output>
After completion, create `.planning/phases/04-types-schema-db-migration/04-01-SUMMARY.md`
</output>
