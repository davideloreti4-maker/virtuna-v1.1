---
phase: 02-landing-page
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/hive-demo/index.tsx
  - src/components/hive-demo/hive-demo-canvas.tsx
autonomous: true

must_haves:
  truths:
    - "Hive demo canvas does not run requestAnimationFrame when scrolled out of view"
    - "Hive demo canvas resumes animation when scrolled back into view"
    - "Mobile users can scroll past the hive demo section without being blocked"
    - "Hive demo renders exactly 50 pre-computed nodes (LAND-02: ≤50 nodes constraint)"
    - "Hive demo uses pre-computed data from hive-demo-data.ts, no runtime physics (LAND-02: pre-computed, no physics)"
    - "Hive demo renders smoothly on mobile without jank (Canvas 2D, no physics) (LAND-03)"
  artifacts:
    - path: "src/components/hive-demo/index.tsx"
      provides: "Hive demo section wrapper with lazy mounting via IntersectionObserver"
      contains: "useInView"
    - path: "src/components/hive-demo/hive-demo-canvas.tsx"
      provides: "Canvas renderer with RAF lifecycle tied to visibility, Canvas 2D only"
      contains: "requestAnimationFrame"
    - path: "src/components/hive-demo/hive-demo-data.ts"
      provides: "Pre-computed 50-node data set (1 center + 5 tier-1 + 44 tier-2)"
      contains: "50 nodes total"
  key_links:
    - from: "src/components/hive-demo/index.tsx"
      to: "src/components/hive-demo/hive-demo-canvas.tsx"
      via: "Conditional render based on inView"
      pattern: "inView.*HiveDemoCanvas"
    - from: "src/components/hive-demo/hive-demo-canvas.tsx"
      to: "src/components/hive-demo/hive-demo-data.ts"
      via: "Import pre-computed node data"
      pattern: "import.*hive-demo-data"
---

<objective>
Add IntersectionObserver-based lazy loading to the hive demo canvas so it only runs the requestAnimationFrame loop when visible, preventing battery drain on mobile.

Purpose: The current HiveDemoCanvas starts its RAF loop immediately on mount and never pauses, even when scrolled off-screen. On mobile devices, this causes unnecessary CPU usage and battery drain. The fix uses `react-intersection-observer` (already installed, unused) to conditionally mount the canvas.

Output: Hive demo lazily mounts when approaching viewport, RAF loop only runs while visible.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-landing-page/02-RESEARCH.md
@src/components/hive-demo/index.tsx
@src/components/hive-demo/hive-demo-canvas.tsx
@src/components/hive-demo/hive-demo-data.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add IntersectionObserver lazy mounting to HiveDemo wrapper</name>
  <files>
    src/components/hive-demo/index.tsx
    src/components/hive-demo/hive-demo-canvas.tsx
  </files>
  <action>
Use `react-intersection-observer` (already installed at ^10.0.2) to lazy-mount the HiveDemoCanvas component. This achieves two goals: (1) canvas doesn't load until user scrolls near it (better LCP), (2) canvas unmounts when scrolled away (stops RAF loop, saves battery).

**In `src/components/hive-demo/index.tsx`:**

1. Import `useInView` from `react-intersection-observer`
2. Add `const { ref, inView } = useInView({ triggerOnce: false, rootMargin: "200px" })` — `triggerOnce: false` so it re-triggers when scrolling back; `rootMargin: "200px"` starts loading 200px before visible
3. Apply `ref` to the container div that wraps `HiveDemoCanvas`
4. Conditionally render: `{inView ? <HiveDemoCanvas /> : <div className="w-full h-full bg-background" />}` — placeholder has same background to prevent layout shift
5. Keep all existing section markup, heading, FadeIn animations unchanged

**In `src/components/hive-demo/hive-demo-canvas.tsx`:**

No changes needed. The current useEffect cleanup already calls `cancelAnimationFrame(animRef.current)` on unmount (line 146-148). When the parent unmounts HiveDemoCanvas via `inView: false`, the RAF loop stops automatically.

Key constraints:
- Do NOT use `triggerOnce: true` — we want the canvas to unmount when scrolled away (battery savings)
- Do NOT add touch event listeners or change `touchAction: "auto"`
- Do NOT change any Canvas 2D rendering logic
- The placeholder div must have the same dimensions (aspect-square, max-h constraints) to prevent layout shift — but these are on the parent container, so the placeholder just needs `w-full h-full bg-background`
  </action>
  <verify>
Run `pnpm build` — should compile without errors.
Run `grep -n 'useInView' src/components/hive-demo/index.tsx` — should return an import and usage line.
Run `grep -n 'inView' src/components/hive-demo/index.tsx` — should show conditional rendering logic.
Verify that `touchAction: "auto"` still exists in hive-demo-canvas.tsx.

**LAND-02 constraint verification (≤50 nodes, pre-computed, no physics):**
Run `grep -n '50 nodes' src/components/hive-demo/hive-demo-data.ts` — confirms exactly 50 nodes documented in data file.
Run `grep -c 'nodes.push' src/components/hive-demo/hive-demo-data.ts` — count node push calls to verify ≤50 total.
Run `grep -rn 'physics\|velocity\|acceleration\|force\|gravity\|d3-force\|matter-js' src/components/hive-demo/` — should return zero results (no physics engine).
Run `grep -n 'canvas\|Canvas\|getContext.*2d' src/components/hive-demo/hive-demo-canvas.tsx` — confirms Canvas 2D rendering (not WebGL/Three.js).
Run `grep -rn 'import.*hive-demo-data' src/components/hive-demo/hive-demo-canvas.tsx` — confirms canvas uses pre-computed data.
  </verify>
  <done>
HiveDemoCanvas conditionally mounts/unmounts based on IntersectionObserver visibility. RAF loop only runs when the section is within 200px of the viewport. Canvas placeholder prevents layout shift. LAND-02 constraints verified: ≤50 pre-computed nodes, Canvas 2D, no physics engine. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes without errors
2. `grep -rn 'useInView' src/components/hive-demo/` confirms IntersectionObserver usage
3. `grep -rn 'touchAction.*auto' src/components/hive-demo/hive-demo-canvas.tsx` confirms mobile scroll pass-through preserved
4. No new dependencies added (react-intersection-observer already installed)
5. Hive demo section renders with progressive build animation when scrolled into view

**LAND-02 constraint verification:**
6. `grep -n '50 nodes' src/components/hive-demo/hive-demo-data.ts` — confirms ≤50 node count
7. `grep -rn 'physics\|velocity\|acceleration\|d3-force\|matter-js' src/components/hive-demo/` — zero results (no physics)
8. `grep -n 'getContext.*2d' src/components/hive-demo/hive-demo-canvas.tsx` — confirms Canvas 2D (not WebGL)
9. `grep -rn 'import.*hive-demo-data' src/components/hive-demo/hive-demo-canvas.tsx` — confirms pre-computed data usage
</verification>

<success_criteria>
- HiveDemoCanvas only mounts when within 200px of viewport
- HiveDemoCanvas unmounts (stopping RAF) when scrolled out of viewport
- No layout shift when canvas loads (placeholder matches dimensions)
- Mobile touch scrolling through the section still works (touchAction: auto preserved)
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-landing-page/02-02-SUMMARY.md`
</output>
