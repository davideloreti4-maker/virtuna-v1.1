---
phase: 07-polish-edge-cases
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/components/competitors/competitor-card.tsx
  - src/app/(app)/competitors/competitors-client.tsx
  - src/components/competitors/competitor-table.tsx
  - src/components/competitors/detail/detail-header.tsx
  - src/app/(app)/competitors/[handle]/page.tsx
  - src/app/(app)/competitors/compare/comparison-client.tsx
autonomous: true

must_haves:
  truths:
    - "Competitor cards show a stale data indicator with relative timestamp below the handle"
    - "Competitor cards show an error badge when scrape_status is 'failed'"
    - "Competitor table shows a Status column with stale indicator or error badge per row"
    - "Detail page header shows stale indicator and error banner with retry button when scrape failed"
    - "Comparison page shows stale indicators under each competitor selector"
  artifacts:
    - path: "src/components/competitors/competitor-card.tsx"
      provides: "Card with stale indicator and error badge"
      contains: "StaleIndicator"
    - path: "src/components/competitors/competitors-client.tsx"
      provides: "Threading of last_scraped_at and scrape_status to card data"
      contains: "last_scraped_at"
    - path: "src/components/competitors/competitor-table.tsx"
      provides: "Table with status column showing stale/error state"
      contains: "StaleIndicator"
    - path: "src/components/competitors/detail/detail-header.tsx"
      provides: "Detail header with stale indicator and error banner"
      contains: "ScrapeErrorBanner"
  key_links:
    - from: "src/components/competitors/competitor-card.tsx"
      to: "src/components/competitors/stale-indicator.tsx"
      via: "import StaleIndicator"
      pattern: "import.*StaleIndicator"
    - from: "src/components/competitors/detail/detail-header.tsx"
      to: "src/components/competitors/scrape-error-banner.tsx"
      via: "import ScrapeErrorBanner"
      pattern: "import.*ScrapeErrorBanner"
    - from: "src/app/(app)/competitors/competitors-client.tsx"
      to: "src/components/competitors/competitor-card.tsx"
      via: "last_scraped_at and scrape_status threaded through CompetitorCardData"
      pattern: "last_scraped_at.*profile\\.last_scraped_at"
---

<objective>
Wire stale data indicators and error states into all competitor views: dashboard cards, leaderboard table, detail page header, and comparison page.

Purpose: The building blocks from plan 07-01 (StaleIndicator, ScrapeErrorBanner, retryScrape, formatRelativeTime, isStale) exist but are not yet visible anywhere. This plan threads the `last_scraped_at` and `scrape_status` data through all component interfaces and renders the indicators in every competitor view, satisfying requirements UI-03 and UI-04.

Output: 6 modified files -- stale/error indicators visible on dashboard cards, table rows, detail header, and comparison page.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-polish-edge-cases/07-01-SUMMARY.md
@src/components/competitors/competitor-card.tsx
@src/components/competitors/competitor-table.tsx
@src/app/(app)/competitors/competitors-client.tsx
@src/components/competitors/detail/detail-header.tsx
@src/app/(app)/competitors/[handle]/page.tsx
@src/app/(app)/competitors/compare/comparison-client.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend CompetitorCardData, thread data in client, update card and table views</name>
  <files>
    src/components/competitors/competitor-card.tsx
    src/app/(app)/competitors/competitors-client.tsx
    src/components/competitors/competitor-table.tsx
  </files>
  <action>
**competitor-card.tsx** -- Extend the `CompetitorCardData` interface with two new fields:
```typescript
last_scraped_at: string | null;
scrape_status: string | null;
```
Add them after `video_count` and before `snapshots`.

Import `StaleIndicator` from `@/components/competitors/stale-indicator` and `{ formatRelativeTime, isStale }` from `@/lib/competitors-utils`.

In the card JSX, add the stale indicator below the display_name (inside the `min-w-0 flex-1` div), right after the display_name paragraph:
```tsx
<StaleIndicator lastScrapedAt={data.last_scraped_at} />
```

When `data.scrape_status === "failed"`, show a small inline error badge next to the handle. Add after the stale indicator:
```tsx
{data.scrape_status === "failed" && (
  <span className="text-[10px] text-red-400 font-medium">Scrape failed</span>
)}
```

Note: CompetitorCard is a "use client" component so StaleIndicator (server component) will be rendered inside it. Since StaleIndicator accepts only serializable props and renders a plain `<span>`, this is safe -- it becomes a client-rendered component in this context.

**competitors-client.tsx** -- In the `.map()` that builds `cards`, add the two new fields:
```typescript
last_scraped_at: profile.last_scraped_at,
scrape_status: profile.scrape_status,
```
These fields already exist in the `CompetitorRow.competitor_profiles` interface (both already defined as `string | null`). No interface changes needed in competitors-client.tsx.

**competitor-table.tsx** -- Add a Status column to the table:
- Import `StaleIndicator` from `@/components/competitors/stale-indicator` and `{ isStale }` from `@/lib/competitors-utils`
- Add a new non-sortable `<th>` header "Status" after the "Trend" column header:
  ```tsx
  <th className="py-3 px-4 text-right font-medium text-foreground-muted text-xs">
    Status
  </th>
  ```
- In each table row, add a corresponding `<td>` after the Trend cell:
  ```tsx
  <td className="py-3 px-4 text-right">
    {s.scrape_status === "failed" ? (
      <span className="text-[10px] text-red-400 font-medium">Failed</span>
    ) : (
      <StaleIndicator lastScrapedAt={s.last_scraped_at} />
    )}
  </td>
  ```
  The `s` variable already has `last_scraped_at` and `scrape_status` from the extended `CompetitorCardData` type.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm all types align.
Verify the new fields flow from competitors-client.tsx -> CompetitorCardData -> card/table components.
  </verify>
  <done>
Dashboard card grid shows stale indicators below handle and error badge when scrape failed. Table view shows a Status column with stale indicator or "Failed" badge. Data flows from server page through client wrapper to both views.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add stale indicator and error banner to detail header and comparison page</name>
  <files>
    src/components/competitors/detail/detail-header.tsx
    src/app/(app)/competitors/[handle]/page.tsx
    src/app/(app)/competitors/compare/comparison-client.tsx
  </files>
  <action>
**detail-header.tsx** -- This is a server component. Add stale indicator and error banner:

Import `StaleIndicator` from `@/components/competitors/stale-indicator` and `ScrapeErrorBanner` from `@/components/competitors/scrape-error-banner`.

Add StaleIndicator below the bio paragraph (or below display_name if no bio), inside the profile info div (`min-w-0 flex-1`):
```tsx
<div className="mt-1">
  <StaleIndicator lastScrapedAt={profile.last_scraped_at} />
</div>
```

The `profile` is `Tables<"competitor_profiles">` which already includes `last_scraped_at` and `scrape_status` from the database types.

When `profile.scrape_status === "failed"`, render the ScrapeErrorBanner between the profile info div and the stats row:
```tsx
{profile.scrape_status === "failed" && (
  <div className="mb-4">
    <ScrapeErrorBanner handle={profile.tiktok_handle} />
  </div>
)}
```

Note: DetailHeader is a server component. ScrapeErrorBanner is a client component -- this is valid in Next.js (server renders client components as children).

**[handle]/page.tsx** -- No changes needed. The detail page already fetches `profile` via `select("*")` which includes `last_scraped_at` and `scrape_status`, and passes the full profile to `DetailHeader`. The types already align.

**comparison-client.tsx** -- Add stale indicators under each competitor in the comparison view:

Import `StaleIndicator` from `@/components/competitors/stale-indicator`.

Update the `ComparisonClientProps` interface to include `lastScrapedAtA` and `lastScrapedAtB` as `string | null`. However, looking at the data flow -- `ComparisonData` comes from the server page.tsx. Instead of modifying the type chain, add `lastScrapedAt` to the `ComparisonData` type in `compare/page.tsx`.

Actually, check: the comparison page `page.tsx` already does `select("*")` to get profiles, so `last_scraped_at` is available. Thread it through:

1. In `compare/page.tsx`, add `lastScrapedAt: string | null` to the `ComparisonData` type export, and set it from `profile.last_scraped_at` when building the ComparisonData objects.

2. In `comparison-client.tsx`, render a StaleIndicator under each selector:
   After the `<ComparisonSelector>` for side A, add:
   ```tsx
   {dataA && <StaleIndicator lastScrapedAt={dataA.lastScrapedAt} />}
   ```
   After the `<ComparisonSelector>` for side B, add:
   ```tsx
   {dataB && <StaleIndicator lastScrapedAt={dataB.lastScrapedAt} />}
   ```
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm all types align.
Verify detail page renders stale indicator under handle and error banner above stats when scrape_status is "failed".
Verify comparison page shows stale indicators under each competitor selector.
  </verify>
  <done>
Detail page header shows stale indicator with relative time and ScrapeErrorBanner with retry button when scrape failed. Comparison page shows stale indicators under each competitor selector. All views satisfy UI-03 (stale indicators) and UI-04 (error states with retry).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Dashboard cards show "Updated {time}" below handle -- amber when >48h, muted when fresh
3. Dashboard cards show "Scrape failed" badge when scrape_status is "failed"
4. Dashboard table has "Status" column showing stale indicator or "Failed" badge
5. Detail page header shows stale indicator next to profile info
6. Detail page shows error banner with retry button when scrape_status is "failed"
7. Comparison page shows stale indicator under each competitor selector
</verification>

<success_criteria>
All competitor views (dashboard cards, table, detail header, comparison) display stale data indicators showing last refresh time. Failed scrapes show error state with retry on the detail page. Requirements UI-03 and UI-04 are fully satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-edge-cases/07-02-SUMMARY.md`
</output>
