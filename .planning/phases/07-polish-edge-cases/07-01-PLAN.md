---
phase: 07-polish-edge-cases
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/competitors-utils.ts
  - src/components/competitors/stale-indicator.tsx
  - src/app/actions/competitors/retry-scrape.ts
  - src/components/competitors/scrape-error-banner.tsx
autonomous: true

must_haves:
  truths:
    - "formatRelativeTime returns human-readable relative time string for any ISO date or null"
    - "isStale returns true when last_scraped_at is null or older than 48 hours"
    - "StaleIndicator renders relative time with warning color when stale"
    - "retryScrape server action re-scrapes a competitor profile and updates scrape_status"
    - "ScrapeErrorBanner shows error message with retry button that calls retryScrape"
  artifacts:
    - path: "src/lib/competitors-utils.ts"
      provides: "formatRelativeTime and isStale utility functions"
      contains: "formatRelativeTime"
    - path: "src/components/competitors/stale-indicator.tsx"
      provides: "Reusable stale data indicator component"
      contains: "StaleIndicator"
    - path: "src/app/actions/competitors/retry-scrape.ts"
      provides: "Server action for retry scraping a single competitor"
      exports: ["retryScrape"]
    - path: "src/components/competitors/scrape-error-banner.tsx"
      provides: "Error state banner with retry button"
      contains: "ScrapeErrorBanner"
  key_links:
    - from: "src/components/competitors/stale-indicator.tsx"
      to: "src/lib/competitors-utils.ts"
      via: "import formatRelativeTime, isStale"
      pattern: "import.*formatRelativeTime.*competitors-utils"
    - from: "src/components/competitors/scrape-error-banner.tsx"
      to: "src/app/actions/competitors/retry-scrape.ts"
      via: "import retryScrape server action"
      pattern: "import.*retryScrape"
    - from: "src/app/actions/competitors/retry-scrape.ts"
      to: "src/lib/scraping"
      via: "createScrapingProvider for re-scraping"
      pattern: "createScrapingProvider"
---

<objective>
Create the foundational utility functions and reusable components for stale data indication and scrape error recovery.

Purpose: Phase 7 requires stale indicators and error states across all competitor views. This plan creates the shared building blocks: utility functions (formatRelativeTime, isStale), a reusable StaleIndicator component, a retryScrape server action, and a ScrapeErrorBanner client component. Plan 07-02 will wire these into all views.

Output: 4 files -- 2 utility functions in competitors-utils.ts, StaleIndicator component, retryScrape server action, ScrapeErrorBanner component.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/competitors-utils.ts
@src/app/api/cron/refresh-competitors/route.ts
@src/app/actions/competitors/add.ts
@src/lib/scraping/index.ts
@src/lib/supabase/service.ts
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add formatRelativeTime and isStale utilities + create StaleIndicator component</name>
  <files>
    src/lib/competitors-utils.ts
    src/components/competitors/stale-indicator.tsx
  </files>
  <action>
Add two pure functions to the bottom of `src/lib/competitors-utils.ts`:

1. `formatRelativeTime(isoDate: string | null): string` -- converts an ISO date string to a human-readable relative time string:
   - null input returns "Never"
   - Less than 1 hour: "Just now"
   - Less than 24 hours: "{N}h ago"
   - Less than 7 days: "{N}d ago"
   - 7+ days: "{N}w ago"
   Uses `Date.now() - new Date(isoDate).getTime()` for calculation. No external dependencies (matches zero new npm packages constraint).

2. `isStale(isoDate: string | null): boolean` -- returns true when data is considered stale:
   - null returns true (never scraped = stale)
   - Returns true when elapsed time exceeds 48 hours (48 * 60 * 60 * 1000 ms)

Both functions must be exported.

Create `src/components/competitors/stale-indicator.tsx` as a **server component** (no "use client"):
- Accepts props: `{ lastScrapedAt: string | null }`
- Imports `formatRelativeTime` and `isStale` from `@/lib/competitors-utils`
- Renders a `<span>` with `text-xs` base styling
- When stale: use `text-amber-400` color class
- When fresh: use `text-foreground-muted` color class
- Text content: `Updated {formatRelativeTime(lastScrapedAt)}`
- Export as named export `StaleIndicator`
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors in both files.
Visually verify the imports resolve by checking the import paths.
  </verify>
  <done>
formatRelativeTime returns correct relative time strings for null, recent, hours-old, days-old, and weeks-old dates. isStale correctly identifies dates older than 48h. StaleIndicator renders with appropriate color based on staleness.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create retryScrape server action and ScrapeErrorBanner component</name>
  <files>
    src/app/actions/competitors/retry-scrape.ts
    src/components/competitors/scrape-error-banner.tsx
  </files>
  <action>
Create `src/app/actions/competitors/retry-scrape.ts` as a server action:
- "use server" directive at top
- Import `revalidatePath` from `next/cache`, `createClient` from `@/lib/supabase/server`, `createServiceClient` from `@/lib/supabase/service`, `createScrapingProvider` from `@/lib/scraping`
- Export async function `retryScrape(handle: string): Promise<{ error?: string }>`
- Auth check: `createClient()` -> `getUser()` -> return `{ error: "Not authenticated" }` if no user
- Verify competitor exists: query `competitor_profiles` by `tiktok_handle === handle` using user client, return `{ error: "Competitor not found" }` if not found
- Use service client for the update (bypasses RLS)
- Create scraping provider and call `scraper.scrapeProfile(handle)`
- On success: update `competitor_profiles` with fresh data (display_name, bio, avatar_url, verified, follower_count, following_count, heart_count, video_count, last_scraped_at = new Date().toISOString(), scrape_status = "success"). Match the exact same field mapping pattern used in `refresh-competitors/route.ts`.
- Also upsert a daily snapshot to `competitor_snapshots` with `onConflict: "competitor_id,snapshot_date"` using the fresh metrics and today's date (`new Date().toISOString().split("T")[0]`).
- Call `revalidatePath("/competitors")` and `revalidatePath(\`/competitors/${handle}\`)` after successful update
- On catch: return `{ error: "Scrape failed -- please try again later" }`
- Profile-only retry (matches cron behavior, no video re-scrape per research recommendation)

Create `src/components/competitors/scrape-error-banner.tsx` as a **client component**:
- "use client" directive
- Import `useTransition` from "react" and `retryScrape` from `@/app/actions/competitors/retry-scrape`
- Props: `{ handle: string }` (no callback prop -- directly calls the server action)
- Use `useTransition` for the retry action (not useState + async)
- Render a div with: `border border-red-500/20 bg-red-500/[0.05] rounded-lg p-3 flex items-center justify-between`
- Left side: "Data refresh failed" in `text-sm text-red-400`
- Right side: retry button with `text-xs font-medium px-3 py-1.5 rounded-lg border border-white/[0.06] text-foreground hover:bg-white/[0.02] disabled:opacity-50 transition-colors`
- Button text: "Retrying..." when isPending, "Retry" otherwise
- onClick: `startTransition(async () => { await retryScrape(handle); })`
- Export as named export `ScrapeErrorBanner`
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors.
Verify the server action file has "use server" directive and the banner has "use client" directive.
Verify the retryScrape action follows the same pattern as refresh-competitors/route.ts for profile updates.
  </verify>
  <done>
retryScrape server action authenticates user, scrapes fresh profile data via Apify, updates competitor_profiles with fresh metrics and scrape_status="success", upserts daily snapshot, and revalidates affected paths. ScrapeErrorBanner renders error state with retry button that calls the server action via useTransition.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. formatRelativeTime handles: null -> "Never", <1h -> "Just now", 5h -> "5h ago", 3d -> "3d ago", 14d -> "2w ago"
3. isStale handles: null -> true, now -> false, 49h ago -> true, 1h ago -> false
4. StaleIndicator is a server component (no "use client") that renders with correct color
5. retryScrape follows the same update pattern as refresh-competitors cron route
6. ScrapeErrorBanner is a client component using useTransition for retry
</verification>

<success_criteria>
All 4 new exports (formatRelativeTime, isStale, StaleIndicator, retryScrape, ScrapeErrorBanner) compile without errors and are ready to be wired into views by plan 07-02.
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-edge-cases/07-01-SUMMARY.md`
</output>
