---
phase: 46-forms-modals
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/app/content-form.tsx
  - src/components/app/survey-form.tsx
autonomous: true

must_haves:
  truths:
    - "ContentForm textarea uses GlassTextarea with autoResize instead of raw textarea"
    - "SurveyForm question textarea uses GlassTextarea instead of raw textarea"
    - "SurveyForm option inputs use GlassInput instead of raw inputs"
    - "SurveyForm question type dropdown uses design system Select instead of Radix DropdownMenu"
    - "Both forms validate on blur and on submit with inline error text below invalid fields"
    - "Submit buttons use Button variant=primary with loading prop during submission"
    - "Character counter appears on textareas when within 20% of max length"
    - "All hardcoded zinc/orange colors replaced with design tokens"
  artifacts:
    - path: "src/components/app/content-form.tsx"
      provides: "Content form using GlassTextarea + Button + Zod validation"
      contains: "GlassTextarea"
    - path: "src/components/app/survey-form.tsx"
      provides: "Survey form using GlassInput + GlassTextarea + Select + Button + Zod validation"
      contains: "GlassInput"
  key_links:
    - from: "src/components/app/content-form.tsx"
      to: "@/components/primitives/GlassTextarea"
      via: "import"
      pattern: "GlassTextarea"
    - from: "src/components/app/content-form.tsx"
      to: "@/components/ui/button"
      via: "import"
      pattern: "Button.*variant.*primary"
    - from: "src/components/app/survey-form.tsx"
      to: "@/components/ui/select"
      via: "import replacing DropdownMenu"
      pattern: "Select.*options"
    - from: "src/components/app/survey-form.tsx"
      to: "@/components/primitives/GlassInput"
      via: "import"
      pattern: "GlassInput"
---

<objective>
Migrate ContentForm and SurveyForm to design system components with Zod v4 validation.

Purpose: Replace all raw HTML form elements and hardcoded styles with GlassTextarea, GlassInput, Select, and Button from the design system. Add on-blur + on-submit validation with inline error text. This covers FORM-01, FORM-02, FORM-04, FORM-05.
Output: Two fully migrated form components using design system primitives with consistent validation, focus rings, error states, and submit loading states.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-forms-modals/46-CONTEXT.md
@.planning/phases/46-forms-modals/46-RESEARCH.md

@src/components/app/content-form.tsx
@src/components/app/survey-form.tsx
@src/components/app/test-creation-flow.tsx
@src/components/primitives/GlassTextarea.tsx
@src/components/primitives/GlassInput.tsx
@src/components/ui/select.tsx
@src/components/ui/button.tsx
@src/lib/test-types.ts
@src/types/test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate ContentForm to design system components with Zod validation</name>
  <files>src/components/app/content-form.tsx</files>
  <action>
**Step 1: Read current component**
Read `src/components/app/content-form.tsx` to understand:
- Props interface (`onSubmit`, `onChangeType`, `isViewingHistory`, `currentResult`)
- Business logic in `handleSubmit`
- State variables (`content`, etc.)
- The `iconMap` record and icon rendering
- The `isViewingHistory` read-only behavior and `currentResult` pre-fill logic

**Step 2: Read design system components**
Read these files to understand their APIs:
- `src/components/primitives/GlassTextarea.tsx` — props: `size`, `error` (boolean), `autoResize`, `minRows`, `maxRows`, `className`, `style`
- `src/components/ui/button.tsx` — props: `variant` ("primary"|"secondary"|"ghost"|"destructive"), `size` ("sm"|"md"|"lg"), `loading` (boolean), `asChild`
- `src/components/ui/select.tsx` — props: `options` (SelectOption[]), `value`, `onChange`, `placeholder`, `disabled`, `size`, `error`

**Step 3: Generate via v0**
Load the v0 MCP tool via ToolSearch (query: "select:mcp__v0__v0_generate_ui"), then call `mcp__v0__v0_generate_ui` with a prompt that includes:

- The full current content-form.tsx code (or a summary of its structure, props, state, handlers)
- The design system component APIs listed above (GlassTextarea props, Button props)
- Brand bible context: dark theme (bg-base #0A0A0B), glass surfaces (surface-elevated), coral accent (#E57850), Satoshi body font, border-border tokens, text-foreground/text-foreground-secondary/text-foreground-muted tokens
- Requirements:
  - Replace raw `<textarea>` with `<GlassTextarea autoResize size="md" />` — delete any manual `useEffect` height calculation
  - Replace submit button with `<Button variant="primary" loading={isSubmitting}>Simulate</Button>`
  - Replace type selector badge button with `<Button variant="secondary" size="sm">`
  - Replace "Upload Images" and "Help Me Craft" buttons with `<Button variant="secondary" size="sm">`
  - Add Zod v4 validation schema: `z.object({ content: z.string().min(1, { error: "Required" }).min(10, { error: "At least 10 characters" }) })`
  - Add `errors` state, `validateField` (on blur via `safeParse`), `validateForm` (on submit)
  - After first error, re-validate on change to clear error when valid
  - Show error text below textarea: `<p className="text-sm text-error" role="alert">`
  - Character counter below textarea: show when `content.length >= MAX_LENGTH * 0.8` (MAX_LENGTH=500), format `{len}/{max}`, `text-foreground-muted` or `text-error` when at/over limit
  - Replace ALL hardcoded colors: `border-zinc-*` -> `border-border`, `bg-zinc-*` -> `bg-surface`, `text-zinc-*` -> `text-foreground-secondary`/`text-foreground-muted`, `bg-orange-*` -> use Button primary, `text-white` -> `text-foreground`
- What to preserve: `iconMap`, `isViewingHistory` behavior, `currentResult` pre-fill, `onChangeType`/`onSubmit` props interface, all business logic in `handleSubmit`, Lucide icons (icon migration is separate scope)

**Step 4: Integrate v0 output**
Write v0's generated code to `src/components/app/content-form.tsx`, then manually adjust:
- Fix import paths: `GlassTextarea` from `@/components/primitives/GlassTextarea`, `Button` from `@/components/ui/button`, `z` from `zod`
- Re-wire the `onSubmit` callback, `onChangeType` prop, and `isViewingHistory`/`currentResult` logic if v0 didn't preserve them exactly
- Ensure `handleSubmit` business logic is intact (v0 may have simplified it)
- Verify `iconMap` is preserved with correct Lucide imports
- Add `isSubmitting` state wired to the existing submit flow

**Step 5: Verify**
Run `npx tsc --noEmit`. Grep for `bg-zinc`, `border-zinc`, `text-zinc`, `bg-orange` in content-form.tsx — must return zero. Grep for `GlassTextarea` and `Button` to confirm design system imports.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors. Grep for `bg-zinc`, `border-zinc`, `text-zinc`, `bg-orange` in content-form.tsx to confirm zero hardcoded colors. Grep for `GlassTextarea` and `Button` to confirm design system imports.
  </verify>
  <done>
ContentForm uses GlassTextarea (with autoResize) for content input, Button (primary) for submit with loading state, Button (secondary) for action buttons. Zod v4 validation on blur + submit with inline error text. Character counter at 80%+ of max. All hardcoded colors replaced with design tokens. No TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate SurveyForm to design system components with Zod validation</name>
  <files>src/components/app/survey-form.tsx</files>
  <action>
**Step 1: Read current component**
Read `src/components/app/survey-form.tsx` to understand:
- `SurveySubmission` interface and `QuestionType` type (exported — other components depend on these)
- The `QuestionTypeDropdown` sub-component (will be deleted, replaced by Select)
- State: `question`, `questionType`, `options`, `isViewingHistory`
- Option management callbacks: `addOption`, `removeOption`, `updateOption`
- Business logic in `handleSubmit`
- Radix `DropdownMenu` import (to be removed)

**Step 2: Read design system components**
Read:
- `src/components/ui/select.tsx` — `Select` props: `options` (SelectOption[]), `value`, `onChange`, `placeholder`, `disabled`, `size`, `error`
- `src/components/primitives/GlassInput.tsx` — props: `size`, `error`, `loading`, `leftIcon`, `rightIcon`, `showClear`, `onClear`
- `src/components/primitives/GlassTextarea.tsx` — props: `size`, `error`, `autoResize`, `minRows`, `maxRows`
- `src/components/ui/button.tsx` — props: `variant`, `size`, `loading`, `asChild`

**Step 3: Generate via v0**
Call `mcp__v0__v0_generate_ui` (already loaded from Task 1) with a prompt including:

- The full current survey-form.tsx code (or summary of structure/state/handlers)
- Design system APIs: Select (options, value, onChange, placeholder, disabled), GlassInput (size, error), GlassTextarea (autoResize, size, error), Button (variant, size, loading)
- Brand bible context: same dark theme tokens as Task 1
- Requirements:
  - Replace question `<textarea>` with `<GlassTextarea autoResize size="md" />`
  - Replace each option `<input>` with `<GlassInput size="sm" />`
  - DELETE the entire `QuestionTypeDropdown` component. Remove `import * as DropdownMenu from "@radix-ui/react-dropdown-menu"`. Replace with:
    ```tsx
    const QUESTION_TYPE_OPTIONS = [
      { value: "single-select", label: "Single Select" },
      { value: "open-response", label: "Open Response" },
    ];
    <Select options={QUESTION_TYPE_OPTIONS} value={questionType} onChange={(val) => setQuestionType(val as QuestionType)} placeholder="Select question type..." />
    ```
  - When `isViewingHistory`, pass `disabled` to Select
  - Replace submit button with `<Button variant="primary" loading={isSubmitting}>Ask</Button>`
  - Replace add/remove option buttons with `<Button variant="ghost" size="sm">`
  - Add Zod v4 schema: `z.object({ question: z.string().min(1, { error: "Required" }).min(5, { error: "At least 5 characters" }) })`
  - Validate question on blur and submit with inline error text
  - Replace ALL hardcoded colors: same token mapping as Task 1 plus `focus-visible:ring-indigo-500` -> design system focus ring, `text-indigo-500` -> `text-accent`
- What to preserve: `SurveySubmission` interface, `QuestionType` type, all option callbacks, `isViewingHistory` behavior, `GripVertical` drag handle, all `handleSubmit` logic

**Step 4: Integrate v0 output**
Write v0's generated code to `src/components/app/survey-form.tsx`, then manually adjust:
- Fix import paths: `Select` from `@/components/ui/select`, `GlassInput` from `@/components/primitives/GlassInput`, `GlassTextarea` from `@/components/primitives/GlassTextarea`, `Button` from `@/components/ui/button`, `z` from `zod`
- Ensure `SurveySubmission` interface and `QuestionType` type are exported (other files import them)
- Re-wire option management callbacks if v0 altered them
- Ensure `handleSubmit` preserves all existing business logic
- Confirm Radix DropdownMenu import and QuestionTypeDropdown component are fully removed
- Add `isSubmitting` state wired to existing submit flow

**Step 5: Verify**
Run `npx tsc --noEmit`. Grep for `DropdownMenu` — must return zero. Grep for `Select`, `GlassTextarea`, `GlassInput`, `Button` — must find them. Grep for `bg-zinc`, `border-zinc`, `text-zinc`, `bg-orange`, `text-indigo` — must return zero.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors. Grep for `DropdownMenu` in survey-form.tsx to confirm Radix dropdown is removed. Grep for `Select` to confirm design system Select is used. Grep for `GlassTextarea`, `GlassInput`, `Button` to confirm design system imports. Grep for `bg-zinc`, `border-zinc`, `text-zinc`, `bg-orange`, `text-indigo` to confirm zero hardcoded colors.
  </verify>
  <done>
SurveyForm uses GlassTextarea for question input, GlassInput for option inputs, Select for question type dropdown (replacing Radix DropdownMenu), Button (primary) for submit with loading state. Zod v4 validation on question field. QuestionTypeDropdown component deleted. All hardcoded colors replaced with design tokens. SurveySubmission interface preserved. No TypeScript errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `grep -c "bg-zinc\|border-zinc\|text-zinc\|bg-orange\|text-indigo" src/components/app/content-form.tsx src/components/app/survey-form.tsx` returns 0 for both files
3. `grep -c "GlassTextarea" src/components/app/content-form.tsx` returns >= 1
4. `grep -c "GlassInput" src/components/app/survey-form.tsx` returns >= 1
5. `grep -c "Select" src/components/app/survey-form.tsx` returns >= 1 (design system Select)
6. `grep -c "DropdownMenu" src/components/app/survey-form.tsx` returns 0 (Radix removed)
7. `grep -c "Button" src/components/app/content-form.tsx src/components/app/survey-form.tsx` returns >= 2 each
8. `grep -c "z\.string\|safeParse\|zod" src/components/app/content-form.tsx src/components/app/survey-form.tsx` returns >= 1 each
9. `npm run build` completes without errors
</verification>

<success_criteria>
- ContentForm uses GlassTextarea, Button (primary/secondary), Zod v4 validation with inline errors, character counter
- SurveyForm uses GlassTextarea, GlassInput, Select (replacing Radix DropdownMenu), Button, Zod v4 validation
- All form inputs show consistent focus rings (from design system primitives)
- Error text appears below invalid fields on blur and submit
- Submit buttons show loading state during submission
- Zero hardcoded color classes remain
- No TypeScript errors
- test-creation-flow.tsx continues to work without changes (props interfaces preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/46-forms-modals/46-01-SUMMARY.md`
</output>
