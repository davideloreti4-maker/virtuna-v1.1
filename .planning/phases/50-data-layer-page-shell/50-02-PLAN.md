---
phase: 50-data-layer-page-shell
plan: 02
type: execute
wave: 2
depends_on: ["50-01"]
files_modified:
  - src/app/(app)/trending/page.tsx
  - src/app/(app)/trending/trending-client.tsx
  - src/components/app/sidebar.tsx
autonomous: false

must_haves:
  truths:
    - "User can navigate to /trending via sidebar nav item and sees a 'Trending' heading"
    - "Three category tabs render with coral accent on the active tab"
    - "Switching tabs filters content client-side without page reload"
    - "Active tab syncs with URL search params (/trending?tab=breaking-out)"
    - "Browser back/forward updates the active tab"
    - "Stats bar shows category counts and aggregate metrics"
    - "Brief skeleton flash appears when switching tabs"
    - "Empty tab state shows illustrated message when a category has no videos"
  artifacts:
    - path: "src/app/(app)/trending/page.tsx"
      provides: "Server component: metadata, searchParams validation, Suspense boundary"
      exports: ["default", "metadata"]
      min_lines: 20
    - path: "src/app/(app)/trending/trending-client.tsx"
      provides: "Client component: tabs, URL sync, stats bar, skeleton states, empty states"
      exports: ["TrendingClient"]
      min_lines: 100
    - path: "src/components/app/sidebar.tsx"
      provides: "Trending nav item in sidebar"
      contains: "TrendingUp"
  key_links:
    - from: "src/app/(app)/trending/page.tsx"
      to: "src/app/(app)/trending/trending-client.tsx"
      via: "import { TrendingClient }"
      pattern: "import.*TrendingClient.*from.*trending-client"
    - from: "src/app/(app)/trending/trending-client.tsx"
      to: "src/lib/trending-mock-data.ts"
      via: "import { getVideosByCategory, getTrendingStats }"
      pattern: "import.*from.*@/lib/trending-mock-data"
    - from: "src/app/(app)/trending/trending-client.tsx"
      to: "src/types/trending.ts"
      via: "import type { TrendingCategory, ValidTab }"
      pattern: "import type.*from.*@/types/trending"
    - from: "src/components/app/sidebar.tsx"
      to: "/trending route"
      via: "router.push('/trending')"
      pattern: "router\\.push.*trending"
---

<objective>
Build the /trending page route with server/client component split, sidebar navigation, category tabs synced to URL, stats bar, and skeleton/empty states.

Purpose: Create the complete page shell that users interact with -- the visual and interactive foundation that video cards and detail modal will build on in Phases 51-52.

Output: Server page component, client shell component with tabs/stats/states, and sidebar nav item.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-data-layer-page-shell/50-CONTEXT.md
@.planning/phases/50-data-layer-page-shell/50-RESEARCH.md
@.planning/phases/50-data-layer-page-shell/50-01-SUMMARY.md

Reference files (read for patterns, do not modify):
@src/app/(app)/settings/page.tsx (server component pattern with searchParams)
@src/components/app/sidebar.tsx (nav item pattern)
@src/components/app/sidebar-nav-item.tsx (SidebarNavItem API)
@src/components/ui/category-tabs.tsx (CategoryTabs API)
@src/components/ui/tabs.tsx (TabsTrigger styling, TabsContent)
@src/components/ui/typography.tsx (Heading component API)
@src/components/ui/skeleton.tsx (Skeleton component)
@src/components/app/app-shell.tsx (AppShell layout structure)
@src/app/(app)/layout.tsx (route group layout)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server page component and add sidebar nav item</name>
  <files>src/app/(app)/trending/page.tsx, src/components/app/sidebar.tsx</files>
  <action>
**A. Create `src/app/(app)/trending/page.tsx`** (server component):

Follow the exact pattern from `src/app/(app)/settings/page.tsx`:

```typescript
import type { Metadata } from "next";
import { Suspense } from "react";
import { TrendingClient } from "./trending-client";
import { VALID_TABS, type ValidTab } from "@/types/trending";

export const metadata: Metadata = {
  title: "Trending | Virtuna",
  description: "Discover trending TikTok videos across categories",
};

interface PageProps {
  searchParams: Promise<{ tab?: string }>;
}

export default async function TrendingPage({ searchParams }: PageProps) {
  const params = await searchParams;
  const tabParam = params.tab || "";
  const defaultTab: ValidTab = VALID_TABS.includes(tabParam as ValidTab)
    ? (tabParam as ValidTab)
    : "breaking-out";

  return (
    <Suspense fallback={<TrendingPageSkeleton />}>
      <TrendingClient defaultTab={defaultTab} />
    </Suspense>
  );
}
```

Include a `TrendingPageSkeleton` function component that renders a skeleton matching the page layout shape:
- Max-width container (1280px), centered, padding
- Skeleton for the heading (h-8 w-48)
- Skeleton for stats bar (h-5 w-full max-w-lg, mt-3)
- Skeleton for tab bar (h-10 w-80, mt-6)
- Grid of 6 skeleton cards (3 cols, each h-64 rounded-xl, mt-8)

**B. Add sidebar nav item to `src/components/app/sidebar.tsx`:**

1. Add import: `import { TrendingUp } from "lucide-react";`
2. In the bottom `<nav>` section, add a Trending nav item BEFORE "Manage plan" (it's a primary navigation feature, not a utility):

```tsx
<SidebarNavItem
  label="Trending"
  icon={TrendingUp}
  onClick={() => {
    router.push("/trending");
    onMobileOpenChange?.(false);
  }}
/>
```

Add it right before the "Manage plan" SidebarNavItem, after the separator line and `<nav>` opening tag. This keeps primary features at the top of the bottom nav.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Navigate to `http://localhost:3000/trending` -- page renders (even if TrendingClient doesn't exist yet, the skeleton fallback should show)
3. Sidebar shows "Trending" nav item with TrendingUp icon
4. Clicking "Trending" in sidebar navigates to /trending
  </verify>
  <done>Server page component exists at /trending route with metadata, searchParams validation, and Suspense boundary. Sidebar has Trending nav item.</done>
</task>

<task type="auto">
  <name>Task 2: Create trending client component with tabs, URL sync, stats bar, and loading states</name>
  <files>src/app/(app)/trending/trending-client.tsx</files>
  <action>
Create `src/app/(app)/trending/trending-client.tsx` as a `"use client"` component.

**Imports needed:**
- `useState`, `useEffect`, `useCallback`, `Suspense` from "react"
- `useSearchParams` from "next/navigation"
- `Heading, Text, Caption` from `@/components/ui/typography`
- `CategoryTabs, TabsContent` from `@/components/ui/category-tabs`
- `Skeleton` from `@/components/ui/skeleton`
- `getVideosByCategory, getTrendingStats` from `@/lib/trending-mock-data`
- `CATEGORY_LABELS, VALID_TABS` from `@/types/trending`
- Type imports: `TrendingCategory, ValidTab, TrendingStats`
- `TrendingUp, Inbox` from "lucide-react" (for empty state icon)

**Props interface:**
```typescript
interface TrendingClientProps {
  defaultTab: ValidTab;
}
```

**Component structure:**

```tsx
export function TrendingClient({ defaultTab }: TrendingClientProps) {
```

**1. Tab state with URL sync:**
- Use `useSearchParams()` to read current tab from URL
- Maintain local `activeTab` state initialized from `searchParams.get("tab") ?? defaultTab`
- `handleTabChange(value: string)`: sets `isLoading(true)`, updates local state, calls `window.history.pushState(null, "", `/trending?tab=${value}`)`, then `setTimeout(() => setIsLoading(false), 250)` for skeleton flash
- Add `useEffect` listening to `popstate` event to sync local tab state when user presses browser back/forward: read URL param, validate, update local state

**2. Stats bar:**
- Call `getTrendingStats()` to get stats (memoize with useMemo or just call at render -- it's cheap)
- Render a stats row below the heading with:
  - Category counts: "Breaking Out (14) 路 Trending Now (14) 路 Rising Again (14)"
  - Aggregate: "42 videos 路 156.2M total views"
- Format view counts with a helper: `formatCompactNumber(n)` that returns "1.2M", "450K", etc.
- Stats bar always visible, even when loading or empty tab -- no layout shift (per CONTEXT.md)
- Use `Text` component with `size="sm"` and `muted` for the stats, separated by `路` (middle dot)

**3. Category tabs:**
- Define categories array:
  ```typescript
  const categories = [
    { value: "breaking-out", label: "Breaking Out" },
    { value: "trending-now", label: "Trending Now" },
    { value: "rising-again", label: "Rising Again" },
  ];
  ```
- Use `CategoryTabs` in controlled mode: `value={activeTab}` and `onValueChange={handleTabChange}`
- Wrap tabs in a sticky container:
  ```tsx
  <div className="sticky top-0 z-10 bg-background/80 pb-3 pt-2" style={{ backdropFilter: 'blur(12px)', WebkitBackdropFilter: 'blur(12px)' }}>
  ```
  (Use inline styles for backdrop-filter per project memory -- Lightning CSS strips it from classes)

**4. Tab content -- coral accent styling:**
- The active tab needs coral accent. Override the default glass pill style by passing a custom className to CategoryTabs that targets the active state. Since CategoryTabs renders TabsTrigger with `className="shrink-0"`, add a wrapper `className` on the CategoryTabs root or wrap in a div with CSS that targets `[data-state=active]`:
  ```tsx
  <CategoryTabs
    categories={categories}
    value={activeTab}
    onValueChange={handleTabChange}
    className="[&_[role=tab][data-state=active]]:bg-accent/10 [&_[role=tab][data-state=active]]:text-accent [&_[role=tab][data-state=active]]:border-accent/20"
  >
  ```

**5. Tab content areas:**
- For each category, render a `TabsContent` with `value={category.value}`
- Inside each TabsContent:
  - If `isLoading`: show `<SkeletonGrid />` (6 skeleton cards in a 3-col grid)
  - If no videos for this category: show `<EmptyState category={category.label} />`
  - Otherwise: show a placeholder message like "X videos ready for cards" (Phase 51 will add VideoCard grid here). Render a simple list/count for now -- the grid slot where video cards will go.

**6. Layout container:**
- Wrap everything in: `<div className="mx-auto max-w-[1280px] px-6 py-8 md:px-8">`
- Heading: `<Heading level={1} size={3}>Trending</Heading>` (h1 semantics, h3 visual size -- 24px, medium weight)
- Stats bar: below heading with `mt-2`
- Tabs: below stats bar with `mt-6`
- Content: inside TabsContent with `mt-0` (TabsContent already has mt-4)

**7. Helper components (defined in the same file):**

`SkeletonGrid`: renders 6 skeleton cards in CSS grid:
```tsx
function SkeletonGrid() {
  return (
    <div className="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-3">
      {Array.from({ length: 6 }).map((_, i) => (
        <div key={i} className="space-y-3">
          <Skeleton className="h-52 w-full rounded-xl" />
          <Skeleton className="h-4 w-3/4" />
          <Skeleton className="h-3 w-1/2" />
        </div>
      ))}
    </div>
  );
}
```

`EmptyState`: icon + message:
```tsx
function EmptyState({ category }: { category: string }) {
  return (
    <div className="flex flex-col items-center justify-center py-20 text-center">
      <div className="rounded-2xl bg-surface p-4 mb-4">
        <Inbox className="h-10 w-10 text-foreground-muted" />
      </div>
      <Text size="lg" className="text-foreground-secondary">No videos {category.toLowerCase()} right now</Text>
      <Text size="sm" muted className="mt-1">Check back soon for new trending content</Text>
    </div>
  );
}
```

`formatCompactNumber(n: number): string`:
```typescript
function formatCompactNumber(n: number): string {
  if (n >= 1_000_000_000) return `${(n / 1_000_000_000).toFixed(1)}B`;
  if (n >= 1_000_000) return `${(n / 1_000_000).toFixed(1)}M`;
  if (n >= 1_000) return `${(n / 1_000).toFixed(1)}K`;
  return n.toString();
}
```

**Important notes:**
- Do NOT use `router.push`/`router.replace` for tab changes -- use `window.history.pushState` for shallow URL updates (no server re-render)
- Do NOT create a Zustand store -- URL params are source of truth
- Wrap `useSearchParams` usage properly -- the Suspense boundary is in page.tsx
- Keep stats bar visible with zeroed values when loading
- Use generous spacing throughout for premium feel
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `http://localhost:3000/trending` shows: Heading "Trending", stats bar, 3 category tabs
3. Default tab is "Breaking Out" with coral accent on active
4. Clicking tabs: brief skeleton flash (~250ms), then content updates, URL updates
5. Manually visit `/trending?tab=rising-again` -- "Rising Again" tab is active
6. Browser back/forward updates active tab
7. Stats bar shows category counts and total metrics
  </verify>
  <done>Client component renders complete page shell with heading, stats bar, category tabs with coral accent, URL sync via pushState, skeleton loading flash on tab switch, and empty state for categories with no videos. All tab state driven by URL search params.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete trending page shell with:
- /trending route accessible via sidebar "Trending" nav item
- "Trending" heading with stats bar showing category counts and aggregate metrics
- 3 category tabs (Breaking Out, Trending Now, Rising Again) with coral accent on active
- URL sync (tab=breaking-out in URL, browser back/forward works)
- Skeleton loading flash (~250ms) on tab switch
- Placeholder content showing video count per category (cards come in Phase 51)
  </what-built>
  <how-to-verify>
1. Start dev server: `pnpm dev` (or check if already running)
2. Navigate to `http://localhost:3000/trending` directly -- should see "Trending" heading, stats bar, tabs
3. Click sidebar "Trending" nav item -- should navigate to /trending
4. Verify default tab is "Breaking Out" with coral (#FF7F50) accent
5. Click "Trending Now" tab -- brief skeleton flash, then content switches, URL shows `?tab=trending-now`
6. Click "Rising Again" tab -- same behavior, URL shows `?tab=rising-again`
7. Press browser back button -- should go back to "Trending Now" tab
8. Visit `http://localhost:3000/trending?tab=rising-again` directly -- "Rising Again" should be active
9. Verify stats bar shows counts (14 per category) and total views
10. Verify tabs are sticky on scroll (if content is tall enough to scroll)
11. Verify spacing feels premium and breathable, not data-dense
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles clean: `npx tsc --noEmit`
2. Route `/trending` resolves within the `(app)` route group
3. Sidebar shows "Trending" with TrendingUp icon
4. Three tabs render with coral accent on active
5. Tab switching: URL updates, content filters, skeleton flash ~250ms
6. Browser back/forward syncs tab state
7. Stats bar visible at all times with category counts
8. Requirements covered: PAGE-01, PAGE-02, PAGE-03, PAGE-04, FILT-01, FILT-02, FILT-03, FILT-04
</verification>

<success_criteria>
- /trending page accessible via sidebar nav and direct URL
- Typography Heading renders "Trending"
- CategoryTabs with 3 categories, coral accent on active tab
- Tab state synced to URL search params (shareable, back/forward works)
- Stats bar with category counts and aggregate metrics
- Skeleton flash on tab switch (~200-300ms)
- All 8 PAGE/FILT requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/50-data-layer-page-shell/50-02-SUMMARY.md`
</output>
