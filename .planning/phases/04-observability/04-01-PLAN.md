---
phase: 04-observability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sentry.server.config.ts
  - sentry.edge.config.ts
  - src/instrumentation.ts
  - src/instrumentation-client.ts
  - next.config.ts
autonomous: true
user_setup:
  - service: sentry
    why: "Error tracking and exception monitoring"
    env_vars:
      - name: NEXT_PUBLIC_SENTRY_DSN
        source: "Sentry Dashboard -> Settings -> Projects -> virtuna-web -> Client Keys (DSN)"
    dashboard_config:
      - task: "Create Sentry project (if not exists)"
        location: "Sentry Dashboard -> Projects -> Create Project -> Next.js"

must_haves:
  truths:
    - "Sentry SDK initializes on server runtime (Node.js) when NEXT_PUBLIC_SENTRY_DSN is set"
    - "Sentry SDK initializes on edge runtime when NEXT_PUBLIC_SENTRY_DSN is set"
    - "Server Component and middleware errors are captured via onRequestError hook"
    - "next.config.ts wraps config with withSentryConfig for source map upload"
    - "Build succeeds with @sentry/nextjs installed and configured"
  artifacts:
    - path: "sentry.server.config.ts"
      provides: "Sentry Node.js SDK init"
      contains: "Sentry.init"
    - path: "sentry.edge.config.ts"
      provides: "Sentry Edge SDK init"
      contains: "Sentry.init"
    - path: "src/instrumentation.ts"
      provides: "Next.js instrumentation hook with runtime-conditional Sentry registration"
      exports: ["register", "onRequestError"]
    - path: "src/instrumentation-client.ts"
      provides: "Client-side Sentry init (minimal, no replay)"
      contains: "Sentry.init"
    - path: "next.config.ts"
      provides: "withSentryConfig wrapper"
      contains: "withSentryConfig"
  key_links:
    - from: "src/instrumentation.ts"
      to: "sentry.server.config.ts"
      via: "dynamic import in register() when NEXT_RUNTIME=nodejs"
      pattern: "import.*sentry\\.server\\.config"
    - from: "src/instrumentation.ts"
      to: "sentry.edge.config.ts"
      via: "dynamic import in register() when NEXT_RUNTIME=edge"
      pattern: "import.*sentry\\.edge\\.config"
---

<objective>
Install `@sentry/nextjs` and configure the standard 4-file manual setup for Next.js 15+: server config, edge config, instrumentation hook (with `onRequestError`), and minimal client-side init. Wrap `next.config.ts` with `withSentryConfig`.

Purpose: OBS-01 — Sentry SDK installed and configured so pipeline exceptions can be captured in subsequent plans.
Output: 5 files (2 Sentry configs at project root, 2 instrumentation files in src/, updated next.config.ts)
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@next.config.ts
@package.json
@.planning/phases/04-observability/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @sentry/nextjs and create Sentry config files</name>
  <files>
    package.json
    sentry.server.config.ts
    sentry.edge.config.ts
    src/instrumentation.ts
    src/instrumentation-client.ts
  </files>
  <action>
    1. Install the SDK:
       ```
       pnpm add @sentry/nextjs
       ```

    2. Create `sentry.server.config.ts` at project root:
       ```typescript
       import * as Sentry from "@sentry/nextjs";

       Sentry.init({
         dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
         environment: process.env.NODE_ENV,
         tracesSampleRate: process.env.NODE_ENV === "development" ? 1.0 : 0.1,
         sendDefaultPii: false,
       });
       ```

    3. Create `sentry.edge.config.ts` at project root:
       ```typescript
       import * as Sentry from "@sentry/nextjs";

       Sentry.init({
         dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
         environment: process.env.NODE_ENV,
         tracesSampleRate: process.env.NODE_ENV === "development" ? 1.0 : 0.1,
       });
       ```

    4. Create `src/instrumentation.ts`:
       ```typescript
       import * as Sentry from "@sentry/nextjs";

       export async function register() {
         if (process.env.NEXT_RUNTIME === "nodejs") {
           await import("../sentry.server.config");
         }
         if (process.env.NEXT_RUNTIME === "edge") {
           await import("../sentry.edge.config");
         }
       }

       export const onRequestError = Sentry.captureRequestError;
       ```
       NOTE: Import paths use `../` because `instrumentation.ts` is in `src/` and configs are at project root.

    5. Create `src/instrumentation-client.ts` (minimal — no replay, no performance, backend-focused milestone):
       ```typescript
       import * as Sentry from "@sentry/nextjs";

       Sentry.init({
         dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
         environment: process.env.NODE_ENV,
         tracesSampleRate: 0,
       });
       ```
       `tracesSampleRate: 0` because this milestone is backend-only. Client-side performance tracing can be enabled in a future milestone.
  </action>
  <verify>
    - All 4 files exist: `ls sentry.server.config.ts sentry.edge.config.ts src/instrumentation.ts src/instrumentation-client.ts`
    - Each file imports from `@sentry/nextjs` and calls `Sentry.init`
  </verify>
  <done>
    sentry.server.config.ts, sentry.edge.config.ts, src/instrumentation.ts (with register + onRequestError), and src/instrumentation-client.ts all exist and contain correct Sentry.init calls.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wrap next.config.ts with withSentryConfig and verify build</name>
  <files>next.config.ts</files>
  <action>
    1. Edit `next.config.ts` to import and wrap with `withSentryConfig`:
       ```typescript
       import type { NextConfig } from "next";
       import { withSentryConfig } from "@sentry/nextjs";

       const nextConfig: NextConfig = {
         transpilePackages: ['three'],
         images: {
           remotePatterns: [
             { protocol: 'https', hostname: 'picsum.photos' },
             { protocol: 'https', hostname: 'fastly.picsum.photos' },
           ],
         },
       };

       export default withSentryConfig(nextConfig, {
         org: process.env.SENTRY_ORG,
         project: process.env.SENTRY_PROJECT,
         silent: !process.env.CI,
       });
       ```
       Use `process.env.SENTRY_ORG` and `process.env.SENTRY_PROJECT` rather than hardcoded values so it works without a Sentry account configured (source map upload silently skipped when undefined).

    2. Add `NEXT_PUBLIC_SENTRY_DSN` to `.env.example` under a new "# Sentry" section:
       ```
       # Sentry (error tracking)
       NEXT_PUBLIC_SENTRY_DSN=         # Sentry DSN from project settings (required for error tracking)
       SENTRY_ORG=                     # Sentry org slug (optional, for source map upload)
       SENTRY_PROJECT=                 # Sentry project slug (optional, for source map upload)
       ```

    3. Run `pnpm build` and confirm it succeeds with zero errors. The build may emit a warning about missing SENTRY_DSN — that is expected and harmless (Sentry silently no-ops without a DSN).
  </action>
  <verify>
    - `pnpm build` exits 0
    - `grep "withSentryConfig" next.config.ts` returns a match
    - `grep "NEXT_PUBLIC_SENTRY_DSN" .env.example` returns a match
  </verify>
  <done>
    next.config.ts exports via withSentryConfig wrapper. .env.example documents all Sentry env vars. `pnpm build` succeeds.
  </done>
</task>

</tasks>

<verification>
1. `ls sentry.server.config.ts sentry.edge.config.ts src/instrumentation.ts src/instrumentation-client.ts` — all 4 files exist
2. `grep -l "Sentry.init" sentry.server.config.ts sentry.edge.config.ts src/instrumentation-client.ts` — 3 init calls
3. `grep "onRequestError" src/instrumentation.ts` — hook exported
4. `grep "withSentryConfig" next.config.ts` — wrapper applied
5. `pnpm build` exits 0
</verification>

<success_criteria>
- @sentry/nextjs is in package.json dependencies
- 4 Sentry configuration files exist with correct contents
- next.config.ts wrapped with withSentryConfig
- Build succeeds
- .env.example documents NEXT_PUBLIC_SENTRY_DSN, SENTRY_ORG, SENTRY_PROJECT
</success_criteria>

<output>
After completion, create `.planning/phases/04-observability/04-01-SUMMARY.md`
</output>
