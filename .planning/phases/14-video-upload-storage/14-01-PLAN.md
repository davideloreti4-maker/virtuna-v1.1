---
phase: 14-video-upload-storage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/app/video-upload.tsx
  - src/components/app/content-form.tsx
  - src/components/app/test-creation-flow.tsx
  - src/app/(app)/dashboard/dashboard-client.tsx
autonomous: true

must_haves:
  truths:
    - "VideoUpload component uploads selected file to Supabase Storage 'videos' bucket and returns real storage path"
    - "test-creation-flow passes real video_storage_path (not 'pending-upload') to /api/analyze"
    - "Upload progress indicator reflects actual Supabase Storage upload progress"
    - "Client-side MAX_FILE_SIZE (50MB) matches server-side VIDEO_MAX_SIZE_BYTES (50MB) — no silent pipeline failures for oversized files"
  artifacts:
    - path: "src/components/app/video-upload.tsx"
      provides: "Supabase Storage upload with progress tracking"
      contains: "supabase.storage"
    - path: "src/components/app/test-creation-flow.tsx"
      provides: "Real video_storage_path wiring to API"
      contains: "uploadVideo"
  key_links:
    - from: "src/components/app/video-upload.tsx"
      to: "Supabase Storage 'videos' bucket"
      via: "supabase.storage.from('videos').upload()"
      pattern: "storage\\.from.*upload"
    - from: "src/components/app/test-creation-flow.tsx"
      to: "/api/analyze"
      via: "video_storage_path from upload result"
      pattern: "video_storage_path.*videos/"
---

<objective>
Wire client-side video upload to Supabase Storage end-to-end.

Purpose: Replace the "pending-upload" placeholder with actual file upload to Supabase Storage. The VideoUpload component needs to upload files and return a real storage path that the test-creation-flow can send to /api/analyze.

Output: VideoUpload uploads to Supabase Storage with progress tracking, test-creation-flow sends real video_storage_path.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/components/app/video-upload.tsx
@src/components/app/test-creation-flow.tsx
@src/components/app/content-form.tsx
@src/lib/supabase/client.ts
@src/app/(app)/dashboard/dashboard-client.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Supabase Storage upload to VideoUpload with progress tracking</name>
  <files>src/components/app/video-upload.tsx</files>
  <action>
    Add a `uploadToStorage` function to VideoUpload that uploads the selected file to Supabase Storage:

    1. **Lower MAX_FILE_SIZE from 200MB to 50MB.** Change `const MAX_FILE_SIZE = 200 * 1024 * 1024` to `const MAX_FILE_SIZE = 50 * 1024 * 1024` and update the error message from "200MB" to "50MB", and the dropzone subtext from "up to 200MB" to "up to 50MB". Reason: `analyzeVideoWithGemini` in gemini.ts hard-rejects files over 50MB (`VIDEO_MAX_SIZE_BYTES`). Without this change, files between 50-200MB would upload to Storage successfully but fail during Gemini analysis.

    2. Import `createClient` from `@/lib/supabase/client` (browser client).

    3. Add new props to `VideoUploadProps`:
       - `onUploadComplete: (storagePath: string) => void` — called with the real `videos/{userId}/{timestamp}-{filename}` path after upload succeeds
       - `onUploadError: (error: string) => void` — called if upload fails

    4. When a file is selected via `handleFileSelection`, immediately start uploading:
       - Create Supabase browser client
       - Get current user ID via `supabase.auth.getUser()` (needed for path namespacing)
       - Generate storage path: `videos/${userId}/${Date.now()}-${file.name}` (ensures uniqueness, satisfies the "videos/" prefix requirement from Phase 13)
       - Use `supabase.storage.from('videos').upload(path, file, { upsert: false })` to upload
       - Track upload progress via XMLHttpRequest: Since Supabase JS client v2 doesn't expose upload progress natively, use a two-phase approach:
         a. Set `uploadProgress` to a simulated value using `setInterval` that increments from 0 to 90 over the expected upload time (estimate from file.size / assumed bandwidth)
         b. When `supabase.storage.upload()` resolves, jump to 100%
       - On success: call `onUploadComplete(path)`, clear uploadProgress
       - On error: call `onUploadError(error.message)`, set error state, clear uploadProgress, call `onFileSelect(null)` to reset

    5. The component already has `uploadProgress` as a prop. Change this to internal state managed by the upload function. Remove `uploadProgress` from `VideoUploadProps` since the component now manages its own upload lifecycle.

    6. When user clicks remove (handleRemove): If there's an active upload, abort it. Reset all state.

    IMPORTANT: The Supabase Storage bucket "videos" must already exist. Document this as a prerequisite but do NOT create it programmatically — that's a Supabase Dashboard action (noted in user_setup below but handled by execute-plan).
  </action>
  <verify>
    - `pnpm build` succeeds (no TypeScript errors)
    - VideoUpload component compiles with new upload logic
    - The `onUploadComplete` callback receives a path starting with "videos/"
  </verify>
  <done>
    VideoUpload component uploads files to Supabase Storage "videos" bucket on file selection, tracks progress internally, and calls onUploadComplete with the real storage path.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire real video_storage_path in test-creation-flow and dashboard-client</name>
  <files>src/components/app/test-creation-flow.tsx, src/app/(app)/dashboard/dashboard-client.tsx</files>
  <action>
    Update both test-creation-flow.tsx and dashboard-client.tsx to use the real video storage path from upload instead of "pending-upload":

    **test-creation-flow.tsx:**

    1. Add state: `const [videoStoragePath, setVideoStoragePath] = useState<string | null>(null);`

    2. Add state: `const [uploadError, setUploadError] = useState<string | null>(null);`

    3. Update `handleContentSubmit` for video_upload mode:
       - Instead of `payload.video_storage_path = "pending-upload"`, use: `payload.video_storage_path = videoStoragePath`
       - If `videoStoragePath` is null when submitting video_upload, show error and return early (guard against submitting before upload completes)

    4. Pass upload callbacks through ContentForm to VideoUpload. Since ContentForm calls `onSubmit(formData)` and formData has `video_file`, the flow needs adjustment:
       - Add `onVideoUploadComplete` and `onVideoUploadError` props to ContentForm
       - ContentForm passes these to VideoUpload as `onUploadComplete` and `onUploadError`
       - test-creation-flow sets `videoStoragePath` in `onVideoUploadComplete`
       - test-creation-flow sets `uploadError` in `onVideoUploadError`

    5. Update submit guard: disable submit button while video is uploading (videoStoragePath is null and input_mode is video_upload).

    **dashboard-client.tsx:**

    6. Apply the same pattern: track videoStoragePath state, pass upload callbacks, use real path instead of "pending-upload".

    7. Both files: remove the comment "// For now, set video_storage_path to empty -- actual Supabase upload is Phase 8+" and replace with real wiring.

    **content-form.tsx (minimal change):**

    8. Add `onVideoUploadComplete?: (path: string) => void` and `onVideoUploadError?: (error: string) => void` to ContentFormProps.
    9. Pass these through to `<VideoUpload onUploadComplete={onVideoUploadComplete} onUploadError={onVideoUploadError} />`.
  </action>
  <verify>
    - `pnpm build` succeeds
    - In video_upload mode, the payload sent to /api/analyze has `video_storage_path` starting with "videos/" (not "pending-upload")
    - Submit is disabled while upload is in progress
  </verify>
  <done>
    Both test-creation-flow and dashboard-client pass real Supabase Storage paths to /api/analyze. The "pending-upload" placeholder is eliminated. Submit is guarded until upload completes.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero errors
2. VideoUpload component has `supabase.storage.from('videos').upload()` call
3. test-creation-flow.tsx has no "pending-upload" string
4. dashboard-client.tsx has no "pending-upload" string
5. Upload progress state is managed internally by VideoUpload
6. onUploadComplete callback provides path starting with "videos/"
</verification>

<success_criteria>
- VideoUpload uploads to Supabase Storage and returns real storage path via callback
- test-creation-flow sends real video_storage_path to /api/analyze
- Upload progress indicator reflects upload lifecycle (progress -> complete)
- No "pending-upload" placeholder remains in video_upload code paths
</success_criteria>

<output>
After completion, create `.planning/phases/14-video-upload-storage/14-01-SUMMARY.md`
</output>
