---
phase: 14-video-upload-storage
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/lib/engine/pipeline.ts
  - src/app/api/analyze/route.ts
autonomous: true

must_haves:
  truths:
    - "Pipeline detects video_upload mode and calls analyzeVideoWithGemini instead of analyzeWithGemini"
    - "Video file is downloaded from Supabase Storage and passed as Buffer to Gemini"
    - "Gemini video analysis returns video-specific signals (visual_production_quality, hook_visual_impact, pacing_score, transition_quality)"
  artifacts:
    - path: "src/lib/engine/pipeline.ts"
      provides: "Video-aware Gemini analysis branching"
      contains: "analyzeVideoWithGemini"
    - path: "src/app/api/analyze/route.ts"
      provides: "Video download from Supabase Storage"
      contains: "storage.from"
  key_links:
    - from: "src/app/api/analyze/route.ts"
      to: "Supabase Storage 'videos' bucket"
      via: "service.storage.from('videos').download()"
      pattern: "storage\\.from.*download"
    - from: "src/lib/engine/pipeline.ts"
      to: "src/lib/engine/gemini.ts"
      via: "analyzeVideoWithGemini(videoBuffer, mimeType, niche)"
      pattern: "analyzeVideoWithGemini"
---

<objective>
Wire server-side video download from Supabase Storage and route to Gemini video analysis in the pipeline.

Purpose: Complete the video analysis path — when a user uploads a video, the pipeline needs to download the file from Supabase Storage, convert it to a Buffer, and pass it to `analyzeVideoWithGemini` (which uploads to Gemini Files API for visual analysis). Currently the pipeline always calls text-only `analyzeWithGemini`.

Output: Pipeline detects video_upload mode, downloads from Storage, runs Gemini video analysis with video-specific signals.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/lib/engine/pipeline.ts
@src/lib/engine/gemini.ts
@src/app/api/analyze/route.ts
@src/lib/engine/types.ts
@src/lib/engine/normalize.ts
@src/lib/supabase/service.ts
@.planning/phases/14-video-upload-storage/14-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Download video from Supabase Storage in analyze route and pass to pipeline</name>
  <files>src/app/api/analyze/route.ts, src/lib/engine/pipeline.ts</files>
  <action>
    Wire video download and pipeline video analysis:

    **route.ts changes:**

    1. After Zod validation and before calling `runPredictionPipeline`, check if `validated.input_mode === "video_upload"`:
       - Download the video from Supabase Storage using `service.storage.from('videos').download(validated.video_storage_path!)` where `service` is the already-existing service client
       - The download returns a Blob — convert to Buffer: `const arrayBuffer = await blob.arrayBuffer(); const videoBuffer = Buffer.from(arrayBuffer);`
       - Determine MIME type from the file extension in the storage path (mp4->video/mp4, mov->video/quicktime, webm->video/webm, avi->video/x-msvideo, mkv->video/x-matroska). Default to "video/mp4" if extension unknown.
       - If download fails, return 400 with error message "Failed to download video from storage. It may have expired or been deleted."
       - Pass `videoBuffer` and `mimeType` to `runPredictionPipeline` via an optional parameter

    2. Extend `runPredictionPipeline` signature to accept optional video data:
       ```typescript
       export async function runPredictionPipeline(
         input: AnalysisInput,
         videoData?: { buffer: Buffer; mimeType: string }
       ): Promise<PipelineResult>
       ```

    **pipeline.ts changes:**

    3. In the Gemini analysis stage (Stage 3), branch based on input mode:
       - If `validated.input_mode === "video_upload" && videoData`:
         Call `analyzeVideoWithGemini(videoData.buffer, videoData.mimeType, payload.niche ?? undefined)` instead of `analyzeWithGemini(validated)`
         The return type is `{ analysis: GeminiVideoAnalysis; cost_cents: number }` — cast or union the type since `GeminiVideoAnalysis` extends `GeminiAnalysis` with additional `video_signals`
       - Otherwise: call `analyzeWithGemini(validated)` as before (text mode / TikTok URL mode)

    4. Import `analyzeVideoWithGemini` from `./gemini` and `GeminiVideoAnalysis` from `./types`.

    5. Update the `PipelineResult` type to include optional video analysis data:
       - Change `geminiResult` type to `{ analysis: GeminiAnalysis | GeminiVideoAnalysis; cost_cents: number }`
       - This preserves backward compatibility — text analyses return GeminiAnalysis, video analyses return GeminiVideoAnalysis (which has the extra `video_signals` field)

    6. The aggregator already handles GeminiAnalysis — it doesn't need to know about video_signals specifically. The video_signals data will be available in the pipeline result for any downstream consumer that needs it.

    IMPORTANT:
    - The service client is already created in route.ts (`const service = createServiceClient()`) and in pipeline.ts. Use the existing one.
    - Do NOT modify the video_storage_path validation guard in route.ts (the "pending-upload" / "videos/" prefix check stays).
    - The `analyzeVideoWithGemini` function in gemini.ts is already fully implemented — it handles Gemini Files API upload, polling, and cleanup. We just need to call it.
  </action>
  <verify>
    - `pnpm build` succeeds
    - pipeline.ts imports `analyzeVideoWithGemini`
    - route.ts has `storage.from('videos').download()` call
    - For video_upload mode, the pipeline calls `analyzeVideoWithGemini` with buffer and MIME type
    - For text/tiktok_url modes, the pipeline still calls `analyzeWithGemini` (unchanged behavior)
  </verify>
  <done>
    Pipeline detects video_upload mode, downloads file from Supabase Storage, and routes to Gemini video analysis. Text and TikTok URL modes are unchanged. Video-specific signals (visual_production_quality, hook_visual_impact, pacing_score, transition_quality) are returned in the pipeline result.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero errors
2. `grep -n "analyzeVideoWithGemini" src/lib/engine/pipeline.ts` returns the import and call site
3. `grep -n "storage.*download" src/app/api/analyze/route.ts` returns the download call
4. `grep -n "videoData" src/lib/engine/pipeline.ts` shows the optional parameter usage
5. Text mode analysis still works (no regression — the branch only activates for video_upload)
</verification>

<success_criteria>
- Pipeline branches to Gemini video analysis for video_upload input mode
- Video is downloaded from Supabase Storage as Buffer and passed to analyzeVideoWithGemini
- Gemini returns video-specific signals alongside the 5 standard factors
- Text and TikTok URL analysis paths are unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/14-video-upload-storage/14-02-SUMMARY.md`
</output>
