---
phase: 06-ai-intelligence
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/competitors/intelligence/intelligence-section.tsx
  - src/components/competitors/intelligence/strategy-analysis-card.tsx
  - src/components/competitors/intelligence/viral-detection-card.tsx
  - src/components/competitors/intelligence/hashtag-gap-card.tsx
  - src/components/competitors/intelligence/recommendations-card.tsx
  - src/app/(app)/competitors/[handle]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Competitor detail page displays an AI Intelligence section below existing analytics sections"
    - "Strategy analysis card shows hooks, content series, psychological triggers, overall strategy, strengths, and weaknesses"
    - "Viral detection card lists videos exceeding 3x average views with AI-generated 'why it worked' explanations"
    - "Hashtag gap card shows competitor-only, user-only, and shared hashtags with AI recommendations"
    - "Recommendations card shows prioritized actionable items across format, timing, hooks, and content style categories"
    - "When no cached AI data exists, each card shows a 'Generate Analysis' button instead of empty state"
    - "Clicking 'Generate Analysis' triggers the POST /api/intelligence/[competitorId] endpoint and displays results"
  artifacts:
    - path: "src/components/competitors/intelligence/intelligence-section.tsx"
      provides: "Main intelligence wrapper component"
    - path: "src/components/competitors/intelligence/strategy-analysis-card.tsx"
      provides: "INTL-01: Strategy analysis display"
    - path: "src/components/competitors/intelligence/viral-detection-card.tsx"
      provides: "INTL-02: Viral video detection display"
    - path: "src/components/competitors/intelligence/hashtag-gap-card.tsx"
      provides: "INTL-03: Hashtag gap analysis display"
    - path: "src/components/competitors/intelligence/recommendations-card.tsx"
      provides: "INTL-04: Personalized recommendations display"
    - path: "src/app/(app)/competitors/[handle]/page.tsx"
      provides: "Updated detail page with intelligence section"
      contains: "IntelligenceSection"
  key_links:
    - from: "src/app/(app)/competitors/[handle]/page.tsx"
      to: "src/lib/ai/intelligence-service.ts"
      via: "getAllIntelligence call in server component"
      pattern: "import.*intelligence-service"
    - from: "src/app/(app)/competitors/[handle]/page.tsx"
      to: "src/components/competitors/intelligence/intelligence-section.tsx"
      via: "renders IntelligenceSection with pre-fetched cached data"
      pattern: "<IntelligenceSection"
    - from: "src/components/competitors/intelligence/intelligence-section.tsx"
      to: "/api/intelligence/[competitorId]"
      via: "client-side fetch for on-demand generation"
      pattern: "fetch.*api/intelligence"
---

<objective>
Build the intelligence UI section for the competitor detail page: 4 card components displaying AI-generated insights (strategy analysis, viral detection, hashtag gap, recommendations), a wrapper component that handles the generate/loading/display states, and wire it into the existing detail page server component.

Purpose: This completes Phase 6 by making AI insights visible to users. The service layer (06-01) provides cached data; this plan creates the visual interface and the on-demand generation flow.

Output: 5 new components in `src/components/competitors/intelligence/`, updated detail page.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ai-intelligence/06-RESEARCH.md
@.planning/phases/06-ai-intelligence/06-01-SUMMARY.md

# Key existing files
@src/app/(app)/competitors/[handle]/page.tsx      # Detail page to extend
@src/components/competitors/detail/growth-section.tsx  # Pattern reference: existing detail section component
@src/components/competitors/detail/content-analysis-section.tsx  # Pattern reference for section layout
@src/lib/ai/intelligence-service.ts               # getAllIntelligence, service functions (from 06-01)
@src/lib/ai/types.ts                              # Zod schemas and TypeScript types (from 06-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 4 intelligence card components and the wrapper section</name>
  <files>
    src/components/competitors/intelligence/strategy-analysis-card.tsx
    src/components/competitors/intelligence/viral-detection-card.tsx
    src/components/competitors/intelligence/hashtag-gap-card.tsx
    src/components/competitors/intelligence/recommendations-card.tsx
    src/components/competitors/intelligence/intelligence-section.tsx
  </files>
  <action>
All 4 card components follow the established Raycast design system: `bg-transparent`, `border border-white/[0.06]`, `rounded-xl` (12px), `shadow-[inset_0_1px_0_0_rgba(255,255,255,0.05)]`. Use `@phosphor-icons/react` for icons (consistent with the rest of the app).

**1. strategy-analysis-card.tsx** (server component -- no "use client"):

Props: `{ data: StrategyAnalysis | null }` (import type from `@/lib/ai/types`).

If `data` is null, render nothing (the parent wrapper handles the empty/generate state).

Display sections:
- **Overall Strategy**: `data.overall_strategy` as a paragraph with `text-sm text-[var(--color-muted)]` styling
- **Content Hooks**: `data.hooks` as a grid of mini-cards showing pattern name, frequency badge, and example text
- **Content Series**: `data.content_series` as a list with name (bold), description, video count badge
- **Psychological Triggers**: `data.psychological_triggers` as tag pills
- **Strengths/Weaknesses**: Two columns (green-tinted/red-tinted) with bullet items

Use `<h3>` for section labels. Keep the layout clean and scannable.

**2. viral-detection-card.tsx** (server component):

Props: `{ data: ViralExplanation | null, competitorHandle: string }`.

If `data` is null or `data.videos.length === 0`, render nothing.

For each viral video in `data.videos`:
- Video caption (truncated to 80 chars)
- Viral multiplier badge (e.g., "12.5x avg" in coral/accent)
- View count formatted with `formatCount` from `competitors-utils.ts`
- AI explanation paragraph
- Key factors as bullet list

Limit display to top 5 viral videos.

**3. hashtag-gap-card.tsx** (server component):

Props: `{ data: HashtagGap | null }`.

If `data` is null, render nothing.

Three sections with clear visual separation:
- **Competitor Uses (You Don't)**: `data.competitor_only` -- tag name, count badge, AI recommendation. Use coral/accent color for tags to draw attention.
- **You Use (Competitor Doesn't)**: `data.user_only` -- tag name, count badge, AI assessment.
- **Shared Hashtags**: `data.shared` -- tag name with both counts side-by-side.
- **Overall Recommendation**: `data.overall_recommendation` as a summary paragraph at the bottom.

If all arrays are empty, show a "No significant hashtag differences found" message.

**4. recommendations-card.tsx** (server component):

Props: `{ data: Recommendations | null }`.

If `data` is null, render nothing.

- **Summary**: `data.summary` paragraph at top
- **Recommendations grid**: Group by category. Each category gets an icon:
  - `format` -> VideoCamera icon
  - `timing` -> Clock icon
  - `hooks` -> Lightning icon
  - `content_style` -> Palette icon
- Each recommendation: title (bold), description, priority badge (high=coral, medium=amber, low=muted), action items as a checklist

Sort recommendations by priority (high first).

**5. intelligence-section.tsx** ("use client"):

This is a CLIENT component because it handles the "Generate Analysis" button click + loading state.

Props from server component:
```typescript
interface IntelligenceSectionProps {
  competitorId: string
  competitorHandle: string
  cachedStrategy: StrategyAnalysis | null
  cachedViral: ViralExplanation | null
  cachedHashtagGap: HashtagGap | null
  cachedRecommendations: Recommendations | null
  hasUserVideos: boolean  // Whether user has self-tracked (for hashtag gap availability)
}
```

State:
- `strategy`, `viral`, `hashtagGap`, `recommendations` -- initialized from cached props
- `generating: Record<string, boolean>` -- per-type loading state
- `error: string | null`

Rendering:
- Section header: "AI Intelligence" with Sparkle icon and a brief description
- If ALL 4 analysis types have data, render all 4 cards directly
- For each type that has NO cached data, show a generate CTA card with a "Generate" button
- Special case for hashtag_gap: if `!hasUserVideos`, show a CTA to connect TikTok handle instead of generate button
- "Generate All" button in the header to trigger all missing analyses at once

Generate handler:
```typescript
async function handleGenerate(analysisType: string) {
  setGenerating(prev => ({ ...prev, [analysisType]: true }));
  try {
    const res = await fetch(`/api/intelligence/${competitorId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ analysis_type: analysisType }),
    });
    if (!res.ok) throw new Error("Analysis failed");
    const data = await res.json();
    // Update the appropriate state
    switch (analysisType) {
      case "strategy": setStrategy(data); break;
      case "viral": setViral(data); break;
      case "hashtag_gap": setHashtagGap(data); break;
      case "recommendations": setRecommendations(data); break;
    }
  } catch (e) {
    setError(e instanceof Error ? e.message : "Failed to generate analysis");
  } finally {
    setGenerating(prev => ({ ...prev, [analysisType]: false }));
  }
}
```

Loading state: Show a spinner + "Analyzing..." text in place of the generate button while `generating[type]` is true. Use the existing Spinner component if available, otherwise a simple CSS animation.

The 4 card sub-components are server components imported and rendered within this client component -- this works because they only receive serializable data props.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- All 5 components compile and export correctly
- intelligence-section.tsx is marked "use client"
- The 4 card components are NOT marked "use client" (they're server-compatible, rendered by a client parent)
- No AI library imports in any component file (only type imports from `@/lib/ai/types`)
  </verify>
  <done>
- 4 card components render AI insights with proper Raycast styling (transparent bg, 6% borders, 12px radius)
- Intelligence section handles cached data display AND on-demand generation via API
- Generate button triggers POST to /api/intelligence/[competitorId] and displays results
- Loading states shown during AI generation
- Hashtag gap card shows CTA for users without self-tracked data
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire intelligence section into the competitor detail page</name>
  <files>
    src/app/(app)/competitors/[handle]/page.tsx
  </files>
  <action>
Update the existing detail page server component to:

**1. Import intelligence service and section:**
```typescript
import { getAllIntelligence } from "@/lib/ai/intelligence-service";
import { IntelligenceSection } from "@/components/competitors/intelligence/intelligence-section";
```

**2. Fetch cached intelligence data** (add to existing parallel fetch):

After the existing `Promise.all` for snapshots + videos, add a parallel fetch for cached intelligence:
```typescript
const cachedIntelligence = await getAllIntelligence(supabase, profile.id);
```

This is fast (single DB query) and doesn't block on AI. It just reads what's already cached.

**3. Determine if user has self-tracked videos** (for hashtag gap availability):

```typescript
// Check if user has self-tracked their own TikTok handle
const { data: creatorProfile } = await supabase
  .from("creator_profiles")
  .select("tiktok_handle")
  .eq("user_id", user.id)
  .single();

let hasUserVideos = false;
if (creatorProfile?.tiktok_handle) {
  const { data: userProfile } = await supabase
    .from("competitor_profiles")
    .select("id")
    .eq("tiktok_handle", creatorProfile.tiktok_handle)
    .single();
  if (userProfile) {
    const { count } = await supabase
      .from("competitor_videos")
      .select("id", { count: "exact", head: true })
      .eq("competitor_id", userProfile.id);
    hasUserVideos = (count ?? 0) > 0;
  }
}
```

**Note:** This adds 1-2 small queries. If performance is a concern, combine into the existing Promise.all. But since these are index lookups they'll be fast.

**4. Render IntelligenceSection** at the bottom of the page (after ContentAnalysisSection):

```tsx
<IntelligenceSection
  competitorId={profile.id}
  competitorHandle={profile.tiktok_handle}
  cachedStrategy={cachedIntelligence.strategy ?? null}
  cachedViral={cachedIntelligence.viral ?? null}
  cachedHashtagGap={cachedIntelligence.hashtag_gap ?? null}
  cachedRecommendations={cachedIntelligence.recommendations ?? null}
  hasUserVideos={hasUserVideos}
/>
```

**5. Do NOT call AI on page load.** The server component only reads the cache. The client intelligence-section component handles the "Generate" button click that triggers actual AI calls via the API route.

This matches the anti-pattern avoidance from RESEARCH.md: "Never call AI on every page load."
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Detail page imports IntelligenceSection and renders it
- `getAllIntelligence` is called in server component (cache read only, no AI call)
- `hasUserVideos` check queries creator_profiles -> competitor_profiles -> competitor_videos
- IntelligenceSection appears below ContentAnalysisSection in the JSX
  </verify>
  <done>
- Detail page has IntelligenceSection as 5th section below existing analytics
- Cached AI insights loaded server-side via `getAllIntelligence`
- User video availability checked for hashtag gap feature
- No AI calls on page load -- generation is on-demand via client interaction
- Page renders instantly with cached data or "Generate" CTAs
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero type errors across all new and modified files
2. Detail page at `/competitors/[handle]` renders IntelligenceSection below existing sections
3. Intelligence section shows "Generate Analysis" buttons when no cached data exists
4. All 4 card components follow Raycast design system (transparent bg, 6% borders, 12px radius, Inter font)
5. No AI library imports (`openai`, `@google/genai`) in any component file
6. Client-side fetch to `/api/intelligence/[competitorId]` for on-demand generation
</verification>

<success_criteria>
- Competitor detail page has a dedicated intelligence section displaying AI-generated insights (INTL-05)
- Strategy analysis card shows hooks, patterns, triggers, content series (INTL-01)
- Viral detection card surfaces videos exceeding 3x average with explanations (INTL-02)
- Hashtag gap card compares user vs competitor hashtags with recommendations (INTL-03)
- Recommendations card shows prioritized actionable items (INTL-04)
- Page loads instantly with cached data; generation is on-demand
</success_criteria>

<output>
After completion, create `.planning/phases/06-ai-intelligence/06-02-SUMMARY.md`
</output>
