---
phase: 08-gap-closure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/competitors/add-competitor-dialog.tsx
  - src/components/competitors/remove-competitor-button.tsx
  - src/app/(app)/competitors/competitors-client.tsx
  - src/components/competitors/competitor-empty-state.tsx
  - src/components/competitors/competitor-card.tsx
  - src/components/competitors/competitor-table.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can add a competitor by pasting @handle via a dialog opened from dashboard header button"
    - "User can add a competitor via the empty state CTA button"
    - "User can remove a tracked competitor via a button on the card with confirmation dialog"
    - "User can remove a tracked competitor via a button on the table row with confirmation dialog"
  artifacts:
    - path: "src/components/competitors/add-competitor-dialog.tsx"
      provides: "Dialog for adding competitor by handle"
      exports: ["AddCompetitorDialog"]
    - path: "src/components/competitors/remove-competitor-button.tsx"
      provides: "Remove button with AlertDialog confirmation"
      exports: ["RemoveCompetitorButton"]
    - path: "src/app/(app)/competitors/competitors-client.tsx"
      provides: "Dashboard with Add button in header"
      contains: "AddCompetitorDialog"
    - path: "src/components/competitors/competitor-empty-state.tsx"
      provides: "Empty state CTA wired to AddCompetitorDialog"
      contains: "AddCompetitorDialog"
    - path: "src/components/competitors/competitor-card.tsx"
      provides: "Card with remove button on hover"
      contains: "RemoveCompetitorButton"
    - path: "src/components/competitors/competitor-table.tsx"
      provides: "Table rows with remove button"
      contains: "RemoveCompetitorButton"
  key_links:
    - from: "src/components/competitors/add-competitor-dialog.tsx"
      to: "src/app/actions/competitors/add.ts"
      via: "addCompetitor server action import"
      pattern: "import.*addCompetitor.*from.*actions/competitors/add"
    - from: "src/components/competitors/remove-competitor-button.tsx"
      to: "src/app/actions/competitors/remove.ts"
      via: "removeCompetitor server action import"
      pattern: "import.*removeCompetitor.*from.*actions/competitors/remove"
    - from: "src/app/(app)/competitors/competitors-client.tsx"
      to: "src/components/competitors/add-competitor-dialog.tsx"
      via: "AddCompetitorDialog import"
      pattern: "import.*AddCompetitorDialog"
    - from: "src/components/competitors/competitor-card.tsx"
      to: "src/components/competitors/remove-competitor-button.tsx"
      via: "RemoveCompetitorButton import"
      pattern: "import.*RemoveCompetitorButton"
---

<objective>
Create AddCompetitorDialog and RemoveCompetitorButton components, then wire them into the dashboard header, empty state CTA, competitor cards, and table rows.

Purpose: Close the 2 broken E2E flows (add competitor, remove competitor) so users can manage their tracked competitor list.
Output: 2 new components, 4 modified files.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.0-MILESTONE-AUDIT.md
@.planning/phases/08-gap-closure/08-RESEARCH.md
@src/app/(app)/competitors/competitors-client.tsx
@src/components/competitors/competitor-empty-state.tsx
@src/components/competitors/competitor-card.tsx
@src/components/competitors/competitor-table.tsx
@src/components/ui/dialog.tsx
@src/components/app/delete-test-modal.tsx
@src/app/actions/competitors/add.ts
@src/app/actions/competitors/remove.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AddCompetitorDialog and RemoveCompetitorButton components</name>
  <files>
    src/components/competitors/add-competitor-dialog.tsx
    src/components/competitors/remove-competitor-button.tsx
  </files>
  <action>
**File 1: `src/components/competitors/add-competitor-dialog.tsx`**

Create a "use client" component `AddCompetitorDialog` that accepts a `trigger: React.ReactNode` prop. Implementation:

- State: `open` (dialog state), `handle` (input value), `error` (string|null), `isPending` (from useTransition)
- Use `Dialog`, `DialogTrigger`, `DialogContent` (size="sm"), `DialogHeader`, `DialogTitle`, `DialogDescription`, `DialogFooter`, `DialogClose` from `@/components/ui/dialog`
- Use `Input` from `@/components/ui/input` (NOT InputField -- the dialog provides its own layout)
- Use `Button` from `@/components/ui/button`
- Use `useToast` from `@/components/ui/toast`
- Import `addCompetitor` from `@/app/actions/competitors/add`
- Wrap the dialog content in a `<form onSubmit={handleSubmit}>` so Enter key submits
- `handleSubmit`: preventDefault, guard on empty handle, clear error, call `startTransition(async () => { ... })`
  - Inside transition: call `addCompetitor(handle.trim())`
  - On error: `setError(result.error)`
  - On success: `toast({ variant: "success", title: "Now tracking @${result.data!.handle}" })`, reset handle, close dialog
- On dialog close (via `onOpenChange`): reset handle and error state
- Input: placeholder `@username or tiktok.com/@username`, autoFocus, disabled when pending, show `error` prop for validation feedback (use `id="add-competitor-handle"` so error message renders)
- Cancel button: `<DialogClose asChild><Button variant="secondary" type="button">Cancel</Button></DialogClose>`
- Submit button: `<Button variant="primary" type="submit" loading={isPending} disabled={!handle.trim()}>Add</Button>`

**File 2: `src/components/competitors/remove-competitor-button.tsx`**

Create a "use client" component `RemoveCompetitorButton` with props `{ competitorId: string; handle: string }`. Implementation:

- State: `open` (AlertDialog state), `isPending` (from useTransition)
- Use `@radix-ui/react-alert-dialog` directly (import as `* as AlertDialog`) -- follow the exact pattern from `src/components/app/delete-test-modal.tsx`
- Use `Button` from `@/components/ui/button`
- Use `useToast` from `@/components/ui/toast`
- Import `removeCompetitor` from `@/app/actions/competitors/remove`
- Trigger: a small icon button with `Trash2` icon (14px) from lucide-react, styled as:
  `className="p-1.5 rounded-md text-foreground-muted hover:text-foreground hover:bg-white/[0.05] transition-colors"`
  With `aria-label="Remove @{handle}"` for accessibility
- **CRITICAL**: The trigger button's `onClick` must call `e.preventDefault()` and `e.stopPropagation()` BEFORE setting open state. This prevents the parent `<Link>` (on cards) and `onClick` (on table rows) from firing. Use the explicit `onClick` handler pattern, not `AlertDialog.Trigger` alone. Set `open` to `true` in the click handler.
- AlertDialog overlay: match `delete-test-modal.tsx` exactly -- `bg-black/60`, `backdropFilter: "blur(4px)"`, `WebkitBackdropFilter: "blur(4px)"`, z-index `var(--z-modal-backdrop)`
- AlertDialog content: match `delete-test-modal.tsx` exactly -- `backgroundColor: "rgba(17, 18, 20, 0.95)"`, proper inset shadow, rounded-xl, border white/[0.06], z-index `var(--z-modal)`
- Title: `Stop tracking @{handle}?`
- Description: `This competitor will be removed from your tracked list. You can add them back later.`
- Cancel: `<AlertDialog.Cancel asChild><Button variant="secondary">Cancel</Button></AlertDialog.Cancel>`
- Confirm: `<AlertDialog.Action asChild><Button variant="destructive" onClick={handleRemove} loading={isPending}>Remove</Button></AlertDialog.Action>`
- `handleRemove`: call `startTransition(async () => { ... })`
  - Call `removeCompetitor(competitorId)`
  - On error: `toast({ variant: "error", title: "Failed to remove competitor", description: result.error })`
  - On success: `toast({ variant: "success", title: "Stopped tracking @${handle}" })`, close dialog
  </action>
  <verify>
Run `npx tsc --noEmit` -- both new files compile with no type errors.
Verify imports: `grep -n 'addCompetitor' src/components/competitors/add-competitor-dialog.tsx`
Verify imports: `grep -n 'removeCompetitor' src/components/competitors/remove-competitor-button.tsx`
  </verify>
  <done>
AddCompetitorDialog accepts a trigger prop and renders a form dialog calling addCompetitor with toast feedback. RemoveCompetitorButton renders a trash icon with AlertDialog confirmation calling removeCompetitor with e.stopPropagation().
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire AddCompetitorDialog and RemoveCompetitorButton into dashboard, cards, table, and empty state</name>
  <files>
    src/app/(app)/competitors/competitors-client.tsx
    src/components/competitors/competitor-empty-state.tsx
    src/components/competitors/competitor-card.tsx
    src/components/competitors/competitor-table.tsx
  </files>
  <action>
**File 1: `src/app/(app)/competitors/competitors-client.tsx`**

- Import `AddCompetitorDialog` from `@/components/competitors/add-competitor-dialog`
- Import `Plus` icon from `lucide-react`
- In the header bar (the `<div className="flex items-center gap-3">` inside the page header), add an "Add Competitor" button BEFORE the Compare link. Wrap it in `AddCompetitorDialog`:
  ```tsx
  <AddCompetitorDialog
    trigger={
      <Button variant="primary" size="sm">
        <Plus size={14} className="mr-1.5" />
        Add Competitor
      </Button>
    }
  />
  ```
- Import `Button` from `@/components/ui/button` (if not already imported)
- The `AddCompetitorDialog` must be accessible regardless of competitor count (it shows even when list is empty, since the header is always visible)

**File 2: `src/components/competitors/competitor-empty-state.tsx`**

- Import `AddCompetitorDialog` from `@/components/competitors/add-competitor-dialog`
- Replace the existing plain `<Button variant="primary">Add Competitor</Button>` (which has no onClick) with:
  ```tsx
  <AddCompetitorDialog
    trigger={<Button variant="primary">Add Competitor</Button>}
  />
  ```
- This wires the CTA to actually open the dialog

**File 3: `src/components/competitors/competitor-card.tsx`**

- Import `RemoveCompetitorButton` from `@/components/competitors/remove-competitor-button`
- Add the RemoveCompetitorButton to the card, positioned in the top-right corner of the card content, visible on hover. Place it inside the `<CardContent>` div, BEFORE the existing top row (avatar + handle).
- Add a wrapper div with `group` class on the `<Card>` element (add `className="cursor-pointer group"` to Card, or wrap the CardContent)
- Position the remove button absolutely in the top-right of CardContent:
  ```tsx
  <div className="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity">
    <RemoveCompetitorButton competitorId={data.id} handle={data.tiktok_handle} />
  </div>
  ```
- Make CardContent `relative` (add `relative` to its className) so the absolute positioning works
- The `RemoveCompetitorButton` already handles `e.preventDefault()` and `e.stopPropagation()` so the parent `<Link>` won't fire

**File 4: `src/components/competitors/competitor-table.tsx`**

- Import `RemoveCompetitorButton` from `@/components/competitors/remove-competitor-button`
- Add a new column header after the existing "Status" column:
  ```tsx
  <th className="py-3 px-4 w-10">
    <span className="sr-only">Actions</span>
  </th>
  ```
- Add a new `<td>` as the last cell in each table row:
  ```tsx
  <td className="py-3 px-4">
    <RemoveCompetitorButton competitorId={s.id} handle={s.tiktok_handle} />
  </td>
  ```
- The `RemoveCompetitorButton` already handles `e.stopPropagation()` so the row's `onClick` navigation won't fire
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors.
Run `grep -c 'AddCompetitorDialog' src/app/(app)/competitors/competitors-client.tsx` -- should be >= 1.
Run `grep -c 'AddCompetitorDialog' src/components/competitors/competitor-empty-state.tsx` -- should be >= 1.
Run `grep -c 'RemoveCompetitorButton' src/components/competitors/competitor-card.tsx` -- should be >= 1.
Run `grep -c 'RemoveCompetitorButton' src/components/competitors/competitor-table.tsx` -- should be >= 1.
  </verify>
  <done>
Dashboard header has an "Add Competitor" button opening AddCompetitorDialog. Empty state CTA button opens AddCompetitorDialog. Competitor cards show a remove button on hover (top-right). Table rows have a remove button in the last column. All wired to their respective server actions with toast feedback.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. AddCompetitorDialog component exists and imports addCompetitor action
3. RemoveCompetitorButton component exists and imports removeCompetitor action
4. competitors-client.tsx imports and renders AddCompetitorDialog with Plus button
5. competitor-empty-state.tsx wraps CTA button in AddCompetitorDialog
6. competitor-card.tsx renders RemoveCompetitorButton on hover
7. competitor-table.tsx renders RemoveCompetitorButton in each row
8. All event propagation is handled (e.preventDefault + e.stopPropagation on remove button)
</verification>

<success_criteria>
- AddCompetitorDialog renders a form dialog with handle input, calls addCompetitor, shows toast feedback
- RemoveCompetitorButton renders trash icon with AlertDialog confirmation, calls removeCompetitor, shows toast feedback
- Dashboard header "Add Competitor" button opens the dialog
- Empty state CTA button opens the dialog
- Competitor cards show remove button on hover (top-right corner)
- Table rows have remove button in actions column
- Clicking remove on a card does NOT navigate to detail page
- Clicking remove on a table row does NOT navigate to detail page
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/08-gap-closure/08-02-SUMMARY.md`
</output>
