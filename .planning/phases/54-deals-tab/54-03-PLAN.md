---
phase: 54-deals-tab
plan: 03
type: execute
wave: 2
depends_on: ["54-01", "54-02"]
files_modified:
  - src/components/app/brand-deals/deals-tab.tsx
  - src/components/app/brand-deals/deal-apply-modal.tsx
  - src/components/app/brand-deals/brand-deals-page.tsx
  - src/components/app/brand-deals/index.ts

autonomous: false

must_haves:
  truths:
    - "Deals tab shows 10 deal cards in a responsive grid (3 columns on lg, 2 on sm, 1 on mobile)"
    - "New This Week row appears above the main grid showing deals with isNew flag"
    - "Filtering by category updates the grid in real-time; search by brand name is debounced"
    - "Empty state renders when no deals match the current filter + search combination"
    - "Clicking 'Apply' on a deal card opens a modal with name, email, and pitch fields"
    - "Submitting the modal shows success state, then closes and morphs the card button to 'Applied' badge"
    - "Applied deal cards show muted opacity treatment"
    - "Applied state persists across filter changes (not lost when filtering)"
    - "Applied state is stored in BrandDealsPage parent (survives tab switches)"
    - "Deals tab replaces the placeholder div in brand-deals-page.tsx"
  artifacts:
    - path: "src/components/app/brand-deals/deals-tab.tsx"
      provides: "DealsTab container component with filter/search/applied state"
      exports: ["DealsTab"]
      min_lines: 80
    - path: "src/components/app/brand-deals/deal-apply-modal.tsx"
      provides: "DealApplyModal with form and success state"
      exports: ["DealApplyModal"]
      min_lines: 80
    - path: "src/components/app/brand-deals/brand-deals-page.tsx"
      provides: "Updated BrandDealsPage with DealsTab integration and appliedDeals state"
      min_lines: 80
    - path: "src/components/app/brand-deals/index.ts"
      provides: "Updated barrel exports"
  key_links:
    - from: "src/components/app/brand-deals/deals-tab.tsx"
      to: "src/components/app/brand-deals/deal-card.tsx"
      via: "Renders DealCard in grid"
      pattern: "DealCard"
    - from: "src/components/app/brand-deals/deals-tab.tsx"
      to: "src/components/app/brand-deals/deal-filter-bar.tsx"
      via: "DealFilterBar for search and category filtering"
      pattern: "DealFilterBar"
    - from: "src/components/app/brand-deals/deals-tab.tsx"
      to: "src/components/app/brand-deals/new-this-week-row.tsx"
      via: "NewThisWeekRow for featured deals section"
      pattern: "NewThisWeekRow"
    - from: "src/components/app/brand-deals/deals-tab.tsx"
      to: "src/components/app/brand-deals/deals-empty-state.tsx"
      via: "DealsEmptyState when filter yields zero results"
      pattern: "DealsEmptyState"
    - from: "src/components/app/brand-deals/deals-tab.tsx"
      to: "src/components/app/brand-deals/deal-apply-modal.tsx"
      via: "DealApplyModal opened on Apply click"
      pattern: "DealApplyModal"
    - from: "src/components/app/brand-deals/brand-deals-page.tsx"
      to: "src/components/app/brand-deals/deals-tab.tsx"
      via: "DealsTab rendered in deals Tabs.Content"
      pattern: "<DealsTab"
    - from: "src/components/app/brand-deals/deals-tab.tsx"
      to: "src/hooks/use-debounce.ts"
      via: "useDebouncedCallback for search debouncing"
      pattern: "useDebouncedCallback"
---

<objective>
Wire all Phase 54 components into the DealsTab container, build the Apply modal, and integrate into BrandDealsPage -- completing the Deals tab with full interactivity.

Purpose: This plan integrates all the building blocks from Plans 01 and 02 into a working, interactive Deals tab. It adds the Apply modal (the primary user interaction), manages all state (filters, search, applied deals), and replaces the placeholder in BrandDealsPage.

Output: Four files -- DealsTab container, DealApplyModal, updated BrandDealsPage, and updated index.ts barrel exports.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-deals-tab/54-CONTEXT.md
@.planning/phases/54-deals-tab/54-RESEARCH.md
@.planning/phases/54-deals-tab/54-01-SUMMARY.md
@.planning/phases/54-deals-tab/54-02-SUMMARY.md

@src/types/brand-deals.ts
@src/lib/mock-brand-deals.ts
@src/components/app/brand-deals/brand-deals-page.tsx
@src/components/app/brand-deals/index.ts
@src/components/ui/dialog.tsx
@src/components/ui/input.tsx
@src/components/ui/button.tsx
@src/components/ui/badge.tsx
@src/components/app/leave-feedback-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DealApplyModal with form fields and success state</name>
  <files>src/components/app/brand-deals/deal-apply-modal.tsx</files>
  <action>
Create `src/components/app/brand-deals/deal-apply-modal.tsx` as a "use client" component.

**DealApplyModalProps interface:**
```typescript
interface DealApplyModalProps {
  deal: BrandDeal | null;
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onApplied: (dealId: string) => void;
}
```

**Modal implementation:**

Use the DESIGN SYSTEM `Dialog` components (NOT raw Radix primitives like the leave-feedback-modal does). Import from `@/components/ui/dialog`:
- `Dialog`, `DialogContent`, `DialogHeader`, `DialogTitle`, `DialogDescription`, `DialogFooter`, `DialogClose`

Use `InputField` from `@/components/ui/input` (NOT raw `<input>` elements) for form fields.
Use `Button` from `@/components/ui/button` for submit and cancel.

**State:**
```typescript
const [name, setName] = useState("");
const [email, setEmail] = useState("");
const [pitch, setPitch] = useState("");
const [isSubmitting, setIsSubmitting] = useState(false);
const [submitted, setSubmitted] = useState(false);
```

**Form fields (inside DialogContent size="md"):**
1. DialogHeader with DialogTitle "Apply to {deal.brandName}" and DialogDescription "Fill in your details to apply for this deal."
2. Form body (padded `<div className="space-y-4 px-6 py-4">`):
   - `InputField label="Your name" placeholder="John Doe"` -- controlled by name state
   - `InputField label="Contact email" type="email" placeholder="you@example.com"` -- controlled by email state
   - `<textarea>` for pitch (no InputField for textarea -- use styled textarea matching design system):
     - Label: "Short pitch"
     - Placeholder: "Why are you a good fit for this deal?"
     - 3-4 rows
     - Style it to match InputField styling: `w-full rounded-md border border-border bg-surface px-3 py-2 text-foreground placeholder:text-foreground-muted focus:outline-none focus:ring-2 focus:ring-accent/50 focus:border-accent transition-colors`
3. DialogFooter with:
   - `DialogClose asChild` wrapping `<Button variant="secondary">Cancel</Button>`
   - `<Button variant="primary" type="submit" loading={isSubmitting} disabled={!name.trim() || !email.trim() || !pitch.trim()}>Apply</Button>`

**Submit flow (follows leave-feedback-modal pattern):**
1. `e.preventDefault()`
2. Set `isSubmitting = true`
3. `await new Promise(r => setTimeout(r, 800))` -- simulate API
4. Set `isSubmitting = false`, `submitted = true`
5. After 1500ms timeout:
   - Call `onApplied(deal.id)`
   - Reset all form fields to empty strings
   - Set `submitted = false`
   - Call `onOpenChange(false)`

**Success state:**
When `submitted === true`, replace form body with a success view:
- Centered checkmark icon in green circle (use Check from `@phosphor-icons/react` or inline SVG)
- "Application submitted!" heading
- "You'll hear back from {deal.brandName} soon." subtext

**Reset on close:**
When `onOpenChange` is called with `false` and `!submitted`, reset form fields. This handles the case where user closes modal without submitting.

**Guard:** If `deal` is null, return null (modal won't render).

Wrap the form in `<Dialog open={open} onOpenChange={onOpenChange}>` -- controlled dialog pattern.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors.
  </verify>
  <done>
DealApplyModal renders a controlled Dialog with name, email, and pitch fields. Submit shows loading state, then success animation, then closes and calls onApplied. Form resets on close. Uses design system Dialog/InputField/Button components.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DealsTab container and wire into BrandDealsPage</name>
  <files>
    src/components/app/brand-deals/deals-tab.tsx
    src/components/app/brand-deals/brand-deals-page.tsx
    src/components/app/brand-deals/index.ts
  </files>
  <action>
**Part A: Create deals-tab.tsx**

Create `src/components/app/brand-deals/deals-tab.tsx` as a "use client" container component.

**DealsTabProps interface:**
```typescript
interface DealsTabProps {
  appliedDeals: Set<string>;
  onApplyDeal: (dealId: string) => void;
}
```

appliedDeals state is LIFTED to BrandDealsPage to survive tab switches (per Pitfall 4 in RESEARCH.md). DealsTab receives it as a prop.

**State (internal to DealsTab):**
```typescript
const [activeCategory, setActiveCategory] = useState<BrandDealCategory | "all">("all");
const [searchQuery, setSearchQuery] = useState("");
const [debouncedSearch, setDebouncedSearch] = useState("");
const [applyingDeal, setApplyingDeal] = useState<BrandDeal | null>(null);
```

**Debounce wiring:**
```typescript
const debouncedSetSearch = useDebouncedCallback(
  useCallback((value: string) => setDebouncedSearch(value), []),
  300
);

function handleSearchChange(query: string) {
  setSearchQuery(query); // Immediate UI update
  debouncedSetSearch(query); // Debounced filter update
}
```

**Filtered deals (useMemo):**
```typescript
const filteredDeals = useMemo(() => {
  return MOCK_DEALS.filter((deal) => {
    const matchesCategory = activeCategory === "all" || deal.category === activeCategory;
    const matchesSearch = deal.brandName.toLowerCase().includes(debouncedSearch.toLowerCase());
    return matchesCategory && matchesSearch;
  });
}, [activeCategory, debouncedSearch]);

const newDeals = useMemo(() => MOCK_DEALS.filter((d) => d.isNew), []);
```

**Clear filters handler:**
```typescript
function handleClearFilters() {
  setActiveCategory("all");
  setSearchQuery("");
  setDebouncedSearch("");
}
```

**Apply handler:**
```typescript
function handleApplyClick(deal: BrandDeal) {
  setApplyingDeal(deal);
}

function handleApplied(dealId: string) {
  onApplyDeal(dealId);
  setApplyingDeal(null);
}
```

**Render layout (top to bottom):**
1. `<NewThisWeekRow deals={newDeals} appliedDeals={appliedDeals} onApply={handleApplyClick} />`
2. `<DealFilterBar activeCategory={activeCategory} onCategoryChange={setActiveCategory} searchQuery={searchQuery} onSearchChange={handleSearchChange} />`
3. If `filteredDeals.length === 0`: `<DealsEmptyState onClearFilters={handleClearFilters} />`
4. Else: Responsive grid:
   ```tsx
   <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 mt-6">
     {filteredDeals.map((deal) => (
       <DealCard
         key={deal.id}
         deal={deal}
         isApplied={appliedDeals.has(deal.id)}
         onApply={handleApplyClick}
       />
     ))}
   </div>
   ```
5. `<DealApplyModal deal={applyingDeal} open={!!applyingDeal} onOpenChange={(open) => { if (!open) setApplyingDeal(null); }} onApplied={handleApplied} />`

**Imports:**
- Components: DealCard, DealFilterBar, DealsEmptyState, NewThisWeekRow, DealApplyModal (all relative)
- Hooks: useDebouncedCallback from `@/hooks/use-debounce`
- Data: MOCK_DEALS from `@/lib/mock-brand-deals`
- Types: BrandDeal, BrandDealCategory from `@/types/brand-deals`
- React: useState, useMemo, useCallback

---

**Part B: Update brand-deals-page.tsx**

Edit `src/components/app/brand-deals/brand-deals-page.tsx`:

1. Add import: `import { DealsTab } from "./deals-tab";`
2. Add state for applied deals (lifted from DealsTab):
   ```typescript
   const [appliedDeals, setAppliedDeals] = useState<Set<string>>(new Set());

   function handleApplyDeal(dealId: string) {
     setAppliedDeals((prev) => new Set(prev).add(dealId));
   }
   ```
   Add `import { useState } from "react";` if not already present.

3. Replace the deals tab placeholder:
   Change from:
   ```tsx
   <Tabs.Content value="deals" forceMount={currentTab === "deals" ? true : undefined} className="outline-none">
     <div className="flex min-h-[300px] items-center justify-center rounded-xl border border-border-subtle">
       <p className="text-foreground-muted">Deals tab content -- Phase 54</p>
     </div>
   </Tabs.Content>
   ```
   To:
   ```tsx
   <Tabs.Content value="deals" forceMount={currentTab === "deals" ? true : undefined} className="outline-none">
     <DealsTab appliedDeals={appliedDeals} onApplyDeal={handleApplyDeal} />
   </Tabs.Content>
   ```

   Leave earnings and affiliates tab placeholders unchanged.

---

**Part C: Update index.ts barrel exports**

Add to `src/components/app/brand-deals/index.ts`:
```typescript
export { DealsTab } from "./deals-tab";
```
Keep existing BrandDealsPage export.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors across all modified files.
Run `pnpm build` (or `npm run build`) to verify production build succeeds.
  </verify>
  <done>
DealsTab container renders NewThisWeekRow + DealFilterBar + responsive card grid + empty state + apply modal. Applied state lifted to BrandDealsPage and survives tab switches. Grid is 3 cols on lg, 2 on sm, 1 on mobile. Search is debounced at 300ms. Clear filters resets both category and search. Apply opens modal, modal submit marks deal as applied. brand-deals-page.tsx imports DealsTab and replaces placeholder. index.ts exports updated.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Deals tab with card grid, filter pills, debounced search, "New This Week" featured row, and Apply modal with success state. Applied cards show muted opacity. Color semantics: orange (fashion/beauty/food), green (payouts), blue (tech/gaming/finance).</what-built>
  <how-to-verify>
1. Start dev server: `pnpm dev` (or `npm run dev`)
2. Navigate to http://localhost:3000/brand-deals?tab=deals
3. Verify "New This Week" horizontal scroll row at top with 3 featured deal cards (Nike, Sephora, Razer) and info badge showing "3"
4. Verify main grid shows 10 deal cards in 3-column layout (resize browser to verify 2-col tablet, 1-col mobile)
5. Verify each card has: brand logo (small, inline), brand name, 3-line clamped description, green payout top-right, colored category pill, status badge, Apply button
6. Click a category filter pill (e.g., "tech") -- grid should filter to tech deals only
7. Type a brand name in search (e.g., "Nike") -- grid should filter after brief debounce delay
8. Combine filter + search, then verify "No deals found" empty state appears when nothing matches
9. Click "Clear filters" button in empty state -- grid should reset to all deals
10. Click "Apply" on any deal card -- modal should open with name, email, pitch fields
11. Fill all fields and click "Apply" in modal -- should show loading, then success checkmark, then close
12. After modal closes, the card should show "Applied" badge (green) instead of Apply button, and card should be slightly muted (opacity)
13. Switch to another tab (Earnings or Affiliates) and back -- applied state should persist
14. Verify edge case deal-010: long brand name truncates, payout shows "Revenue share TBD"
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `pnpm build` (or `npm run build`) succeeds
3. Navigating to /brand-deals?tab=deals shows the complete deals tab
4. Deal cards render in responsive 3/2/1 column grid
5. Filter pills work with real-time category filtering
6. Search input debounces at 300ms
7. Empty state renders when no deals match, with working "Clear filters" CTA
8. Apply modal opens on button click, has 3 fields, shows success state
9. Applied cards show "Applied" badge and muted opacity
10. Applied state survives tab switches (lifted to BrandDealsPage)
11. New This Week row renders with horizontal scroll and snap behavior
</verification>

<success_criteria>
- DealsTab container correctly composes all Plan 01 and Plan 02 components
- Applied state persists across tab switches (lifted to parent)
- Apply modal uses design system Dialog/InputField/Button (not raw primitives)
- Responsive grid: 3 cols lg, 2 cols sm, 1 col mobile
- All 14 requirements (DEAL-01 through DEAL-12, PLSH-01, PLSH-02) are addressed
- Human verification confirms visual correctness and interaction flow
</success_criteria>

<output>
After completion, create `.planning/phases/54-deals-tab/54-03-SUMMARY.md`
</output>
