---
phase: 11-extraction
plan: 04
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - extraction/scripts/capture-modals.ts
  - extraction/scripts/capture-settings.ts
  - extraction/scripts/capture-simulation.ts
  - extraction/scripts/capture-flows.ts
autonomous: true

must_haves:
  truths:
    - "Simulation flow captured through all 4 loading phases"
    - "Results panel captured with sections expanded/collapsed"
    - "Test history captured empty, with items, and with delete modal"
    - "Settings pages captured for all tabs"
    - "All modals captured (feedback, create society, delete confirmation)"
    - "Mobile viewport screenshots exist for all key screens"
    - "Video recordings capture animation timing for reference"
  artifacts:
    - path: "extraction/screenshots/desktop/simulation/loading-phase-1.png"
      provides: "First loading phase screenshot"
    - path: "extraction/screenshots/desktop/results/panel-default.png"
      provides: "Results panel default state"
    - path: "extraction/screenshots/desktop/settings/profile.png"
      provides: "Settings profile tab"
    - path: "extraction/screenshots/desktop/modals/feedback.png"
      provides: "Leave Feedback modal"
    - path: "extraction/videos/flows/simulation-flow.webm"
      provides: "Full simulation flow video recording"
    - path: "extraction/scripts/capture-simulation.ts"
      provides: "Simulation and results capture script"
    - path: "extraction/scripts/capture-flows.ts"
      provides: "Video recording script for user flows"
  key_links:
    - from: "extraction/scripts/capture-flows.ts"
      to: "extraction/videos/flows/"
      via: "recordVideo"
      pattern: "recordVideo.*dir"
---

<objective>
Extract modals, settings, simulation states, and record video of user flows from app.societies.io.

Purpose: Complete the extraction coverage with simulation phases, results panel, settings pages, modals, and video recordings that capture animation timing for Phase 13 refinement.
Output: Full screenshot coverage of remaining screens plus video recordings of key user flows.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-extraction/11-CONTEXT.md
@.planning/phases/11-extraction/11-RESEARCH.md
@.planning/phases/11-extraction/11-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create simulation and results capture script</name>
  <files>
    - extraction/scripts/capture-simulation.ts
  </files>
  <action>
Create extraction/scripts/capture-simulation.ts that captures:

**1. Simulation Loading Phases (EXT-07)**:
- Phase 1: `simulation/loading-phase-1.png`
- Phase 2: `simulation/loading-phase-2.png`
- Phase 3: `simulation/loading-phase-3.png`
- Phase 4: `simulation/loading-phase-4.png`
- Complete: `simulation/loading-complete.png`

**2. Results Panel (EXT-08)**:
- Default state (collapsed sections): `results/panel-default.png`
- Impact score section: `results/impact-score.png`
- Attention section expanded: `results/attention-expanded.png`
- Variants section: `results/variants.png`
- Insights section: `results/insights.png`
- Themes section: `results/themes.png`

**3. Test History (EXT-09)**:
- Empty history: `history/empty.png`
- With test items: `history/with-items.png`
- Item selected: `history/item-selected.png`
- Delete confirmation modal: `history/delete-modal.png`

Script structure:
```typescript
import { chromium } from 'playwright';
import { VIEWPORTS, ViewportName, createAuthContext, ensureDir, scrollToBottom } from './utils';

async function captureSimulationAndResults() {
  const browser = await chromium.launch();

  for (const viewport of ['desktop', 'mobile'] as ViewportName[]) {
    const context = await createAuthContext(browser, viewport);
    const page = await context.newPage();

    await page.goto('https://app.societies.io/dashboard');
    await page.waitForLoadState('networkidle');

    // ===== SIMULATION FLOW =====
    const simDir = `./extraction/screenshots/${viewport}/simulation`;
    ensureDir(simDir);

    // Start a test simulation
    const newTestBtn = page.locator('[data-testid="new-test"], button:has-text("New Test")').first();
    if (await newTestBtn.isVisible()) {
      await newTestBtn.click();
      await page.waitForTimeout(300);

      // Select TikTok (or first available type)
      const tiktokOption = page.locator('[data-testid*="tiktok"], button:has-text("TikTok")').first();
      if (await tiktokOption.isVisible()) {
        await tiktokOption.click();
        await page.waitForTimeout(300);

        // Fill form
        const textarea = page.locator('textarea').first();
        if (await textarea.isVisible()) {
          await textarea.fill('Test content for simulation capture. Analyzing social media impact.');
        }

        // Submit to start simulation
        const simulateBtn = page.locator('button:has-text("Simulate"), button[type="submit"]').first();
        if (await simulateBtn.isVisible()) {
          await simulateBtn.click();

          // Capture loading phases (timing depends on app behavior)
          for (let phase = 1; phase <= 4; phase++) {
            await page.waitForTimeout(1500); // Approximate phase timing
            await page.screenshot({ path: `${simDir}/loading-phase-${phase}.png`, fullPage: true });
          }

          // Wait for results to appear
          await page.waitForSelector('[data-testid="results"], [class*="results"]', { timeout: 180000 });
          await page.screenshot({ path: `${simDir}/loading-complete.png`, fullPage: true });
        }
      }
    }

    // ===== RESULTS PANEL =====
    const resultsDir = `./extraction/screenshots/${viewport}/results`;
    ensureDir(resultsDir);

    // Results should be visible after simulation
    const resultsPanel = page.locator('[data-testid="results-panel"], [class*="results"]');
    if (await resultsPanel.isVisible()) {
      await scrollToBottom(page);
      await page.screenshot({ path: `${resultsDir}/panel-default.png`, fullPage: true });

      // Try to expand/collapse sections
      const sections = ['impact', 'attention', 'variants', 'insights', 'themes'];
      for (const section of sections) {
        const sectionTrigger = page.locator(`[data-testid*="${section}"], button:has-text("${section}"), [class*="${section}"]`).first();
        if (await sectionTrigger.isVisible()) {
          await sectionTrigger.click();
          await page.waitForTimeout(200);
          await page.screenshot({ path: `${resultsDir}/${section}-expanded.png`, fullPage: true });
        }
      }
    }

    // ===== TEST HISTORY =====
    const historyDir = `./extraction/screenshots/${viewport}/history`;
    ensureDir(historyDir);

    // Navigate back to dashboard to see history
    await page.goto('https://app.societies.io/dashboard');
    await page.waitForLoadState('networkidle');

    // History should be in sidebar
    const historySection = page.locator('[data-testid="test-history"], [class*="history"]');
    if (await historySection.isVisible()) {
      await page.screenshot({ path: `${historyDir}/with-items.png`, fullPage: true });

      // Click on a history item
      const historyItem = page.locator('[data-testid*="history-item"], [class*="history"] li, [class*="history"] button').first();
      if (await historyItem.isVisible()) {
        await historyItem.click();
        await page.waitForTimeout(300);
        await page.screenshot({ path: `${historyDir}/item-selected.png`, fullPage: true });

        // Try to open delete modal (usually via three-dot menu)
        const menuTrigger = page.locator('[data-testid*="menu"], button[aria-haspopup], [class*="more"]').first();
        if (await menuTrigger.isVisible()) {
          await menuTrigger.click();
          await page.waitForTimeout(200);

          const deleteBtn = page.locator('button:has-text("Delete"), [data-testid*="delete"]').first();
          if (await deleteBtn.isVisible()) {
            await deleteBtn.click();
            await page.waitForTimeout(300);
            await page.screenshot({ path: `${historyDir}/delete-modal.png`, fullPage: true });
            await page.keyboard.press('Escape');
          }
        }
      }
    }

    await context.close();
  }

  await browser.close();
  console.log('Simulation and results capture complete!');
}

captureSimulationAndResults().catch(console.error);
```

  </action>
  <verify>
Run script: `npx ts-node extraction/scripts/capture-simulation.ts`
Screenshots exist in:
- extraction/screenshots/desktop/simulation/
- extraction/screenshots/desktop/results/
- extraction/screenshots/desktop/history/
  </verify>
  <done>
- Simulation loading phases captured (1-4 plus complete)
- Results panel captured with section expansion states
- Test history captured with item selection and delete modal
- Both viewports covered
  </done>
</task>

<task type="auto">
  <name>Task 2: Create modals and settings capture script</name>
  <files>
    - extraction/scripts/capture-modals.ts
    - extraction/scripts/capture-settings.ts
  </files>
  <action>
**1. Create extraction/scripts/capture-modals.ts (EXT-11)**:

```typescript
import { chromium } from 'playwright';
import { VIEWPORTS, ViewportName, createAuthContext, ensureDir } from './utils';

async function captureModals() {
  const browser = await chromium.launch();

  for (const viewport of ['desktop', 'mobile'] as ViewportName[]) {
    const context = await createAuthContext(browser, viewport);
    const page = await context.newPage();

    await page.goto('https://app.societies.io/dashboard');
    await page.waitForLoadState('networkidle');

    const outputDir = `./extraction/screenshots/${viewport}/modals`;
    ensureDir(outputDir);

    // ===== FEEDBACK MODAL =====
    // Usually triggered from settings or help menu
    const feedbackTrigger = page.locator('button:has-text("Feedback"), button:has-text("Leave Feedback"), [data-testid*="feedback"]').first();
    if (await feedbackTrigger.isVisible()) {
      await feedbackTrigger.click();
      await page.waitForTimeout(300);
      await page.screenshot({ path: `${outputDir}/feedback.png`, fullPage: true });
      await page.keyboard.press('Escape');
      await page.waitForTimeout(200);
    }

    // ===== CREATE SOCIETY MODAL =====
    const societySelector = page.locator('[data-testid="society-selector"]').first();
    if (await societySelector.isVisible()) {
      await societySelector.click();
      await page.waitForTimeout(300);

      const createBtn = page.locator('button:has-text("Create"), button:has-text("New Society")').first();
      if (await createBtn.isVisible()) {
        await createBtn.click();
        await page.waitForTimeout(300);
        await page.screenshot({ path: `${outputDir}/create-society.png`, fullPage: true });
        await page.keyboard.press('Escape');
        await page.waitForTimeout(200);
      }
      await page.keyboard.press('Escape');
    }

    // ===== DELETE CONFIRMATION MODAL =====
    // Usually found in test history or settings
    // Try to trigger from history
    const historyItem = page.locator('[data-testid*="history-item"]').first();
    if (await historyItem.isVisible()) {
      await historyItem.hover();
      const menuBtn = page.locator('[data-testid*="menu"], button[aria-haspopup]').first();
      if (await menuBtn.isVisible()) {
        await menuBtn.click();
        await page.waitForTimeout(200);

        const deleteBtn = page.locator('button:has-text("Delete")').first();
        if (await deleteBtn.isVisible()) {
          await deleteBtn.click();
          await page.waitForTimeout(300);
          await page.screenshot({ path: `${outputDir}/delete-confirmation.png`, fullPage: true });
          await page.keyboard.press('Escape');
        }
      }
    }

    await context.close();
  }

  await browser.close();
  console.log('Modals capture complete!');
}

captureModals().catch(console.error);
```

**2. Create extraction/scripts/capture-settings.ts (EXT-10)**:

```typescript
import { chromium } from 'playwright';
import { VIEWPORTS, ViewportName, createAuthContext, ensureDir, scrollToBottom } from './utils';

async function captureSettings() {
  const browser = await chromium.launch();

  for (const viewport of ['desktop', 'mobile'] as ViewportName[]) {
    const context = await createAuthContext(browser, viewport);
    const page = await context.newPage();

    const outputDir = `./extraction/screenshots/${viewport}/settings`;
    ensureDir(outputDir);

    // Navigate to settings page
    await page.goto('https://app.societies.io/settings');
    await page.waitForLoadState('networkidle');

    // If settings is behind navigation, try to find settings link
    if (page.url().includes('dashboard')) {
      const settingsLink = page.locator('a:has-text("Settings"), button:has-text("Settings"), [data-testid*="settings"]').first();
      if (await settingsLink.isVisible()) {
        await settingsLink.click();
        await page.waitForLoadState('networkidle');
      }
    }

    // Capture each settings tab
    const tabs = ['profile', 'account', 'notifications', 'billing', 'team'];

    for (const tab of tabs) {
      const tabTrigger = page.locator(`[data-testid*="${tab}"], button:has-text("${tab}"), a:has-text("${tab}")`).first();

      if (await tabTrigger.isVisible()) {
        await tabTrigger.click();
        await page.waitForTimeout(300);
        await scrollToBottom(page);
        await page.screenshot({ path: `${outputDir}/${tab}.png`, fullPage: true });
      }
    }

    // Also capture the default/overview state
    await page.goto('https://app.societies.io/settings');
    await page.waitForLoadState('networkidle');
    await scrollToBottom(page);
    await page.screenshot({ path: `${outputDir}/default.png`, fullPage: true });

    await context.close();
  }

  await browser.close();
  console.log('Settings capture complete!');
}

captureSettings().catch(console.error);
```

  </action>
  <verify>
Run both scripts:
- `npx ts-node extraction/scripts/capture-modals.ts`
- `npx ts-node extraction/scripts/capture-settings.ts`

Check screenshots exist in:
- extraction/screenshots/desktop/modals/
- extraction/screenshots/desktop/settings/
- extraction/screenshots/mobile/modals/
- extraction/screenshots/mobile/settings/
  </verify>
  <done>
- All modals captured (feedback, create society, delete confirmation)
- Settings tabs captured (profile, account, notifications, billing, team)
- Both viewports covered
  </done>
</task>

<task type="auto">
  <name>Task 3: Create video flow recording script</name>
  <files>
    - extraction/scripts/capture-flows.ts
  </files>
  <action>
Create extraction/scripts/capture-flows.ts that records complete user flows as video:

Per CONTEXT.md: "Record complete user flow videos to capture animation timing, transition effects, loading animations, hover/interaction micro-animations"

**Flows to record**:
1. Simulation flow: new test -> fill form -> simulate -> results
2. Society creation flow: open selector -> create -> fill form -> confirm
3. Test history flow: select history item -> view results -> delete

Script structure:
```typescript
import { chromium, BrowserContext, Page } from 'playwright';
import { VIEWPORTS, createAuthContext, ensureDir } from './utils';

async function recordFlows() {
  const browser = await chromium.launch();

  // Videos are only recorded at desktop for simplicity
  // Mobile animations can be captured separately if needed
  ensureDir('./extraction/videos/flows');

  // ===== SIMULATION FLOW =====
  {
    const context = await browser.newContext({
      storageState: './extraction/auth/.auth/state.json',
      viewport: VIEWPORTS.desktop,
      recordVideo: {
        dir: './extraction/videos/flows/',
        size: VIEWPORTS.desktop,
      },
    });

    const page = await context.newPage();
    await page.goto('https://app.societies.io/dashboard');
    await page.waitForLoadState('networkidle');

    // Execute simulation flow
    const newTestBtn = page.locator('[data-testid="new-test"], button:has-text("New Test")').first();
    if (await newTestBtn.isVisible()) {
      await newTestBtn.click();
      await page.waitForTimeout(500);

      const tiktokOption = page.locator('[data-testid*="tiktok"], button:has-text("TikTok")').first();
      if (await tiktokOption.isVisible()) {
        await tiktokOption.click();
        await page.waitForTimeout(500);

        const textarea = page.locator('textarea').first();
        if (await textarea.isVisible()) {
          // Type slowly to capture typing animation
          await textarea.type('Sample TikTok content for simulation testing. #testing #demo', { delay: 50 });
        }

        const simulateBtn = page.locator('button:has-text("Simulate"), button[type="submit"]').first();
        if (await simulateBtn.isVisible()) {
          await simulateBtn.click();

          // Wait for simulation to complete (up to 3 minutes)
          await page.waitForSelector('[data-testid="results"], [class*="results"]', { timeout: 180000 });
          await page.waitForTimeout(2000); // Let results animations complete
        }
      }
    }

    // CRITICAL: Close context to save video
    await context.close();

    // Rename video to meaningful name
    const videoPath = await page.video()?.path();
    if (videoPath) {
      const fs = await import('fs');
      fs.renameSync(videoPath, './extraction/videos/flows/simulation-flow.webm');
    }
  }

  // ===== SOCIETY CREATION FLOW =====
  {
    const context = await browser.newContext({
      storageState: './extraction/auth/.auth/state.json',
      viewport: VIEWPORTS.desktop,
      recordVideo: {
        dir: './extraction/videos/flows/',
        size: VIEWPORTS.desktop,
      },
    });

    const page = await context.newPage();
    await page.goto('https://app.societies.io/dashboard');
    await page.waitForLoadState('networkidle');

    const societySelector = page.locator('[data-testid="society-selector"]').first();
    if (await societySelector.isVisible()) {
      await societySelector.click();
      await page.waitForTimeout(500);

      const createBtn = page.locator('button:has-text("Create"), button:has-text("New")').first();
      if (await createBtn.isVisible()) {
        await createBtn.click();
        await page.waitForTimeout(500);

        // Fill create form (if present)
        const nameInput = page.locator('input[name*="name"], input[placeholder*="name"]').first();
        if (await nameInput.isVisible()) {
          await nameInput.type('Test Society Demo', { delay: 50 });
        }

        // Wait a bit then close (don't actually create)
        await page.waitForTimeout(1000);
        await page.keyboard.press('Escape');
        await page.waitForTimeout(500);
      }
    }

    await context.close();

    const videoPath = await page.video()?.path();
    if (videoPath) {
      const fs = await import('fs');
      fs.renameSync(videoPath, './extraction/videos/flows/society-creation-flow.webm');
    }
  }

  // ===== TEST HISTORY FLOW =====
  {
    const context = await browser.newContext({
      storageState: './extraction/auth/.auth/state.json',
      viewport: VIEWPORTS.desktop,
      recordVideo: {
        dir: './extraction/videos/flows/',
        size: VIEWPORTS.desktop,
      },
    });

    const page = await context.newPage();
    await page.goto('https://app.societies.io/dashboard');
    await page.waitForLoadState('networkidle');

    // Click on history item
    const historyItem = page.locator('[data-testid*="history-item"], [class*="history"] li').first();
    if (await historyItem.isVisible()) {
      await historyItem.click();
      await page.waitForTimeout(1000);

      // Open delete menu
      const menuBtn = page.locator('[data-testid*="menu"], button[aria-haspopup]').first();
      if (await menuBtn.isVisible()) {
        await menuBtn.click();
        await page.waitForTimeout(500);

        const deleteBtn = page.locator('button:has-text("Delete")').first();
        if (await deleteBtn.isVisible()) {
          await deleteBtn.click();
          await page.waitForTimeout(500);
          await page.keyboard.press('Escape'); // Cancel delete
          await page.waitForTimeout(500);
        }
      }
    }

    await context.close();

    const videoPath = await page.video()?.path();
    if (videoPath) {
      const fs = await import('fs');
      fs.renameSync(videoPath, './extraction/videos/flows/test-history-flow.webm');
    }
  }

  await browser.close();
  console.log('Flow video recording complete!');
}

recordFlows().catch(console.error);
```

  </action>
  <verify>
Run script: `npx ts-node extraction/scripts/capture-flows.ts`
Videos exist in:
- extraction/videos/flows/simulation-flow.webm
- extraction/videos/flows/society-creation-flow.webm
- extraction/videos/flows/test-history-flow.webm
  </verify>
  <done>
- Simulation flow video recorded (captures loading animations)
- Society creation flow video recorded
- Test history flow video recorded
- Videos provide animation timing reference for Phase 13
  </done>
</task>

</tasks>

<verification>
- [ ] `extraction/scripts/capture-simulation.ts` exists and runs
- [ ] `extraction/scripts/capture-modals.ts` exists and runs
- [ ] `extraction/scripts/capture-settings.ts` exists and runs
- [ ] `extraction/scripts/capture-flows.ts` exists and runs
- [ ] Simulation screenshots capture all 4 loading phases
- [ ] Results panel screenshots exist
- [ ] History screenshots exist (empty, with items, delete modal)
- [ ] Settings screenshots exist for all tabs
- [ ] Modal screenshots exist (feedback, create society, delete)
- [ ] Video recordings exist in extraction/videos/flows/
</verification>

<success_criteria>
All EXT requirements covered:
- EXT-07: Simulation loading phases captured
- EXT-08: Results panel sections captured
- EXT-09: Test history states captured
- EXT-10: Settings tabs captured
- EXT-11: All modals captured
- EXT-12: Mobile viewport included (via viewport loop in each script)
- EXT-13: Hover/focus states captured in previous plans + this plan

Video recordings provide animation timing reference for Phase 13 refinement.
</success_criteria>

<output>
After completion, create `.planning/phases/11-extraction/11-04-SUMMARY.md`
</output>
