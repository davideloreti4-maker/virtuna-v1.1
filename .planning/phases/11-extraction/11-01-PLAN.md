---
phase: 11-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - extraction/playwright.config.ts
  - extraction/scripts/capture-auth.ts
  - extraction/scripts/utils.ts
  - extraction/auth/.gitkeep
  - extraction/.gitignore
  - package.json
autonomous: false

must_haves:
  truths:
    - "Playwright is installed and configured for Chromium"
    - "Authentication state can be saved from a logged-in browser session"
    - "Saved auth state enables subsequent scripts to access app.societies.io authenticated"
  artifacts:
    - path: "extraction/playwright.config.ts"
      provides: "Playwright configuration with viewport presets and base URL"
      contains: "defineConfig"
    - path: "extraction/scripts/capture-auth.ts"
      provides: "Script to save authentication state from manual login"
      contains: "storageState"
    - path: "extraction/scripts/utils.ts"
      provides: "Shared utilities: viewports, screenshot helper, scroll handler"
      exports: ["VIEWPORTS", "captureScreen", "scrollToBottom"]
  key_links:
    - from: "extraction/scripts/capture-auth.ts"
      to: "extraction/auth/.auth/state.json"
      via: "storageState save"
      pattern: "storageState.*path"
---

<objective>
Setup Playwright extraction infrastructure with authentication handling and shared utilities.

Purpose: Establish the foundation for all extraction scripts — Playwright config, auth persistence, and reusable capture helpers.
Output: Working Playwright setup that can authenticate to app.societies.io and capture screenshots at both viewport sizes.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-extraction/11-CONTEXT.md
@.planning/phases/11-extraction/11-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Playwright and create extraction folder structure</name>
  <files>
    - package.json
    - extraction/playwright.config.ts
    - extraction/.gitignore
    - extraction/auth/.gitkeep
    - extraction/screenshots/.gitkeep
    - extraction/videos/.gitkeep
  </files>
  <action>
1. Install Playwright:
   ```bash
   pnpm add -D @playwright/test
   npx playwright install chromium
   ```

2. Create extraction folder structure:
   ```
   extraction/
   ├── playwright.config.ts
   ├── .gitignore
   ├── auth/
   │   └── .gitkeep
   ├── scripts/
   ├── screenshots/
   │   ├── desktop/
   │   └── mobile/
   └── videos/
       └── flows/
   ```

3. Create playwright.config.ts:
   ```typescript
   import { defineConfig } from '@playwright/test';

   export default defineConfig({
     testDir: './scripts',
     timeout: 120000,
     use: {
       baseURL: 'https://app.societies.io',
       trace: 'on-first-retry',
     },
     projects: [
       {
         name: 'desktop',
         use: {
           viewport: { width: 1440, height: 900 },
         },
       },
       {
         name: 'mobile',
         use: {
           viewport: { width: 375, height: 812 },
         },
       },
     ],
   });
   ```

4. Create extraction/.gitignore:
   ```
   auth/.auth/
   screenshots/
   videos/
   ```

  </action>
  <verify>
- `pnpm exec playwright --version` returns version
- `extraction/playwright.config.ts` exists
- Folder structure created
  </verify>
  <done>
- Playwright installed with Chromium browser
- Config file defines desktop (1440x900) and mobile (375x812) viewports
- Git ignores auth state and capture outputs
  </done>
</task>

<task type="auto">
  <name>Task 2: Create authentication capture script and shared utilities</name>
  <files>
    - extraction/scripts/capture-auth.ts
    - extraction/scripts/utils.ts
  </files>
  <action>
1. Create extraction/scripts/utils.ts with shared utilities:
   ```typescript
   import { Page, BrowserContext, chromium } from 'playwright';
   import * as fs from 'fs';
   import * as path from 'path';

   export const VIEWPORTS = {
     desktop: { width: 1440, height: 900 },
     mobile: { width: 375, height: 812 },
   } as const;

   export type ViewportName = keyof typeof VIEWPORTS;

   export const AUTH_STATE_PATH = './extraction/auth/.auth/state.json';
   export const SCREENSHOTS_DIR = './extraction/screenshots';
   export const VIDEOS_DIR = './extraction/videos';

   /**
    * Scroll to bottom of page to trigger lazy-loaded content
    * Per CONTEXT.md: "always scroll to bottom — top banner may push content down"
    */
   export async function scrollToBottom(page: Page): Promise<void> {
     await page.evaluate(async () => {
       await new Promise<void>((resolve) => {
         let totalHeight = 0;
         const distance = 100;
         const timer = setInterval(() => {
           const scrollHeight = document.body.scrollHeight;
           window.scrollBy(0, distance);
           totalHeight += distance;
           if (totalHeight >= scrollHeight) {
             clearInterval(timer);
             resolve();
           }
         }, 100);
       });
     });
     await page.waitForLoadState('networkidle');
   }

   /**
    * Capture screenshot with consistent naming
    */
   export async function captureScreen(
     page: Page,
     viewport: ViewportName,
     category: string,
     name: string,
     state?: string
   ): Promise<string> {
     const dir = path.join(SCREENSHOTS_DIR, viewport, category);
     fs.mkdirSync(dir, { recursive: true });

     const filename = state ? `${name}-${state}.png` : `${name}.png`;
     const filepath = path.join(dir, filename);

     await scrollToBottom(page);
     await page.screenshot({ path: filepath, fullPage: true });
     console.log(`Captured: ${filepath}`);
     return filepath;
   }

   /**
    * Create authenticated browser context
    */
   export async function createAuthContext(
     browser: ReturnType<typeof chromium.launch> extends Promise<infer T> ? T : never,
     viewport: ViewportName,
     options?: { recordVideo?: boolean }
   ): Promise<BrowserContext> {
     const contextOptions: any = {
       storageState: AUTH_STATE_PATH,
       viewport: VIEWPORTS[viewport],
     };

     if (options?.recordVideo) {
       contextOptions.recordVideo = {
         dir: VIDEOS_DIR + '/flows/',
         size: VIEWPORTS[viewport],
       };
     }

     return browser.newContext(contextOptions);
   }

   /**
    * Ensure directory exists
    */
   export function ensureDir(dir: string): void {
     fs.mkdirSync(dir, { recursive: true });
   }
   ```

2. Create extraction/scripts/capture-auth.ts:
   ```typescript
   /**
    * Authentication State Capture Script
    *
    * Run this script to save authentication state from a manual login.
    * Opens a browser window, waits for you to log in, then saves the session.
    *
    * Usage: npx ts-node extraction/scripts/capture-auth.ts
    */
   import { chromium } from 'playwright';
   import * as fs from 'fs';
   import * as path from 'path';
   import { AUTH_STATE_PATH, VIEWPORTS } from './utils';

   async function captureAuthState() {
     console.log('Starting authentication capture...');
     console.log('A browser window will open. Please log in manually.');
     console.log('Once logged in and on the dashboard, the session will be saved.');

     const browser = await chromium.launch({ headless: false });
     const context = await browser.newContext({
       viewport: VIEWPORTS.desktop,
     });
     const page = await context.newPage();

     await page.goto('https://app.societies.io');

     console.log('\n--- Waiting for login completion ---');
     console.log('Please log in via the browser window.');
     console.log('Script will continue once you reach a page containing "/dashboard" or the main app.\n');

     // Wait for user to complete login (2 minute timeout)
     await page.waitForURL('**/*', { timeout: 120000 });

     // Give time for the app to fully load
     await page.waitForLoadState('networkidle');
     await page.waitForTimeout(2000);

     // Ensure auth directory exists
     const authDir = path.dirname(AUTH_STATE_PATH);
     fs.mkdirSync(authDir, { recursive: true });

     // Save authentication state
     await context.storageState({ path: AUTH_STATE_PATH });
     console.log(`\nAuthentication state saved to: ${AUTH_STATE_PATH}`);

     await browser.close();
     console.log('Browser closed. Auth capture complete!');
   }

   captureAuthState().catch(console.error);
   ```

3. Add npm script to package.json:
   ```json
   "scripts": {
     "extraction:auth": "npx ts-node extraction/scripts/capture-auth.ts"
   }
   ```

  </action>
  <verify>
- Both files compile without errors: `npx tsc --noEmit extraction/scripts/*.ts`
- Utils exports VIEWPORTS, captureScreen, scrollToBottom, createAuthContext
- capture-auth.ts imports from utils correctly
  </verify>
  <done>
- Shared utilities provide consistent viewport definitions and capture helpers
- Auth capture script opens browser for manual login
- npm script "extraction:auth" available for easy execution
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>
Run authentication capture to save session state.
  </action>
  <instructions>
1. Run: `pnpm extraction:auth`
2. A browser window will open to app.societies.io
3. Log in with your credentials
4. Wait for dashboard to load
5. Script will automatically save session state
6. Verify: `extraction/auth/.auth/state.json` exists
  </instructions>
  <resume-signal>Type "auth saved" once the auth state file exists</resume-signal>
</task>

</tasks>

<verification>
- [ ] `pnpm exec playwright --version` shows installed version
- [ ] `extraction/playwright.config.ts` exists with desktop/mobile viewports
- [ ] `extraction/scripts/utils.ts` exports shared utilities
- [ ] `extraction/scripts/capture-auth.ts` exists
- [ ] Auth state saved to `extraction/auth/.auth/state.json` (after human action)
</verification>

<success_criteria>
- Playwright infrastructure ready for subsequent extraction scripts
- Authentication state persisted for use by all capture scripts
- Shared utilities reduce code duplication across scripts
</success_criteria>

<output>
After completion, create `.planning/phases/11-extraction/11-01-SUMMARY.md`
</output>
