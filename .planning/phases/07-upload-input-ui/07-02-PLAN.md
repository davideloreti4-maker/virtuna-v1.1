---
phase: 07-upload-input-ui
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/components/app/content-form.tsx
  - src/components/app/test-creation-flow.tsx
  - src/components/app/index.ts
autonomous: true

must_haves:
  truths:
    - "Content form displays 3 tabs: Text, TikTok URL, Video Upload"
    - "Text tab defaults selected on load"
    - "Switching tabs preserves all input across tabs (no clearing)"
    - "Text tab has structured fields: caption textarea, niche dropdown, hashtags input, optional notes"
    - "Video tab has upload zone + structured context fields (niche, hashtags, caption) below"
    - "TikTok URL tab has URL input only — no extra context fields"
    - "Submit button always says 'Test'"
    - "Submitting text mode sends input_mode='text' with content_text to /api/analyze"
    - "Submitting TikTok URL mode sends input_mode='tiktok_url' with tiktok_url to /api/analyze"
    - "Submitting video mode sends input_mode='video_upload' with video_storage_path to /api/analyze"
    - "Validation errors show inline on submit, not live"
  artifacts:
    - path: "src/components/app/content-form.tsx"
      provides: "Tabbed content form with 3 input modes"
      min_lines: 100
    - path: "src/components/app/test-creation-flow.tsx"
      provides: "Orchestrator wired to v2 AnalysisInput shape"
      contains: "input_mode"
  key_links:
    - from: "src/components/app/content-form.tsx"
      to: "src/components/app/video-upload.tsx"
      via: "import VideoUpload"
      pattern: "import.*VideoUpload.*video-upload"
    - from: "src/components/app/content-form.tsx"
      to: "src/components/app/tiktok-url-input.tsx"
      via: "import TikTokUrlInput"
      pattern: "import.*TikTokUrlInput.*tiktok-url-input"
    - from: "src/components/app/content-form.tsx"
      to: "src/components/ui/tabs.tsx"
      via: "import Tabs components"
      pattern: "import.*Tabs.*TabsList.*TabsTrigger.*TabsContent"
    - from: "src/components/app/test-creation-flow.tsx"
      to: "src/hooks/queries/use-analyze.ts"
      via: "useAnalyze mutation with input_mode field"
      pattern: "input_mode.*text.*tiktok_url.*video_upload"
---

<objective>
Rewrite the content form with 3-tab layout (Text, TikTok URL, Video Upload) and update the test creation flow to submit the v2 AnalysisInput payload shape.

Purpose: This is the user-facing integration — the existing single-textarea form becomes a tabbed multi-mode input form, and the submission flow sends the correct v2 payload to /api/analyze.

Output: Updated `content-form.tsx`, updated `test-creation-flow.tsx`, updated `index.ts` exports
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-upload-input-ui/07-01-SUMMARY.md

# Existing files to modify
@src/components/app/content-form.tsx
@src/components/app/test-creation-flow.tsx
@src/components/app/index.ts

# UI primitives used
@src/components/ui/tabs.tsx
@src/components/ui/input.tsx
@src/components/ui/select.tsx
@src/components/ui/textarea.tsx
@src/components/ui/button.tsx

# v2 input types
@src/lib/engine/types.ts (AnalysisInputSchema section)

# Mutation hook
@src/hooks/queries/use-analyze.ts

# Phase context with locked decisions
@.planning/phases/07-upload-input-ui/07-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite content-form.tsx with 3-tab input modes</name>
  <files>src/components/app/content-form.tsx</files>
  <action>
Rewrite the `ContentForm` component to support 3 input modes via tabs. Remove the old single-textarea layout entirely.

**New props interface:**
```ts
interface ContentFormData {
  input_mode: "text" | "tiktok_url" | "video_upload";
  // Text mode fields
  caption: string;
  niche: string;
  hashtags: string;
  notes: string;
  // TikTok URL mode
  tiktok_url: string;
  // Video mode
  video_file: File | null;
  video_caption: string;
  video_niche: string;
  video_hashtags: string;
}

interface ContentFormProps {
  onSubmit: (data: ContentFormData) => void;
  className?: string;
}
```

Remove the old `testType`, `onChangeType`, `initialContent` props. The form is now self-contained with tabs.

**Tab structure — use existing `Tabs`, `TabsList`, `TabsTrigger`, `TabsContent` from `@/components/ui/tabs`:**

```tsx
<Tabs defaultValue="text" value={activeTab} onValueChange={setActiveTab}>
  <TabsList>
    <TabsTrigger value="text">Text</TabsTrigger>
    <TabsTrigger value="tiktok_url">TikTok URL</TabsTrigger>
    <TabsTrigger value="video_upload">Video</TabsTrigger>
  </TabsList>
  <TabsContent value="text">...</TabsContent>
  <TabsContent value="tiktok_url">...</TabsContent>
  <TabsContent value="video_upload">...</TabsContent>
</Tabs>
```

Add icons to each tab trigger: `Type` (lucide) for Text, `Link` for TikTok URL, `Video` for Video Upload. Place icon before label text with `gap-1.5`.

**State management:**
- Single `useState` for the full `ContentFormData` object — all fields persist across tab switches (per user decision: switching tabs preserves all input).
- `activeTab` state controls which tab is visible.

**Text tab content:**
1. Caption textarea — use existing `Textarea` component, `autoResize`, `minRows={3}`, `maxRows={8}`, placeholder "Paste your caption or script..."
2. Niche dropdown — use existing `Select` component with common TikTok niches:
   ```ts
   const NICHE_OPTIONS = [
     { value: "", label: "Select niche (optional)" },
     { value: "comedy", label: "Comedy" },
     { value: "dance", label: "Dance" },
     { value: "education", label: "Education" },
     { value: "fashion", label: "Fashion & Beauty" },
     { value: "fitness", label: "Fitness & Health" },
     { value: "food", label: "Food & Cooking" },
     { value: "gaming", label: "Gaming" },
     { value: "lifestyle", label: "Lifestyle" },
     { value: "music", label: "Music" },
     { value: "pets", label: "Pets & Animals" },
     { value: "sports", label: "Sports" },
     { value: "tech", label: "Tech & Science" },
     { value: "travel", label: "Travel" },
     { value: "other", label: "Other" },
   ];
   ```
3. Hashtags input — use existing `Input` component, placeholder "#viral #fyp #trending"
4. Notes input — use existing `Input` component, placeholder "Optional context or notes"
5. Layout: vertical stack with `gap-4` between fields, labels above each field (`text-sm font-medium text-foreground mb-1.5`)

**TikTok URL tab content:**
- Import and render `TikTokUrlInput` from `./tiktok-url-input` (created in Plan 7-01)
- URL-only — no extra context fields alongside (per user decision)
- Wire `url` / `onUrlChange` to form state's `tiktok_url` field
- For now, `onFetchPreview` can be a no-op or console.log — actual preview fetching is Phase 8+ concern. Just wire the prop.

**Video Upload tab content:**
1. Import and render `VideoUpload` from `./video-upload` (created in Plan 7-01)
2. Wire `file` / `onFileSelect` to form state's `video_file` field
3. Below the upload zone, show structured context fields:
   - Caption textarea (same as text tab but separate state field `video_caption`)
   - Niche dropdown (same options, separate state field `video_niche`)
   - Hashtags input (separate state field `video_hashtags`)
4. Context fields visible always (even before a file is selected), so user can fill them in any order

**Submit button:**
- Always says "Test" (per user decision — not "Analyze", not dynamic per tab)
- Use existing `Button` with `variant="primary"`
- Positioned at the bottom of the form, full width on mobile, right-aligned on desktop
- Disabled when: text mode and caption empty, tiktok_url mode and url empty, video mode and no file selected

**Validation (on submit only, per user decision):**
- Text mode: caption must be >= 10 characters
- TikTok URL mode: url must match TIKTOK_URL_PATTERN regex
- Video mode: file must be selected
- Show errors as inline text below the relevant field (`text-sm text-error mt-1`)
- Use a `Record<string, string>` errors state, set on submit, clear individual errors on field change

**Form container styling (preserve existing glass panel):**
- Keep the existing glass panel styling from the current content-form.tsx: `rounded-xl border border-white/[0.06]`, `background: linear-gradient(137deg, ...)`, `backdropFilter: blur(5px)`, `boxShadow` with inset highlight
- Padding: `p-5` or `p-6`

**Remove old code:**
- Remove `TEST_TYPES`, `TestType`, `TestTypeIcon` imports
- Remove the old `testType` / `onChangeType` / `initialContent` props
- Remove the `iconMap`, `MAX_LENGTH`, `COUNTER_THRESHOLD`, old validation schema
- Remove the old textarea-only layout, the type selector badge, the "Upload Images" and "Help Me Craft" buttons
- Remove `isViewingHistory` logic (the history viewing will be handled differently in Phase 8)
  </action>
  <verify>
- `pnpm tsc --noEmit` passes
- ContentForm renders with 3 tabs visible
- Tab switching preserves input in all tabs
- Submit calls onSubmit with correct ContentFormData shape
- Validation errors appear inline on submit when fields are invalid
- Form has glass panel styling matching Raycast design
  </verify>
  <done>
content-form.tsx is a 3-tab form with Text (caption + niche + hashtags + notes), TikTok URL (url input only), and Video Upload (upload zone + caption + niche + hashtags). Submit always says "Test". Input preserved across tab switches. Validation on submit only with inline errors. Old single-textarea layout fully replaced.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update test-creation-flow.tsx and exports</name>
  <files>
    src/components/app/test-creation-flow.tsx
    src/components/app/index.ts
  </files>
  <action>
**Update test-creation-flow.tsx:**

The `TestCreationFlow` orchestrator currently passes `testType`, `onChangeType`, and `onSubmit(content: string)` to `ContentForm`. Update it to work with the new `ContentFormData` shape.

1. Remove the `currentTestType` / `setTestType` / `handleSelectType` / `handleChangeType` flow — the form no longer needs a type selector step.
2. Remove the `TestTypeSelector` modal and the `selecting-type` status. The flow goes directly: `idle` -> `filling-form` -> `simulating` -> `viewing-results`.
3. Remove the `contentTypeMap` — the v2 API uses `input_mode` instead of `content_type`.
4. Update `handleContentSubmit` to accept `ContentFormData` instead of a string:

```ts
const handleContentSubmit = (data: ContentFormData) => {
  if (!selectedSocietyId) return;

  const theatreStart = Date.now();
  isCancelledRef.current = false;
  setSubmittedContent(data.caption || data.video_caption || data.tiktok_url || "");
  setStatus("simulating");

  // Build v2 AnalysisInput payload
  const payload: Record<string, unknown> = {
    input_mode: data.input_mode,
    content_type: "video", // TikTok content is always video type
    society_id: selectedSocietyId,
  };

  if (data.input_mode === "text") {
    payload.content_text = data.caption;
    if (data.niche) payload.niche = data.niche;
  } else if (data.input_mode === "tiktok_url") {
    payload.tiktok_url = data.tiktok_url;
  } else if (data.input_mode === "video_upload") {
    // For now, set video_storage_path to empty — actual Supabase upload is Phase 8+
    payload.video_storage_path = "pending-upload";
    payload.content_text = data.video_caption;
    if (data.video_niche) payload.niche = data.video_niche;
  }

  analyzeMutation.mutate(payload as Parameters<typeof analyzeMutation.mutate>[0], {
    onSuccess: async () => { ... same as before ... },
    onError: () => setStatus("filling-form"),
  });
};
```

5. Update the render: when `currentStatus === "filling-form"`, render `<ContentForm onSubmit={handleContentSubmit} />` without `testType` or `onChangeType` props.
6. Remove the survey form branching (`isSurvey` check) — the new content form handles all input modes.
7. Update the trigger: clicking the trigger button goes directly to `filling-form` status (skip `selecting-type`).
8. Keep the `simulating` and `viewing-results` states as-is.

**Update index.ts:**
- Add exports for the new components:
  ```ts
  export { VideoUpload } from "./video-upload";
  export { TikTokUrlInput } from "./tiktok-url-input";
  ```
- Keep the existing `ContentForm` export (same file, updated component)
- Remove `TestTypeSelector` export if it was there (check first — it may still be needed elsewhere)
  </action>
  <verify>
- `pnpm tsc --noEmit` passes
- TestCreationFlow renders ContentForm directly (no type selector step)
- Submitting from any tab constructs the correct AnalysisInput payload shape
- The trigger button -> form flow works without intermediate type selection
- index.ts exports VideoUpload and TikTokUrlInput
  </verify>
  <done>
test-creation-flow.tsx submits v2 AnalysisInput payloads with input_mode discriminator. Type selector step removed — flow goes trigger -> form -> simulating -> results. index.ts exports new components. ContentForm receives and forwards ContentFormData to the orchestrator.
  </done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes with zero errors
2. Content form renders 3 tabs (Text, TikTok URL, Video Upload) inside the glass panel
3. Text tab has caption textarea, niche dropdown, hashtags input, notes input
4. TikTok URL tab has URL input only
5. Video Upload tab has upload zone + caption, niche, hashtags fields
6. Switching tabs preserves all input state
7. Submit always says "Test"
8. TestCreationFlow submits correct input_mode and associated fields to useAnalyze
9. No type selector modal — direct to form flow
</verification>

<success_criteria>
- ContentForm has 3 working input mode tabs with structured fields per user decisions
- Submit button says "Test" and sends the v2 AnalysisInput shape
- Tab switching never clears user input
- Validation on submit only with inline errors
- TestCreationFlow orchestrator wired to new ContentForm without type selector step
- All TypeScript types resolve without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-upload-input-ui/07-02-SUMMARY.md`
</output>
