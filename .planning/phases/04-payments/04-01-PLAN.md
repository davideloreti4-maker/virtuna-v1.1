---
phase: 04-payments
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(marketing)/pricing/pricing-section.tsx
  - supabase/migrations/20260213100000_add_trial_columns.sql
  - src/types/database.types.ts
  - src/app/api/webhooks/whop/route.ts
  - src/app/api/subscription/route.ts
autonomous: true
user_setup:
  - service: whop
    why: "Whop plan IDs and webhook secret must exist in Whop dashboard"
    env_vars:
      - name: WHOP_PRODUCT_ID_STARTER
        source: "Whop Dashboard -> Products -> Starter plan ID"
      - name: WHOP_PRODUCT_ID_PRO
        source: "Whop Dashboard -> Products -> Pro plan ID"
      - name: WHOP_WEBHOOK_SECRET
        source: "Whop Dashboard -> Developer Settings -> Webhook secret"
    dashboard_config:
      - task: "Create Starter and Pro products with desired pricing"
        location: "Whop Dashboard -> Products"
      - task: "Configure webhook endpoint URL to /api/webhooks/whop"
        location: "Whop Dashboard -> Developer Settings -> Webhooks"

must_haves:
  truths:
    - "Authenticated user on /pricing sees buttons that open Whop checkout modal (not redirect to signup)"
    - "Unauthenticated user on /pricing sees links to /auth/signup?plan=X"
    - "Webhook handler stores trial state (is_trial, trial_ends_at) when membership is trialing"
    - "GET /api/subscription returns isTrial and trialEndsAt fields"
  artifacts:
    - path: "src/app/(marketing)/pricing/pricing-section.tsx"
      provides: "Auth-aware pricing CTAs with CheckoutModal"
      contains: "CheckoutModal"
    - path: "supabase/migrations/20260213100000_add_trial_columns.sql"
      provides: "Trial columns on user_subscriptions table"
      contains: "is_trial"
    - path: "src/types/database.types.ts"
      provides: "TypeScript types including is_trial and trial_ends_at"
      contains: "is_trial"
    - path: "src/app/api/webhooks/whop/route.ts"
      provides: "Trial-aware webhook handler"
      contains: "is_trial"
    - path: "src/app/api/subscription/route.ts"
      provides: "Subscription API with trial fields"
      contains: "isTrial"
  key_links:
    - from: "src/app/(marketing)/pricing/pricing-section.tsx"
      to: "src/components/app/checkout-modal.tsx"
      via: "CheckoutModal component render"
      pattern: "CheckoutModal"
    - from: "src/app/api/webhooks/whop/route.ts"
      to: "supabase user_subscriptions"
      via: "upsert with is_trial and trial_ends_at"
      pattern: "is_trial"
    - from: "src/app/api/subscription/route.ts"
      to: "src/lib/whop/subscription.ts"
      via: "getUserSubscription() reading trial fields"
      pattern: "isTrial.*trial_ends_at"
---

<objective>
Wire Whop checkout to pricing page CTAs for authenticated users, add trial columns to the database, and enhance the webhook handler and subscription API to track trial state.

Purpose: This is the backend+wiring foundation for the entire payments phase. Without trial tracking in the DB and auth-aware checkout buttons, no downstream UI (TierGate, trial countdown, upgrade prompts) can function.

Output: Auth-aware pricing page, trial-capable database schema, trial-aware webhook handler, enhanced subscription API.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/(marketing)/pricing/pricing-section.tsx
@src/components/app/checkout-modal.tsx
@src/lib/whop/config.ts
@src/lib/whop/subscription.ts
@src/app/api/webhooks/whop/route.ts
@src/app/api/subscription/route.ts
@src/types/database.types.ts
@supabase/migrations/20260212000000_add_whop_subscriptions.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add trial columns migration + update database types</name>
  <files>
    supabase/migrations/20260213100000_add_trial_columns.sql
    src/types/database.types.ts
  </files>
  <action>
Create migration file `supabase/migrations/20260213100000_add_trial_columns.sql`:

```sql
-- Add trial tracking columns to user_subscriptions
ALTER TABLE user_subscriptions ADD COLUMN is_trial BOOLEAN DEFAULT FALSE;
ALTER TABLE user_subscriptions ADD COLUMN trial_ends_at TIMESTAMPTZ;
```

Update `src/types/database.types.ts` — add `is_trial` and `trial_ends_at` to the `user_subscriptions` type definition in all three sections (Row, Insert, Update):

- Row section: add `is_trial: boolean | null` and `trial_ends_at: string | null`
- Insert section: add `is_trial?: boolean | null` and `trial_ends_at?: string | null`
- Update section: add `is_trial?: boolean | null` and `trial_ends_at?: string | null`

Place them after `current_period_end` in each section to maintain field ordering consistency with the SQL schema.
  </action>
  <verify>
Confirm migration file exists and contains ALTER TABLE statements. Grep database.types.ts for `is_trial` — should appear 3 times (Row, Insert, Update). Run `npx tsc --noEmit` to verify types compile.
  </verify>
  <done>
Migration file adds is_trial and trial_ends_at columns. Database types updated with new fields in Row, Insert, and Update. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Make pricing section auth-aware + enhance webhook and subscription API for trial tracking</name>
  <files>
    src/app/(marketing)/pricing/pricing-section.tsx
    src/app/api/webhooks/whop/route.ts
    src/app/api/subscription/route.ts
  </files>
  <action>
**Pricing Section** (`src/app/(marketing)/pricing/pricing-section.tsx`):

Make the component auth-aware. On mount, check auth status via `createClient()` from `@/lib/supabase/client` (the browser client). Use `useState` for `isAuthenticated` (default `false`) and `checkoutPlan` (default `null`).

In a `useEffect`, call:
```ts
const supabase = createClient();
const { data: { user } } = await supabase.auth.getUser();
if (user) setIsAuthenticated(true);
```

Conditional CTA rendering:
- If `isAuthenticated`: Starter button becomes `<Button variant="secondary" size="lg" className="w-full" onClick={() => setCheckoutPlan("starter")}>Get started</Button>` (no Link wrapper, no asChild)
- If `isAuthenticated`: Pro button becomes `<Button variant="primary" size="lg" className="w-full" onClick={() => setCheckoutPlan("pro")}>Start free trial</Button>` (no Link wrapper, no asChild)
- If NOT authenticated: keep existing `<Link href="/auth/signup?plan=...">` behavior with asChild

Add CheckoutModal at the bottom of the component JSX (before closing `</section>`):
```tsx
{checkoutPlan && (
  <CheckoutModal
    open={!!checkoutPlan}
    onClose={() => setCheckoutPlan(null)}
    planId={checkoutPlan}
  />
)}
```

Import `CheckoutModal` from `@/components/app/checkout-modal` and `createClient` from `@/lib/supabase/client`. Also import `useState, useEffect` from React.

**Webhook Handler** (`src/app/api/webhooks/whop/route.ts`):

In the `membership.went_valid` case, after computing `tier`, detect trial state from webhook data. Whop sends `data.status` which can be `"trialing"` and `data.trial_end` (ISO date string) for trial memberships.

Add to the upsert object:
```ts
is_trial: data.status === 'trialing',
trial_ends_at: data.trial_end || null,
```

In the `membership.went_invalid` case, add to the update object:
```ts
is_trial: false,
trial_ends_at: null,
```

**Subscription API** (`src/app/api/subscription/route.ts`):

Add `isTrial` and `trialEndsAt` fields to both response paths:

For the free/no-subscription fallback:
```ts
isTrial: false,
trialEndsAt: null,
```

For the subscription response:
```ts
isTrial: subscription.is_trial ?? false,
trialEndsAt: subscription.trial_ends_at ?? null,
```
  </action>
  <verify>
1. Run `npx tsc --noEmit` — no type errors.
2. Run `pnpm build` (or `npm run build`) — builds successfully.
3. Grep pricing-section.tsx for "CheckoutModal" — confirms import and render.
4. Grep webhooks/whop/route.ts for "is_trial" — confirms trial tracking in webhook.
5. Grep subscription/route.ts for "isTrial" — confirms API returns trial fields.
  </verify>
  <done>
Authenticated users on /pricing see checkout buttons (not signup links). Webhook handler stores trial state on membership.went_valid and clears on went_invalid. Subscription API returns isTrial and trialEndsAt. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (type safety across all changes)
2. `pnpm build` succeeds (no broken imports or missing modules)
3. Migration file exists at correct path with ALTER TABLE statements
4. Pricing page renders CheckoutModal for authenticated users
5. Webhook handler includes is_trial and trial_ends_at in upsert
6. Subscription API includes isTrial and trialEndsAt in response
</verification>

<success_criteria>
- Pricing page CTAs open Whop checkout modal for logged-in users
- Pricing page CTAs link to signup for logged-out users
- Database has is_trial and trial_ends_at columns
- Webhook handler detects and stores trial state
- Subscription API exposes trial state to frontend consumers
- All TypeScript types updated and compile successfully
</success_criteria>

<output>
After completion, create `.planning/phases/04-payments/04-01-SUMMARY.md`
</output>
