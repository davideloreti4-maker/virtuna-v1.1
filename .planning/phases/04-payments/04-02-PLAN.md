---
phase: 04-payments
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/hooks/use-subscription.ts
  - src/components/tier-gate.tsx
  - src/components/trial-countdown.tsx
  - src/components/upgrade-prompt.tsx
  - src/components/app/sidebar.tsx
  - src/components/app/app-shell.tsx
autonomous: true

must_haves:
  truths:
    - "Pro-only features are gated for Starter/Free users (TierGate shows upgrade prompt)"
    - "User sees their subscription tier badge in the sidebar (Free/Starter/Pro/Pro Trial)"
    - "User in trial sees days remaining countdown in sidebar"
    - "User near trial expiry sees dismissible upgrade prompt in main content area"
    - "useSubscription hook provides tier, trial state, and polling capability"
  artifacts:
    - path: "src/hooks/use-subscription.ts"
      provides: "Client-side subscription state management with polling"
      exports: ["useSubscription"]
    - path: "src/components/tier-gate.tsx"
      provides: "Client component that gates children behind a tier requirement"
      exports: ["TierGate"]
    - path: "src/components/trial-countdown.tsx"
      provides: "Trial days remaining display"
      exports: ["TrialCountdown"]
    - path: "src/components/upgrade-prompt.tsx"
      provides: "Dismissible upgrade prompt near trial expiry"
      exports: ["UpgradePrompt"]
    - path: "src/components/app/sidebar.tsx"
      provides: "Sidebar with tier badge and trial countdown"
      contains: "useSubscription"
    - path: "src/components/app/app-shell.tsx"
      provides: "AppShell with UpgradePrompt"
      contains: "UpgradePrompt"
  key_links:
    - from: "src/hooks/use-subscription.ts"
      to: "/api/subscription"
      via: "fetch on mount + polling"
      pattern: "fetch.*api/subscription"
    - from: "src/components/tier-gate.tsx"
      to: "src/hooks/use-subscription.ts"
      via: "useSubscription hook call"
      pattern: "useSubscription"
    - from: "src/components/app/sidebar.tsx"
      to: "src/hooks/use-subscription.ts"
      via: "useSubscription for badge and countdown"
      pattern: "useSubscription"
    - from: "src/components/app/app-shell.tsx"
      to: "src/components/upgrade-prompt.tsx"
      via: "UpgradePrompt rendered in main area"
      pattern: "UpgradePrompt"
---

<objective>
Create the useSubscription hook, TierGate component, trial countdown, upgrade prompt, and integrate tier UI into sidebar and app shell.

Purpose: Users need to see their subscription tier reflected in the UI, have Pro-only features gated, and get trial-related notifications. This plan builds all the client-side subscription infrastructure.

Output: useSubscription hook, TierGate component, TrialCountdown component, UpgradePrompt component, sidebar tier badge, app-level upgrade prompt.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-payments/04-01-SUMMARY.md
@src/lib/whop/config.ts
@src/components/ui/feature-gate.tsx
@src/components/ui/upgrade-banner.tsx
@src/components/ui/badge.tsx
@src/components/app/sidebar.tsx
@src/components/app/app-shell.tsx
@src/components/app/checkout-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSubscription hook + TierGate + TrialCountdown + UpgradePrompt components</name>
  <files>
    src/hooks/use-subscription.ts
    src/components/tier-gate.tsx
    src/components/trial-countdown.tsx
    src/components/upgrade-prompt.tsx
  </files>
  <action>
**useSubscription hook** (`src/hooks/use-subscription.ts`):

"use client" hook that fetches `/api/subscription` on mount.

State:
- `data`: `{ tier: VirtunaTier, status: string, isTrial: boolean, trialEndsAt: string | null, whopConnected: boolean, cancelAtPeriodEnd: boolean, currentPeriodEnd: string | null } | null`
- `isLoading`: boolean (true initially)
- `error`: string | null
- `isPolling`: boolean (false initially)

Returns object with:
- `tier`: VirtunaTier (defaults to 'free' while loading)
- `status`: string
- `isTrial`: boolean
- `trialEndsAt`: string | null
- `trialDaysRemaining`: number | null — computed: if `trialEndsAt` is set, compute `Math.max(0, Math.ceil((new Date(trialEndsAt).getTime() - Date.now()) / (1000 * 60 * 60 * 24)))`, else null
- `isLoading`: boolean
- `error`: string | null
- `refetch`: () => Promise<void> — re-fetches subscription data
- `pollForTierChange`: (currentTier: VirtunaTier) => Promise<VirtunaTier> — polls every 2s for up to 30s. Sets isPolling=true. On each poll, fetch `/api/subscription`. If tier differs from `currentTier`, resolve with new tier and set isPolling=false. If 30s timeout, resolve with currentTier and set isPolling=false.
- `isPolling`: boolean

Import `VirtunaTier` from `@/lib/whop/config`. Use `useState`, `useEffect`, `useCallback`, `useRef` from React. The `useRef` is needed for polling interval cleanup.

**TierGate component** (`src/components/tier-gate.tsx`):

"use client" component. Props: `requiredTier: VirtunaTier`, `children: ReactNode`, `fallback?: ReactNode`.

Uses `useSubscription()` internally to get the user's tier. While loading, render nothing (or a minimal skeleton — just `null` is fine to avoid layout shift in most cases).

If `hasAccessToTier(tier, requiredTier)` returns true, render children. Otherwise render the fallback prop, or if no fallback provided, render an `UpgradeBanner` (from `@/components/ui/upgrade-banner`) with `requiredTier` and `onUpgrade` that opens a CheckoutModal.

To make the default fallback work with CheckoutModal:
- Add local state `checkoutPlan: 'starter' | 'pro' | null`
- Default fallback renders UpgradeBanner with `onUpgrade={(tier) => setCheckoutPlan(tier === 'pro' ? 'pro' : 'starter')}`
- Render CheckoutModal conditionally when `checkoutPlan` is set

Import `hasAccessToTier` from `@/lib/whop/config`.

**TrialCountdown component** (`src/components/trial-countdown.tsx`):

"use client" component. No props (self-contained, uses useSubscription).

Uses `useSubscription()` to get `isTrial` and `trialDaysRemaining`. If not in trial or trialDaysRemaining is null, return null.

Renders a compact element for sidebar placement:
```tsx
<div className="flex items-center gap-2 px-3 py-2 text-sm">
  <Clock size={16} className={daysRemaining <= 3 ? "text-warning" : "text-foreground-muted"} />
  <span className={daysRemaining <= 3 ? "text-warning" : "text-foreground-secondary"}>
    {daysRemaining} {daysRemaining === 1 ? "day" : "days"} left in trial
  </span>
</div>
```

Import `Clock` from `@phosphor-icons/react`. Use the design system semantic tokens (text-warning for <= 3 days).

**UpgradePrompt component** (`src/components/upgrade-prompt.tsx`):

"use client" component. No props (self-contained).

Uses `useSubscription()` to get `isTrial` and `trialDaysRemaining`. Shows only when:
- `isTrial` is true AND `trialDaysRemaining !== null` AND `trialDaysRemaining <= 3`

Dismissible via local `useState` (`dismissed`, default false). If dismissed, return null. Dismissal is session-only (resets on page reload).

Has local `checkoutPlan` state for CheckoutModal.

Renders:
```tsx
<div className="mx-4 mb-4 flex items-center justify-between rounded-xl border border-warning/20 bg-warning/5 px-4 py-3">
  <div className="flex items-center gap-3">
    <Zap size={18} className="text-warning" />
    <div>
      <p className="text-sm font-medium text-white">
        Your trial ends in {trialDaysRemaining} {trialDaysRemaining === 1 ? "day" : "days"}
      </p>
      <p className="text-xs text-foreground-muted">Upgrade now to keep Pro features</p>
    </div>
  </div>
  <div className="flex items-center gap-2">
    <Button variant="primary" size="sm" onClick={() => setCheckoutPlan("pro")}>
      Upgrade now
    </Button>
    <button
      type="button"
      onClick={() => setDismissed(true)}
      className="text-foreground-muted hover:text-foreground p-1"
      aria-label="Dismiss"
    >
      <X size={16} />
    </button>
  </div>
</div>
```

Import `Lightning as Zap` (or just `Lightning`) from `@phosphor-icons/react`, `X` from `@phosphor-icons/react`, `Button` from `@/components/ui/button`, `CheckoutModal` from `@/components/app/checkout-modal`.

Render CheckoutModal at end when checkoutPlan is set.
  </action>
  <verify>
1. Run `npx tsc --noEmit` — all new files compile.
2. Grep `use-subscription.ts` for "pollForTierChange" — confirms polling capability.
3. Grep `tier-gate.tsx` for "useSubscription" — confirms hook integration.
4. Grep `trial-countdown.tsx` for "trialDaysRemaining" — confirms countdown logic.
5. Grep `upgrade-prompt.tsx` for "dismissed" — confirms dismissibility.
  </verify>
  <done>
useSubscription hook fetches and exposes tier, trial state, and polling. TierGate gates children behind tier with auto-fallback. TrialCountdown shows days remaining with warning colors. UpgradePrompt shows near expiry with dismiss and upgrade actions. All compile.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate tier badge and trial countdown into sidebar, upgrade prompt into app shell</name>
  <files>
    src/components/app/sidebar.tsx
    src/components/app/app-shell.tsx
  </files>
  <action>
**Sidebar** (`src/components/app/sidebar.tsx`):

1. Import `useSubscription` from `@/hooks/use-subscription`, `Badge` from `@/components/ui/badge`, and `TrialCountdown` from `@/components/trial-countdown`.

2. Inside the `Sidebar` component, call `const { tier, isTrial } = useSubscription();`.

3. Add a tier badge next to the logo in the header section. After the logo SVG `<Link>`, add:
```tsx
<Badge
  variant={tier === 'pro' ? 'accent' : tier === 'starter' ? 'success' : 'default'}
  size="sm"
>
  {isTrial ? 'Pro Trial' : tier === 'free' ? 'Free' : tier === 'starter' ? 'Starter' : 'Pro'}
</Badge>
```

Place the Badge between the logo Link and the collapse Button in the header div. The header div already has `flex items-center justify-between`, so wrap the logo + badge in a `<div className="flex items-center gap-2">`:
```tsx
<div className="flex items-center gap-2">
  <Link href="/" className="flex items-center">
    {/* existing SVG */}
  </Link>
  <Badge ...>{/* tier label */}</Badge>
</div>
```

4. Place `<TrialCountdown />` above the bottom nav section. Insert it before the bottom separator (`{/* Separator */}` that comes before `{/* Bottom navigation */}`):
```tsx
{/* Trial countdown (above bottom nav) */}
<TrialCountdown />

{/* Separator */}
<div className="mx-4 border-t border-border-glass" />

{/* Bottom navigation */}
```

**AppShell** (`src/components/app/app-shell.tsx`):

1. Import `UpgradePrompt` from `@/components/upgrade-prompt`.

2. Inside the `<main>` element, add `<UpgradePrompt />` as the first child (before `{children}`):
```tsx
<main className={cn(...)}>
  <UpgradePrompt />
  {children}
</main>
```

The UpgradePrompt component self-manages its visibility (only shows when trial <= 3 days), so no conditional logic needed in AppShell.
  </action>
  <verify>
1. Run `npx tsc --noEmit` — no errors.
2. Run `pnpm build` — successful build.
3. Grep sidebar.tsx for "Badge" and "TrialCountdown" — confirms both integrations.
4. Grep app-shell.tsx for "UpgradePrompt" — confirms app-level integration.
  </verify>
  <done>
Sidebar shows tier badge (Free/Starter/Pro/Pro Trial) next to logo and trial countdown above bottom nav. AppShell renders UpgradePrompt at top of main content area. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `pnpm build` succeeds
3. useSubscription hook exists with tier, trial state, refetch, and pollForTierChange
4. TierGate gates children and shows upgrade fallback
5. TrialCountdown shows in sidebar during trial
6. UpgradePrompt shows in main area when trial <= 3 days, dismissible
7. Sidebar displays tier badge next to logo
</verification>

<success_criteria>
- useSubscription hook provides tier, isTrial, trialDaysRemaining, pollForTierChange, isPolling
- TierGate restricts Pro-only features for lower tiers with automatic upgrade prompt fallback
- Tier badge visible in sidebar reflecting current subscription state
- Trial countdown visible in sidebar during active trial
- Upgrade prompt appears in main content area when trial is near expiry
- All components self-contained and use existing design system tokens
</success_criteria>

<output>
After completion, create `.planning/phases/04-payments/04-02-SUMMARY.md`
</output>
