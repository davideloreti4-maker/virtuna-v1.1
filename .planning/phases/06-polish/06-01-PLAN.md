---
phase: 06-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(app)/brand-deals/page.tsx
  - src/app/layout.tsx
  - src/lib/supabase/middleware.ts
  - src/app/(marketing)/opengraph-image.tsx
  - src/app/(app)/dashboard/dashboard-client.tsx
autonomous: true

must_haves:
  truths:
    - "Sharing the landing page URL on social media shows a Virtuna-branded OG preview (not a broken image or generic placeholder)"
    - "Sharing a referral link (?ref=CODE) on social media shows the same landing page OG preview"
    - "Visiting /brand-deals redirects to /referrals (no dead placeholder page)"
    - "Middleware has no references to non-existent routes (/earnings, /content-intelligence)"
    - "Root layout metadata does not reference a non-existent /og-image.png file"
    - "Dashboard filter pills container has min-w-0 to prevent overflow on mobile"
  artifacts:
    - path: "src/app/(marketing)/opengraph-image.tsx"
      provides: "Marketing-specific OG image for landing page and referral links"
    - path: "src/app/(app)/brand-deals/page.tsx"
      provides: "Redirect to /referrals"
    - path: "src/lib/supabase/middleware.ts"
      provides: "Clean protected prefixes (no dead routes)"
  key_links:
    - from: "src/app/(marketing)/opengraph-image.tsx"
      to: "Landing page social sharing"
      via: "Next.js opengraph-image file convention"
      pattern: "ImageResponse.*Virtuna"
    - from: "src/app/(app)/brand-deals/page.tsx"
      to: "/referrals"
      via: "next/navigation redirect"
      pattern: "redirect.*referrals"
---

<objective>
Fix OG metadata conflicts, create marketing-route OG image, redirect dead brand-deals page, clean up middleware dead routes, and apply dashboard mobile fix.

Purpose: Resolve the OG image conflict (static /og-image.png reference vs dynamic opengraph-image.tsx), ensure social sharing works correctly for landing page and referral links, eliminate dead routes from middleware, and fix dashboard filter pill overflow.

Output: Working OG previews for social sharing, clean middleware, brand-deals redirect, dashboard mobile fix.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/layout.tsx
@src/app/opengraph-image.tsx
@src/lib/supabase/middleware.ts
@src/app/(app)/brand-deals/page.tsx
@src/app/(app)/dashboard/dashboard-client.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix OG metadata + create marketing OG image</name>
  <files>
    src/app/layout.tsx
    src/app/(marketing)/opengraph-image.tsx
  </files>
  <action>
    **1. Fix root layout.tsx metadata conflict:**
    - Remove the `images` array from `openGraph` in the exported `metadata` object (lines 27-34). The `opengraph-image.tsx` file convention auto-injects the correct OG image -- having a static `/og-image.png` reference conflicts and points to a file that does not exist.
    - Remove the `images` array from `twitter` metadata (line 43). Same reason -- the opengraph-image.tsx convention handles this.
    - Keep all other metadata fields (title, description, url, siteName, locale, type, twitter.card, twitter.title, twitter.description).

    **2. Create marketing-route OG image:**
    - Create `src/app/(marketing)/opengraph-image.tsx` following the EXACT pattern of the root `src/app/opengraph-image.tsx`.
    - Use `export const runtime = "edge"` and `ImageResponse` from `next/og`.
    - Size: 1200x630, contentType: "image/png".
    - Alt text: "Virtuna - AI Content Intelligence for TikTok Creators".
    - Design the image content to be more specific to the landing page:
      - Background: #07080a (same dark bg)
      - Virtuna logo SVG (same as root OG)
      - Brand name "Virtuna" in large white text
      - Tagline: "Know what will go viral before you post" in coral (#FF7F50)
      - Subtitle: "AI-powered predictions, trend intelligence, and audience insights for TikTok creators" in muted (#848586)
    - This OG image will automatically apply to all routes under (marketing)/ including the landing page `/` and `/pricing`.
    - Referral links (`/?ref=CODE`) resolve to `/` which is under (marketing), so they get this OG image automatically.
  </action>
  <verify>
    Run `pnpm build` and check no build errors. Verify the opengraph-image route is listed in the build output. Run `curl -s http://localhost:3000 | grep -i 'og:image'` after starting dev server to confirm OG tags are present and do NOT reference /og-image.png.
  </verify>
  <done>
    Root layout metadata has no static /og-image.png references. Marketing route has its own opengraph-image.tsx. Social sharing of landing page and referral links will show Virtuna-branded preview.
  </done>
</task>

<task type="auto">
  <name>Task 2: Redirect brand-deals + clean middleware dead routes + dashboard mobile fix</name>
  <files>
    src/app/(app)/brand-deals/page.tsx
    src/lib/supabase/middleware.ts
    src/app/(app)/dashboard/dashboard-client.tsx
  </files>
  <action>
    **1. Redirect brand-deals page:**
    - Replace the entire content of `src/app/(app)/brand-deals/page.tsx` with a simple redirect:
      ```typescript
      import { redirect } from "next/navigation";
      export default function BrandDealsPage() {
        redirect("/referrals");
      }
      ```
    - Remove the Metadata export (no need for metadata on a redirect page).

    **2. Clean middleware PROTECTED_PREFIXES:**
    - In `src/lib/supabase/middleware.ts`, remove these entries from `PROTECTED_PREFIXES` array:
      - `"/earnings"` -- no /earnings route exists
      - `"/content-intelligence"` -- no /content-intelligence route exists
    - Keep `"/brand-deals"` in PROTECTED_PREFIXES since the page still exists as a redirect (needs auth protection to redirect authenticated users properly).

    **3. Clean middleware PUBLIC_PATHS:**
    - Remove these test/showcase paths from `PUBLIC_PATHS` array:
      - `"/primitives-showcase"`
      - `"/viral-score-test"`
      - `"/viral-results-showcase"`
      - `"/viz-test"`
    - Keep `"/showcase"` (design system reference page, useful for development).
    - Keep `"/coming-soon"` (still used by footer links).

    **4. Dashboard filter pill mobile fix:**
    - In `src/app/(app)/dashboard/dashboard-client.tsx`, find the filter pills container (line ~155):
      ```tsx
      <div className="flex items-center gap-3 overflow-x-auto">
      ```
    - Add `min-w-0` to prevent flex child overflow on narrow screens:
      ```tsx
      <div className="flex min-w-0 items-center gap-3 overflow-x-auto">
      ```
  </action>
  <verify>
    Run `pnpm build` to verify clean build. Check that visiting /brand-deals in the browser redirects to /referrals. Verify middleware file has no references to /earnings or /content-intelligence.
  </verify>
  <done>
    /brand-deals redirects to /referrals. Middleware only references existing routes. Dashboard filter pills have min-w-0 for mobile overflow prevention. No dead route references in middleware.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` completes without errors
2. Root layout.tsx metadata has no `/og-image.png` references
3. `src/app/(marketing)/opengraph-image.tsx` exists and follows the ImageResponse pattern
4. `/brand-deals` redirects to `/referrals`
5. Middleware PROTECTED_PREFIXES contains only: /dashboard, /brand-deals, /settings, /welcome, /referrals
6. Middleware PUBLIC_PATHS contains only: /, /coming-soon, /showcase, /login, /signup, /auth/callback
7. Dashboard filter container has `min-w-0` class
</verification>

<success_criteria>
- OG metadata is clean (no broken static references, dynamic generation via file convention)
- Marketing routes serve branded OG images for social sharing
- No dead placeholder pages visible to users
- Middleware is clean of non-existent route references
- Dashboard filter pills don't overflow on mobile
</success_criteria>

<output>
After completion, create `.planning/phases/06-polish/06-01-SUMMARY.md`
</output>
