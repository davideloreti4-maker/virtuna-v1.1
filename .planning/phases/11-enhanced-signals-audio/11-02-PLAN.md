---
phase: 11-enhanced-signals-audio
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/lib/engine/trends.ts
autonomous: true

must_haves:
  truths:
    - "Hashtag scoring weights by popularity from scraped videos"
    - "Overused hashtags (e.g., #fyp, #viral) are penalized via saturation detection"
    - "hashtagRelevance in FeatureVector receives a meaningful 0-1 score instead of placeholder 0"
  artifacts:
    - path: "src/lib/engine/trends.ts"
      provides: "Semantic hashtag scoring with popularity weighting and saturation detection"
      contains: "hashtagRelevance"
  key_links:
    - from: "src/lib/engine/trends.ts"
      to: "TrendEnrichment"
      via: "new hashtag_relevance field in return value"
      pattern: "hashtag_relevance"
    - from: "src/lib/engine/aggregator.ts"
      to: "trendEnrichment.hashtag_relevance"
      via: "hashtagRelevance field in FeatureVector"
      pattern: "hashtagRelevance"
---

<objective>
Replace the naive hashtag overlap counting with semantic hashtag scoring that weights by popularity and penalizes oversaturated tags.

Purpose: Current hashtag scoring just counts how many user hashtags appear in scraped videos (`hashtagOverlap * 3`). This treats #fyp (billions of uses) the same as a niche-specific trending hashtag. We need popularity weighting with saturation detection.

Output: Updated `src/lib/engine/trends.ts` with semantic hashtag scoring, `hashtag_relevance` added to TrendEnrichment return, and wiring in aggregator for FeatureVector.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-enhanced-signals-audio/11-01-SUMMARY.md
@src/lib/engine/trends.ts
@src/lib/engine/types.ts
@src/lib/engine/aggregator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement semantic hashtag scoring with popularity weighting and saturation detection</name>
  <files>src/lib/engine/trends.ts</files>
  <action>
    Replace the existing hashtag scoring section in `enrichWithTrends` (the block starting at `// Extract hashtags from content`) with a semantic scoring approach:

    1. **Build hashtag frequency map from scraped videos:**
       From the cached `recentVideos`, build a map of `hashtag → { count: number, totalViews: number }` showing how many videos use each hashtag and their total views.

    2. **Saturation detection:**
       Define saturated hashtags as those appearing in > 40% of scraped videos. These are "generic" tags that provide no signal.
       Hardcode a known-saturated blocklist as a safety net: `["fyp", "foryou", "foryoupage", "viral", "trending", "xyzbca"]`.
       Any hashtag in the blocklist OR exceeding 40% frequency is considered saturated.

    3. **Popularity-weighted scoring:**
       For each user hashtag that appears in scraped videos and is NOT saturated:
       - `popularity = Math.log10(Math.max(tagData.totalViews, 1))` — log-scaled to avoid mega-view tags dominating
       - `frequency_weight = tagData.count / recentVideos.length` — how commonly used (0-1)
       - `relevance = popularity * frequency_weight` — combined signal

       Saturated hashtags contribute 0 to relevance but still contribute to trend_score at 10% of their normal weight (they're not useless, just not differentiating).

    4. **Normalize to 0-1:**
       `hashtag_relevance = Math.min(1, totalRelevance / maxExpectedRelevance)` where `maxExpectedRelevance` is calibrated to ~3 (a user with 3 highly-relevant trending hashtags scores ~1.0).

    5. **Update return value:**
       Add `hashtag_relevance: number` (0-1) to the return object. Update the `TrendEnrichment` interface in `types.ts` to include this field (add `hashtag_relevance: number;` after `trend_context`).

    6. **Update trend_score contribution:**
       Replace the old `trendScore += Math.min(30, hashtagOverlap * 3)` with a contribution based on the new relevance: `trendScore += Math.round(hashtag_relevance * 30)` — same max contribution (30) but weighted by quality instead of raw count.

    7. **Wire in aggregator.ts:**
       In `src/lib/engine/aggregator.ts`, replace `hashtagRelevance: 0, // Placeholder — populated in Phase 11` (or the 11-02 reference left by Plan 01) with `hashtagRelevance: trendEnrichment.hashtag_relevance ?? 0,`.
  </action>
  <verify>
    ```bash
    npx tsc --noEmit src/lib/engine/trends.ts src/lib/engine/types.ts src/lib/engine/aggregator.ts
    ```
    Confirm no type errors. Verify hashtag_relevance is present in TrendEnrichment type.
  </verify>
  <done>
    - #fyp and #viral contribute 0 relevance (saturated)
    - A niche trending hashtag appearing in 15% of videos with 500K total views scores significantly higher than a generic tag
    - hashtag_relevance returns a value between 0 and 1
    - aggregator.ts FeatureVector uses trendEnrichment.hashtag_relevance instead of hardcoded 0
    - trend_score hashtag contribution is weighted by quality, not raw count
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes across all modified files
2. `pnpm build` completes without errors
3. Saturated hashtags (#fyp, #viral) produce 0 relevance score
4. Niche trending hashtags produce meaningful relevance scores
5. hashtagRelevance wired in aggregator FeatureVector assembly
</verification>

<success_criteria>
- Hashtag scoring weights by popularity with saturation detection for overused tags — SIG-03 satisfied
- hashtagRelevance in FeatureVector receives real data instead of placeholder 0
- TrendEnrichment type updated with hashtag_relevance field
</success_criteria>

<output>
After completion, create `.planning/phases/11-enhanced-signals-audio/11-02-SUMMARY.md`
</output>
