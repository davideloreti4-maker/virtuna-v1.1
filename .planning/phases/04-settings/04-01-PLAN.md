---
phase: 04-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/app/settings/profile-section.tsx
  - src/components/app/settings/account-section.tsx
  - src/stores/settings-store.ts
autonomous: true

must_haves:
  truths:
    - "User can edit profile fields (name, company, role) and save — data persists in Supabase across page reloads"
    - "Profile loads real user data from Supabase auth (email) and creator_profiles (display_name, bio) on mount"
    - "User can change password via Supabase auth with validation (match check, minimum length)"
    - "User can delete account with a confirmation dialog that requires typing 'delete my account'"
  artifacts:
    - path: "src/components/app/settings/profile-section.tsx"
      provides: "Profile form with Supabase read/write"
      contains: "creator_profiles"
    - path: "src/components/app/settings/account-section.tsx"
      provides: "Password change and account deletion with Supabase auth"
      contains: "updateUser"
    - path: "src/stores/settings-store.ts"
      provides: "Settings store with Supabase-backed profile hydration"
      contains: "supabase"
  key_links:
    - from: "src/components/app/settings/profile-section.tsx"
      to: "supabase.from('creator_profiles')"
      via: "upsert on save, select on mount"
      pattern: "creator_profiles.*upsert|creator_profiles.*select"
    - from: "src/components/app/settings/account-section.tsx"
      to: "supabase.auth.updateUser"
      via: "password change handler"
      pattern: "auth\\.updateUser"
---

<objective>
Wire the Settings profile section and account actions to Supabase so data persists across sessions.

Purpose: Currently profile save is a mock (setTimeout + Zustand store to localStorage), password change is console.log, and delete account is console.log. This plan replaces all three with real Supabase integration.

Output: Profile saves to creator_profiles table, password change calls Supabase auth, delete account calls Supabase auth with confirmation dialog.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/app/settings/profile-section.tsx
@src/components/app/settings/account-section.tsx
@src/stores/settings-store.ts
@src/types/settings.ts
@src/types/database.types.ts
@src/lib/supabase/client.ts
@src/components/app/sidebar.tsx (reference for Supabase upsert pattern to creator_profiles)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire profile section to Supabase</name>
  <files>
    src/components/app/settings/profile-section.tsx
    src/stores/settings-store.ts
  </files>
  <action>
Replace the mock profile save flow with real Supabase integration:

**profile-section.tsx:**
1. Import `createClient` from `@/lib/supabase/client`
2. On component mount (useEffect), fetch real user data:
   - `supabase.auth.getUser()` to get email and user_metadata (full_name from Google OAuth)
   - `supabase.from("creator_profiles").select("display_name, bio, avatar_url").eq("user_id", user.id).single()` to get profile fields
   - Map: `name` from creator_profiles.display_name (fallback to user_metadata.full_name or email prefix), `email` from auth user, `company` and `role` from localStorage only (no DB column for these — keep in Zustand store as before)
3. Replace `handleSave`:
   - Call `supabase.from("creator_profiles").upsert({ user_id: user.id, display_name: name, updated_at: new Date().toISOString() }, { onConflict: "user_id" })` for name
   - Keep company/role in Zustand localStorage store (no DB column exists)
   - Show error state if upsert fails, success feedback if it succeeds
   - Use existing pattern from sidebar.tsx TikTok handle save as reference
4. Add loading state while fetching initial data (skeleton or spinner for form fields)
5. Email field should be read-only (disabled) — email changes go through account section
6. Keep the avatar section as-is (console.log stub for "Change avatar" — avatar upload is out of scope)

**settings-store.ts:**
- Remove the hardcoded DEFAULT_PROFILE values (name, email) — these will come from Supabase
- Keep company/role in localStorage store as supplementary fields
- The `_hydrate` function should still load from localStorage for company/role, but name/email will be overwritten by Supabase data in the component

Do NOT change the store signature — keep updateProfile working for company/role localStorage persistence.
  </action>
  <verify>
    - Open /settings in browser, check profile tab loads real user data (email from auth, name from creator_profiles or fallback)
    - Edit name, click save, refresh page — name persists
    - Edit company/role, save, refresh — persists via localStorage
    - Check browser console for no errors
  </verify>
  <done>Profile section loads real data from Supabase auth + creator_profiles on mount, saves display_name to Supabase on save, and company/role persist to localStorage</done>
</task>

<task type="auto">
  <name>Task 2: Wire password change and delete account to Supabase</name>
  <files>
    src/components/app/settings/account-section.tsx
  </files>
  <action>
Replace mock account actions with real Supabase auth calls:

**Password change:**
1. Import `createClient` from `@/lib/supabase/client`
2. Add validation before calling Supabase:
   - `newPassword` must be at least 8 characters
   - `newPassword` must match `confirmPassword`
   - Show inline error messages for validation failures (use text-error class)
3. Replace `handlePasswordChange`:
   - Call `supabase.auth.updateUser({ password: newPassword })`
   - NOTE: Supabase client-side updateUser does NOT require current password (user is already authenticated via session). Remove the "Current password" field entirely — it's misleading since Supabase doesn't verify it client-side.
   - On success: clear fields, show green "Password updated!" message (2s timeout like profile save)
   - On error: show error.message in red text below the form
4. Add `isSaving` state for loading button state
5. Add `error` and `success` state strings

**Delete account:**
1. Replace inline button with a proper confirmation flow:
   - When "Delete account" clicked, show a confirmation area (inline, not modal — keep it simple) below the button
   - Confirmation area: text "Type 'delete my account' to confirm", text input, and a "Permanently delete" button (red, disabled until input matches)
   - On confirm: call `supabase.auth.admin` — WAIT, admin client is server-only. Instead, create a simple approach:
     - For now, sign the user out and show a message "Contact support to complete account deletion" — full server-side deletion requires an API route which is out of scope for this plan
     - OR use `supabase.rpc('delete_user')` if such a function exists — it likely doesn't
   - **Decision: Use a pragmatic approach** — show the confirmation dialog, and on confirm call `supabase.auth.signOut()` + router.push("/login") with a toast/message. Add a comment `// TODO: Implement server-side account deletion API route`
   - The confirmation UX itself (typing "delete my account") is the value — the actual deletion can be wired to a backend route later
2. Add `showDeleteConfirm` state, `deleteInput` state

**"Change email" button in email section:**
- Keep as-is (no-op) — email change requires verification flow which is out of scope. Add `title="Coming soon"` tooltip or disabled state with text "(coming soon)" next to button.
  </action>
  <verify>
    - Open /settings?tab=account
    - Try password change with mismatched passwords — see validation error
    - Try password change with too-short password — see validation error
    - Try valid password change — see success message (verify via Supabase dashboard if possible)
    - Click "Delete account" — see confirmation area with text input
    - Type wrong text — delete button stays disabled
    - Type "delete my account" — button enables, click it, user is signed out and redirected
    - Check no console errors
  </verify>
  <done>Password change calls Supabase auth.updateUser with validation, delete account shows confirmation dialog with type-to-confirm pattern, email change is marked as coming soon</done>
</task>

</tasks>

<verification>
1. Profile tab: loads real data, saves name to Supabase, company/role to localStorage, persists across refresh
2. Account tab: password change validates and calls Supabase, delete account has confirmation UX, email shows coming soon
3. No console errors on any settings tab
4. Build compiles without TypeScript errors: `pnpm build` passes or `npx tsc --noEmit`
</verification>

<success_criteria>
- Profile name persists in Supabase creator_profiles.display_name across page reloads
- Password can be changed via Supabase auth (validated: min 8 chars, passwords match)
- Delete account has type-to-confirm UX that signs user out
- No mock setTimeout delays or console.log stubs remain in profile or account sections
</success_criteria>

<output>
After completion, create `.planning/phases/04-settings/04-01-SUMMARY.md`
</output>
