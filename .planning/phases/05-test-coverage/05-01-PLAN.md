---
phase: 05-test-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vitest.config.ts
  - package.json
  - src/lib/engine/__tests__/factories.ts
  - src/lib/engine/deepseek.ts
autonomous: true

must_haves:
  truths:
    - "`pnpm test` executes Vitest and exits 0 (even with no tests yet)"
    - "Coverage thresholds are configured at 80% for lines, functions, branches, statements"
    - "Mock factories produce valid GeminiAnalysis, DeepSeekReasoning, RuleScoreResult, TrendEnrichment, ContentPayload, and PipelineResult objects"
    - "`resetCircuitBreaker()` export exists on deepseek.ts for test state isolation"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Vitest configuration with v8 coverage, @/ alias, 80% thresholds"
      contains: "coverage"
    - path: "package.json"
      provides: "test and test:coverage scripts"
      contains: "vitest"
    - path: "src/lib/engine/__tests__/factories.ts"
      provides: "Shared mock data factories for all test files"
      exports: ["makeGeminiAnalysis", "makeDeepSeekReasoning", "makeRuleScoreResult", "makeTrendEnrichment", "makeContentPayload", "makePipelineResult", "makeFeatureVector"]
    - path: "src/lib/engine/deepseek.ts"
      provides: "resetCircuitBreaker test helper export"
      contains: "resetCircuitBreaker"
  key_links:
    - from: "vitest.config.ts"
      to: "src/lib/engine/__tests__/"
      via: "include glob pattern"
      pattern: "src/\\*\\*/\\*.test.ts"
    - from: "package.json"
      to: "vitest.config.ts"
      via: "vitest CLI reads config"
      pattern: "vitest"
---

<objective>
Configure Vitest with v8 coverage, add test scripts to package.json, create shared mock factories, and add resetCircuitBreaker() export to deepseek.ts.

Purpose: Foundation for all subsequent test plans. Every test file needs these factories and this config.
Output: Working `pnpm test` command, factories.ts with 7+ factory functions, circuit breaker reset helper.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-test-coverage/05-RESEARCH.md
@src/lib/engine/types.ts
@src/lib/engine/pipeline.ts
@src/lib/engine/deepseek.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Vitest, configure vitest.config.ts, add test scripts</name>
  <files>vitest.config.ts, package.json</files>
  <action>
1. Install dev dependencies: `pnpm add -D vitest @vitest/coverage-v8`
2. Create `vitest.config.ts` at project root with:
   - `resolve.alias`: `'@/'` maps to `new URL('./src/', import.meta.url).pathname`
   - `test.globals: true` (no need to import describe/it/expect in every file)
   - `test.environment: 'node'`
   - `test.include: ['src/**/*.test.ts']`
   - `coverage.provider: 'v8'`
   - `coverage.reporter: ['text', 'json', 'html']`
   - `coverage.reportsDirectory: './coverage'`
   - `coverage.include: ['src/lib/engine/**/*.ts']`
   - `coverage.exclude`: `['src/lib/engine/__tests__/**', 'src/lib/engine/types.ts', 'src/lib/engine/calibration-baseline.json', 'src/lib/engine/training-data.json', 'src/lib/engine/ml-weights.json']`
   - `coverage.thresholds`: lines 80, functions 80, branches 80, statements 80
3. Add scripts to `package.json`:
   - `"test": "vitest run"` (single run for CI)
   - `"test:watch": "vitest"` (watch mode for dev)
   - `"test:coverage": "vitest run --coverage"` (with coverage report)
4. Add `coverage/` to `.gitignore` if not already present.
  </action>
  <verify>Run `pnpm test` — should exit 0 with "no test files found" or similar (no tests yet). Run `pnpm test:coverage` — should exit 0 (coverage thresholds won't fail until actual engine code is imported).</verify>
  <done>`pnpm test` exits 0, vitest.config.ts exists with 80% thresholds, package.json has test/test:watch/test:coverage scripts</done>
</task>

<task type="auto">
  <name>Task 2: Create mock factories and add resetCircuitBreaker export</name>
  <files>src/lib/engine/__tests__/factories.ts, src/lib/engine/deepseek.ts</files>
  <action>
1. Create `src/lib/engine/__tests__/factories.ts` with factory functions:

   **makeGeminiAnalysis(overrides?)** — Returns valid `GeminiAnalysis` with 5 factors (Scroll-Stop Power, Completion Pull, Rewatch Potential, Share Trigger, Emotional Charge), each with score 7, rationale, improvement_tip. Include overall_impression and content_summary. Optional video_signals.

   **makeDeepSeekReasoning(overrides?)** — Returns valid `DeepSeekReasoning` with behavioral_predictions (completion_pct, share_pct, comment_pct, save_pct with percentile strings), component_scores (all 7 scores: hook_effectiveness, retention_strength, shareability, comment_provocation, save_worthiness, trend_alignment, originality), at least 1 suggestion, empty warnings, confidence "medium".

   **makeRuleScoreResult(overrides?)** — Returns `RuleScoreResult` with rule_score 55, one matched rule (regex tier).

   **makeTrendEnrichment(overrides?)** — Returns `TrendEnrichment` with trend_score 30, one matched trend, trend_context string, hashtag_relevance 0.5.

   **makeContentPayload(overrides?)** — Returns `ContentPayload` with input_mode "text", content_text "Test content #viral", hashtags ["#viral"], no video_url, duration_hint null.

   **makeFeatureVector(overrides?)** — Returns a full `FeatureVector` with sensible defaults for all fields (Gemini factor scores at 7, DeepSeek component scores at 6, video signals null, ruleScore 55, trendScore 30).

   **makePipelineResult(overrides?)** — Returns a full `PipelineResult` composed from the other factories. Includes requestId "test-req-123", timings array with sample entries, total_duration_ms 1500, empty warnings, geminiResult with cost_cents 0.5, deepseekResult with cost_cents 0.3, ruleResult from makeRuleScoreResult, trendEnrichment from makeTrendEnrichment, creatorContext with found:false, audioResult null.

   Each factory should use `Partial<T>` overrides merged with spread: `{ ...defaults, ...overrides }`. Import types from `../types` and `../pipeline`.

2. Add `resetCircuitBreaker()` export to `src/lib/engine/deepseek.ts`:
   - Add at the bottom of the file, before the final export line:
     ```typescript
     /** @internal — test use only. Resets circuit breaker to closed state. */
     export function resetCircuitBreaker(): void {
       breaker = {
         status: "closed",
         consecutiveFailures: 0,
         nextRetryAt: 0,
         backoffIndex: 0,
       };
     }
     ```
   - Update the final export line to include `resetCircuitBreaker`: `export { DEEPSEEK_MODEL, isCircuitOpen, resetCircuitBreaker };`
  </action>
  <verify>Run `npx tsc --noEmit` on factories.ts (or `pnpm build` to confirm no type errors). Verify factories.ts exports all 7 functions. Verify deepseek.ts exports resetCircuitBreaker.</verify>
  <done>factories.ts exports 7 factory functions that produce type-safe test data. deepseek.ts exports resetCircuitBreaker() for test state isolation. No TypeScript errors.</done>
</task>

</tasks>

<verification>
1. `pnpm test` exits 0
2. `pnpm test:coverage` exits 0
3. `vitest.config.ts` has coverage thresholds at 80%
4. `src/lib/engine/__tests__/factories.ts` exports all 7 factory functions
5. `src/lib/engine/deepseek.ts` exports `resetCircuitBreaker`
6. No TypeScript compilation errors
</verification>

<success_criteria>
Test infrastructure is operational: Vitest runs, coverage is configured with 80% thresholds, factory functions produce valid typed test data, and circuit breaker state can be reset between tests.
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-coverage/05-01-SUMMARY.md`
</output>
