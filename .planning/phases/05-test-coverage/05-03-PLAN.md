---
phase: 05-test-coverage
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/lib/engine/__tests__/normalize.test.ts
autonomous: true

must_haves:
  truths:
    - "`normalizeInput()` extracts hashtags from content text into lowercase unique array"
    - "`normalizeInput()` extracts duration hints from '30s', '1 min', '60 seconds' patterns"
    - "`normalizeInput()` handles all 3 input modes: text, tiktok_url, video_upload"
    - "Text mode uses content_text directly, URL mode sets video_url from tiktok_url, upload mode sets video_url from video_storage_path"
    - "Missing optional fields default to null"
  artifacts:
    - path: "src/lib/engine/__tests__/normalize.test.ts"
      provides: "Unit tests for normalizeInput covering hashtags, duration, 3 input modes"
      min_lines: 80
  key_links:
    - from: "src/lib/engine/__tests__/normalize.test.ts"
      to: "src/lib/engine/normalize.ts"
      via: "import normalizeInput"
      pattern: "import.*normalizeInput.*normalize"
---

<objective>
Write unit tests for normalize.ts covering hashtag extraction, duration hint parsing, and all 3 input modes.

Purpose: normalize.ts is fully pure (no external dependencies) — direct testing without mocks.
Output: normalize.test.ts with comprehensive tests for extractHashtags, extractDurationHint, and normalizeInput.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/engine/normalize.ts
@src/lib/engine/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for normalizeInput — hashtags, duration, input modes</name>
  <files>src/lib/engine/__tests__/normalize.test.ts</files>
  <action>
Create `src/lib/engine/__tests__/normalize.test.ts`. No mocks needed — normalize.ts is fully pure.

Import `normalizeInput` from `../normalize`.

**describe('normalizeInput — hashtag extraction'):**

1. **Extracts hashtags from text**: Input `content_text: "Check out #viral and #trending content"`. Assert `hashtags` equals `["#viral", "#trending"]`.

2. **Lowercases hashtags**: Input `content_text: "#Viral #TRENDING"`. Assert both are lowercase.

3. **Deduplicates hashtags**: Input `content_text: "#viral #viral"`. Assert `hashtags` has length 1.

4. **Returns empty for no hashtags**: Input `content_text: "No hashtags here"`. Assert `hashtags` is empty array.

5. **Handles Unicode hashtags**: Input `content_text: "#caf\u00e9 #r\u00e9sum\u00e9"`. Assert both appear in hashtags (the regex uses `\u00C0-\u024F` range).

6. **Empty content_text**: Input with `content_text` undefined (optional field). Assert `hashtags` is empty array and `content_text` is empty string.

**describe('normalizeInput — duration extraction'):**

7. **Extracts seconds from "30s"**: Input `content_text: "This 30s video is great"`. Assert `duration_hint === 30`.

8. **Extracts seconds from "60 seconds"**: Input `content_text: "Watch this 60 seconds clip"`. Assert `duration_hint === 60`.

9. **Extracts minutes as seconds**: Input `content_text: "A 2 min tutorial"`. Assert `duration_hint === 120` (2 * 60).

10. **Returns null when no hint**: Input `content_text: "Great content"`. Assert `duration_hint === null`.

11. **Case insensitive**: Input `content_text: "15 Seconds of fame"`. Assert `duration_hint === 15`.

**describe('normalizeInput — input modes'):**

12. **Text mode**: Input `{ input_mode: "text", content_text: "Hello world", content_type: "post" }`. Assert `input_mode === "text"`, `video_url === null`, `content_text === "Hello world"`.

13. **TikTok URL mode**: Input `{ input_mode: "tiktok_url", tiktok_url: "https://tiktok.com/@user/video/123", content_type: "video" }`. Assert `video_url === "https://tiktok.com/@user/video/123"`, `input_mode === "tiktok_url"`.

14. **Video upload mode**: Input `{ input_mode: "video_upload", video_storage_path: "uploads/vid.mp4", content_type: "video" }`. Assert `video_url === "uploads/vid.mp4"`, `input_mode === "video_upload"`.

15. **Optional fields default to null**: Input text mode with no niche, creator_handle, society_id. Assert all three are null.

16. **Niche and creator_handle pass through**: Input with `niche: "fitness"`, `creator_handle: "@user"`. Assert both appear in output.

All inputs must satisfy the AnalysisInput type shape (include required fields like content_type).
  </action>
  <verify>Run `pnpm test src/lib/engine/__tests__/normalize.test.ts` — all tests pass.</verify>
  <done>normalize.test.ts covers hashtag extraction (including edge cases), duration hint parsing (s/min/seconds patterns), all 3 input modes, and optional field defaults</done>
</task>

</tasks>

<verification>
1. `pnpm test src/lib/engine/__tests__/normalize.test.ts` passes all tests
2. Tests cover: hashtag extraction (5 cases), duration hints (5 cases), input modes (5 cases), total 15+ cases
3. No mocks required — normalize.ts is pure
</verification>

<success_criteria>
All normalize.ts public behavior is tested: hashtag extraction with edge cases, duration parsing with all supported patterns, all 3 input modes with correct field mapping, and optional field defaults.
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-coverage/05-03-SUMMARY.md`
</output>
