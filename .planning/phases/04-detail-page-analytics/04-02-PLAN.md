---
phase: 04-detail-page-analytics
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/competitors/detail/video-card.tsx
  - src/components/competitors/detail/top-videos-section.tsx
  - src/components/competitors/detail/content-analysis-section.tsx
  - src/components/competitors/charts/posting-heatmap.tsx
  - src/components/competitors/charts/duration-breakdown-chart.tsx
  - src/app/(app)/competitors/[handle]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Detail page displays top-performing videos ranked by views or engagement rate"
    - "Detail page displays recent videos feed (last 20 videos, chronological)"
    - "Detail page shows posting frequency/cadence (posts per week/month)"
    - "Detail page shows hashtag frequency ranking from video hashtags array"
    - "Detail page shows best posting time heatmap as a day-of-week x hour CSS grid (UTC)"
    - "Detail page shows video duration format breakdown (< 15s, 15-60s, 1-3min, 3min+)"
  artifacts:
    - path: "src/components/competitors/detail/video-card.tsx"
      provides: "Individual video card with metrics display"
    - path: "src/components/competitors/detail/top-videos-section.tsx"
      provides: "Top videos ranked by views + recent videos feed + posting cadence"
    - path: "src/components/competitors/detail/content-analysis-section.tsx"
      provides: "Hashtag frequency + posting heatmap + duration breakdown wrapper"
    - path: "src/components/competitors/charts/posting-heatmap.tsx"
      provides: "7x24 CSS grid heatmap for posting time analysis"
    - path: "src/components/competitors/charts/duration-breakdown-chart.tsx"
      provides: "Horizontal bar chart for video duration distribution"
  key_links:
    - from: "src/app/(app)/competitors/[handle]/page.tsx"
      to: "src/components/competitors/detail/top-videos-section.tsx"
      via: "server component passes pre-computed video data"
      pattern: "TopVideosSection"
    - from: "src/app/(app)/competitors/[handle]/page.tsx"
      to: "src/components/competitors/detail/content-analysis-section.tsx"
      via: "server component passes hashtags, heatmap grid, duration breakdown"
      pattern: "ContentAnalysisSection"
    - from: "src/components/competitors/charts/posting-heatmap.tsx"
      to: "computePostingTimeGrid"
      via: "receives pre-computed 7x24 grid as prop"
---

<objective>
Build the content analysis sections of the competitor detail page: video feeds, hashtag ranking, posting time heatmap, and duration breakdown.

Purpose: Users can analyze competitor content strategy -- what formats they use, when they post, which hashtags they favor, and which videos perform best (CONT-01 through CONT-06, COMP-06).

Output: Complete detail page with all 5 analytics sections (header + growth + engagement + videos + content analysis). Phase 4 fully satisfies all 12 requirements.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-detail-page-analytics/04-RESEARCH.md
@.planning/phases/04-detail-page-analytics/04-01-SUMMARY.md

# Built in 04-01
@src/app/(app)/competitors/[handle]/page.tsx — server component to extend with content sections
@src/lib/competitors-utils.ts — utility functions including computeHashtagFrequency, computePostingTimeGrid, computeDurationBreakdown, computePostingCadence
@src/components/competitors/charts/chart-tooltip.tsx — shared dark theme tooltip
@src/types/database.types.ts — competitor_videos Row type for video card props
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create video card, top videos section, and recent videos feed</name>
  <files>
    src/components/competitors/detail/video-card.tsx
    src/components/competitors/detail/top-videos-section.tsx
  </files>
  <action>
**1. Create `src/components/competitors/detail/video-card.tsx`** — Individual video display card:

- Server component (no "use client" needed -- no interactivity)
- Props interface `VideoCardData`:
  ```typescript
  interface VideoCardData {
    caption: string | null;
    views: number | null;
    likes: number | null;
    comments: number | null;
    shares: number | null;
    saves: number | null;
    duration_seconds: number | null;
    posted_at: string | null;
    video_url: string | null;
    engagementRate: number | null;
  }
  ```
- No thumbnails (not in schema) -- text-based card with metrics
- Layout: border border-white/[0.06] rounded-xl p-4 space-y-3
- Top: Caption text (2 lines max, truncated with line-clamp-2), or "No caption" in muted text if null
- Middle: 4-column metrics grid:
  - Views (Eye icon), Likes (Heart icon), Comments (ChatCircle icon), Shares (ShareNetwork icon)
  - Use `formatCount` for each value, icons from lucide-react or @phosphor-icons/react
- Bottom row: flex justify-between
  - Left: Duration formatted as "Xs" / "Xm Xs" / "Xh Xm" (write a small inline helper)
  - Middle: Engagement rate badge (if not null): `{rate}%` in a small pill with coral background at 10% opacity
  - Right: Posted date formatted as relative time ("2d ago", "1w ago") or absolute date if older than 30 days
- If `video_url` is not null, wrap card in `<a href={video_url} target="_blank" rel="noopener noreferrer">` with hover:bg-white/[0.02] transition

**2. Create `src/components/competitors/detail/top-videos-section.tsx`** — Videos feed section:

- Server component (VideoCard is server, no Recharts here)
- Props:
  ```typescript
  interface TopVideosSectionProps {
    topVideos: VideoCardData[];       // Top 10 by views
    recentVideos: VideoCardData[];    // Last 20 chronological
    cadence: { postsPerWeek: number; postsPerMonth: number } | null;
  }
  ```
- Section title: "Videos" (text-lg font-semibold, mb-4)
- Stats bar at top: posting cadence displayed as "~X.X posts/week" and "~X.X posts/month" in stat pills (border border-white/[0.06] rounded-lg px-3 py-1 inline-flex), or "Not enough data" if cadence is null
- Two sub-sections with headings:
  - **"Top Performing"** (text-sm font-semibold text-foreground-muted uppercase tracking-wide mb-3)
    - Grid of VideoCards: 1 col on mobile, 2 cols on md, 3 cols on lg
    - Show top 10 videos (sorted by views desc, pre-computed by page.tsx)
  - **"Recent Videos"** (same heading style)
    - Same grid layout
    - Show last 20 videos chronologically (pre-computed by page.tsx)
- If both arrays are empty, show "No videos available" centered message
  </action>
  <verify>
- `npx tsc --noEmit` passes with zero errors
- `src/components/competitors/detail/video-card.tsx` exports `VideoCard` and `VideoCardData`
- `src/components/competitors/detail/top-videos-section.tsx` exports `TopVideosSection`
  </verify>
  <done>
VideoCard renders individual video metrics in a text-based card with caption, 4 metric columns, duration, engagement rate badge, and relative time. TopVideosSection displays top performing and recent videos in responsive grids with posting cadence stat bar.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create content analysis components (heatmap, duration, hashtags) and wire into detail page</name>
  <files>
    src/components/competitors/charts/posting-heatmap.tsx
    src/components/competitors/charts/duration-breakdown-chart.tsx
    src/components/competitors/detail/content-analysis-section.tsx
    src/app/(app)/competitors/[handle]/page.tsx
  </files>
  <action>
**1. Create `src/components/competitors/charts/posting-heatmap.tsx`** — Pure CSS grid heatmap:

- `"use client"` directive (uses inline styles with dynamic values)
- Props: `grid: number[][]` (7 days x 24 hours)
- Constants: `DAYS = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]`
- Compute `maxCount = Math.max(...grid.flat(), 1)` to normalize opacity
- Layout: `overflow-x-auto` wrapper for mobile scrolling
- Grid: `gridTemplateColumns: "40px repeat(24, 1fr)"` via inline style
- First row: empty corner cell + 24 hour labels (0-23, text-[10px] text-foreground-muted text-center)
- For each day: day label (text-xs text-foreground-muted) + 24 hour cells:
  - Each cell: `aspect-square rounded-sm`
  - Background: `oklch(0.72 0.16 40 / ${opacity})` where opacity = count > 0 ? 0.15 + (count / maxCount) * 0.85 : 0.03
  - Title attribute: `"Mon 14:00 - 3 posts"` for tooltip on hover
- Add fragment keys correctly for React (use `<Fragment key={day}>` for each day row group)
- Bottom label: "(UTC)" in text-[10px] text-foreground-muted italic mt-1

**2. Create `src/components/competitors/charts/duration-breakdown-chart.tsx`** — Horizontal BarChart:

- `"use client"` directive
- Props: `data: { label: string; count: number; percentage: number }[]`
- If all counts are 0, return "No duration data" message
- Use Recharts: `BarChart` with `layout="vertical"` inside `ResponsiveContainer` with `height={200}`
- XAxis: type="number", hide (tick={false}, axisLine={false})
- YAxis: type="category", dataKey="label", width 60, fontSize 12, stroke `var(--color-foreground-muted)`
- Single Bar: dataKey="count", fill `var(--color-accent)`, barSize 20, radius [0, 6, 6, 0]
- Custom label on each bar: show `{percentage}%` right-aligned inside the bar (use Recharts `<Cell>` or custom `label` prop)
- Tooltip: use ChartTooltip
- `isAnimationActive={false}`

**3. Create `src/components/competitors/detail/content-analysis-section.tsx`** — Wrapper section:

- `"use client"` (contains chart components)
- Props:
  ```typescript
  interface ContentAnalysisSectionProps {
    hashtags: { tag: string; count: number }[];
    heatmapGrid: number[][];
    durationBreakdown: { label: string; count: number; percentage: number }[];
  }
  ```
- Section title: "Content Analysis" (text-lg font-semibold, mb-4)
- Three sub-sections in a responsive grid (lg:grid-cols-2 gap-6, with heatmap spanning full width):

  **Sub-section 1: Hashtags** (takes left column)
  - Heading: "Top Hashtags" (text-sm font-semibold text-foreground-muted uppercase tracking-wide)
  - Scrollable list (max-h-[300px] overflow-y-auto) of top 20 hashtags:
    - Each row: `#tag` on the left (text-sm), count on the right (text-sm text-foreground-muted)
    - Bar indicator behind each row: width proportional to max count, bg coral at 10% opacity
    - Separator: border-b border-white/[0.04]
  - If empty: "No hashtag data" message

  **Sub-section 2: Duration Breakdown** (takes right column)
  - Heading: "Video Duration Distribution"
  - DurationBreakdownChart component with data

  **Sub-section 3: Posting Time Heatmap** (spans full width, lg:col-span-2)
  - Heading: "Best Posting Times"
  - PostingHeatmap component with grid
  - If all grid values are 0: "No posting time data" message

**4. Modify `src/app/(app)/competitors/[handle]/page.tsx`** — Add content sections:

- Import `TopVideosSection`, `ContentAnalysisSection`, and all needed utility functions
- Import `VideoCardData` type from video-card.tsx
- After existing pre-computation, add:
  ```typescript
  // Video data for content sections
  const allVideos = videos ?? [];

  // Top 10 videos by views (desc)
  const topVideos: VideoCardData[] = [...allVideos]
    .sort((a, b) => (b.views ?? 0) - (a.views ?? 0))
    .slice(0, 10)
    .map((v) => ({
      caption: v.caption,
      views: v.views,
      likes: v.likes,
      comments: v.comments,
      shares: v.shares,
      saves: v.saves,
      duration_seconds: v.duration_seconds,
      posted_at: v.posted_at,
      video_url: v.video_url,
      engagementRate: computeVideoEngagementRate(v),
    }));

  // Recent 20 videos chronologically
  const recentVideos: VideoCardData[] = allVideos
    .slice(0, 20)
    .map((v) => ({
      caption: v.caption,
      views: v.views,
      likes: v.likes,
      comments: v.comments,
      shares: v.shares,
      saves: v.saves,
      duration_seconds: v.duration_seconds,
      posted_at: v.posted_at,
      video_url: v.video_url,
      engagementRate: computeVideoEngagementRate(v),
    }));

  // Posting cadence
  const cadence = computePostingCadence(allVideos);

  // Hashtag frequency
  const hashtags = computeHashtagFrequency(allVideos);

  // Posting time heatmap grid
  const heatmapGrid = computePostingTimeGrid(allVideos);

  // Duration breakdown
  const durationBreakdown = computeDurationBreakdown(allVideos);
  ```
- Replace the placeholder comment from 04-01 with:
  ```tsx
  <TopVideosSection
    topVideos={topVideos}
    recentVideos={recentVideos}
    cadence={cadence}
  />
  <ContentAnalysisSection
    hashtags={hashtags}
    heatmapGrid={heatmapGrid}
    durationBreakdown={durationBreakdown}
  />
  ```
  </action>
  <verify>
- `npx tsc --noEmit` passes with zero errors
- All 4 files exist on disk
- Navigate to `/competitors/[handle]` — all 5 sections visible: Header, Growth, Engagement, Videos, Content Analysis
- Heatmap renders as a 7x24 grid with day labels and hour labels
- Duration breakdown renders as horizontal bars
- Hashtag list shows ranked tags with frequency counts
  </verify>
  <done>
Detail page fully complete with all 5 sections. Top performing videos ranked by views, recent videos feed (20 max), posting cadence stats, hashtag frequency ranking, posting time heatmap (CSS grid, UTC), and video duration format breakdown. Phase 4 requirements COMP-06, GROW-02, GROW-03, ENGM-01-03, CONT-01-06 all satisfied.
  </done>
</task>

</tasks>

<verification>
1. Navigate to `/competitors/[handle]` — page renders all 5 sections (header, growth, engagement, videos, content analysis)
2. Top Performing section shows up to 10 videos sorted by views, each with metrics and engagement rate
3. Recent Videos section shows up to 20 videos chronologically, each with caption, metrics, duration, posting time
4. Posting cadence displayed as posts per week and per month
5. Hashtag frequency list shows ranked tags with counts and proportional bar indicators
6. Posting time heatmap renders 7x24 CSS grid with day/hour labels and "(UTC)" annotation
7. Duration breakdown horizontal bar chart shows 4 buckets with percentage labels
8. Empty data states handled gracefully for all sections
9. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- All content analysis sections render on detail page
- Video cards display all available metrics without thumbnails
- Heatmap uses pure CSS grid (no Recharts)
- All 12 Phase 4 requirements satisfied
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-detail-page-analytics/04-02-SUMMARY.md`
</output>
