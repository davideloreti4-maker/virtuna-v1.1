---
phase: 04-detail-page-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/competitors-utils.ts
  - src/components/competitors/charts/chart-tooltip.tsx
  - src/components/competitors/charts/follower-growth-chart.tsx
  - src/components/competitors/charts/engagement-bar-chart.tsx
  - src/components/competitors/detail/detail-header.tsx
  - src/components/competitors/detail/growth-section.tsx
  - src/components/competitors/detail/engagement-section.tsx
  - src/app/(app)/competitors/[handle]/page.tsx
  - src/app/(app)/competitors/[handle]/loading.tsx
  - src/components/competitors/competitor-card.tsx
  - src/components/competitors/competitor-table.tsx
autonomous: true

must_haves:
  truths:
    - "User can click a competitor card/row on the dashboard to navigate to /competitors/[handle]"
    - "Detail page displays profile header with avatar, handle, display name, bio, follower count, total likes, video count"
    - "Detail page shows follower growth over time as a Recharts area chart with gradient fill from daily snapshots"
    - "Detail page shows average views per video (last 30 videos)"
    - "Detail page shows per-video engagement breakdown (likes, comments, shares, views) as a bar chart"
    - "Detail page shows computed engagement rate per video and average engagement rate across recent videos"
    - "Detail page shows 'Not enough data' fallback when < 2 snapshots exist"
    - "Loading skeleton appears during page navigation"
  artifacts:
    - path: "src/lib/competitors-utils.ts"
      provides: "computeVideoEngagementRate, computeAverageViews, computePostingCadence, computeHashtagFrequency, computePostingTimeGrid, computeDurationBreakdown"
    - path: "src/app/(app)/competitors/[handle]/page.tsx"
      provides: "Server component detail page with parallel Supabase queries"
      contains: "await params"
    - path: "src/components/competitors/charts/follower-growth-chart.tsx"
      provides: "Recharts AreaChart with gradient fill for follower time-series"
    - path: "src/components/competitors/charts/engagement-bar-chart.tsx"
      provides: "Recharts BarChart for per-video engagement breakdown"
    - path: "src/components/competitors/detail/detail-header.tsx"
      provides: "Profile header section with avatar, stats, back link"
    - path: "src/components/competitors/detail/growth-section.tsx"
      provides: "Growth chart + average views stat card section"
    - path: "src/components/competitors/detail/engagement-section.tsx"
      provides: "Engagement bar chart + avg engagement rate section"
  key_links:
    - from: "src/components/competitors/competitor-card.tsx"
      to: "/competitors/[handle]"
      via: "Next.js Link wrapping card"
      pattern: "Link.*href.*competitors/"
    - from: "src/app/(app)/competitors/[handle]/page.tsx"
      to: "supabase"
      via: "parallel Promise.all queries for profile, snapshots, videos"
      pattern: "Promise\\.all"
    - from: "src/app/(app)/competitors/[handle]/page.tsx"
      to: "src/components/competitors/detail/*"
      via: "server component passes pre-computed props to detail sections"
---

<objective>
Build the competitor detail page with profile header, follower growth chart, and engagement metrics section.

Purpose: Users can drill into any competitor from the dashboard to see growth trends and engagement analytics -- the core value proposition of the detail view (COMP-06, GROW-02, GROW-03, ENGM-01, ENGM-02, ENGM-03).

Output: Working `/competitors/[handle]` route with server component data fetching, Recharts charts, and skeleton loading. Dashboard cards and table rows link to the detail page.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-detail-page-analytics/04-RESEARCH.md

# Existing patterns to mirror
@src/app/(app)/competitors/page.tsx — server component data fetching pattern
@src/components/competitors/competitor-sparkline.tsx — Recharts client wrapper pattern
@src/lib/competitors-utils.ts — utility functions to extend
@src/components/competitors/competitor-card.tsx — needs Link wrapping
@src/components/competitors/competitor-table.tsx — needs row Link wrapping
@src/types/database.types.ts — competitor_profiles, competitor_snapshots, competitor_videos Row types
@src/app/globals.css — CSS custom properties for dark theme
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend competitors-utils.ts with analytics functions and create chart components</name>
  <files>
    src/lib/competitors-utils.ts
    src/components/competitors/charts/chart-tooltip.tsx
    src/components/competitors/charts/follower-growth-chart.tsx
    src/components/competitors/charts/engagement-bar-chart.tsx
  </files>
  <action>
**1. Extend `src/lib/competitors-utils.ts`** — Add 6 new pure utility functions below the existing `computeEngagementRate`:

```typescript
// --- Video-level engagement ---

interface VideoMetrics {
  views: number | null;
  likes: number | null;
  comments: number | null;
  shares: number | null;
}

/** Compute engagement rate for a single video: (likes + comments + shares) / views * 100. Returns null if views <= 0 or null. */
export function computeVideoEngagementRate(video: VideoMetrics): number | null {
  if (!video.views || video.views <= 0) return null;
  const engagement = (video.likes ?? 0) + (video.comments ?? 0) + (video.shares ?? 0);
  return Math.round((engagement / video.views) * 100 * 10) / 10;
}

/** Compute average views across videos (defaults to last 30). Returns null if no valid videos. */
export function computeAverageViews(videos: { views: number | null }[], limit = 30): number | null {
  const recent = videos.slice(0, limit);
  const valid = recent.filter((v) => v.views !== null && v.views > 0);
  if (valid.length === 0) return null;
  const total = valid.reduce((sum, v) => sum + v.views!, 0);
  return Math.round(total / valid.length);
}

/** Compute posting frequency: posts per week and per month. Returns null if no dated videos. */
export function computePostingCadence(videos: { posted_at: string | null }[]): { postsPerWeek: number; postsPerMonth: number } | null {
  const dated = videos.filter((v) => v.posted_at !== null);
  if (dated.length < 2) return null;
  const sorted = [...dated].sort((a, b) => new Date(a.posted_at!).getTime() - new Date(b.posted_at!).getTime());
  const firstDate = new Date(sorted[0]!.posted_at!);
  const lastDate = new Date(sorted[sorted.length - 1]!.posted_at!);
  const spanMs = lastDate.getTime() - firstDate.getTime();
  const spanWeeks = Math.max(spanMs / (7 * 24 * 60 * 60 * 1000), 1);
  const spanMonths = Math.max(spanWeeks / 4.33, 1);
  return {
    postsPerWeek: Math.round((dated.length / spanWeeks) * 10) / 10,
    postsPerMonth: Math.round((dated.length / spanMonths) * 10) / 10,
  };
}

/** Extract and rank hashtags by frequency from video hashtags arrays. Uses hashtags column as source of truth (not caption parsing). */
export function computeHashtagFrequency(videos: { hashtags: string[] | null }[]): { tag: string; count: number }[] {
  const freq: Record<string, number> = {};
  for (const video of videos) {
    if (!video.hashtags) continue;
    for (const tag of video.hashtags) {
      const normalized = tag.toLowerCase().trim();
      if (normalized) {
        freq[normalized] = (freq[normalized] ?? 0) + 1;
      }
    }
  }
  return Object.entries(freq)
    .map(([tag, count]) => ({ tag, count }))
    .sort((a, b) => b.count - a.count);
}

/** Aggregate posting times into a 7x24 grid (Mon=0..Sun=6 x 0-23 hours). Uses UTC times. */
export function computePostingTimeGrid(videos: { posted_at: string | null }[]): number[][] {
  const grid: number[][] = Array.from({ length: 7 }, () => Array(24).fill(0));
  for (const video of videos) {
    if (!video.posted_at) continue;
    const date = new Date(video.posted_at);
    const day = date.getUTCDay(); // 0=Sun
    const hour = date.getUTCHours();
    const adjustedDay = day === 0 ? 6 : day - 1; // Mon=0..Sun=6
    grid[adjustedDay]![hour]!++;
  }
  return grid;
}

/** Bucket videos by duration into format categories per CONT-06. */
export function computeDurationBreakdown(videos: { duration_seconds: number | null }[]): { label: string; count: number; percentage: number }[] {
  const buckets = [
    { label: "< 15s", min: 0, max: 15, count: 0 },
    { label: "15-60s", min: 15, max: 60, count: 0 },
    { label: "1-3 min", min: 60, max: 180, count: 0 },
    { label: "3+ min", min: 180, max: Infinity, count: 0 },
  ];
  const validVideos = videos.filter((v) => v.duration_seconds !== null && v.duration_seconds > 0);
  for (const video of validVideos) {
    const d = video.duration_seconds!;
    const bucket = buckets.find((b) => d >= b.min && d < b.max);
    if (bucket) bucket.count++;
  }
  const total = validVideos.length || 1;
  return buckets.map(({ label, count }) => ({ label, count, percentage: Math.round((count / total) * 100) }));
}
```

Note: Extract the `VideoMetrics` interface as a named export above the existing `computeEngagementRate` function so both old and new functions can reference it. Update `computeEngagementRate` to use the same `VideoMetrics` interface for consistency.

**2. Create `src/components/competitors/charts/chart-tooltip.tsx`** — Shared dark theme tooltip for all Recharts charts:

- `"use client"` directive
- Props: `active?: boolean`, `payload?: { name: string; value: number; color: string }[]`, `label?: string`, `formatter?: (value: number) => string`
- Dark theme: `bg: #18191a`, border `border-white/[0.06]`, `box-shadow: rgba(0,0,0,0.5) 0px 4px 12px`
- Default formatter: `(v) => v.toLocaleString()`
- Render payload entries with a small colored dot + name + formatted value
- Return null if !active or no payload
- Follow the code example from research exactly

**3. Create `src/components/competitors/charts/follower-growth-chart.tsx`** — AreaChart with gradient:

- `"use client"` directive
- Props: `data: { date: string; followers: number }[]`
- If `data.length < 2`, return a "Not enough data yet" message (text-sm text-foreground-muted, centered in a 300px-height container)
- Use Recharts: `AreaChart` inside `ResponsiveContainer` with explicit `height={300}`
- Gradient: `linearGradient` with coral accent color (`var(--color-accent)`), 30% opacity at top, 0% at bottom
- CartesianGrid: `strokeDasharray="3 3"`, stroke `rgba(255,255,255,0.06)`, `vertical={false}`
- XAxis: dataKey="date", stroke `var(--color-foreground-muted)`, fontSize 12, no tickLine/axisLine
- YAxis: same styling, `tickFormatter` using `formatCount` from competitors-utils
- Tooltip: use `<ChartTooltip />` from chart-tooltip.tsx, with formatter using `formatCount`
- Area: type="monotone", dataKey="followers", stroke `var(--color-accent)`, fill `url(#followerGradient)`, strokeWidth 2
- `isAnimationActive={false}` to prevent SSR hydration layout shift

**4. Create `src/components/competitors/charts/engagement-bar-chart.tsx`** — BarChart for per-video engagement:

- `"use client"` directive
- Props: `data: { caption: string; views: number; likes: number; comments: number; shares: number; engagementRate: number | null }[]`
- If `data.length === 0`, return "No video data available" message
- Use Recharts: `BarChart` inside `ResponsiveContainer` with explicit `height={300}`
- CartesianGrid: same styling as follower chart
- XAxis: dataKey="caption", fontSize 11, `tickFormatter` truncating to 15 chars with ellipsis, angle -45, textAnchor "end", height 60
- YAxis: stroke `var(--color-foreground-muted)`, fontSize 12, no tickLine/axisLine
- Three stacked Bar components: likes (coral accent), comments (lighter coral, opacity 0.6), shares (even lighter, opacity 0.3)
- Tooltip: use `<ChartTooltip />`
- `isAnimationActive={false}`
  </action>
  <verify>
- `npx tsc --noEmit` passes with zero errors
- All 4 files exist on disk with correct exports
- `computeVideoEngagementRate({ views: 1000, likes: 50, comments: 10, shares: 5 })` would return 6.5
- `computeVideoEngagementRate({ views: 0, likes: 5, comments: 0, shares: 0 })` would return null
  </verify>
  <done>
Six new utility functions exported from competitors-utils.ts. Three chart components (tooltip, follower growth, engagement bar) created as "use client" Recharts wrappers with dark theme styling and empty data fallbacks. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create detail page server component, header, sections, skeleton, and wire dashboard Links</name>
  <files>
    src/components/competitors/detail/detail-header.tsx
    src/components/competitors/detail/growth-section.tsx
    src/components/competitors/detail/engagement-section.tsx
    src/app/(app)/competitors/[handle]/page.tsx
    src/app/(app)/competitors/[handle]/loading.tsx
    src/components/competitors/competitor-card.tsx
    src/components/competitors/competitor-table.tsx
  </files>
  <action>
**1. Create `src/components/competitors/detail/detail-header.tsx`** — Profile header section:

- Server component (no "use client")
- Props: `profile` matching `competitor_profiles` Row type from database.types.ts (use `Tables<"competitor_profiles">` or inline the relevant fields)
- Layout: flex row with back link on the left ("< Back to Competitors" as Next.js Link to `/competitors`)
- Below: Avatar (size "lg"), @handle (text-lg font-semibold), display_name (text-sm text-foreground-muted), bio (text-sm text-foreground-muted, max 2 lines truncate)
- Stats row: 3 stat cards in a grid (Followers, Total Likes, Videos) using `formatCount`
- Styling: border-b border-white/[0.06] pb-6 mb-6

**2. Create `src/components/competitors/detail/growth-section.tsx`** — Growth analytics section:

- `"use client"` (wraps Recharts chart)
- Props: `chartData: { date: string; followers: number }[]`, `averageViews: number | null`, `growthVelocity: { percentage: number; direction: "up" | "down" | "flat" } | null`
- Section title: "Growth" (text-lg font-semibold, mb-4)
- Two-column layout (lg:grid-cols-2 gap-6):
  - Left: FollowerGrowthChart component with chartData
  - Right: Stat cards stacked vertically:
    - "Avg Views/Video" — `formatCount(averageViews)` or "--"
    - "Weekly Growth" — GrowthDelta component if velocity exists, else "--"
- Both stat cards: border border-white/[0.06] rounded-xl p-4, label text-xs text-foreground-muted, value text-xl font-semibold

**3. Create `src/components/competitors/detail/engagement-section.tsx`** — Engagement analytics section:

- `"use client"` (wraps Recharts chart)
- Props: `chartData: { caption: string; views: number; likes: number; comments: number; shares: number; engagementRate: number | null }[]`, `averageEngagementRate: number | null`
- Section title: "Engagement" (text-lg font-semibold, mb-4)
- Two-column layout:
  - Left: EngagementBarChart with chartData (show top 10 videos only for readability)
  - Right: Stat card showing "Avg Engagement Rate" — `averageEngagementRate !== null ? averageEngagementRate + "%" : "--"`
- Additional: Below the chart, a scrollable table showing per-video engagement breakdown:
  - Columns: Video (truncated caption), Views, Likes, Comments, Shares, Eng. Rate
  - Max 20 rows, sorted by views descending
  - Use `computeVideoEngagementRate` for per-row rate
  - Table styled like CompetitorTable (same border/hover conventions)

**4. Create `src/app/(app)/competitors/[handle]/page.tsx`** — Server component detail page:

- **CRITICAL**: Next.js 15 params: `params: Promise<{ handle: string }>`, must `await params`
- Auth check: `createClient()` -> `getUser()` -> null guard
- Fetch profile: query `competitor_profiles` where `tiktok_handle = handle`, `.single()`. Call `notFound()` if null.
- Verify user tracks this competitor: query `user_competitors` where `competitor_id = profile.id` and `user_id = user.id`. Call `notFound()` if no junction row (prevents accessing competitors not in user's list).
- Parallel fetch: `Promise.all` for snapshots (all time, ascending by snapshot_date) and videos (all, descending by posted_at)
- Pre-compute all analytics server-side:
  - `chartData` for follower growth: map snapshots to `{ date: snapshot_date, followers: follower_count }`
  - `growthVelocity` via `computeGrowthVelocity(snapshots)`
  - `averageViews` via `computeAverageViews(videos)`
  - `engagementChartData`: top 20 videos by views, map to `{ caption, views, likes, comments, shares, engagementRate }`
  - `averageEngagementRate` via `computeEngagementRate(videos)`
- Render layout: `<div className="space-y-8 pb-8">` containing:
  - `<DetailHeader profile={profile} />`
  - `<GrowthSection chartData={...} averageViews={...} growthVelocity={...} />`
  - `<EngagementSection chartData={...} averageEngagementRate={...} />`
  - Placeholder div for content analysis sections (Plan 04-02): `{/* Content analysis sections added in 04-02 */}`
- Export metadata: `{ title: "@handle | Competitors | Virtuna" }`
- Use `generateMetadata` async function for dynamic title with handle

**5. Create `src/app/(app)/competitors/[handle]/loading.tsx`** — Skeleton:

- Mirrors detail page layout with animated shimmer blocks:
  - Header skeleton: avatar circle + text bars
  - Two section skeletons: title bar + chart-height (300px) rounded rectangle
- Use `animate-pulse` Tailwind class
- Same spacing as real page (space-y-8)

**6. Modify `src/components/competitors/competitor-card.tsx`** — Wrap card with Link:

- Add `import Link from "next/link"`
- Wrap the `<Card>` element with `<Link href={`/competitors/${data.tiktok_handle}`}>`
- The card already has `cursor-pointer` class

**7. Modify `src/components/competitors/competitor-table.tsx`** — Make rows clickable:

- Add `import Link from "next/link"`
- Wrap each `<tr>` inside the map with `<Link href={`/competitors/${c.tiktok_handle}`}>` -- but since `<Link>` renders an `<a>`, and `<a>` inside `<tbody>` is invalid HTML, instead use `onClick` with `useRouter().push()` or wrap the row content differently.
- Best approach: wrap each `<tr>` in the map callback, adding `onClick={() => router.push(`/competitors/${c.tiktok_handle}`)}` with `useRouter` from next/navigation. The component is already `"use client"`. Keep the `cursor-pointer` class on `<tr>`.
  </action>
  <verify>
- `npx tsc --noEmit` passes with zero errors
- `src/app/(app)/competitors/[handle]/page.tsx` exists and uses `await params` pattern
- `src/app/(app)/competitors/[handle]/loading.tsx` exists
- Both `competitor-card.tsx` and `competitor-table.tsx` have navigation to `/competitors/[handle]`
- All detail section components exist: detail-header.tsx, growth-section.tsx, engagement-section.tsx
  </verify>
  <done>
Detail page loads at `/competitors/[handle]` with profile header, follower growth area chart, engagement bar chart, per-video engagement table, and stat cards. Dashboard cards and table rows navigate to the detail page on click. Loading skeleton displays during navigation. All data fetched server-side with parallel queries.
  </done>
</task>

</tasks>

<verification>
1. Navigate to `/competitors` dashboard -- cards and table rows should be clickable
2. Click a competitor card -- should navigate to `/competitors/[handle]`
3. Detail page shows profile header with avatar, handle, follower count, total likes, video count
4. Follower growth area chart renders with coral gradient (or "Not enough data" if < 2 snapshots)
5. Engagement bar chart renders with per-video breakdown (or "No video data" fallback)
6. Average views per video and average engagement rate displayed as stat cards
7. Per-video engagement table shows views, likes, comments, shares, engagement rate columns
8. Loading skeleton appears when navigating to detail page
9. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- `/competitors/[handle]` route renders with all growth and engagement sections
- Dashboard cards/rows link to detail page
- All charts handle empty data gracefully
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-detail-page-analytics/04-01-SUMMARY.md`
</output>
