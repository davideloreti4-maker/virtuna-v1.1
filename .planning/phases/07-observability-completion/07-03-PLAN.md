---
phase: 07-observability-completion
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/cron/calculate-trends/route.ts
  - src/app/api/cron/calibration-audit/route.ts
  - src/app/api/cron/refresh-competitors/route.ts
  - src/app/api/cron/retrain-ml/route.ts
  - src/app/api/cron/scrape-trending/route.ts
  - src/app/api/cron/sync-whop/route.ts
  - src/app/api/cron/validate-rules/route.ts
  - src/app/api/webhooks/apify/route.ts
  - src/app/api/webhooks/whop/route.ts
autonomous: true

must_haves:
  truths:
    - "All 7 cron route handlers use createLogger instead of console.*"
    - "Both webhook route handlers use createLogger instead of console.*"
    - "Zero console.log, console.error, or console.warn calls remain in any cron or webhook route"
    - "All module bindings follow the naming convention: cron/<route-name> or webhook/<provider>"
  artifacts:
    - path: "src/app/api/cron/calculate-trends/route.ts"
      provides: "Structured logging for calculate-trends cron"
      contains: "createLogger"
    - path: "src/app/api/cron/calibration-audit/route.ts"
      provides: "Structured logging for calibration-audit cron"
      contains: "createLogger"
    - path: "src/app/api/cron/refresh-competitors/route.ts"
      provides: "Structured logging for refresh-competitors cron"
      contains: "createLogger"
    - path: "src/app/api/cron/retrain-ml/route.ts"
      provides: "Structured logging for retrain-ml cron"
      contains: "createLogger"
    - path: "src/app/api/cron/scrape-trending/route.ts"
      provides: "Structured logging for scrape-trending cron"
      contains: "createLogger"
    - path: "src/app/api/cron/sync-whop/route.ts"
      provides: "Structured logging for sync-whop cron"
      contains: "createLogger"
    - path: "src/app/api/cron/validate-rules/route.ts"
      provides: "Structured logging for validate-rules cron"
      contains: "createLogger"
    - path: "src/app/api/webhooks/apify/route.ts"
      provides: "Structured logging for apify webhook"
      contains: "createLogger"
    - path: "src/app/api/webhooks/whop/route.ts"
      provides: "Structured logging for whop webhook"
      contains: "createLogger"
  key_links:
    - from: "src/app/api/cron/*/route.ts"
      to: "@/lib/logger"
      via: "import createLogger at top of each file"
      pattern: "import.*createLogger.*from.*@/lib/logger"
    - from: "src/app/api/webhooks/*/route.ts"
      to: "@/lib/logger"
      via: "import createLogger at top of each file"
      pattern: "import.*createLogger.*from.*@/lib/logger"
---

<objective>
Migrate all 7 cron route handlers and 2 webhook route handlers from `console.*` to `createLogger`.

Purpose: These 9 files contain 43 total `console.*` calls — the last remaining unstructured log output in the application's backend routes. After this plan, all application code uses the structured logger.

Output: All 9 route files import `createLogger`, use module-bound loggers, and emit structured JSON logs with no string interpolation.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-observability-completion/07-RESEARCH.md
@src/lib/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate simple cron routes (refresh-competitors, sync-whop, scrape-trending)</name>
  <files>
    src/app/api/cron/refresh-competitors/route.ts
    src/app/api/cron/sync-whop/route.ts
    src/app/api/cron/scrape-trending/route.ts
  </files>
  <action>
For each of the 3 files, apply this pattern:

1. Add import at top: `import { createLogger } from "@/lib/logger";`
2. Add module-level logger after imports: `const log = createLogger({ module: "cron/<route-name>" });`
3. Replace every `console.error(...)` with `log.error(...)` using structured data
4. Replace every `console.log(...)` with `log.info(...)` using structured data
5. Replace every `console.warn(...)` with `log.warn(...)` using structured data

**Migration rules (apply to ALL replacements):**
- Extract string-interpolated variables into the data object: `console.log(\`Processed ${n}\`)` becomes `log.info("Processed", { count: n })`
- The `[module-name]` prefix in existing console messages is redundant (logger bindings provide it). Remove it from the message string.
- Error objects: use `error instanceof Error ? error.message : String(error)` for JSON serialization safety
- Supabase errors: use `error.message` directly (PostgrestError has a string `.message`)
- Two-argument console calls like `console.warn("message", data)` become `log.warn("message", data)` — the structured logger accepts the same signature
- Never use template literals in the first argument (message). All variables go in the second argument (data object).

**Module naming convention:**
- `refresh-competitors` -> `{ module: "cron/refresh-competitors" }`
- `sync-whop` -> `{ module: "cron/sync-whop" }`
- `scrape-trending` -> `{ module: "cron/scrape-trending" }`

**Expected call counts:** refresh-competitors: 2, sync-whop: 3, scrape-trending: 3. Total: 8 replacements.
  </action>
  <verify>
1. `grep -c 'console\.' src/app/api/cron/refresh-competitors/route.ts src/app/api/cron/sync-whop/route.ts src/app/api/cron/scrape-trending/route.ts` returns 0 for all three
2. `grep -c 'createLogger' src/app/api/cron/refresh-competitors/route.ts src/app/api/cron/sync-whop/route.ts src/app/api/cron/scrape-trending/route.ts` returns >= 1 for all three
3. `pnpm build` succeeds (TypeScript compiles, no type errors)
  </verify>
  <done>
All 3 simple cron routes use createLogger with structured data. Zero console.* calls remain. Module bindings follow `cron/<route-name>` convention.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate medium/complex cron routes (calculate-trends, calibration-audit, validate-rules, retrain-ml)</name>
  <files>
    src/app/api/cron/calculate-trends/route.ts
    src/app/api/cron/calibration-audit/route.ts
    src/app/api/cron/validate-rules/route.ts
    src/app/api/cron/retrain-ml/route.ts
  </files>
  <action>
For each of the 4 files, apply the same migration pattern as Task 1:

1. Add import: `import { createLogger } from "@/lib/logger";`
2. Add module-level logger: `const log = createLogger({ module: "cron/<route-name>" });`
3. Replace all `console.*` calls with structured equivalents

**Module naming:**
- `calculate-trends` -> `{ module: "cron/calculate-trends" }`
- `calibration-audit` -> `{ module: "cron/calibration-audit" }`
- `validate-rules` -> `{ module: "cron/validate-rules" }`
- `retrain-ml` -> `{ module: "cron/retrain-ml" }`

**Special attention for retrain-ml (7 calls, most complex):**
- Multiple `console.log` calls with string interpolation for training metrics — extract all variables into structured data
- Example: `console.log(\`Training accuracy: ${accuracy}%\`)` becomes `log.info("Training complete", { accuracy })`
- Combine sequential console.log calls that report related metrics into a single structured log entry where it makes semantic sense

**Special attention for calibration-audit (6 calls):**
- Likely has `console.log` calls with ECE metrics — put them in structured data
- Example: `console.log(\`ECE: ${ece}\`)` becomes `log.info("Calibration audit complete", { ece })`

**Special attention for validate-rules (6 calls):**
- Multiple error paths — ensure each uses the `error instanceof Error ? error.message : String(error)` pattern

**Expected call counts:** calculate-trends: 4, calibration-audit: 6, validate-rules: 6, retrain-ml: 7. Total: 23 replacements.
  </action>
  <verify>
1. `grep -c 'console\.' src/app/api/cron/calculate-trends/route.ts src/app/api/cron/calibration-audit/route.ts src/app/api/cron/validate-rules/route.ts src/app/api/cron/retrain-ml/route.ts` returns 0 for all four
2. `grep -c 'createLogger' src/app/api/cron/calculate-trends/route.ts src/app/api/cron/calibration-audit/route.ts src/app/api/cron/validate-rules/route.ts src/app/api/cron/retrain-ml/route.ts` returns >= 1 for all four
3. `pnpm build` succeeds
  </verify>
  <done>
All 4 medium/complex cron routes use createLogger with structured data. Zero console.* calls remain. Module bindings follow `cron/<route-name>` convention. String interpolation replaced with structured data objects.
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate webhook routes (apify, whop) and verify zero console.* across all 9 files</name>
  <files>
    src/app/api/webhooks/apify/route.ts
    src/app/api/webhooks/whop/route.ts
  </files>
  <action>
For each webhook file, apply the same migration pattern:

1. Add import: `import { createLogger } from "@/lib/logger";`
2. Add module-level logger: `const log = createLogger({ module: "webhook/<provider>" });`
3. Replace all `console.*` calls with structured equivalents

**Module naming:**
- `apify` -> `{ module: "webhook/apify" }`
- `whop` -> `{ module: "webhook/whop" }`

**Special attention for whop webhook (8 calls, most complex):**
- Has `console.warn` calls with two arguments (message string + data object). These map directly: `console.warn("message", { data })` becomes `log.warn("message", { data })`
- Has event-type-specific error handling — preserve the context (event type, IDs) in structured data
- Example from research: `console.warn("membership.went_valid: missing supabase_user_id in metadata", { whop_user_id: data.user_id, membership_id: data.id })` becomes `log.warn("Missing supabase_user_id in metadata", { event: "membership.went_valid", whop_user_id: data.user_id, membership_id: data.id })`

**Special attention for apify webhook (4 calls):**
- Likely has payload validation errors — use structured data for the validation context

**Expected call counts:** apify: 4, whop: 8. Total: 12 replacements.

**Final verification (covers all 9 files):**
After migrating both webhooks, run a comprehensive check:
```bash
grep -rn 'console\.\(log\|error\|warn\)' src/app/api/cron/*/route.ts src/app/api/webhooks/*/route.ts
```
This MUST return zero results.
  </action>
  <verify>
1. `grep -rn 'console\.' src/app/api/cron/*/route.ts src/app/api/webhooks/*/route.ts` returns zero matches
2. `grep -c 'createLogger' src/app/api/webhooks/apify/route.ts src/app/api/webhooks/whop/route.ts` returns >= 1 for both
3. `pnpm test` passes (203+ tests, >80% coverage)
4. `pnpm build` succeeds with no TypeScript errors
  </verify>
  <done>
All 9 route files (7 cron + 2 webhook) use createLogger with structured data. Zero console.* calls remain across all cron and webhook routes. All module bindings follow `cron/<name>` / `webhook/<provider>` convention. Both `pnpm test` and `pnpm build` pass.
  </done>
</task>

</tasks>

<verification>
- `grep -rn 'console\.\(log\|error\|warn\)' src/app/api/cron/*/route.ts src/app/api/webhooks/*/route.ts` returns zero matches
- `grep -rn 'createLogger' src/app/api/cron/*/route.ts src/app/api/webhooks/*/route.ts` shows imports in all 9 files
- No string interpolation (template literals) in log message arguments across any of the 9 files
- `pnpm test` passes (203+ tests, >80% coverage)
- `pnpm build` succeeds with no TypeScript errors
</verification>

<success_criteria>
SC-5 from the phase is satisfied: all 7 cron route handlers and 2 webhook handlers use `createLogger` instead of `console.*`. Combined with plans 07-01 and 07-02, all phase success criteria (SC-1 through SC-7) are met.
</success_criteria>

<output>
After completion, create `.planning/phases/07-observability-completion/07-03-SUMMARY.md`
</output>
