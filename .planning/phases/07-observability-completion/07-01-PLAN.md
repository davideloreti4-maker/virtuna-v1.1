---
phase: 07-observability-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/engine/deepseek.ts
autonomous: true

must_haves:
  truths:
    - "Every cost-bearing pipeline stage (gemini, deepseek) emits a log entry with all 4 fields: requestId, stage, duration_ms, cost_cents"
    - "The DeepSeek->Gemini fallback log includes a stage field"
    - "The Pipeline complete log includes cost_cents alongside stage and duration_ms"
  artifacts:
    - path: "src/lib/engine/deepseek.ts"
      provides: "stage field on Gemini fallback log"
      contains: "stage: \"deepseek_gemini_fallback\""
  key_links:
    - from: "src/lib/engine/deepseek.ts"
      to: "@/lib/logger"
      via: "createLogger at module level"
      pattern: "log\\.info.*stage.*duration_ms.*cost_cents"
---

<objective>
Add the missing `stage` field to the DeepSeek->Gemini fallback log entry in deepseek.ts.

Purpose: Research confirmed that gemini.ts, deepseek.ts, and pipeline.ts already emit the 4 required fields (requestId via logger bindings, stage, duration_ms, cost_cents) on their happy paths. The single gap is the DeepSeek Gemini fallback log (line ~608) which has `duration_ms` and `cost_cents` but is missing `stage`. This plan closes that gap.

Output: deepseek.ts fallback log entry includes `stage: "deepseek_gemini_fallback"` alongside existing fields.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/engine/deepseek.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add stage field to DeepSeek Gemini fallback log and verify all engine stage logs</name>
  <files>src/lib/engine/deepseek.ts</files>
  <action>
In `src/lib/engine/deepseek.ts`, find the fallback log entry around line 608:

```typescript
log.info("DeepSeek->Gemini fallback complete", {
  duration_ms: fallbackDuration,
  cost_cents: +cost_cents.toFixed(4),
});
```

Add the `stage` field to make it consistent with all other stage completion logs:

```typescript
log.info("DeepSeek->Gemini fallback complete", {
  stage: "deepseek_gemini_fallback",
  duration_ms: fallbackDuration,
  cost_cents: +cost_cents.toFixed(4),
});
```

After the edit, verify the other stage completion logs are correct (no changes needed, just confirm):
- gemini.ts: `stage: "gemini_text_analysis"` and `stage: "gemini_video_analysis"` -- both already have all 4 fields
- deepseek.ts: `stage: "deepseek_reasoning"` -- already has all 4 fields
- pipeline.ts: `stage: "pipeline"` with `cost_cents` -- already has all 4 fields

No other files need modification.
  </action>
  <verify>
1. `grep -n 'stage.*deepseek_gemini_fallback' src/lib/engine/deepseek.ts` shows the new field
2. `pnpm test` passes (203+ tests)
3. `pnpm build` succeeds with no TypeScript errors
  </verify>
  <done>
The DeepSeek Gemini fallback log entry includes `stage: "deepseek_gemini_fallback"` alongside `duration_ms` and `cost_cents`. All cost-bearing pipeline stages (gemini text, gemini video, deepseek reasoning, deepseek gemini fallback, pipeline total) emit log entries with all 4 required fields.
  </done>
</task>

</tasks>

<verification>
- `grep -rn 'stage:.*duration_ms.*cost_cents\|duration_ms.*stage:.*cost_cents\|cost_cents.*stage:.*duration_ms' src/lib/engine/deepseek.ts` shows the fallback log has all fields
- `grep -c 'console\.' src/lib/engine/gemini.ts src/lib/engine/deepseek.ts src/lib/engine/pipeline.ts` returns 0 for all three files
- `pnpm test` passes
- `pnpm build` succeeds
</verification>

<success_criteria>
SC-1 and SC-2 from the phase are satisfied: every cost-bearing stage emits `{ stage, duration_ms, cost_cents }` and the Pipeline complete log includes `cost_cents`.
</success_criteria>

<output>
After completion, create `.planning/phases/07-observability-completion/07-01-SUMMARY.md`
</output>
