---
phase: 07-observability-completion
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/engine/trends.ts
  - src/lib/engine/creator.ts
autonomous: true

must_haves:
  truths:
    - "trends.ts uses createLogger with module binding and emits structured log calls"
    - "creator.ts uses createLogger with module binding and emits structured log calls"
    - "Existing tests for trends.ts and creator.ts still pass without modification"
  artifacts:
    - path: "src/lib/engine/trends.ts"
      provides: "Structured logging for trend enrichment"
      contains: "createLogger"
    - path: "src/lib/engine/creator.ts"
      provides: "Structured logging for creator context"
      contains: "createLogger"
  key_links:
    - from: "src/lib/engine/trends.ts"
      to: "@/lib/logger"
      via: "import createLogger"
      pattern: "import.*createLogger.*from.*@/lib/logger"
    - from: "src/lib/engine/creator.ts"
      to: "@/lib/logger"
      via: "import createLogger"
      pattern: "import.*createLogger.*from.*@/lib/logger"
---

<objective>
Add structured logging to trends.ts and creator.ts — the only two engine modules without any logging.

Purpose: These are the last two engine modules that have zero logging. Both their test files already mock `@/lib/logger`, so adding the import and logger calls requires zero test changes.

Note: The phase description mentions `admin/costs/route.ts` catch block, but research confirmed it already uses `createLogger` correctly (SC-4 is pre-satisfied). No work needed there.

Output: Both files import `createLogger` and emit structured log calls at key decision points.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/engine/trends.ts
@src/lib/engine/creator.ts
@src/lib/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add structured logger to trends.ts</name>
  <files>src/lib/engine/trends.ts</files>
  <action>
Add the `createLogger` import and module-level logger to `src/lib/engine/trends.ts`:

```typescript
import { createLogger } from "@/lib/logger";

const log = createLogger({ module: "trends" });
```

Add structured log calls at these key points inside `enrichWithTrends()`:

1. **After fetching/caching trending sounds** (after the `soundsCache.set` line, around line 43):
```typescript
log.debug("Trending sounds loaded", { count: trendingSounds.length, cached: !!soundsCache.get("trending_sounds") });
```

2. **After the trend matching loop completes** (after the for-loop ends, around line 79):
```typescript
log.info("Trend enrichment complete", {
  matched_sounds: matched_trends.length,
  hashtag_count: hashtags.length,
  trend_score: normalizedScore,
  hashtag_relevance: +hashtag_relevance.toFixed(3),
});
```

Place the summary log just before the return statement (after `normalizedScore` is computed, around line 156), NOT inside the matching loop.

Use `log.debug` for cache operations (noisy) and `log.info` for the final enrichment summary (useful in production).

Do NOT use string interpolation in log messages. All variable data goes into the structured data object.
  </action>
  <verify>
1. `grep -n 'createLogger' src/lib/engine/trends.ts` shows the import and module-level logger
2. `pnpm test -- --run src/lib/engine/__tests__/trends.test.ts` passes (test already mocks @/lib/logger)
  </verify>
  <done>
trends.ts imports createLogger, creates a module-level logger with `{ module: "trends" }`, and emits structured log calls for cache loads and enrichment results.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add structured logger to creator.ts</name>
  <files>src/lib/engine/creator.ts</files>
  <action>
Add the `createLogger` import and module-level logger to `src/lib/engine/creator.ts`:

```typescript
import { createLogger } from "@/lib/logger";

const log = createLogger({ module: "creator" });
```

Add structured log calls at these key points:

1. **In `getPlatformAverages()`, when falling back to defaults** (inside the `if (error || !videos || videos.length === 0)` block, around line 56):
```typescript
log.debug("Platform averages fallback", { reason: error ? "db_error" : "no_data" });
```

2. **In `fetchCreatorContext()`, after profile lookup completes** (just before the final return, around line 154):
```typescript
log.info("Creator context resolved", {
  found: !!profile,
  creator_handle: creator_handle ?? "none",
});
```

3. **In `fetchCreatorContext()`, when no creator handle is provided** (inside the `if (!creator_handle)` block, around line 117):
```typescript
log.debug("No creator handle provided, using cold-start context");
```

Use `log.debug` for expected paths (cache fallback, no handle). Use `log.info` for the profile lookup result (useful for debugging creator context issues in production).

Do NOT use string interpolation. All variable data goes into the structured data object.
  </action>
  <verify>
1. `grep -n 'createLogger' src/lib/engine/creator.ts` shows the import and module-level logger
2. `pnpm test -- --run src/lib/engine/__tests__/creator.test.ts` passes (test already mocks @/lib/logger)
3. `pnpm test` passes (all 203+ tests)
  </verify>
  <done>
creator.ts imports createLogger, creates a module-level logger with `{ module: "creator" }`, and emits structured log calls for fallback scenarios and profile lookup results.
  </done>
</task>

</tasks>

<verification>
- `grep -c 'createLogger' src/lib/engine/trends.ts src/lib/engine/creator.ts` returns >= 1 for both files
- `grep -c 'console\.' src/lib/engine/trends.ts src/lib/engine/creator.ts` returns 0 for both files (they had no console.* before either)
- `pnpm test` passes (203+ tests, >80% coverage)
- `pnpm build` succeeds
</verification>

<success_criteria>
SC-3 from the phase is satisfied: trends.ts and creator.ts use `createLogger` with module binding and structured log calls. SC-4 (admin/costs) was already satisfied — no work needed.
</success_criteria>

<output>
After completion, create `.planning/phases/07-observability-completion/07-02-SUMMARY.md`
</output>
