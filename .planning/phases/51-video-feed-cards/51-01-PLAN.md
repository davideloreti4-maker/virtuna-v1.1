---
phase: 51-video-feed-cards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - next.config.ts
  - src/hooks/use-infinite-videos.ts
autonomous: true

must_haves:
  truths:
    - "Next.js Image can load picsum.photos thumbnails without hostname error"
    - "useInfiniteVideos hook returns paginated videos for a given category, with loadMore and hasMore"
    - "Switching category resets pagination to first page"
  artifacts:
    - path: "next.config.ts"
      provides: "remotePatterns for picsum.photos and fastly.picsum.photos"
      contains: "picsum.photos"
    - path: "src/hooks/use-infinite-videos.ts"
      provides: "useInfiniteVideos custom hook"
      exports: ["useInfiniteVideos"]
  key_links:
    - from: "src/hooks/use-infinite-videos.ts"
      to: "src/lib/trending-mock-data.ts"
      via: "getVideosByCategory import"
      pattern: "getVideosByCategory"
---

<objective>
Set up image configuration and build the infinite scroll data hook.

Purpose: The VideoGrid (Plan 03) needs Next.js to serve picsum.photos images and a hook to paginate mock data. Both are non-visual, no v0 needed.
Output: Updated next.config.ts with remotePatterns, new useInfiniteVideos hook with category-aware pagination.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/trending.ts
@src/lib/trending-mock-data.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add picsum.photos remotePatterns + install react-intersection-observer</name>
  <files>next.config.ts</files>
  <action>
1. Run `pnpm add react-intersection-observer` to install the infinite scroll sentinel library.

2. Update next.config.ts to add `images.remotePatterns` for picsum.photos. The existing config has `transpilePackages: ['three']`. Add the images key:

```typescript
const nextConfig: NextConfig = {
  transpilePackages: ['three'],
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'picsum.photos',
      },
      {
        protocol: 'https',
        hostname: 'fastly.picsum.photos',
      },
    ],
  },
};
```

Both hostnames are needed because picsum.photos often redirects to fastly.picsum.photos for CDN delivery.
  </action>
  <verify>
- `pnpm list react-intersection-observer` shows the package installed
- `grep "picsum" next.config.ts` shows both hostnames present
- `pnpm build` (or at minimum `pnpm tsc --noEmit`) passes without errors
  </verify>
  <done>react-intersection-observer installed, next.config.ts allows picsum.photos images</done>
</task>

<task type="auto">
  <name>Task 2: Create useInfiniteVideos hook</name>
  <files>src/hooks/use-infinite-videos.ts</files>
  <action>
Create `src/hooks/use-infinite-videos.ts` -- a custom hook for paginated video loading with category reset.

```typescript
"use client";

import { useState, useEffect, useCallback } from "react";
import { getVideosByCategory } from "@/lib/trending-mock-data";
import type { TrendingCategory, TrendingVideo } from "@/types/trending";

interface UseInfiniteVideosReturn {
  videos: TrendingVideo[];
  hasMore: boolean;
  loadMore: () => void;
  isLoadingMore: boolean;
  total: number;
}

/**
 * Paginated video hook with category-aware reset.
 *
 * Returns a growing slice of videos for the given category.
 * Each call to `loadMore` appends the next batch. Changing
 * `category` resets to the first page.
 *
 * @param category - Active trending category to filter by
 * @param pageSize - Number of videos per batch (default: 6, fills 2 desktop grid rows)
 */
export function useInfiniteVideos(
  category: TrendingCategory,
  pageSize = 6
): UseInfiniteVideosReturn {
  const [displayCount, setDisplayCount] = useState(pageSize);
  const [isLoadingMore, setIsLoadingMore] = useState(false);

  const allVideos = getVideosByCategory(category);
  const hasMore = displayCount < allVideos.length;

  const loadMore = useCallback(() => {
    if (!hasMore || isLoadingMore) return;

    setIsLoadingMore(true);
    // Brief delay for skeleton flash (perceived loading)
    const timer = setTimeout(() => {
      setDisplayCount((prev) => Math.min(prev + pageSize, allVideos.length));
      setIsLoadingMore(false);
    }, 300);

    return () => clearTimeout(timer);
  }, [hasMore, isLoadingMore, pageSize, allVideos.length]);

  // Reset when category changes
  useEffect(() => {
    setDisplayCount(pageSize);
    setIsLoadingMore(false);
  }, [category, pageSize]);

  return {
    videos: allVideos.slice(0, displayCount),
    hasMore,
    loadMore,
    isLoadingMore,
    total: allVideos.length,
  };
}
```

Key decisions:
- Page size 6 = fills 2 desktop rows (3 cols x 2 rows)
- 300ms delay in loadMore for skeleton flash (matches existing 250ms tab loading pattern)
- `isLoadingMore` guard prevents duplicate batch loads (Pitfall 4 from research)
- Category change resets displayCount (Pitfall 5 from research)
- Returns `total` for potential "showing X of Y" UI
  </action>
  <verify>
- File exists at src/hooks/use-infinite-videos.ts
- `pnpm tsc --noEmit` passes (TypeScript compiles)
- Hook exports `useInfiniteVideos` function
- Hook imports from `@/lib/trending-mock-data` and `@/types/trending`
  </verify>
  <done>useInfiniteVideos hook created with category-aware pagination, loading guard, and category reset</done>
</task>

</tasks>

<verification>
- `pnpm tsc --noEmit` passes
- next.config.ts contains both picsum.photos and fastly.picsum.photos remotePatterns
- react-intersection-observer is in package.json dependencies
- useInfiniteVideos hook compiles and has correct imports
</verification>

<success_criteria>
Next.js can serve external picsum.photos images. useInfiniteVideos hook provides paginated, category-aware video data ready for the VideoGrid component.
</success_criteria>

<output>
After completion, create `.planning/phases/51-video-feed-cards/51-01-SUMMARY.md`
</output>
