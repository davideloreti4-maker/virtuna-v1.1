---
phase: 05-referral
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/app/(app)/referrals/page.tsx
  - src/components/referral/ReferralLinkCard.tsx
  - src/components/referral/ReferralStatsCard.tsx
  - src/components/referral/CopyButton.tsx
  - src/components/sidebar/sidebar.tsx
autonomous: false

must_haves:
  truths:
    - "User can access /referrals page and see their unique referral link"
    - "User can copy referral link with one click (visual feedback on copy)"
    - "User sees click count, conversion count, and total earnings"
    - "Referrals page is accessible from sidebar navigation"
    - "UI follows Raycast design language (12px cards, 6% borders, coral accents)"
  artifacts:
    - path: "src/app/(app)/referrals/page.tsx"
      provides: "Referral dashboard page"
      contains: "ReferralLinkCard"
      min_lines: 60
    - path: "src/components/referral/ReferralLinkCard.tsx"
      provides: "Referral link display with copy button"
      contains: "CopyButton"
      min_lines: 40
    - path: "src/components/referral/ReferralStatsCard.tsx"
      provides: "Stats display (clicks, conversions, earnings)"
      contains: "clicks"
      min_lines: 50
    - path: "src/components/referral/CopyButton.tsx"
      provides: "Copy-to-clipboard button"
      contains: "navigator.clipboard"
      min_lines: 40
  key_links:
    - from: "src/app/(app)/referrals/page.tsx"
      to: "/api/referral/generate"
      via: "fetch POST"
      pattern: "fetch.*api/referral/generate"
    - from: "src/app/(app)/referrals/page.tsx"
      to: "/api/referral/stats"
      via: "fetch GET"
      pattern: "fetch.*api/referral/stats"
    - from: "src/components/referral/ReferralLinkCard.tsx"
      to: "CopyButton component"
      via: "import and render"
      pattern: "import.*CopyButton"
    - from: "src/components/sidebar/sidebar.tsx"
      to: "/referrals route"
      via: "navItems array"
      pattern: 'href.*"/referrals"'
---

<objective>
Build the user-facing referral dashboard with link sharing, copy button, and stats display.

Purpose: Enable users to generate and share their referral link, then monitor performance (clicks, conversions, earnings). This completes the referral MVP by connecting the tracking backend (Plans 05-01, 05-02) to a functional UI.

Output: /referrals page with two cards (link + stats), copy-to-clipboard interaction, sidebar integration, and Raycast design language.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-referral/05-RESEARCH.md
@.planning/phases/05-referral/05-01-SUMMARY.md
@.planning/phases/05-referral/05-02-SUMMARY.md

# Existing Code
@src/components/sidebar/sidebar.tsx
@src/components/app/app-shell.tsx
@BRAND-BIBLE.md

# Design Language (from BRAND-BIBLE.md and CLAUDE.md)
- Cards: `rounded-[12px]`, `border border-white/[0.06]`, `inset shadow-[inset_0_1px_0_0_rgba(255,255,255,0.05)]`
- Card hover: `hover:bg-white/[0.02]` only (NO translate-y, NO border change)
- Buttons: Primary = `shadow-button` (coral bg), Secondary = `bg-transparent border-white/[0.06]` hover `bg-white/[0.1]`
- Body bg: `#07080a`, surface: `#18191a`, muted: `#848586`, coral: `#FF7F50`
- Font: Inter (single font, all weights), `letter-spacing: 0.2px`, antialiased
- Radius scale: 8px (buttons/inputs), 12px (cards)

# Component Patterns
Server components by default, client components ("use client") only for interactivity (clicks, state).
Server component fetches data via Supabase, passes to client components as props.

# Existing Sidebar Structure
sidebar.tsx has navItems array with:
- Dashboard, Brand Deals, Pricing (existing)
- Need to add Referrals item (icon: Share2 from lucide-react, id: "referrals", href: "/referrals")

# API Responses
- /api/referral/generate: `{ code: string }`
- /api/referral/stats: `{ clicks: number, conversions: number, earningsCents: number }`
</context>

<tasks>

<task type="auto">
  <name>Create copy-to-clipboard button component</name>
  <files>
src/components/referral/CopyButton.tsx
  </files>
  <action>
Create client component with native Clipboard API, visual feedback, and fallback.

Implementation:
```typescript
"use client";

import { useState } from "react";
import { CheckIcon, ClipboardIcon } from "lucide-react";

interface CopyButtonProps {
  text: string;
  label?: string;
}

export function CopyButton({ text, label = "Copy Link" }: CopyButtonProps) {
  const [copied, setCopied] = useState(false);

  const handleCopy = async () => {
    try {
      await navigator.clipboard.writeText(text);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (err) {
      console.error("Failed to copy:", err);
      // Fallback for browsers without clipboard API
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed";
      textArea.style.opacity = "0";
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand("copy");
      document.body.removeChild(textArea);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    }
  };

  return (
    <button
      onClick={handleCopy}
      className="inline-flex items-center gap-2 px-4 py-2 bg-coral text-accent-foreground rounded-lg hover:bg-coral/90 transition-colors shadow-button"
      aria-label={label}
    >
      {copied ? (
        <>
          <CheckIcon className="w-4 h-4" />
          Copied!
        </>
      ) : (
        <>
          <ClipboardIcon className="w-4 h-4" />
          {label}
        </>
      )}
    </button>
  );
}
```

Per research (RESEARCH.md lines 369-423): Native Clipboard API with fallback, 2-second feedback duration, coral primary button styling.

IMPORTANT: Use shadow-button for primary button (coral), position:fixed + opacity:0 for textarea fallback (avoids layout shift).
  </action>
  <verify>
1. `cat src/components/referral/CopyButton.tsx` shows "use client" directive
2. Component imports CheckIcon and ClipboardIcon from lucide-react
3. Component uses navigator.clipboard.writeText with try-catch
4. Fallback creates invisible textarea and uses document.execCommand("copy")
5. Button has shadow-button class (primary coral styling)
6. Copied state shows CheckIcon for 2 seconds then reverts
7. `npx tsc --noEmit` passes
  </verify>
  <done>
CopyButton client component created with Clipboard API, fallback for older browsers, 2s visual feedback, coral primary button styling.
  </done>
</task>

<task type="auto">
  <name>Create referral link card component</name>
  <files>
src/components/referral/ReferralLinkCard.tsx
  </files>
  <action>
Create client component displaying referral link with copy button and share instructions.

Implementation:
```typescript
"use client";

import { CopyButton } from "./CopyButton";

interface ReferralLinkCardProps {
  referralLink: string;
}

export function ReferralLinkCard({ referralLink }: ReferralLinkCardProps) {
  return (
    <div className="rounded-[12px] border border-white/[0.06] p-6 space-y-4 shadow-[inset_0_1px_0_0_rgba(255,255,255,0.05)]">
      <div>
        <h2 className="text-xl font-semibold text-foreground mb-2">
          Your Referral Link
        </h2>
        <p className="text-sm text-muted">
          Share this link with friends. When they sign up and purchase a subscription, you'll earn $10.
        </p>
      </div>

      <div className="flex items-center gap-3 p-3 rounded-lg bg-white/[0.03] border border-white/[0.05]">
        <code className="flex-1 text-sm text-foreground font-mono truncate">
          {referralLink}
        </code>
        <CopyButton text={referralLink} label="Copy" />
      </div>

      <div className="text-xs text-muted">
        <p>ðŸ’¡ Tip: Share on social media, in your TikTok bio, or with creator friends.</p>
      </div>
    </div>
  );
}
```

Design notes:
- Card: 12px radius, 6% border, inset shadow
- Inner container: 3% bg, 5% border (subtle depth)
- Code display: mono font, truncate long URLs, flex-1 to fill space
- CopyButton: positioned right, compact label ("Copy" not "Copy Link")

Per Raycast language: Clean, dark, minimal. No glow effects, color only for accents.
  </action>
  <verify>
1. `cat src/components/referral/ReferralLinkCard.tsx` shows "use client" directive
2. Component imports CopyButton from "./CopyButton"
3. Card has rounded-[12px], border-white/[0.06], inset shadow
4. Inner container has bg-white/[0.03], border-white/[0.05]
5. Code element uses font-mono and truncate classes
6. CopyButton receives referralLink as text prop
7. `npx tsc --noEmit` passes
  </verify>
  <done>
ReferralLinkCard component created with Raycast styling, code display + copy button, and share instructions.
  </done>
</task>

<task type="auto">
  <name>Create referral stats card component</name>
  <files>
src/components/referral/ReferralStatsCard.tsx
  </files>
  <action>
Create client component displaying aggregated stats (clicks, conversions, earnings) in a grid layout.

Implementation:
```typescript
"use client";

interface ReferralStatsCardProps {
  clicks: number;
  conversions: number;
  earningsCents: number;
}

export function ReferralStatsCard({
  clicks,
  conversions,
  earningsCents,
}: ReferralStatsCardProps) {
  const earningsDollars = (earningsCents / 100).toFixed(2);
  const conversionRate = clicks > 0 ? ((conversions / clicks) * 100).toFixed(1) : "0.0";

  return (
    <div className="rounded-[12px] border border-white/[0.06] p-6 space-y-4 shadow-[inset_0_1px_0_0_rgba(255,255,255,0.05)]">
      <div>
        <h2 className="text-xl font-semibold text-foreground mb-2">
          Performance
        </h2>
        <p className="text-sm text-muted">
          Track your referral clicks, conversions, and earnings.
        </p>
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div className="rounded-lg bg-white/[0.02] border border-white/[0.05] p-4">
          <div className="text-2xl font-bold text-foreground">{clicks}</div>
          <div className="text-xs text-muted mt-1">Total Clicks</div>
        </div>

        <div className="rounded-lg bg-white/[0.02] border border-white/[0.05] p-4">
          <div className="text-2xl font-bold text-foreground">{conversions}</div>
          <div className="text-xs text-muted mt-1">Conversions</div>
        </div>

        <div className="rounded-lg bg-white/[0.02] border border-white/[0.05] p-4">
          <div className="text-2xl font-bold text-coral">${earningsDollars}</div>
          <div className="text-xs text-muted mt-1">Total Earnings</div>
        </div>

        <div className="rounded-lg bg-white/[0.02] border border-white/[0.05] p-4">
          <div className="text-2xl font-bold text-foreground">{conversionRate}%</div>
          <div className="text-xs text-muted mt-1">Conversion Rate</div>
        </div>
      </div>
    </div>
  );
}
```

Design notes:
- Stats grid: 2 columns, 4 metrics
- Each stat box: subtle 2% bg, 5% border, 8px radius (inner cards)
- Earnings highlighted in coral (accent color)
- Conversion rate calculated client-side (clicks > 0 check to avoid division by zero)

Per Raycast language: Clean hierarchy, coral accent for key metric (earnings), consistent spacing.
  </action>
  <verify>
1. `cat src/components/referral/ReferralStatsCard.tsx` shows "use client" directive
2. Component displays 4 metrics: clicks, conversions, earnings, conversion rate
3. Grid uses grid-cols-2 layout
4. Each stat box has rounded-lg, bg-white/[0.02], border-white/[0.05]
5. Earnings value uses text-coral class (accent color)
6. Conversion rate calculated with division-by-zero check
7. `npx tsc --noEmit` passes
  </verify>
  <done>
ReferralStatsCard component created with 2x2 grid, 4 metrics, coral accent on earnings, and calculated conversion rate.
  </done>
</task>

<task type="auto">
  <name>Create referrals dashboard page</name>
  <files>
src/app/(app)/referrals/page.tsx
  </files>
  <action>
Create server component that fetches referral code + stats, then renders cards.

Implementation:
```typescript
import { createClient } from "@/lib/supabase/server";
import { ReferralLinkCard } from "@/components/referral/ReferralLinkCard";
import { ReferralStatsCard } from "@/components/referral/ReferralStatsCard";
import { redirect } from "next/navigation";

export const metadata = {
  title: "Referrals | Virtuna",
  description: "Share Virtuna and earn rewards",
};

export default async function ReferralsPage() {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect("/");
  }

  // Fetch or generate referral code
  let { data: codeData } = await supabase
    .from("referral_codes")
    .select("code")
    .eq("user_id", user.id)
    .maybeSingle();

  let referralCode = codeData?.code;

  // If no code exists, generate one
  if (!referralCode) {
    const response = await fetch(
      `${process.env.NEXT_PUBLIC_APP_URL || "http://localhost:3000"}/api/referral/generate`,
      {
        method: "POST",
        headers: {
          cookie: `sb-${process.env.NEXT_PUBLIC_SUPABASE_URL?.split("//")[1]?.split(".")[0]}-auth-token=${user.id}`,
        },
      }
    );
    const data = await response.json();
    referralCode = data.code;
  }

  // Fetch stats
  const { data: clicks } = await supabase
    .from("referral_clicks")
    .select("id", { count: "exact", head: true })
    .eq("referrer_user_id", user.id);

  const { data: conversions } = await supabase
    .from("referral_conversions")
    .select("bonus_cents")
    .eq("referrer_user_id", user.id);

  const totalClicks = clicks?.length || 0;
  const totalConversions = conversions?.length || 0;
  const totalEarningsCents = conversions?.reduce((sum, c) => sum + c.bonus_cents, 0) || 0;

  const referralLink = `${process.env.NEXT_PUBLIC_APP_URL || "http://localhost:3000"}/?ref=${referralCode}`;

  return (
    <div className="max-w-4xl mx-auto p-6 space-y-6">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-foreground mb-2">Referral Program</h1>
        <p className="text-muted">
          Invite friends to Virtuna and earn $10 for every successful conversion.
        </p>
      </div>

      <ReferralLinkCard referralLink={referralLink} />
      <ReferralStatsCard
        clicks={totalClicks}
        conversions={totalConversions}
        earningsCents={totalEarningsCents}
      />
    </div>
  );
}
```

Notes:
- Server component (no "use client") â€” fetches data at request time
- Auth check: redirect to landing if not authenticated
- Code generation: check DB first, call API if missing (lazy generation)
- Stats fetched directly from DB (not via /api/referral/stats for server efficiency)
- NEXT_PUBLIC_APP_URL used for link construction (falls back to localhost:3000 in dev)

IMPORTANT: Server component can't call /api routes with session cookies directly â€” use Supabase client to query DB instead of fetch /api/referral/stats.
  </action>
  <verify>
1. `cat src/app/(app)/referrals/page.tsx` shows default export (server component, no "use client")
2. Page imports createClient from @/lib/supabase/server
3. Page imports ReferralLinkCard and ReferralStatsCard
4. Page checks auth with supabase.auth.getUser() and redirects if not authenticated
5. Page queries referral_codes for existing code
6. Page queries referral_clicks and referral_conversions for stats
7. Page constructs referralLink with NEXT_PUBLIC_APP_URL and ?ref= param
8. Page passes data as props to client components
9. `npx tsc --noEmit` passes
  </verify>
  <done>
/referrals page created as server component, fetches code + stats from DB, renders ReferralLinkCard and ReferralStatsCard with proper Raycast layout.
  </done>
</task>

<task type="auto">
  <name>Add Referrals link to sidebar navigation</name>
  <files>
src/components/sidebar/sidebar.tsx
  </files>
  <action>
Add "Referrals" item to navItems array in sidebar.tsx.

Locate the navItems array (likely around line 20-40) and add new item AFTER "Brand Deals" entry:

```typescript
{
  label: "Referrals",
  icon: Share2,
  id: "referrals",
  href: "/referrals",
},
```

Also add Share2 import at top of file:
```typescript
import { Share2 } from "lucide-react";
```

Note: sidebar.tsx should already have imports like Lightbulb, Briefcase, CurrencyDollar â€” follow same pattern.

Per requirements: REF-05 requires dashboard shows referral stats, which implies navigation access.
  </action>
  <verify>
1. `grep "Share2" src/components/sidebar/sidebar.tsx` shows import from lucide-react
2. navItems array includes entry with label: "Referrals", icon: Share2, href: "/referrals"
3. Referrals item positioned after Brand Deals (logical placement: earnings-related features together)
4. `npx tsc --noEmit` passes
5. Visual check: Start dev server, open sidebar, verify Referrals link appears with Share2 icon
  </verify>
  <done>
Sidebar navigation includes Referrals link with Share2 icon, positioned after Brand Deals, routes to /referrals.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete referral dashboard UI with link sharing, copy button, and stats display
  </what-built>
  <how-to-verify>
1. Start dev server: `pnpm dev`
2. Open browser: `http://localhost:3000`
3. Sign in as authenticated user
4. Click "Referrals" in sidebar (Share2 icon)
5. Verify page renders with:
   - Page title: "Referral Program"
   - ReferralLinkCard with your unique link (e.g., `http://localhost:3000/?ref=A2B3C4D5`)
   - CopyButton (clipboard icon + "Copy")
   - ReferralStatsCard with 4 metrics (clicks, conversions, earnings, conversion rate)
6. Click "Copy" button:
   - Button should show checkmark + "Copied!" for 2 seconds
   - Paste (Cmd+V) in another app â€” should paste full referral link
7. Visual checks:
   - Cards use 12px radius, 6% white borders
   - No harsh glow effects, clean dark design
   - Earnings value in coral color (#FF7F50)
   - Responsive layout (test at mobile width ~375px)
8. Test with stats:
   - Manually insert test data in DB or trigger conversion via Plan 05-02 flow
   - Refresh page, verify stats update correctly
   - Conversion rate calculated: (conversions / clicks) * 100

Expected behavior:
- UI matches Raycast design language (dark, minimal, coral accents)
- Copy button works reliably (both Clipboard API and fallback)
- Stats display real data from database
- Page accessible only when authenticated
  </how-to-verify>
  <resume-signal>
Type "approved" to continue, or describe any visual/functional issues found
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks complete and checkpoint approved:

1. **Page accessibility**: Visit /referrals while unauthenticated, verify redirect to /
2. **Code generation**: Visit /referrals first time, verify code generated and stored in DB
3. **Link format**: Verify referralLink is `${APP_URL}/?ref=${CODE}` (8-char uppercase code)
4. **Copy functionality**: Click copy button multiple times, verify reliable clipboard write
5. **Stats accuracy**: Cross-check displayed stats with database queries (clicks, conversions, earnings)
6. **Responsive design**: Test at mobile width (375px), tablet (768px), desktop (1280px)
7. **Sidebar integration**: Verify Referrals appears in sidebar with correct icon and routing
8. **Design language**: Visual audit â€” 12px card radius, 6% borders, coral on earnings, Inter font
</verification>

<success_criteria>
- [x] CopyButton component with Clipboard API + fallback, 2s feedback, coral primary styling
- [x] ReferralLinkCard displays link in code font with copy button and instructions
- [x] ReferralStatsCard shows 4 metrics in 2x2 grid with coral accent on earnings
- [x] /referrals page fetches code + stats from DB, renders cards, auth-gated
- [x] Sidebar includes Referrals link with Share2 icon
- [x] UI follows Raycast design language (verified in checkpoint)
- [x] Copy button works reliably (verified in checkpoint)
- [x] Stats display real data (verified in checkpoint)
- [x] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-referral/05-03-SUMMARY.md` following the template.

Include:
- Screenshot or description of UI (cards, stats grid, copy button)
- Example referral link generated
- Checkpoint approval confirmation
- Design language adherence notes (Raycast pattern compliance)
</output>
