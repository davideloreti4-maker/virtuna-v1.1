---
phase: 07-simulation-results
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/app/simulation/loading-phases.tsx
  - src/components/app/index.ts
  - src/stores/test-store.ts
autonomous: true

must_haves:
  truths:
    - "User sees 4 distinct loading phases during simulation"
    - "Each phase shows checkmark when complete"
    - "Current phase has green indicator"
    - "Progress bar shows overall progress"
    - "Cancel button available to abort"
  artifacts:
    - path: "src/components/app/simulation/loading-phases.tsx"
      provides: "4-phase loading display"
      min_lines: 80
    - path: "src/stores/test-store.ts"
      provides: "Simulation phase state"
      contains: "simulationPhase"
  key_links:
    - from: "loading-phases.tsx"
      to: "test-store"
      via: "useTestStore hook"
      pattern: "useTestStore"
---

<objective>
Build 4-phase loading states with progress indicators

Purpose: Match societies.io loading sequence that shows simulation progress
Output: LoadingPhases component and updated test store with phase tracking
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-simulation-results/07-RESEARCH.md
@.planning/phases/07-simulation-results/07-CONTEXT.md
@src/stores/test-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Query v0 MCP for LoadingPhases component</name>
  <files>n/a (research task)</files>
  <action>
    1. Use ToolSearch to find "v0" MCP tool
    2. Query v0 MCP with the following context:
       - "Dark themed loading progress component for AI simulation"
       - "4 phases shown vertically: 'Analyzing content...', 'Matching profiles...', 'Running simulation...', 'Generating insights...'"
       - "Each phase has: text label, checkmark icon when complete"
       - "Current phase has green dot/pulse indicator next to it"
       - "Thin horizontal progress bar below the steps"
       - "Cancel button at bottom"
       - "Use Tailwind CSS, zinc-900/950 dark theme, emerald for success/active"
       - "Phosphor or Lucide icons for checkmarks"
    3. Save v0 output for adaptation in Task 2
  </action>
  <verify>v0 MCP returns loading phases component code</verify>
  <done>Have reference code for LoadingPhases component</done>
</task>

<task type="auto">
  <name>Task 2: Add simulation phase state to test-store</name>
  <files>src/stores/test-store.ts</files>
  <action>
    Extend test-store.ts:

    1. Add SimulationPhase type:
    ```typescript
    type SimulationPhase =
      | 'analyzing'    // Phase 1: Analyzing content
      | 'matching'     // Phase 2: Matching profiles
      | 'simulating'   // Phase 3: Running simulation
      | 'generating';  // Phase 4: Generating insights
    ```

    2. Add to TestState interface:
    ```typescript
    simulationPhase: SimulationPhase | null;
    phaseProgress: number; // 0-100 for overall progress
    ```

    3. Add action:
    ```typescript
    cancelSimulation: () => void;
    ```

    4. Update submitTest to progress through phases:
    ```typescript
    submitTest: async (content, societyId) => {
      // ... existing validation

      set({ currentStatus: 'simulating', simulationPhase: 'analyzing', phaseProgress: 0 });

      // Phase 1: Analyzing (0-25%)
      await new Promise(r => setTimeout(r, 1000));
      if (get().currentStatus !== 'simulating') return; // cancelled

      set({ simulationPhase: 'matching', phaseProgress: 25 });

      // Phase 2: Matching (25-50%)
      await new Promise(r => setTimeout(r, 1000));
      if (get().currentStatus !== 'simulating') return;

      set({ simulationPhase: 'simulating', phaseProgress: 50 });

      // Phase 3: Simulating (50-75%)
      await new Promise(r => setTimeout(r, 1000));
      if (get().currentStatus !== 'simulating') return;

      set({ simulationPhase: 'generating', phaseProgress: 75 });

      // Phase 4: Generating (75-100%)
      await new Promise(r => setTimeout(r, 1000));
      if (get().currentStatus !== 'simulating') return;

      set({ phaseProgress: 100 });

      // Generate result (existing code)
      // ...
    };
    ```

    5. Add cancelSimulation:
    ```typescript
    cancelSimulation: () => {
      set({
        currentStatus: 'filling-form',  // Return to form
        simulationPhase: null,
        phaseProgress: 0,
      });
    };
    ```

    6. Update reset to clear phase state:
    ```typescript
    reset: () => {
      set({
        currentTestType: null,
        currentStatus: 'idle',
        currentResult: null,
        simulationPhase: null,
        phaseProgress: 0,
      });
    };
    ```

    Export SimulationPhase type.
  </action>
  <verify>npm run build succeeds, TypeScript types correct</verify>
  <done>Test store has simulationPhase state and phase progression logic</done>
</task>

<task type="auto">
  <name>Task 3: Build LoadingPhases component</name>
  <files>src/components/app/simulation/loading-phases.tsx, src/components/app/index.ts</files>
  <action>
    Create src/components/app/simulation/loading-phases.tsx:

    1. Adapt v0 output to project structure:
       - Import cn from @/lib/utils
       - Import useTestStore from @/stores/test-store
       - Import Check, Loader2 from lucide-react

    2. Component structure:
    ```typescript
    'use client';

    import { cn } from '@/lib/utils';
    import { useTestStore } from '@/stores/test-store';
    import { Check, Loader2 } from 'lucide-react';

    const PHASES = [
      { id: 'analyzing', label: 'Analyzing content...' },
      { id: 'matching', label: 'Matching profiles...' },
      { id: 'simulating', label: 'Running simulation...' },
      { id: 'generating', label: 'Generating insights...' },
    ] as const;

    export function LoadingPhases() {
      const { simulationPhase, phaseProgress, cancelSimulation } = useTestStore();

      const currentPhaseIndex = PHASES.findIndex(p => p.id === simulationPhase);

      return (
        <div className="rounded-2xl border border-zinc-800 bg-zinc-900 p-6">
          {/* Phase list */}
          <div className="space-y-3">
            {PHASES.map((phase, index) => {
              const isComplete = index < currentPhaseIndex;
              const isCurrent = index === currentPhaseIndex;

              return (
                <div key={phase.id} className="flex items-center gap-3">
                  {/* Status indicator */}
                  <div className={cn(
                    "flex h-5 w-5 items-center justify-center rounded-full",
                    isComplete && "bg-emerald-500",
                    isCurrent && "bg-emerald-500/20",
                    !isComplete && !isCurrent && "bg-zinc-800"
                  )}>
                    {isComplete ? (
                      <Check className="h-3 w-3 text-white" />
                    ) : isCurrent ? (
                      <div className="h-2 w-2 animate-pulse rounded-full bg-emerald-500" />
                    ) : null}
                  </div>

                  {/* Label */}
                  <span className={cn(
                    "text-sm",
                    isCurrent && "text-white font-medium",
                    isComplete && "text-zinc-400",
                    !isComplete && !isCurrent && "text-zinc-600"
                  )}>
                    {phase.label}
                  </span>
                </div>
              );
            })}
          </div>

          {/* Progress bar */}
          <div className="mt-6">
            <div className="h-1 w-full overflow-hidden rounded-full bg-zinc-800">
              <div
                className="h-full bg-emerald-500 transition-all duration-500"
                style={{ width: `${phaseProgress}%` }}
              />
            </div>
          </div>

          {/* Cancel button */}
          <button
            type="button"
            onClick={cancelSimulation}
            className={cn(
              "mt-6 w-full rounded-xl px-4 py-2",
              "border border-zinc-700 bg-transparent text-zinc-400",
              "text-sm font-medium",
              "transition-colors hover:bg-zinc-800 hover:text-white"
            )}
          >
            Cancel
          </button>
        </div>
      );
    }
    ```

    3. Export from src/components/app/index.ts:
    ```typescript
    export { LoadingPhases } from './simulation/loading-phases';
    ```

    Ensure the directory src/components/app/simulation/ is created.
  </action>
  <verify>
    npm run build succeeds
    Component renders without errors (will be integrated in 07-05)
  </verify>
  <done>LoadingPhases component exists with 4-phase display and cancel button</done>
</task>

</tasks>

<verification>
- Build succeeds: `npm run build`
- LoadingPhases component exports from @/components/app
- Test store has simulationPhase and phaseProgress state
- cancelSimulation action resets to filling-form status
</verification>

<success_criteria>
- 4 phases displayed with proper status indicators
- Progress bar shows overall simulation progress
- Cancel button available and functional in store
- Test store phases progress through 4 stages with ~1s each
</success_criteria>

<output>
After completion, create `.planning/phases/07-simulation-results/07-02-SUMMARY.md`
</output>
