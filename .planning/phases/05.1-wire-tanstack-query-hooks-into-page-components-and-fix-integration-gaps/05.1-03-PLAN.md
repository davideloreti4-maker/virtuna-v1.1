---
phase: 05.1-wire-tanstack-query-hooks-into-page-components-and-fix-integration-gaps
plan: 03
type: execute
wave: 2
depends_on: ["05.1-01"]
files_modified:
  - src/components/app/brand-deals/deals-tab.tsx
  - src/components/app/brand-deals/deal-apply-modal.tsx
  - src/components/app/brand-deals/brand-deals-page.tsx
autonomous: true

must_haves:
  truths:
    - "Deals tab loads deals from /api/deals via useDeals() hook, not from MOCK_DEALS import"
    - "Deal apply modal submits via useApplyToDeal() mutation, not setTimeout simulation"
    - "Applied deals state comes from useDealEnrollments() query, not local useState"
    - "Fake setTimeout loading in deals-tab.tsx is replaced with real isLoading from useDeals()"
  artifacts:
    - path: "src/components/app/brand-deals/deals-tab.tsx"
      provides: "Deals tab wired to useDeals query hook"
      contains: "useDeals"
    - path: "src/components/app/brand-deals/deal-apply-modal.tsx"
      provides: "Apply modal wired to useApplyToDeal mutation"
      contains: "useApplyToDeal"
    - path: "src/components/app/brand-deals/brand-deals-page.tsx"
      provides: "Parent page using useDealEnrollments for applied state"
      contains: "useDealEnrollments"
  key_links:
    - from: "src/components/app/brand-deals/deals-tab.tsx"
      to: "src/hooks/queries/use-deals.ts"
      via: "useDeals hook import"
      pattern: "import.*useDeals.*from.*hooks/queries"
    - from: "src/components/app/brand-deals/deals-tab.tsx"
      to: "src/lib/mappers/deals.ts"
      via: "mapDealRowToUI mapper"
      pattern: "mapDealRowToUI"
    - from: "src/components/app/brand-deals/deal-apply-modal.tsx"
      to: "src/hooks/queries/use-deals.ts"
      via: "useApplyToDeal mutation hook"
      pattern: "import.*useApplyToDeal.*from.*hooks/queries"
---

<objective>
Wire the brand deals page components to TanStack Query hooks, replacing mock data imports and fake API simulations with real API calls.

Purpose: The deals tab imports `MOCK_DEALS` from mock data, the apply modal uses `setTimeout` to simulate an API call, and applied-deal tracking uses local `useState`. This plan replaces all three with `useDeals()`, `useApplyToDeal()`, and `useDealEnrollments()` from TanStack Query hooks. Earnings and affiliates tabs stay on mock data (no API routes exist for them).

Output: Deals tab and apply flow backed by real API data from Supabase.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/hooks/queries/use-deals.ts
@src/lib/mappers/deals.ts
@src/types/brand-deals.ts
@src/components/app/brand-deals/deals-tab.tsx
@src/components/app/brand-deals/deal-apply-modal.tsx
@src/components/app/brand-deals/brand-deals-page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire DealsTab to useDeals hook with mapper and remove mock data</name>
  <files>
    src/components/app/brand-deals/deals-tab.tsx
    src/components/app/brand-deals/brand-deals-page.tsx
  </files>
  <action>
**DealsTab changes (`deals-tab.tsx`):**

Imports to change:
- Remove: `import { MOCK_DEALS } from "@/lib/mock-brand-deals"`
- Add: `import { useDeals } from "@/hooks/queries"`
- Add: `import { mapDealRowToUI } from "@/lib/mappers"`

Replace mock data with useDeals query:
```typescript
const { data, isLoading, fetchNextPage, hasNextPage, isFetchingNextPage } = useDeals({
  status: "active",
});
```

Flatten pages and map to UI types:
```typescript
const allDeals = useMemo(() =>
  data?.pages.flatMap(page => page.data.map(mapDealRowToUI)) ?? [],
  [data]
);
```

Update filtered deals to use `allDeals` instead of `MOCK_DEALS`:
```typescript
const filteredDeals = useMemo(() => {
  return allDeals.filter((deal) => {
    const matchesCategory = activeCategory === "all" || deal.category === activeCategory;
    const matchesSearch = deal.brandName.toLowerCase().includes(debouncedSearch.toLowerCase());
    return matchesCategory && matchesSearch;
  });
}, [allDeals, activeCategory, debouncedSearch]);
```

Update new deals row:
```typescript
const newDeals = useMemo(() => allDeals.filter((d) => d.isNew), [allDeals]);
```

Remove fake loading state:
- Remove `const [isLoading, setIsLoading] = useState(true);`
- Remove the `useEffect` with `setTimeout(() => setIsLoading(false), 800)`
- Use `isLoading` directly from the `useDeals()` hook (already destructured above)
- The existing `if (isLoading) return <DealsTabSkeleton />;` works as-is since the variable name matches

Update the `appliedDeals` prop usage:
- The prop `appliedDeals: Set<string>` currently comes from parent local state. After wiring `useDealEnrollments()` in the parent (BrandDealsPage), this Set will be derived from real enrollment data. Keep the prop interface unchanged for now -- the parent will provide it.

**BrandDealsPage changes (`brand-deals-page.tsx`):**

Replace local `appliedDeals` state with `useDealEnrollments()`:
- Add: `import { useDealEnrollments } from "@/hooks/queries"`
- Replace `const [appliedDeals, setAppliedDeals] = useState<Set<string>>(new Set());` with:
```typescript
const { data: enrollmentsData } = useDealEnrollments();
const appliedDeals = useMemo(() => {
  if (!enrollmentsData?.data) return new Set<string>();
  return new Set(enrollmentsData.data.map(e => e.deal_id));
}, [enrollmentsData]);
```

Remove `handleApplyDeal` function (no longer needed -- cache invalidation in useApplyToDeal handles it automatically).

Update DealsTab usage:
- Remove `onApplyDeal` prop if the DealsTab no longer needs it. BUT: the DealsTab currently uses `onApplyDeal(dealId)` in `handleApplied` to update parent state. Since parent now derives from query, the apply modal's mutation will invalidate the enrollments cache automatically. The DealsTab still needs `onApplyDeal` as a no-op or remove it. Simplest: remove the `onApplyDeal` prop from DealsTab interface entirely. The apply modal will handle mutation + cache invalidation. The parent automatically re-renders because useDealEnrollments() cache gets invalidated.

Update DealsTab props interface:
- Remove `onApplyDeal` prop
- Keep `appliedDeals` prop (now derived from query in parent)
- In `handleApplied`, just close the modal (remove `onApplyDeal(dealId)` call)
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `grep -r "MOCK_DEALS" src/components/app/brand-deals/deals-tab.tsx` returns nothing
3. `grep -r "useDeals" src/components/app/brand-deals/deals-tab.tsx` returns a match
4. `grep -r "useDealEnrollments" src/components/app/brand-deals/brand-deals-page.tsx` returns a match
5. `grep -r "setTimeout" src/components/app/brand-deals/deals-tab.tsx` returns nothing
  </verify>
  <done>
DealsTab loads deals from the API via useDeals(), maps DB rows to BrandDeal UI type, and the fake 800ms loading is replaced with real isLoading. BrandDealsPage derives applied deal state from useDealEnrollments() query.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire DealApplyModal to useApplyToDeal mutation</name>
  <files>
    src/components/app/brand-deals/deal-apply-modal.tsx
  </files>
  <action>
Replace the `setTimeout` fake API call with the `useApplyToDeal()` mutation hook.

**Imports to add:**
- `import { useApplyToDeal } from "@/hooks/queries"`

**Inside the component:**
Add the mutation hook:
```typescript
const applyMutation = useApplyToDeal();
```

**Replace `handleSubmit`:**
The current handler does:
1. `setIsSubmitting(true)`
2. `await new Promise(r => setTimeout(r, 800))` (fake delay)
3. `setIsSubmitting(false)` + `setSubmitted(true)`
4. Auto-close after 1500ms

Replace with real mutation:
```typescript
async function handleSubmit(e: React.FormEvent): Promise<void> {
  e.preventDefault();
  if (!deal) return;

  const dealId = deal.id;

  applyMutation.mutate(
    {
      dealId,
      applicationNote: pitch,
    },
    {
      onSuccess: () => {
        setSubmitted(true);
        // Auto-close after success animation
        setTimeout(() => {
          resetForm();
          setSubmitted(false);
          onOpenChange(false);
        }, 1500);
      },
      onError: (error) => {
        // TODO: Show error toast via sonner
        console.error("Failed to apply:", error.message);
      },
    }
  );
}
```

**Replace `isSubmitting` state:**
- Remove `const [isSubmitting, setIsSubmitting] = useState(false);`
- Use `applyMutation.isPending` instead
- In the submit button: `loading={applyMutation.isPending}`

**Remove the `onApplied` prop usage:**
- The `onApplied` callback was used to tell the parent about the successful application. Since `useApplyToDeal()` automatically invalidates the `deals.enrollments` cache on success, the parent's `useDealEnrollments()` re-fetches automatically. Remove the `onApplied(dealId)` call from the success handler.
- Update the props interface: remove `onApplied` prop OR keep it and call it for backward compatibility. Check if DealsTab still passes `onApplied`. Since Task 1 removes it, remove here too.

**Update props interface:**
```typescript
interface DealApplyModalProps {
  deal: BrandDeal | null;
  open: boolean;
  onOpenChange: (open: boolean) => void;
  // onApplied removed -- mutation handles cache invalidation
}
```
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `grep -r "setTimeout.*800" src/components/app/brand-deals/deal-apply-modal.tsx` returns nothing (fake API delay removed)
3. `grep -r "useApplyToDeal" src/components/app/brand-deals/deal-apply-modal.tsx` returns a match
4. `grep -r "applyMutation.isPending\|isPending" src/components/app/brand-deals/deal-apply-modal.tsx` returns a match
  </verify>
  <done>
DealApplyModal submits applications via useApplyToDeal() mutation, shows real loading/error states, and cache invalidation automatically updates the parent's applied deals set.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for all modified brand-deals files
2. No `MOCK_DEALS` imports remain in deals-tab.tsx
3. No `setTimeout` fake API calls remain in deal-apply-modal.tsx
4. `useDeals`, `useDealEnrollments`, and `useApplyToDeal` are all imported from `@/hooks/queries`
5. `mapDealRowToUI` is imported from `@/lib/mappers`
6. Earnings and affiliates tabs are unchanged (still mock data, expected)
</verification>

<success_criteria>
- Deals tab fetches real deals from /api/deals via TanStack Query
- Apply modal uses real mutation to POST /api/deals/:id/apply
- Applied deals state derived from useDealEnrollments() (not local state)
- All fake loading delays removed
- TypeScript compiles cleanly
- Earnings and affiliates tabs unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-wire-tanstack-query-hooks-into-page-components-and-fix-integration-gaps/05.1-03-SUMMARY.md`
</output>
