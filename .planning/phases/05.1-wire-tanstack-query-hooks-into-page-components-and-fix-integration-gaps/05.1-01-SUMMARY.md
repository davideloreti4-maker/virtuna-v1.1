---
phase: 05.1-wire-tanstack-query-hooks-into-page-components-and-fix-integration-gaps
plan: 01
subsystem: api
tags: [mappers, type-safety, tanstack-query, supabase, api-routes]

# Dependency graph
requires: []
provides:
  - "mapScrapedVideoToTrendingVideo mapper (scraped_videos -> TrendingVideo)"
  - "mapDealRowToUI mapper (deals -> BrandDeal)"
  - "GET /api/analysis/history endpoint"
  - "Fixed useAnalysisHistory hook (correct endpoint)"
affects:
  - "05.1-02 (trending page wiring uses trending mapper)"
  - "05.1-03 (deals page wiring uses deals mapper)"
  - "05.1-04 (dashboard wiring uses analysis history)"

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "DB-to-UI mapper pattern: typed functions in src/lib/mappers/ that convert snake_case DB rows to camelCase UI types with null fallbacks"
    - "Category validation pattern: validate DB string against const array of valid values, fallback to default"

key-files:
  created:
    - "src/lib/mappers/trending.ts"
    - "src/lib/mappers/deals.ts"
    - "src/lib/mappers/index.ts"
    - "src/app/api/analysis/history/route.ts"
  modified:
    - "src/hooks/queries/use-analyze.ts"

key-decisions:
  - "Placeholder thumbnails/avatars use picsum.photos seeded by platform_video_id/author for consistent output"
  - "Velocity field defaults to 1.0 with TODO for future derivation from historical data"
  - "Analysis history limited to 50 rows without cursor pagination (simple MVP approach)"

patterns-established:
  - "Mapper barrel export: all mappers re-exported from src/lib/mappers/index.ts"
  - "Cents-to-dollars conversion: compensation_fixed_cents / 100 in mapper layer"
  - "isNew derivation: 7-day window from created_at timestamp"

# Metrics
duration: 2min
completed: 2026-02-13
---

# Phase 5.1 Plan 01: Mappers & Analysis History Summary

**DB-to-UI type mappers for trending videos and deals, plus /api/analysis/history route and useAnalysisHistory endpoint bug fix (QUERY-06)**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-13T12:20:18Z
- **Completed:** 2026-02-13T12:22:12Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- Two fully-typed mapper functions converting Supabase DB rows to UI component types with null safety
- New authenticated GET /api/analysis/history route querying analysis_results table
- Fixed QUERY-06 bug: useAnalysisHistory() now calls /api/analysis/history instead of /api/outcomes

## Task Commits

Each task was committed atomically:

1. **Task 1: Create type mapper functions for trending videos and deals** - `dab0ac9` (feat)
2. **Task 2: Create /api/analysis/history route and fix useAnalysisHistory endpoint** - `39a67f4` (fix)

## Files Created/Modified
- `src/lib/mappers/trending.ts` - mapScrapedVideoToTrendingVideo: scraped_videos row to TrendingVideo with category validation, null fallbacks, placeholder URLs
- `src/lib/mappers/deals.ts` - mapDealRowToUI: deals row to BrandDeal with cents-to-dollars, payout range derivation, requirements string, isNew detection
- `src/lib/mappers/index.ts` - Barrel export for both mapper functions
- `src/app/api/analysis/history/route.ts` - Authenticated GET endpoint returning user's analysis_results (excludes soft-deleted, ordered by created_at DESC, limit 50)
- `src/hooks/queries/use-analyze.ts` - Changed fetch endpoint from /api/outcomes to /api/analysis/history

## Decisions Made
- Used picsum.photos seeded by platform_video_id/author for placeholder thumbnails and avatars (deterministic, no external dependency)
- Velocity defaults to 1.0 since no DB column exists yet (TODO comment for future derivation)
- Analysis history returns flat JSON array (not paginated) since MVP dashboard only needs recent 50 results
- Followed existing Supabase auth pattern: createClient() from @/lib/supabase/server with getUser() check

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Mapper functions ready for import by trending page wiring (05.1-02) and deals page wiring (05.1-03)
- Analysis history endpoint ready for dashboard wiring (05.1-04)
- All exports available via barrel file at src/lib/mappers/index.ts

## Self-Check: PASSED

- All 5 files verified present on disk
- Both task commits (dab0ac9, 39a67f4) verified in git log
- No TypeScript errors in new/modified files
- /api/outcomes removed from use-analyze.ts, /api/analysis/history confirmed

---
*Phase: 05.1-wire-tanstack-query-hooks-into-page-components-and-fix-integration-gaps*
*Completed: 2026-02-13*
