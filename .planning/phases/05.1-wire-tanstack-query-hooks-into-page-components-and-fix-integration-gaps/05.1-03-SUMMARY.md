---
phase: 05.1-wire-tanstack-query-hooks-into-page-components-and-fix-integration-gaps
plan: 03
subsystem: ui
tags: [tanstack-query, react, brand-deals, mutations, infinite-query, mappers]

# Dependency graph
requires:
  - phase: 05.1-01
    provides: "mapDealRowToUI mapper, useDeals/useDealEnrollments/useApplyToDeal hooks, query keys"
provides:
  - "Brand deals page wired to real API data via TanStack Query hooks"
  - "Deal application flow using real mutation (not setTimeout simulation)"
  - "Applied deals state derived from server (useDealEnrollments), not local useState"
affects: [05.1-04]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Infinite query pagination with page flattening and DB-to-UI mapping"
    - "Mutation with automatic cache invalidation replacing parent callback chain"
    - "Server-derived state (useDealEnrollments) replacing local useState"

key-files:
  created: []
  modified:
    - "src/components/app/brand-deals/deals-tab.tsx"
    - "src/components/app/brand-deals/deal-apply-modal.tsx"
    - "src/components/app/brand-deals/brand-deals-page.tsx"

key-decisions:
  - "Removed onApplyDeal/onApplied callback chain entirely -- mutation cache invalidation replaces it"
  - "Kept 1500ms success animation setTimeout (UX delay, not fake API)"

patterns-established:
  - "Mutation + cache invalidation pattern: child mutation invalidates parent query, no prop callbacks needed"

# Metrics
duration: 3min
completed: 2026-02-13
---

# Phase 5.1 Plan 03: Brand Deals Page Wiring Summary

**Deals tab and apply modal wired to TanStack Query hooks, replacing mock data imports and fake API simulations with useDeals(), useApplyToDeal(), and useDealEnrollments()**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-13T12:24:38Z
- **Completed:** 2026-02-13T12:28:05Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments
- DealsTab loads deals from /api/deals via useDeals() infinite query with mapDealRowToUI mapping
- DealApplyModal submits applications via useApplyToDeal() mutation with real loading/error states
- BrandDealsPage derives applied-deal state from useDealEnrollments() query (not local useState)
- All fake setTimeout loading delays removed from deals-tab.tsx
- onApplyDeal/onApplied callback chain eliminated -- mutation cache invalidation handles state propagation

## Task Commits

Each task was committed atomically:

1. **Task 1: Wire DealsTab to useDeals hook with mapper and remove mock data** - `18f3c2a` (feat)
2. **Task 2: Wire DealApplyModal to useApplyToDeal mutation** - `6e74eae` (feat)

## Files Created/Modified
- `src/components/app/brand-deals/deals-tab.tsx` - Replaced MOCK_DEALS with useDeals() hook, added mapDealRowToUI mapping, removed fake loading
- `src/components/app/brand-deals/deal-apply-modal.tsx` - Replaced setTimeout with useApplyToDeal() mutation, removed onApplied prop
- `src/components/app/brand-deals/brand-deals-page.tsx` - Replaced local appliedDeals useState with useDealEnrollments() query

## Decisions Made
- Removed the entire onApplyDeal/onApplied callback chain rather than keeping it as a no-op. The useApplyToDeal() mutation automatically invalidates the enrollments cache, which causes BrandDealsPage's useDealEnrollments() to refetch, which updates the appliedDeals Set. No manual parent-child communication needed.
- Kept the 1500ms setTimeout for the success animation auto-close in the apply modal -- this is a UX delay for the checkmark animation, not a fake API simulation.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Removed onApplied prop from DealApplyModal in Task 1 (planned for Task 2)**
- **Found during:** Task 1 (DealsTab wiring)
- **Issue:** Task 1 removes onApplied from DealsTab's modal usage, but the modal's DealApplyModalProps still required it. TypeScript compilation failed.
- **Fix:** Removed onApplied from DealApplyModalProps interface and component signature in Task 1 (instead of waiting for Task 2), and removed the unused dealId variable.
- **Files modified:** src/components/app/brand-deals/deal-apply-modal.tsx
- **Verification:** npx tsc --noEmit passes for all brand-deals files
- **Committed in:** 18f3c2a (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Cross-task dependency required pulling part of Task 2's interface changes into Task 1 for TypeScript compilation. Task 2 completed the remaining modal wiring (mutation hook, isPending state). No scope creep.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Brand deals page fully wired to real API data
- Earnings and affiliates tabs remain on mock data (expected -- no API routes exist for them)
- Ready for 05.1-04 (final integration verification)

---
*Phase: 05.1-wire-tanstack-query-hooks-into-page-components-and-fix-integration-gaps*
*Completed: 2026-02-13*

## Self-Check: PASSED

- All 3 modified files exist on disk
- Both task commits found in git log (18f3c2a, 6e74eae)
- useDeals imported in deals-tab.tsx (2 matches)
- useApplyToDeal imported in deal-apply-modal.tsx (2 matches)
- useDealEnrollments imported in brand-deals-page.tsx (2 matches)
- mapDealRowToUI imported in deals-tab.tsx (2 matches)
