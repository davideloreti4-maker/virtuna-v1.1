---
phase: 05.1-wire-tanstack-query-hooks-into-page-components-and-fix-integration-gaps
plan: 04
subsystem: ui
tags: [tanstack-query, zustand, sse, mutation, dashboard, loading-phases, history]

# Dependency graph
requires:
  - phase: 05.1-01
    provides: "useAnalyze mutation hook with SSE streaming, useAnalysisHistory query hook, analysis history API route"
provides:
  - "Dashboard analysis flow powered by useAnalyze() mutation"
  - "Thinned test-store with only UI flow state (no server-state duplication)"
  - "Prop-driven LoadingPhases component"
  - "TestHistoryList wired to useAnalysisHistory() API"
  - "TestCreationFlow wired to useAnalyze() mutation"
  - "Exported pure utility functions (mapPredictionToTestResult, getImpactLabel, deriveAttention)"
affects: [dashboard, simulation-theater, test-history, sidebar]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "TanStack Query mutation for analysis submission with SSE streaming"
    - "Zustand thinned to UI-only flow state, server state in TanStack Query"
    - "Prop-driven presentational components (LoadingPhases)"
    - "Derived state via useMemo from mutation data"

key-files:
  modified:
    - src/stores/test-store.ts
    - src/app/(app)/dashboard/dashboard-client.tsx
    - src/components/app/simulation/loading-phases.tsx
    - src/components/app/test-history-list.tsx
    - src/components/app/test-creation-flow.tsx

key-decisions:
  - "Kept currentResult and viewResult as thin compatibility shims in test-store for sidebar/form consumers not yet migrated"
  - "Exported mapPredictionToTestResult, getImpactLabel, deriveAttention as standalone pure functions from test-store"
  - "Used Record<string, unknown> type for API history rows with field-level casting for TestHistoryItem display"

patterns-established:
  - "Server state in TanStack Query, UI flow state in Zustand: clear separation of concerns"
  - "Derive display data from mutation.data via useMemo + mapper function"
  - "Sync derived result to Zustand store for backward-compatible consumers via useEffect"

# Metrics
duration: 4min
completed: 2026-02-13
---

# Phase 5.1 Plan 04: Dashboard Analysis Wiring Summary

**Dashboard analysis flow wired to useAnalyze() SSE mutation, test-store thinned to UI flow state, LoadingPhases prop-driven, history from useAnalysisHistory() API**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-13T12:25:08Z
- **Completed:** 2026-02-13T12:29:24Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- Dashboard submits analysis via useAnalyze() TanStack Query mutation instead of Zustand submitTest()
- Test-store thinned from 12 state fields + 7 actions to 5 state fields + 6 actions (UI flow only)
- LoadingPhases converted to pure presentational component driven by simulationPhase/onCancel props
- TestHistoryList fetches from /api/analysis/history via useAnalysisHistory() hook
- TestCreationFlow also wired to useAnalyze() mutation (deviation fix)
- Pure utility functions extracted as standalone exports for reuse

## Task Commits

Each task was committed atomically:

1. **Task 1: Thin test-store and wire DashboardClient to useAnalyze mutation** - `25f9dca` (feat)
2. **Task 2: Wire LoadingPhases to props and test-history-list to useAnalysisHistory** - `2e064de` (feat)

## Files Created/Modified
- `src/stores/test-store.ts` - Thinned to UI flow state; SSE streaming, tests[], submitTest, cancelSimulation removed; pure utility functions exported
- `src/app/(app)/dashboard/dashboard-client.tsx` - Wired to useAnalyze() mutation; derives currentResult via useMemo; passes phase props to LoadingPhases
- `src/components/app/simulation/loading-phases.tsx` - Converted to prop-driven (simulationPhase, phaseMessage, onCancel); no more useTestStore import
- `src/components/app/test-history-list.tsx` - Replaced Zustand tests[] with useAnalysisHistory() hook; maps API rows to TestResult shape
- `src/components/app/test-creation-flow.tsx` - Wired to useAnalyze() mutation (was using removed submitTest)

## Decisions Made
- Kept `currentResult` and `viewResult` as thin compatibility shims in test-store because sidebar.tsx, content-form.tsx, and survey-form.tsx still reference them. Full migration to TanStack Query deferred to follow-up.
- Exported pure functions (`mapPredictionToTestResult`, `getImpactLabel`, `deriveAttention`, `PHASE_MESSAGES`) as standalone exports from test-store rather than moving to a separate file, to minimize import path changes.
- Used `Record<string, unknown>` with field-level casting for API history rows rather than a typed mapper, since the API shape will stabilize after Supabase types are generated.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Wired TestCreationFlow to useAnalyze() mutation**
- **Found during:** Task 1 (test-store thinning)
- **Issue:** Removing `submitTest` from test-store broke `test-creation-flow.tsx` which called `submitTest(content, societyId)` directly
- **Fix:** Wired TestCreationFlow to useAnalyze() mutation with same pattern as DashboardClient (mutate with onSuccess/onError callbacks)
- **Files modified:** src/components/app/test-creation-flow.tsx
- **Verification:** `npx tsc --noEmit` passes for test-creation-flow.tsx
- **Committed in:** 25f9dca (Task 1 commit)

**2. [Rule 3 - Blocking] Kept currentResult/viewResult as compatibility shims**
- **Found during:** Task 1 (test-store thinning)
- **Issue:** Removing `currentResult` and `viewResult` from test-store broke sidebar.tsx, survey-form.tsx, content-form.tsx (all read `currentResult` from store)
- **Fix:** Kept `currentResult` as settable state and `viewResult` as a thin shim that sets `isViewingHistory: true`. DashboardClient syncs derived result to store via useEffect.
- **Files modified:** src/stores/test-store.ts
- **Verification:** All consumers compile cleanly
- **Committed in:** 25f9dca (Task 1 commit)

---

**Total deviations:** 2 auto-fixed (2 blocking)
**Impact on plan:** Both fixes necessary for TypeScript compilation. No scope creep -- minimal shims preserve backward compatibility until full migration.

## Issues Encountered
- Pre-existing `blur="none"` TypeScript errors in loading-phases.tsx (GlassCard component type doesn't include "none" variant) -- not introduced by this plan, ignored.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All 4 plans in Phase 5.1 complete (01: mappers/history, 02: trending, 03: deals, 04: dashboard/test-store)
- Dashboard analysis flow end-to-end: select type -> fill form -> submit via useAnalyze() mutation -> LoadingPhases with real SSE events -> ResultsPanel
- Remaining TODOs: delete-test API route, full migration of sidebar/forms off currentResult shim

## Self-Check: PASSED

All 5 modified files exist on disk. Both task commits (25f9dca, 2e064de) verified in git log.

---
*Phase: 05.1-wire-tanstack-query-hooks-into-page-components-and-fix-integration-gaps*
*Completed: 2026-02-13*
