---
phase: 05.1-wire-tanstack-query-hooks-into-page-components-and-fix-integration-gaps
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/mappers/trending.ts
  - src/lib/mappers/deals.ts
  - src/lib/mappers/index.ts
  - src/app/api/analysis/history/route.ts
  - src/hooks/queries/use-analyze.ts
autonomous: true

must_haves:
  truths:
    - "mapScrapedVideoToTrendingVideo transforms a Tables<scraped_videos> row into a valid TrendingVideo type with all required fields"
    - "mapDealRowToUI transforms a Tables<deals> row into a valid BrandDeal type with camelCase field names and correct unit conversions"
    - "GET /api/analysis/history returns the authenticated user's analysis results from analysis_results table (not outcomes)"
    - "useAnalysisHistory() hook fetches from /api/analysis/history instead of /api/outcomes"
  artifacts:
    - path: "src/lib/mappers/trending.ts"
      provides: "scraped_videos -> TrendingVideo mapper"
      exports: ["mapScrapedVideoToTrendingVideo"]
    - path: "src/lib/mappers/deals.ts"
      provides: "deals row -> BrandDeal mapper"
      exports: ["mapDealRowToUI"]
    - path: "src/lib/mappers/index.ts"
      provides: "barrel export for all mappers"
    - path: "src/app/api/analysis/history/route.ts"
      provides: "GET endpoint for analysis history"
      exports: ["GET"]
    - path: "src/hooks/queries/use-analyze.ts"
      provides: "Fixed useAnalysisHistory endpoint"
  key_links:
    - from: "src/lib/mappers/trending.ts"
      to: "src/types/trending.ts"
      via: "TrendingVideo type import"
      pattern: "import.*TrendingVideo.*from.*types/trending"
    - from: "src/lib/mappers/deals.ts"
      to: "src/types/brand-deals.ts"
      via: "BrandDeal type import"
      pattern: "import.*BrandDeal.*from.*types/brand-deals"
    - from: "src/app/api/analysis/history/route.ts"
      to: "analysis_results table"
      via: "Supabase query"
      pattern: "from.*analysis_results"
    - from: "src/hooks/queries/use-analyze.ts"
      to: "/api/analysis/history"
      via: "fetch call"
      pattern: "fetch.*api/analysis/history"
---

<objective>
Create type mapper functions (DB snake_case -> UI camelCase) and fix the useAnalysisHistory bug (wrong endpoint).

Purpose: Provide the adapter layer that all three page-wiring plans (trending, deals, dashboard) depend on. Fix a confirmed bug where useAnalysisHistory() calls /api/outcomes instead of querying the analysis_results table.

Output: Two mapper modules, one new API route, one hook bug fix.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/database.types.ts
@src/types/trending.ts
@src/types/brand-deals.ts
@src/hooks/queries/use-analyze.ts
@src/lib/queries/query-keys.ts
@src/lib/engine/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create type mapper functions for trending videos and deals</name>
  <files>
    src/lib/mappers/trending.ts
    src/lib/mappers/deals.ts
    src/lib/mappers/index.ts
  </files>
  <action>
Create `src/lib/mappers/` directory with three files:

**trending.ts** -- `mapScrapedVideoToTrendingVideo(row: Tables<"scraped_videos">): TrendingVideo`
- Import `Tables` from `@/types/database.types` and `TrendingVideo`, `TrendingCategory` from `@/types/trending`
- Map fields per these rules:
  - `id` -> `id` (direct)
  - `description ?? "Untitled"` -> `title`
  - Construct placeholder `thumbnailUrl`: `https://picsum.photos/seed/${row.platform_video_id}/400/500`
  - Construct `creator` object: `{ handle: row.author ? \`@${row.author.replace(/^@/, "")}\` : "@unknown", displayName: row.author ?? "Unknown Creator", avatarUrl: \`https://picsum.photos/seed/${row.author ?? "default"}/100/100\` }`
  - `views ?? 0` -> `views`
  - `likes ?? 0` -> `likes`
  - `shares ?? 0` -> `shares`
  - `created_at ?? new Date().toISOString()` -> `date`
  - Validate `category` against valid values `["breaking-out", "trending-now", "rising-again"]`, fallback to `"trending-now"` -> `category`
  - `hashtags ?? []` -> `hashtags`
  - `video_url ?? ""` -> `tiktokUrl`
  - Default `1.0` -> `velocity` (no DB column; TODO comment for future derivation)

**deals.ts** -- `mapDealRowToUI(row: Tables<"deals">): BrandDeal`
- Import `Tables` from `@/types/database.types` and `BrandDeal`, `BrandDealCategory` from `@/types/brand-deals`
- Map fields per these rules:
  - `id` -> `id` (direct)
  - `brand_name` -> `brandName`
  - `brand_logo_url ?? ""` -> `brandLogo`
  - `brand_category` validated against BrandDealCategory values, fallback `"tech"` -> `category`
  - `status` -> `status` (cast to union type with fallback `"active"`)
  - `compensation_rev_share_percent ?? 0` -> `commission`
  - `compensation_fixed_cents ? compensation_fixed_cents / 100 : undefined` -> `fixedFee` (cents -> dollars)
  - Derive `payoutRange` from compensation_type + values (e.g., "Revenue share: 15%" or "Fixed: $50")
  - `created_at ?? new Date().toISOString()` -> `startDate`
  - `expires_at ?? undefined` -> `endDate`
  - `description ?? ""` -> `description`
  - Derive `requirements` from `min_followers`, `min_engagement_rate`, `required_niches` (human-readable string)
  - `isNew`: true if `created_at` is within last 7 days
  - `applicantCount`: undefined (not in DB schema)

**index.ts** -- barrel export:
```typescript
export { mapScrapedVideoToTrendingVideo } from "./trending";
export { mapDealRowToUI } from "./deals";
```
  </action>
  <verify>
Run `npx tsc --noEmit` on the mapper files. Verify no TypeScript errors. Check that all TrendingVideo and BrandDeal interface fields are populated in the return objects.
  </verify>
  <done>
Both mapper functions compile with zero TypeScript errors, every field of the target UI types is populated with a valid value (no `undefined` for required fields), and null database values have safe fallbacks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create /api/analysis/history route and fix useAnalysisHistory endpoint</name>
  <files>
    src/app/api/analysis/history/route.ts
    src/hooks/queries/use-analyze.ts
  </files>
  <action>
**Create `src/app/api/analysis/history/route.ts`:**
- Export a `GET` handler
- Use `createRouteHandlerClient` from `@supabase/auth-helpers-nextjs` (or the project's existing Supabase client pattern -- check `src/app/api/analyze/route.ts` for the auth pattern used)
- Get authenticated user from Supabase auth; return 401 if not authenticated
- Query `analysis_results` table: `SELECT * FROM analysis_results WHERE user_id = $userId AND deleted_at IS NULL ORDER BY created_at DESC LIMIT 50`
- Return JSON array of results
- Handle errors with 500 response

**Fix `src/hooks/queries/use-analyze.ts` -- useAnalysisHistory():**
- Change line 117 from `const res = await fetch("/api/outcomes");` to `const res = await fetch("/api/analysis/history");`
- Change error message from `"Failed to fetch analysis history"` to match (keep or update)
- This fixes QUERY-06 bug: analysis history was fetching outcomes instead of analysis results
  </action>
  <verify>
1. Run `npx tsc --noEmit` to verify new route compiles
2. Grep `use-analyze.ts` to confirm `/api/analysis/history` is the endpoint (not `/api/outcomes`)
3. Verify the route file exports a GET function
  </verify>
  <done>
`GET /api/analysis/history` returns analysis results from the `analysis_results` table for the authenticated user. `useAnalysisHistory()` hook fetches from the correct endpoint `/api/analysis/history`.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors across all new and modified files
2. `grep -r "api/outcomes" src/hooks/queries/use-analyze.ts` returns nothing (bug fixed)
3. `grep -r "api/analysis/history" src/hooks/queries/use-analyze.ts` returns a match
4. Both mapper files export typed functions that accept DB row types and return UI types
</verification>

<success_criteria>
- Two mapper functions exist and compile cleanly
- /api/analysis/history route exists and queries analysis_results table
- useAnalysisHistory() calls the correct endpoint
- All new code passes TypeScript compilation
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-wire-tanstack-query-hooks-into-page-components-and-fix-integration-gaps/05.1-01-SUMMARY.md`
</output>
