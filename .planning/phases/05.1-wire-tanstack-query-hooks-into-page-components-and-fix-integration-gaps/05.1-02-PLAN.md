---
phase: 05.1-wire-tanstack-query-hooks-into-page-components-and-fix-integration-gaps
plan: 02
type: execute
wave: 2
depends_on: ["05.1-01"]
files_modified:
  - src/app/(app)/trending/trending-client.tsx
  - src/components/trending/video-grid.tsx
autonomous: true

must_haves:
  truths:
    - "Trending page loads videos from /api/trending via useTrendingVideos() hook, not from mock data imports"
    - "Infinite scroll loads more pages via cursor pagination (fetchNextPage from TanStack Query)"
    - "Category tab switching resets the video grid to the new category's data from the API"
    - "Stats bar shows real data from useTrendingStats() instead of mock getTrendingStats()"
    - "Saved tab still works using bookmarkStore against the full video set"
  artifacts:
    - path: "src/app/(app)/trending/trending-client.tsx"
      provides: "Trending page wired to TanStack Query hooks"
      contains: "useTrendingStats"
    - path: "src/components/trending/video-grid.tsx"
      provides: "Video grid wired to useTrendingVideos with infinite scroll"
      contains: "useTrendingVideos"
  key_links:
    - from: "src/components/trending/video-grid.tsx"
      to: "src/hooks/queries/use-trending.ts"
      via: "useTrendingVideos hook import"
      pattern: "import.*useTrendingVideos.*from.*hooks/queries"
    - from: "src/components/trending/video-grid.tsx"
      to: "src/lib/mappers/trending.ts"
      via: "mapScrapedVideoToTrendingVideo mapper"
      pattern: "mapScrapedVideoToTrendingVideo"
    - from: "src/app/(app)/trending/trending-client.tsx"
      to: "src/hooks/queries/use-trending.ts"
      via: "useTrendingStats hook import"
      pattern: "import.*useTrendingStats.*from.*hooks/queries"
---

<objective>
Wire the trending page components to TanStack Query hooks, replacing all mock data imports with real API data.

Purpose: The trending page currently imports static mock data from `trending-mock-data.ts` and paginates using a custom `useInfiniteVideos` hook that slices arrays. This plan replaces those with `useTrendingVideos()` (infinite query with cursor pagination from `/api/trending`) and `useTrendingStats()`.

Output: Trending page fetching real data from Supabase via API routes.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/hooks/queries/use-trending.ts
@src/lib/mappers/trending.ts
@src/types/trending.ts
@src/components/trending/video-grid.tsx
@src/app/(app)/trending/trending-client.tsx
@src/hooks/use-infinite-videos.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire VideoGrid to useTrendingVideos with mapper and real infinite scroll</name>
  <files>
    src/components/trending/video-grid.tsx
  </files>
  <action>
Replace the mock-data-based `useInfiniteVideos` hook with the TanStack Query `useTrendingVideos()` hook and apply the mapper.

**Imports to change:**
- Remove: `import { useInfiniteVideos } from "@/hooks/use-infinite-videos"`
- Remove: `import { getAllVideos } from "@/lib/trending-mock-data"`
- Add: `import { useTrendingVideos } from "@/hooks/queries"`
- Add: `import { mapScrapedVideoToTrendingVideo } from "@/lib/mappers"`

**For category tabs (non-saved):**
Replace the `useInfiniteVideos` usage with `useTrendingVideos(filterTab)`:
```typescript
const {
  data,
  isLoading,
  fetchNextPage,
  hasNextPage,
  isFetchingNextPage,
} = useTrendingVideos(isSaved ? "breaking-out" : (filterTab as TrendingCategory));
```

Flatten pages and map to UI types:
```typescript
const apiVideos = useMemo(() =>
  data?.pages.flatMap(page => page.data.map(mapScrapedVideoToTrendingVideo)) ?? [],
  [data]
);
```

**For saved tab:**
- The saved tab needs all videos across categories for bookmark filtering. Use the `apiVideos` from the current category query for now (saved tab filters from bookmarked IDs). Since bookmarks reference video IDs that may span categories, keep the existing `getAllVideos()` import ONLY for the saved tab, OR simply show "saved videos from current category". Given that `getAllVideos()` is mock data, for saved tab show a message that saved filtering works within the currently viewed category. Actually, the cleanest approach: keep the saved tab working with whatever videos have been loaded. The bookmark IDs are stored in the bookmark store. For the saved tab, fetch all categories and merge. BUT that's complex. Simplest correct approach: For the saved tab, import `getAllVideos` from mock data ONLY for saved tab as a temporary measure. Add a `// TODO: Replace saved tab with API-backed bookmarks query when bookmark API exists` comment.

**Infinite scroll wiring:**
Replace the old `infiniteResult.loadMore()` pattern with TanStack Query:
```typescript
useEffect(() => {
  if (!isSaved && inView && hasNextPage && !isFetchingNextPage) {
    fetchNextPage();
  }
}, [isSaved, inView, hasNextPage, isFetchingNextPage, fetchNextPage]);
```

Update the display logic:
```typescript
const videos = isSaved ? savedVideos : apiVideos;
const hasMore = isSaved ? false : !!hasNextPage;
const isLoadingMore = isSaved ? false : isFetchingNextPage;
```

Add initial loading state: if `isLoading && !isSaved`, show `VideoCardSkeleton` grid (6 skeletons).

**Do NOT delete `use-infinite-videos.ts`** -- it may be imported elsewhere. Just stop using it here.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `grep -r "useInfiniteVideos" src/components/trending/video-grid.tsx` returns nothing
3. `grep -r "useTrendingVideos" src/components/trending/video-grid.tsx` returns a match
4. `grep -r "mapScrapedVideoToTrendingVideo" src/components/trending/video-grid.tsx` returns a match
  </verify>
  <done>
VideoGrid component fetches videos from /api/trending via useTrendingVideos(), maps DB rows to TrendingVideo type, and supports infinite scroll via fetchNextPage. No more mock array slicing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire TrendingClient stats to useTrendingStats and remove mock loading state</name>
  <files>
    src/app/(app)/trending/trending-client.tsx
  </files>
  <action>
Replace mock stats and fake loading with real TanStack Query data.

**Imports to change:**
- Remove: `import { getTrendingStats, getAllVideos } from "@/lib/trending-mock-data"`
- Add: `import { useTrendingStats } from "@/hooks/queries"`

**Stats replacement:**
Replace `const stats = useMemo(() => getTrendingStats(), []);` with:
```typescript
const { data: statsData, isLoading: statsLoading } = useTrendingStats();
```

The `useTrendingStats()` hook returns `TrendingStats` from the API with shape `{ categories: Array<{ category, video_count, avg_views, top_sounds }>, total_videos }`. This differs from the mock `TrendingStats` type which has `{ totalVideos, totalViews, byCategory: Record<TrendingCategory, CategoryStats> }`.

Create an adapter in-component (or use a mapper) to transform API stats to the UI stats shape:
```typescript
const stats: TrendingStats | null = useMemo(() => {
  if (!statsData) return null;
  const byCategory = {} as Record<TrendingCategory, CategoryStats>;
  let totalViews = 0;
  for (const cat of statsData.categories) {
    const key = cat.category as TrendingCategory;
    if (VALID_TABS.includes(key as any)) {
      byCategory[key] = { count: cat.video_count, totalViews: cat.avg_views * cat.video_count };
      totalViews += cat.avg_views * cat.video_count;
    }
  }
  // Ensure all categories exist
  for (const tab of VALID_TABS) {
    if (!byCategory[tab]) byCategory[tab] = { count: 0, totalViews: 0 };
  }
  return { totalVideos: statsData.total_videos, totalViews, byCategory };
}, [statsData]);
```

**Remove fake loading state:**
- Remove `const [isLoading, setIsLoading] = useState(false);`
- Remove the `setTimeout(() => setIsLoading(false), 250)` in `handleTabChange` and `handlePopState`
- The VideoGrid handles its own loading state via TanStack Query's `isLoading`. Remove the `{isLoading ? <SkeletonGrid /> : <VideoGrid ... />}` ternary -- just render `<VideoGrid>` directly. The grid handles its own skeleton.
- Keep the tab change logic (setActiveTab, URL push) but remove the artificial loading delay.

**Remove getAllVideos for modal navigation:**
The `currentVideos` computation uses `getAllVideos()` for modal keyboard navigation. Since VideoGrid now uses API data, the parent doesn't have direct access to the video list. Two options:
- **Option A (simpler):** Lift the video list up via a callback or shared state. Complex.
- **Option B (pragmatic):** Remove the parent-level `currentVideos` and prev/next navigation for now. The modal still opens on click. Add a `// TODO: Re-implement modal navigation with API data` comment.
- **Option C (best):** Pass the video data up from VideoGrid via a ref or expose it. This is a UX detail, not a wiring blocker.

Choose Option B: remove the `currentVideos` memo and `handleNavigate` callback. Pass `hasPrevious={false}` and `hasNext={false}` to VideoDetailModal temporarily. The modal still works for single video viewing.

**StatsBar guarding:**
If `stats` is null (still loading), show a simple loading state or skip rendering the stats bar. The StatsBar component expects a non-null TrendingStats.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `grep -r "getTrendingStats\|getAllVideos" src/app/(app)/trending/trending-client.tsx` returns nothing
3. `grep -r "useTrendingStats" src/app/(app)/trending/trending-client.tsx` returns a match
4. `grep -r "setTimeout" src/app/(app)/trending/trending-client.tsx` returns nothing (fake loading removed)
  </verify>
  <done>
TrendingClient uses useTrendingStats() for the stats bar with real API data. Fake setTimeout loading states are removed. Category tab switching is handled by the VideoGrid's query key change.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for all modified files
2. No imports from `trending-mock-data` remain in `trending-client.tsx` or `video-grid.tsx` (except saved tab fallback)
3. `useTrendingVideos` and `useTrendingStats` are imported from `@/hooks/queries`
4. `mapScrapedVideoToTrendingVideo` is imported from `@/lib/mappers`
5. No `setTimeout` fake loading patterns remain in trending page components
</verification>

<success_criteria>
- Trending page fetches real data from /api/trending via TanStack Query
- Infinite scroll uses cursor pagination (fetchNextPage) not mock array slicing
- Stats bar shows real category stats from /api/trending/stats
- All fake loading delays (setTimeout) removed
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-wire-tanstack-query-hooks-into-page-components-and-fix-integration-gaps/05.1-02-SUMMARY.md`
</output>
