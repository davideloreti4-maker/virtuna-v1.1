---
phase: 55-affiliates-tab
plan: 02
type: execute
wave: 2
depends_on: ["55-01"]
files_modified:
  - src/components/app/brand-deals/affiliates-tab.tsx
  - src/components/app/brand-deals/brand-deals-page.tsx
  - src/components/app/brand-deals/index.ts
  - src/app/(app)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Affiliates tab shows Active Links section with count Badge in header and 4-5 affiliate link cards"
    - "Affiliates tab shows Available Products section with 6-8 product cards in responsive grid"
    - "Clicking Generate Link on a product adds it to Active Links at the top and removes it from Available Products"
    - "Generate Link shows a toast success message confirming the affiliate link was created"
    - "Empty state renders when no active links exist (e.g., if all links were removed)"
    - "Switching away from Affiliates tab and back preserves the tab state"
  artifacts:
    - path: "src/components/app/brand-deals/affiliates-tab.tsx"
      provides: "AffiliatesTab container component with state management"
      exports: ["AffiliatesTab"]
    - path: "src/components/app/brand-deals/brand-deals-page.tsx"
      provides: "Updated BrandDealsPage with AffiliatesTab wired into affiliates tab content"
      contains: "AffiliatesTab"
    - path: "src/components/app/brand-deals/index.ts"
      provides: "Updated barrel exports including AffiliatesTab"
      contains: "AffiliatesTab"
    - path: "src/app/(app)/layout.tsx"
      provides: "ToastProvider wrapping children inside AppShell"
      contains: "ToastProvider"
  key_links:
    - from: "src/components/app/brand-deals/affiliates-tab.tsx"
      to: "src/components/app/brand-deals/affiliate-link-card.tsx"
      via: "renders AffiliateLinkCard for each active link"
      pattern: "AffiliateLinkCard"
    - from: "src/components/app/brand-deals/affiliates-tab.tsx"
      to: "src/components/app/brand-deals/available-product-card.tsx"
      via: "renders AvailableProductCard for each available product"
      pattern: "AvailableProductCard"
    - from: "src/components/app/brand-deals/affiliates-tab.tsx"
      to: "src/components/ui/toast.tsx"
      via: "useToast for Generate Link success feedback"
      pattern: "useToast"
    - from: "src/components/app/brand-deals/brand-deals-page.tsx"
      to: "src/components/app/brand-deals/affiliates-tab.tsx"
      via: "replaces placeholder div with AffiliatesTab component"
      pattern: "AffiliatesTab"
    - from: "src/app/(app)/layout.tsx"
      to: "src/components/ui/toast.tsx"
      via: "ToastProvider wrapping children for global toast support"
      pattern: "ToastProvider"
---

<objective>
Build the AffiliatesTab container component and wire it into BrandDealsPage. AffiliatesTab manages active links state (initialized from mock data), derives available products by filtering out already-linked products, handles Generate Link interaction (adds to active links, shows toast, removes from available), and renders the two sections using presentational components from Plan 01. Also add ToastProvider to the app layout for global toast support.

Purpose: Completes the Affiliates Tab feature -- users can view active links with stats, copy links, and generate new affiliate links from available products.
Output: AffiliatesTab container, updated BrandDealsPage, updated index.ts, updated app layout with ToastProvider.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/55-affiliates-tab/55-CONTEXT.md
@.planning/phases/55-affiliates-tab/55-RESEARCH.md
@.planning/phases/55-affiliates-tab/55-01-SUMMARY.md

@src/types/brand-deals.ts
@src/lib/mock-brand-deals.ts
@src/lib/affiliate-utils.ts
@src/components/app/brand-deals/affiliate-link-card.tsx
@src/components/app/brand-deals/available-product-card.tsx
@src/components/app/brand-deals/affiliates-empty-state.tsx
@src/components/app/brand-deals/deals-tab.tsx
@src/components/app/brand-deals/brand-deals-page.tsx
@src/components/app/brand-deals/index.ts
@src/components/ui/toast.tsx
@src/app/(app)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AffiliatesTab container and add ToastProvider to app layout</name>
  <files>
    src/components/app/brand-deals/affiliates-tab.tsx
    src/app/(app)/layout.tsx
  </files>
  <action>
    **1. Add ToastProvider to `src/app/(app)/layout.tsx`:**
    - Import `{ ToastProvider }` from `@/components/ui/toast`
    - Wrap `{children}` inside `<AppShell>` with `<ToastProvider>...</ToastProvider>`
    - This enables `useToast` globally across all app pages (needed for Generate Link feedback and future Phase 56)

    **2. Create `src/components/app/brand-deals/affiliates-tab.tsx`** -- Container component managing all Affiliates tab state and interactions.

    Add `"use client"` directive.

    **State:**
    - `activeLinks: AffiliateLink[]` -- useState initialized from `MOCK_AFFILIATE_LINKS`
    - `availableProducts` -- useMemo derived from `MOCK_PRODUCTS` filtered to exclude products whose `name` already appears in `activeLinks` (match on `productName` field in AffiliateLink vs `name` field in Product)

    **Handler: `handleGenerateLink(product: Product): void`**
    - Creates a new `AffiliateLink` object:
      - `id`: `"link-gen-${Date.now()}"`
      - `dealId`: `""` (no deal association for generated links)
      - `productName`: `product.name`
      - `productImage`: `product.brandLogo`
      - `url`: `"https://${product.brandName.toLowerCase().replace(/\s/g, '')}.com/ref/vtna-${Date.now().toString(36)}"`
      - `shortCode`: `"vtna-${Date.now().toString(36)}"`
      - `clicks`: 0
      - `conversions`: 0
      - `earnings`: 0
      - `commissionRate`: `product.commissionRate`
      - `status`: `"active"`
      - `createdAt`: `new Date().toISOString().split("T")[0]`
    - Prepends to activeLinks: `setActiveLinks((prev) => [newLink, ...prev])` (new link appears at TOP)
    - Shows toast: `toast({ variant: "success", title: "Affiliate link created for ${product.name}" })`

    **Render structure:**
    ```
    <div className="space-y-8">
      {/* Active Links section */}
      <section>
        <div className="mb-4 flex items-center gap-2">
          <h2 className="text-lg font-semibold text-foreground">Active Links</h2>
          <Badge variant="default" size="sm">{activeLinks.length}</Badge>
        </div>
        {activeLinks.length === 0 ? (
          <AffiliatesEmptyState />
        ) : (
          <div className="grid grid-cols-1 gap-4 sm:grid-cols-2">
            {activeLinks.map((link) => (
              <AffiliateLinkCard key={link.id} link={link} />
            ))}
          </div>
        )}
      </section>

      {/* Available Products section */}
      {availableProducts.length > 0 && (
        <section>
          <h2 className="mb-4 text-lg font-semibold text-foreground">Available Products</h2>
          <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
            {availableProducts.map((product) => (
              <AvailableProductCard
                key={product.id}
                product={product}
                onGenerateLink={handleGenerateLink}
              />
            ))}
          </div>
        </section>
      )}
    </div>
    ```

    **Layout decisions (from CONTEXT.md Claude's Discretion):**
    - Active Links first (manage existing), Available Products second (discover new)
    - Active Links grid: 2 columns on sm+ (link cards are wider with stats), 1 on mobile
    - Available Products grid: 3 cols lg, 2 sm, 1 mobile (matching Deals tab pattern)
    - Section headings: text-lg font-semibold, Active Links has count Badge
    - space-y-8 between sections for clear separation
    - Available Products section hidden when all products have been linked (no "all generated" state needed -- the section just disappears)

    **Imports:** useState, useMemo from react; MOCK_AFFILIATE_LINKS, MOCK_PRODUCTS from @/lib/mock-brand-deals; useToast from @/components/ui/toast; Badge from @/components/ui/badge; AffiliateLink, Product types from @/types/brand-deals; AffiliateLinkCard, AvailableProductCard, AffiliatesEmptyState from local siblings.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- AffiliatesTab compiles. Verify ToastProvider is wrapping children in app layout. Verify useToast import resolves.
  </verify>
  <done>
    AffiliatesTab container manages active links state, derives available products, handles Generate Link with toast feedback, and renders both sections with proper grids.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire AffiliatesTab into BrandDealsPage and update exports</name>
  <files>
    src/components/app/brand-deals/brand-deals-page.tsx
    src/components/app/brand-deals/index.ts
  </files>
  <action>
    **1. Update `src/components/app/brand-deals/brand-deals-page.tsx`:**
    - Add import: `import { AffiliatesTab } from "./affiliates-tab";`
    - Replace the affiliates placeholder div (lines 79-84, the div with "Affiliates tab content -- Phase 55") with: `<AffiliatesTab />`
    - The `Tabs.Content` wrapper with `value="affiliates"` and `forceMount` stays as-is -- only the inner content changes

    **2. Update `src/components/app/brand-deals/index.ts`:**
    - Add export: `export { AffiliatesTab } from "./affiliates-tab";`
    - Keep existing exports (BrandDealsPage, DealsTab)
  </action>
  <verify>
    1. Run `npx tsc --noEmit` -- full project compiles
    2. Run `pnpm dev` (or `npm run dev`) and navigate to `/brand-deals?tab=affiliates`
    3. Verify: Active Links section shows 5 cards with stats, copy buttons, status badges
    4. Verify: Available Products section shows product cards with commission rates and Generate Link buttons
    5. Verify: Clicking copy button morphs icon from Copy to Check for 2 seconds
    6. Verify: Clicking Generate Link adds product to Active Links at top, removes from Available Products, shows success toast
    7. Verify: Tab switching preserves state (switch to Deals and back)
  </verify>
  <done>
    BrandDealsPage renders AffiliatesTab in the affiliates tab content area. Barrel exports updated. Full affiliates tab experience is live and interactive.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Navigate to `/brand-deals?tab=affiliates` -- Active Links section visible with 5 affiliate link cards
3. Each active link card shows: product thumbnail, name, truncated URL, copy button, status badge (Active/Paused/Expired), and three mini KPI stat blocks (clicks, conversions, earned)
4. Click copy button on any card -- icon morphs from Copy to Check (green) for 2 seconds, then reverts. Clicking copy on card A does NOT affect card B's icon (independent instances).
5. Available Products section shows product cards with brand logo, name, hero commission percentage, and Generate Link button
6. Click Generate Link on a product -- product disappears from Available Products, new affiliate link card appears at TOP of Active Links with 0 stats, success toast appears
7. Active Links count Badge updates after generating a link
8. If manually clearing all active links from state, AffiliatesEmptyState renders with "No active affiliate links" message
9. Switch to Deals tab and back to Affiliates -- state preserved (no re-initialization)
10. ToastProvider in app layout -- toast works globally
</verification>

<success_criteria>
AffiliatesTab is fully functional: Active Links with copy-to-clipboard and stats, Available Products with Generate Link that creates new affiliate links with toast feedback, empty state for zero links, all wired into BrandDealsPage tab shell.
</success_criteria>

<output>
After completion, create `.planning/phases/55-affiliates-tab/55-02-SUMMARY.md`
</output>
