---
phase: 25-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/config.toml
  - supabase/migrations/20260202000000_v16_schema.sql
  - package.json
autonomous: true

must_haves:
  truths:
    - "creator_profiles table exists with social handles, follower counts, and niche fields"
    - "deals table exists with brand, compensation, requirements, deliverables, tier"
    - "deal_enrollments table links creators to deals with status tracking"
    - "wallet_transactions table exists as immutable ledger with balance snapshots"
    - "affiliate_clicks and affiliate_conversions tables exist for attribution tracking"
    - "RLS policies enforce data access control per user"
  artifacts:
    - path: "supabase/migrations/20260202000000_v16_schema.sql"
      provides: "Complete v1.6 database schema"
      contains: "CREATE TABLE creator_profiles"
    - path: "supabase/config.toml"
      provides: "Supabase CLI configuration"
      contains: "project_id"
  key_links:
    - from: "wallet_transactions"
      to: "auth.users"
      via: "user_id foreign key"
      pattern: "REFERENCES auth\\.users"
    - from: "deal_enrollments"
      to: "deals"
      via: "deal_id foreign key"
      pattern: "REFERENCES deals"
    - from: "affiliate_conversions"
      to: "affiliate_clicks"
      via: "click_id foreign key"
      pattern: "REFERENCES affiliate_clicks"
---

<objective>
Create the complete Supabase database schema for v1.6 creator monetization features.

Purpose: This schema is the data foundation for all v1.6 features (Phases 26-30) â€” creator profiles, wallet transactions, deals marketplace, enrollments, and affiliate tracking. Without this schema, no subsequent v1.6 phase can function.

Output: Migration file with all tables, RLS policies, triggers, and indexes deployed to Supabase.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/supabase/client.ts
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Supabase CLI and create migration file</name>
  <files>
    supabase/config.toml
    supabase/migrations/20260202000000_v16_schema.sql
    package.json
  </files>
  <action>
1. Install Supabase CLI as dev dependency:
   `pnpm add -D supabase` (or `npm i -D supabase` if pnpm unavailable)

2. Initialize Supabase project structure:
   `npx supabase init`
   - Creates `supabase/` directory with config.toml and migrations/

3. Link to existing project:
   `npx supabase link --project-ref qyxvxleheckijapurisj`
   - If auth prompt appears, run `npx supabase login` first

4. Create migration file `supabase/migrations/20260202000000_v16_schema.sql` with ALL tables:

```sql
-- v1.6 Brand Deals & Affiliate Hub Schema
-- All money amounts stored as INTEGER (cents)
-- Status fields use TEXT + CHECK (not ENUM) for flexibility
-- RLS uses (SELECT auth.uid()) pattern for 94%+ performance improvement

-- =====================================================
-- CREATOR PROFILES
-- =====================================================
CREATE TABLE creator_profiles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE,
  display_name TEXT,
  bio TEXT,
  avatar_url TEXT,
  -- Social handles
  tiktok_handle TEXT,
  instagram_handle TEXT,
  youtube_handle TEXT,
  twitter_handle TEXT,
  -- Follower counts
  tiktok_followers INTEGER DEFAULT 0,
  instagram_followers INTEGER DEFAULT 0,
  youtube_subscribers INTEGER DEFAULT 0,
  twitter_followers INTEGER DEFAULT 0,
  -- Engagement and niches
  engagement_rate NUMERIC(5,2),
  niches TEXT[] DEFAULT '{}',
  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_creator_profiles_user_id ON creator_profiles(user_id);

-- =====================================================
-- DEALS
-- =====================================================
CREATE TABLE deals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  -- Brand info
  brand_name TEXT NOT NULL,
  brand_logo_url TEXT,
  brand_category TEXT,
  -- Deal details
  title TEXT NOT NULL,
  description TEXT,
  -- Compensation (cents for amounts)
  compensation_type TEXT NOT NULL CHECK (compensation_type IN ('fixed', 'rev_share', 'hybrid')),
  compensation_fixed_cents INTEGER,
  compensation_rev_share_percent NUMERIC(5,2),
  -- Requirements
  min_followers INTEGER DEFAULT 0,
  min_engagement_rate NUMERIC(5,2),
  required_platforms TEXT[] DEFAULT '{}',
  required_niches TEXT[] DEFAULT '{}',
  -- Deliverables
  content_count INTEGER DEFAULT 1,
  content_types TEXT[] DEFAULT '{}',
  deadline_days INTEGER,
  -- Access control
  tier_required TEXT NOT NULL DEFAULT 'starter' CHECK (tier_required IN ('starter', 'pro')),
  -- Status lifecycle
  status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'active', 'paused', 'expired', 'archived')),
  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ
);

CREATE INDEX idx_deals_status ON deals(status);
CREATE INDEX idx_deals_tier ON deals(tier_required);
CREATE INDEX idx_deals_created_at ON deals(created_at DESC);

-- =====================================================
-- DEAL ENROLLMENTS
-- =====================================================
CREATE TABLE deal_enrollments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  deal_id UUID NOT NULL REFERENCES deals(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  -- Status lifecycle
  status TEXT NOT NULL DEFAULT 'applied' CHECK (status IN ('applied', 'accepted', 'rejected', 'active', 'completed', 'cancelled')),
  application_note TEXT,
  deliverables_completed INTEGER DEFAULT 0,
  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  applied_at TIMESTAMPTZ DEFAULT NOW(),
  accepted_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  -- One application per creator per deal
  UNIQUE(deal_id, user_id)
);

CREATE INDEX idx_deal_enrollments_deal_id ON deal_enrollments(deal_id);
CREATE INDEX idx_deal_enrollments_user_id ON deal_enrollments(user_id);
CREATE INDEX idx_deal_enrollments_status ON deal_enrollments(status);

-- =====================================================
-- WALLET TRANSACTIONS (IMMUTABLE LEDGER)
-- =====================================================
CREATE TABLE wallet_transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,
  -- Transaction details (positive = credit, negative = debit)
  amount_cents INTEGER NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('deal_payment', 'affiliate_commission', 'withdrawal', 'adjustment')),
  -- Balance snapshot (immutable ledger pattern)
  balance_after_cents INTEGER NOT NULL,
  -- Status
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'failed')),
  -- Reference to source
  reference_type TEXT CHECK (reference_type IN ('deal_enrollment', 'affiliate_conversion', 'manual')),
  reference_id UUID,
  -- Additional info
  description TEXT,
  metadata JSONB,
  -- Timestamp (NO updated_at - ledger is immutable)
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_wallet_transactions_user_id ON wallet_transactions(user_id);
CREATE INDEX idx_wallet_transactions_created_at ON wallet_transactions(created_at DESC);
CREATE INDEX idx_wallet_transactions_status ON wallet_transactions(status);

-- Immutability trigger: prevent UPDATE and DELETE
CREATE OR REPLACE FUNCTION prevent_wallet_transaction_mutation()
RETURNS TRIGGER AS $$
BEGIN
  RAISE EXCEPTION 'wallet_transactions table is immutable. UPDATE and DELETE operations are not allowed.';
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER wallet_transactions_immutable
  BEFORE UPDATE OR DELETE ON wallet_transactions
  FOR EACH ROW
  EXECUTE FUNCTION prevent_wallet_transaction_mutation();

-- =====================================================
-- AFFILIATE CLICKS
-- =====================================================
CREATE TABLE affiliate_clicks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  creator_id UUID NOT NULL REFERENCES creator_profiles(id) ON DELETE CASCADE,
  program_id TEXT NOT NULL,
  link_code TEXT NOT NULL,
  -- Click metadata
  clicked_at TIMESTAMPTZ DEFAULT NOW(),
  referrer_url TEXT,
  utm_source TEXT,
  utm_medium TEXT,
  utm_campaign TEXT,
  -- Device info
  device_type TEXT,
  user_agent TEXT,
  ip_hash TEXT
);

CREATE INDEX idx_affiliate_clicks_creator_id ON affiliate_clicks(creator_id);
CREATE INDEX idx_affiliate_clicks_program_id ON affiliate_clicks(program_id);
CREATE INDEX idx_affiliate_clicks_link_code ON affiliate_clicks(link_code);
CREATE INDEX idx_affiliate_clicks_clicked_at ON affiliate_clicks(clicked_at DESC);

-- =====================================================
-- AFFILIATE CONVERSIONS
-- =====================================================
CREATE TABLE affiliate_conversions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  click_id UUID REFERENCES affiliate_clicks(id) ON DELETE SET NULL,
  creator_id UUID NOT NULL REFERENCES creator_profiles(id) ON DELETE CASCADE,
  program_id TEXT NOT NULL,
  -- Conversion details
  conversion_type TEXT NOT NULL CHECK (conversion_type IN ('signup', 'purchase', 'subscription')),
  conversion_value_cents INTEGER NOT NULL,
  commission_cents INTEGER NOT NULL,
  -- Timestamps
  converted_at TIMESTAMPTZ DEFAULT NOW(),
  attributed_at TIMESTAMPTZ DEFAULT NOW(),
  -- Additional data
  metadata JSONB
);

CREATE INDEX idx_affiliate_conversions_creator_id ON affiliate_conversions(creator_id);
CREATE INDEX idx_affiliate_conversions_click_id ON affiliate_conversions(click_id);
CREATE INDEX idx_affiliate_conversions_converted_at ON affiliate_conversions(converted_at DESC);
```

Note: This task creates the migration file locally. Pushing to Supabase happens in Task 2.
  </action>
  <verify>
- `ls supabase/` shows config.toml and migrations/ directory
- `cat supabase/migrations/20260202000000_v16_schema.sql` shows all 6 tables
- `grep -c "CREATE TABLE" supabase/migrations/20260202000000_v16_schema.sql` returns 6
- `grep "prevent_wallet_transaction_mutation" supabase/migrations/20260202000000_v16_schema.sql` finds the immutability trigger
  </verify>
  <done>
Supabase CLI installed, project linked, and migration file created with all 6 tables (creator_profiles, deals, deal_enrollments, wallet_transactions, affiliate_clicks, affiliate_conversions), proper indexes, and immutability trigger for wallet_transactions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add RLS policies and push migration</name>
  <files>
    supabase/migrations/20260202000000_v16_schema.sql
  </files>
  <action>
Append RLS policies to the migration file, then push to Supabase.

1. Add to end of migration file:

```sql
-- =====================================================
-- ROW LEVEL SECURITY POLICIES
-- Using (SELECT auth.uid()) wrapper for 94%+ performance improvement
-- =====================================================

-- Enable RLS on all tables
ALTER TABLE creator_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE deals ENABLE ROW LEVEL SECURITY;
ALTER TABLE deal_enrollments ENABLE ROW LEVEL SECURITY;
ALTER TABLE wallet_transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE affiliate_clicks ENABLE ROW LEVEL SECURITY;
ALTER TABLE affiliate_conversions ENABLE ROW LEVEL SECURITY;

-- creator_profiles: Users manage their own profile
CREATE POLICY "Users can view their own profile"
  ON creator_profiles FOR SELECT
  USING (user_id = (SELECT auth.uid()));

CREATE POLICY "Users can create their own profile"
  ON creator_profiles FOR INSERT
  WITH CHECK (user_id = (SELECT auth.uid()));

CREATE POLICY "Users can update their own profile"
  ON creator_profiles FOR UPDATE
  USING (user_id = (SELECT auth.uid()));

-- deals: Active deals are publicly viewable
CREATE POLICY "Anyone can view active deals"
  ON deals FOR SELECT
  USING (status = 'active');

-- deal_enrollments: Users manage their own enrollments
CREATE POLICY "Users can view their own enrollments"
  ON deal_enrollments FOR SELECT
  USING (user_id = (SELECT auth.uid()));

CREATE POLICY "Users can apply to deals"
  ON deal_enrollments FOR INSERT
  WITH CHECK (user_id = (SELECT auth.uid()));

CREATE POLICY "Users can update their own enrollments"
  ON deal_enrollments FOR UPDATE
  USING (user_id = (SELECT auth.uid()));

-- wallet_transactions: Users can only view their own (no INSERT/UPDATE/DELETE via client)
CREATE POLICY "Users can view their own transactions"
  ON wallet_transactions FOR SELECT
  USING (user_id = (SELECT auth.uid()));

-- affiliate_clicks: Creators can view their own clicks
CREATE POLICY "Creators can view their own clicks"
  ON affiliate_clicks FOR SELECT
  USING (creator_id IN (
    SELECT id FROM creator_profiles WHERE user_id = (SELECT auth.uid())
  ));

-- affiliate_conversions: Creators can view their own conversions
CREATE POLICY "Creators can view their own conversions"
  ON affiliate_conversions FOR SELECT
  USING (creator_id IN (
    SELECT id FROM creator_profiles WHERE user_id = (SELECT auth.uid())
  ));
```

2. Push migration to Supabase:
   `npx supabase db push`

3. Verify in Supabase Dashboard:
   - Navigate to Table Editor
   - All 6 tables should show lock icon (RLS enabled)
   - Click any table -> Policies tab should show the policies

4. Test immutability (in Supabase SQL Editor):
   ```sql
   -- This should succeed (if you have an auth.users entry)
   -- INSERT INTO wallet_transactions (user_id, amount_cents, type, balance_after_cents, status)
   -- VALUES ('some-user-id', 1000, 'adjustment', 1000, 'completed');

   -- This should fail with "wallet_transactions table is immutable" error
   -- UPDATE wallet_transactions SET amount_cents = 2000 WHERE id = 'some-id';
   ```
  </action>
  <verify>
- `npx supabase db push` completes without errors
- Supabase Dashboard shows all 6 tables with RLS enabled (lock icon)
- `npx supabase db diff` shows no pending changes (schema in sync)
- In Supabase SQL Editor: Attempting UPDATE on wallet_transactions raises "immutable" exception
  </verify>
  <done>
RLS policies applied to all 6 tables using optimized (SELECT auth.uid()) pattern. Migration pushed to Supabase. Schema is live and ready for use.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `ls supabase/migrations/` shows 20260202000000_v16_schema.sql
2. Supabase Dashboard -> Table Editor shows all 6 tables
3. Each table has lock icon indicating RLS is enabled
4. wallet_transactions UPDATE attempt in SQL Editor fails with immutability error
5. RLS policies appear in each table's Policies tab
</verification>

<success_criteria>
- creator_profiles table exists with social handles (tiktok_handle, instagram_handle, etc.) and follower counts
- deals table exists with compensation_type, tier_required, and status fields using TEXT + CHECK
- deal_enrollments table has UNIQUE(deal_id, user_id) constraint and status tracking
- wallet_transactions uses INTEGER for cents, has balance_after_cents snapshot, and immutability trigger
- affiliate_clicks stores click metadata with referrer, UTM params, and device info
- affiliate_conversions links to originating click via click_id
- RLS policies use (SELECT auth.uid()) pattern for all user-scoped queries
</success_criteria>

<output>
After completion, create `.planning/phases/25-database-foundation/25-01-SUMMARY.md`
</output>
