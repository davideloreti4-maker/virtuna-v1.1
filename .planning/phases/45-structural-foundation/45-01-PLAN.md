---
phase: 45-structural-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/sidebar-store.ts
  - src/app/globals.css
  - src/components/app/sidebar-toggle.tsx
autonomous: true

must_haves:
  truths:
    - "Sidebar collapse state survives page refresh"
    - "Floating toggle button appears in top-left corner when sidebar is hidden"
    - "Toggle button works on both mobile and desktop viewports"
    - "Z-index scale includes sidebar layer between base and dropdown"
  artifacts:
    - path: "src/stores/sidebar-store.ts"
      provides: "Zustand persist store for sidebar open/close state"
      exports: ["useSidebarStore"]
    - path: "src/components/app/sidebar-toggle.tsx"
      provides: "Floating toggle button component"
      exports: ["SidebarToggle"]
    - path: "src/app/globals.css"
      provides: "--z-sidebar CSS custom property in z-index scale"
      contains: "--z-sidebar: 50"
  key_links:
    - from: "src/stores/sidebar-store.ts"
      to: "localStorage"
      via: "Zustand persist middleware"
      pattern: "persist.*virtuna-sidebar"
    - from: "src/components/app/sidebar-toggle.tsx"
      to: "src/stores/sidebar-store.ts"
      via: "useSidebarStore hook"
      pattern: "useSidebarStore"
---

<objective>
Create the sidebar state management store, z-index scale token, and floating toggle button component.

Purpose: Establish the state infrastructure and toggle UI that the sidebar and AppShell will consume in subsequent plans.
Output: `sidebar-store.ts` with Zustand persist, `--z-sidebar` token in globals.css, `SidebarToggle` component.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-structural-foundation/45-RESEARCH.md

@src/stores/society-store.ts
@src/app/globals.css
@src/components/app/mobile-nav.tsx
@src/components/ui/button.tsx
@src/components/ui/icon.tsx
</context>

## v0 Design Output

### Design 2: Sidebar Toggle Button

```tsx
// v0-generated sidebar toggle button (v0-1.5-lg)
// Adapt to use existing Button ghost + Icon primitives

"use client";

import * as React from "react";
import { cn } from "@/lib/utils";

// --- VISIBILITY RULES ---
// On mobile (< 768px): Always visible, as sidebar is off-canvas.
// On desktop (>= 768px): Only visible when the sidebar is collapsed.
// When sidebar is open on desktop: this button is hidden (collapse button inside sidebar is used instead)

type SidebarToggleProps = React.ButtonHTMLAttributes<HTMLButtonElement>;

export const SidebarToggle = React.forwardRef<
  HTMLButtonElement,
  SidebarToggleProps
>(({ className, ...props }, ref) => {
  return (
    <button
      ref={ref}
      aria-label="Open sidebar"
      className={cn(
        // Base styles
        "fixed top-4 left-4 z-50 flex h-9 w-9 items-center justify-center rounded-md border transition-colors",
        // Glass effect
        "border-white/10 bg-black/20 backdrop-blur-lg",
        // Shadow
        "shadow-[0_4px_12px_rgba(0,0,0,0.3)]",
        // Hover & active states
        "hover:bg-white/5 active:bg-white/10",
        // Focus state
        "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/50",
        // Default visibility (always on for mobile, hidden for desktop)
        "flex md:hidden",
        className
      )}
      {...props}
    >
      {/* MenuIcon - 24px, 3 horizontal lines */}
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-white">
        <line x1="4" x2="20" y1="12" y2="12" />
        <line x1="4" x2="20" y1="6" y2="6" />
        <line x1="4" x2="20" y1="18" y2="18" />
      </svg>
    </button>
  );
});

SidebarToggle.displayName = "SidebarToggle";
```

<tasks>

<task type="auto">
  <name>Task 1: Create sidebar Zustand store with persist middleware</name>
  <files>src/stores/sidebar-store.ts</files>
  <action>
Create a new Zustand store file at `src/stores/sidebar-store.ts`. Use the `persist` middleware (NOT the manual `_hydrate()` + `loadFromStorage()` pattern used by existing stores like `society-store.ts`).

The store interface:
```typescript
interface SidebarState {
  isOpen: boolean;
  toggle: () => void;
  open: () => void;
  close: () => void;
}
```

Implementation details:
- Import `create` from `zustand` and `persist` from `zustand/middleware`
- Default `isOpen: true` (sidebar expanded on first visit)
- localStorage key: `'virtuna-sidebar'`
- Do NOT set `skipHydration` — let persist handle hydration automatically. The sidebar uses CSS transitions, so any flash from server default -> persisted state will appear as a smooth animation.
- Export `useSidebarStore` as a named export

Why `persist` instead of manual `_hydrate()`: Zustand persist middleware handles SSR hydration, storage errors, and automatic rehydration without boilerplate. The existing stores use the manual pattern, but research recommends `persist` for new stores.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify the store compiles. Check that `useSidebarStore` is exported and the persist middleware is configured with `'virtuna-sidebar'` key.
  </verify>
  <done>
`sidebar-store.ts` exists with `useSidebarStore` exported, using Zustand `persist` middleware with `'virtuna-sidebar'` localStorage key. Default `isOpen: true`. Actions: `toggle`, `open`, `close`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add --z-sidebar token and create SidebarToggle component</name>
  <files>src/app/globals.css, src/components/app/sidebar-toggle.tsx</files>
  <action>
**Part A: Add z-sidebar to globals.css**

In `src/app/globals.css`, within the `@theme` block under `/* --- Z-Index Scale --- */`, add `--z-sidebar: 50;` between `--z-base: 0;` and `--z-dropdown: 100;`. This establishes the sidebar layer in the z-index scale.

The z-index section should read:
```css
/* --- Z-Index Scale --- */
--z-base: 0;
--z-sidebar: 50;           /* Floating sidebar + toggle */
--z-dropdown: 100;
--z-sticky: 200;
--z-modal-backdrop: 300;
--z-modal: 400;
--z-toast: 500;
--z-tooltip: 600;
```

**Part B: Create SidebarToggle component**

Create `src/components/app/sidebar-toggle.tsx` as a client component that renders a floating toggle button in the top-left corner. Adapt the v0 output to use existing design system primitives:

- Use `Button` component from `@/components/ui/button` with `variant="ghost"` and `size="sm"`
- Use `Icon` component from `@/components/ui/icon` with the `List` icon from `@phosphor-icons/react`
- Wire to `useSidebarStore` — reads `isOpen`, calls `open()` on click
- Position: `fixed left-4 top-4 z-[var(--z-sidebar)]`
- Visibility: Show on mobile always (`flex md:hidden`). On desktop, show only when sidebar is closed (`!isOpen && md:flex`). Use `cn()` to conditionally apply: `isOpen ? "md:hidden" : "md:flex"`
- aria-label: `"Open sidebar"`
- Do NOT add `backdrop-blur` to this button (it's tiny, doesn't need glass effect, and saves a backdrop-filter slot)
- Add subtle glass styling via className: `border border-border bg-surface/80 shadow-md`

The component should NOT use Framer Motion or any animations library — just CSS transitions via Tailwind classes.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify everything compiles. Grep `globals.css` for `--z-sidebar: 50` to confirm the token exists. Verify `SidebarToggle` imports `Button`, `Icon`, and `useSidebarStore`.
  </verify>
  <done>
`--z-sidebar: 50` exists in the z-index scale in globals.css. `SidebarToggle` component exists at `src/components/app/sidebar-toggle.tsx`, uses `Button ghost` + `Icon` + `useSidebarStore`, renders as fixed top-left toggle, hidden when sidebar is open on desktop.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `grep -r "z-sidebar" src/app/globals.css` returns the token
3. `grep -r "useSidebarStore" src/stores/sidebar-store.ts src/components/app/sidebar-toggle.tsx` confirms wiring
4. `grep -r "persist" src/stores/sidebar-store.ts` confirms middleware usage
5. `grep -r "virtuna-sidebar" src/stores/sidebar-store.ts` confirms localStorage key
</verification>

<success_criteria>
- Sidebar store compiles and exports `useSidebarStore` with persist middleware
- Z-index scale in globals.css includes `--z-sidebar: 50`
- SidebarToggle component renders a floating ghost button in top-left, wired to sidebar store
- No TypeScript errors across modified files
</success_criteria>

<output>
After completion, create `.planning/phases/45-structural-foundation/45-01-SUMMARY.md`
</output>
