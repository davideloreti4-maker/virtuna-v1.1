---
phase: 45-structural-foundation
plan: 03
type: execute
wave: 3
depends_on: ["45-01", "45-02"]
files_modified:
  - src/components/app/app-shell.tsx
  - src/components/app/mobile-nav.tsx
autonomous: false

must_haves:
  truths:
    - "Sidebar is always visible on desktop with main content pushed right by 324px"
    - "Collapsing the sidebar smoothly animates both sidebar slide and content push"
    - "On mobile, sidebar overlays content with a dark dimmer behind it"
    - "Hamburger toggle in top-left opens sidebar on mobile"
    - "Max 2 backdrop-filter elements active on mobile at any time"
    - "Collapse state persists across page refresh"
  artifacts:
    - path: "src/components/app/app-shell.tsx"
      provides: "AppShell with sidebar + content push layout"
      exports: ["AppShell"]
    - path: "src/components/app/mobile-nav.tsx"
      provides: "Deleted or emptied — replaced by SidebarToggle"
  key_links:
    - from: "src/components/app/app-shell.tsx"
      to: "src/stores/sidebar-store.ts"
      via: "useSidebarStore for content margin"
      pattern: "useSidebarStore"
    - from: "src/components/app/app-shell.tsx"
      to: "src/components/app/sidebar-toggle.tsx"
      via: "SidebarToggle rendered as sibling"
      pattern: "SidebarToggle"
    - from: "src/components/app/app-shell.tsx"
      to: "src/components/app/sidebar.tsx"
      via: "Sidebar rendered as sibling"
      pattern: "<Sidebar"
---

<objective>
Wire the AppShell to use the sidebar store for content push behavior and integrate the SidebarToggle. Remove the old MobileNav component.

Purpose: Complete the structural layout: desktop content push (324px margin when sidebar open), mobile overlay behavior, and unified toggle button. This is the final integration step.
Output: Updated `app-shell.tsx` with sidebar + content push + toggle, deleted/replaced `mobile-nav.tsx`.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-structural-foundation/45-RESEARCH.md
@.planning/phases/45-structural-foundation/45-01-SUMMARY.md
@.planning/phases/45-structural-foundation/45-02-SUMMARY.md

@src/components/app/app-shell.tsx
@src/components/app/mobile-nav.tsx
@src/components/app/sidebar.tsx
@src/components/app/sidebar-toggle.tsx
@src/stores/sidebar-store.ts
</context>

## v0 Design Output

### Design 3: Full AppShell Layout

```tsx
// v0-generated AppShell layout (v0-1.5-lg)
// Shows desktop open, desktop collapsed, and mobile overlay states

'use client'

import { useState } from 'react'

// Desktop with sidebar open: content pushed right by 324px
// Sidebar: fixed top-3 left-3 bottom-3, 300px wide, glass effect
// Main: margin-left 324px (300 + 12 + 12), transition 300ms cubic-bezier

// Desktop collapsed:
// Sidebar: translateX(-calc(100% + 12px)) — off screen
// Main: margin-left 0 (full width)
// Toggle button: fixed top-4 left-4, 36px, glass

// Mobile:
// Sidebar: same position but overlays content (no margin push)
// Overlay: fixed inset-0, bg-black/50, NO backdrop-filter
// Toggle: always visible on mobile (hamburger)

export function AppShell({ children }: { children: React.ReactNode }) {
  const [isSidebarOpen, setIsSidebarOpen] = useState(true);

  return (
    <div className="flex h-screen bg-[#07080a]">
      {/* Toggle button (mobile always, desktop when collapsed) */}
      <button
        onClick={() => setIsSidebarOpen(true)}
        className={cn(
          "fixed left-4 top-4 z-50 flex h-9 w-9 items-center justify-center rounded-md",
          "border border-white/10 bg-black/20 backdrop-blur-lg shadow-md",
          "hover:bg-white/5 active:bg-white/10",
          isSidebarOpen ? "md:hidden" : "flex",
        )}
        aria-label="Open sidebar"
      >
        <MenuIcon className="h-6 w-6 text-white" />
      </button>

      {/* Mobile overlay - NO backdrop-filter */}
      {isSidebarOpen && (
        <div
          className="fixed inset-0 z-[49] bg-black/50 md:hidden"
          onClick={() => setIsSidebarOpen(false)}
          aria-hidden="true"
        />
      )}

      {/* Sidebar */}
      <aside
        className={cn(
          "fixed top-3 left-3 bottom-3 z-50 w-[300px] flex flex-col",
          "rounded-xl border border-white/[.08] bg-[#18191c]/60 backdrop-blur-[20px]",
          "shadow-[0_8px_32px_rgba(0,0,0,0.2),inset_0_1px_0_rgba(255,255,255,0.1)]",
          "transition-transform duration-300 ease-[cubic-bezier(0.215,0.61,0.355,1)]",
          isSidebarOpen ? "translate-x-0" : "-translate-x-[calc(100%+12px)]",
        )}
      >
        {/* Header with collapse button */}
        <div className="flex items-center justify-between px-4 pt-4 pb-1">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" className="text-white">
            <path d="M6.5 3L12 12L17.5 3H22L12 21L2 3H6.5Z" fill="currentColor" />
          </svg>
          <button
            onClick={() => setIsSidebarOpen(false)}
            className="text-[#848586] hover:text-white"
          >
            <XIcon className="h-5 w-5" />
          </button>
        </div>
        {/* ... sidebar content ... */}
      </aside>

      {/* Main content with push behavior */}
      <main
        className={cn(
          "flex-1 overflow-auto",
          "transition-[margin-left] duration-300 ease-[cubic-bezier(0.215,0.61,0.355,1)]",
          isSidebarOpen ? "md:ml-[324px]" : "md:ml-0",
          "ml-0", // No push on mobile
        )}
      >
        {children}
      </main>
    </div>
  );
}
```

<tasks>

<task type="auto">
  <name>Task 1: Rewrite AppShell with sidebar store and content push</name>
  <files>src/components/app/app-shell.tsx, src/components/app/mobile-nav.tsx</files>
  <action>
**Part A: Rewrite app-shell.tsx**

Rewrite `src/components/app/app-shell.tsx` to integrate the sidebar store, SidebarToggle, and content push behavior. Adapt from the v0 design output:

1. **Remove** the `useState(false)` for `mobileMenuOpen` — state now lives in `useSidebarStore`
2. **Remove** the `<MobileNav>` import and usage — replaced by `<SidebarToggle>`
3. **Add imports**:
   - `useSidebarStore` from `@/stores/sidebar-store`
   - `SidebarToggle` from `./sidebar-toggle`
   - `Sidebar` from `./sidebar` (keep existing)
   - `AuthGuard` from `./auth-guard` (keep existing)
   - `cn` from `@/lib/utils`
4. **Read sidebar state**: `const isOpen = useSidebarStore((s) => s.isOpen);`
5. **Remove props from Sidebar**: The `<Sidebar />` component no longer takes `mobileOpen` or `onMobileOpenChange` props (it reads from store directly)
6. **Layout structure**:
   ```tsx
   <AuthGuard>
     <div className="flex h-screen bg-background">
       <SidebarToggle />
       <Sidebar />
       <main
         className={cn(
           "flex-1 overflow-auto",
           "transition-[margin-left] duration-300 ease-[var(--ease-out-cubic)]",
           isOpen ? "md:ml-[324px]" : "md:ml-0",
           "ml-0",
         )}
       >
         {children}
       </main>
     </div>
   </AuthGuard>
   ```
7. **Key details**:
   - Main content uses `transition-[margin-left]` with `duration-300` and `ease-[var(--ease-out-cubic)]` (same timing as sidebar translateX)
   - Desktop push: `isOpen ? "md:ml-[324px]" : "md:ml-0"` — 324px = 300px sidebar + 12px left inset + 12px gap
   - Mobile: always `ml-0` (no push, sidebar overlays)
   - Background: use `bg-background` design token instead of hardcoded `bg-[#0A0A0A]`
   - The `SidebarToggle` renders OUTSIDE the sidebar, as a sibling in the AppShell. This ensures it's always reachable even when sidebar is hidden.

**Part B: Remove mobile-nav.tsx**

Replace the contents of `src/components/app/mobile-nav.tsx` with a deprecation re-export or empty the file. The simplest approach: replace the entire file contents with:

```tsx
// mobile-nav.tsx - DEPRECATED
// Replaced by SidebarToggle in Phase 45.
// This file is kept to avoid breaking any stale imports.
// TODO: Remove this file once all imports are updated.

export { SidebarToggle as MobileNav } from "./sidebar-toggle";
```

This ensures any stale imports of `MobileNav` from other files still work by re-exporting `SidebarToggle`. The `app-shell.tsx` itself no longer imports `MobileNav`.

**Why this approach**: The v0 design uses inline state management (`useState`), but we adapt it to use the Zustand persist store. The v0 design uses raw HTML elements, but we use `GlassPanel`, `Button`, and `SidebarToggle` components. The core layout pattern (fixed sidebar + margin-left push + CSS transitions) matches the v0 output exactly.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify compilation. Run the dev server (`pnpm dev`) and check:
1. Desktop: Sidebar is visible, main content is pushed right
2. Click collapse button in sidebar: sidebar slides left, content expands
3. Click floating toggle button: sidebar slides back, content pushes right
4. Resize to mobile: sidebar hidden, hamburger visible
5. Click hamburger: overlay + sidebar appear
6. Click overlay: sidebar closes
  </verify>
  <done>
AppShell renders sidebar + main content with 324px left margin push on desktop. Collapse/expand animated with 300ms ease-out-cubic. Mobile shows overlay without backdrop-filter. SidebarToggle replaces MobileNav. Collapse state persists across refresh.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of complete sidebar layout</name>
  <what-built>
Complete floating glassmorphic sidebar with:
- GlassPanel floating panel (300px, inset 12px, blur, border)
- New nav items (Content Intelligence, Trending Feed, Brand Deals)
- SocietySelector and ViewSelector removed
- Collapse button + floating toggle button
- Content push on desktop (324px margin)
- Mobile overlay (bg-black/50, no backdrop-filter)
- Persist collapse state across refresh
  </what-built>
  <how-to-verify>
1. Open `http://localhost:3000/dashboard` in Chrome
2. **Desktop open state**: Sidebar visible as floating glass panel with gap from edges. Content pushed right. Nav items show icon-left, label-right layout.
3. **Desktop collapse**: Click collapse button (top-right of sidebar). Sidebar slides left smoothly. Content expands to full width. Small toggle button appears top-left.
4. **Desktop re-open**: Click the toggle button. Sidebar slides back. Content pushes right again.
5. **Persist**: Collapse the sidebar. Refresh the page. Sidebar should still be collapsed.
6. **Mobile overlay**: Resize browser below 768px. Sidebar hidden. Click hamburger. Dark overlay + sidebar appear. Tap overlay to close.
7. **Glass effect**: Verify sidebar has visible blur effect and subtle border glow
8. **Performance**: Open/close sidebar animation should be smooth (no jank)
9. **Nav items**: Verify "Content Intelligence", "Trending Feed", "Brand Deals" appear with Phosphor icons
10. **Test history**: Scroll test history — should be contained within sidebar
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `pnpm dev` starts without errors
3. Desktop: Sidebar visible at 300px, content at 324px margin-left
4. Collapse/expand: Smooth 300ms animation on both sidebar and content
5. Mobile: Overlay is bg-black/50 only (no backdrop-filter)
6. Persist: Collapse survives page refresh
7. `grep -r "MobileNav" src/components/app/app-shell.tsx` returns nothing (removed)
8. `grep -r "useSidebarStore" src/components/app/app-shell.tsx` confirms store usage
</verification>

<success_criteria>
- AppShell renders with content push (324px margin-left when sidebar open on desktop)
- Content push and sidebar slide animate synchronously at 300ms ease-out-cubic
- Mobile: sidebar overlays with bg-black/50 overlay (no backdrop-filter)
- SidebarToggle visible on mobile always, on desktop only when collapsed
- MobileNav replaced/deprecated
- Collapse state persists across page refresh via Zustand persist
- Max 2 backdrop-filter elements on mobile (sidebar GlassPanel only)
- Human-verified visual quality
</success_criteria>

<output>
After completion, create `.planning/phases/45-structural-foundation/45-03-SUMMARY.md`
</output>
