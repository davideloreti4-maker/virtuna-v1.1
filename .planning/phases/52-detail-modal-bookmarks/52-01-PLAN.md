---
phase: 52-detail-modal-bookmarks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/bookmark-store.ts
  - src/hooks/use-modal-keyboard-nav.ts
autonomous: true

must_haves:
  truths:
    - "Bookmark state persists across page reloads via localStorage"
    - "Arrow keys navigate prev/next video when modal is open"
  artifacts:
    - path: "src/stores/bookmark-store.ts"
      provides: "Zustand bookmark store with localStorage persistence"
      exports: ["useBookmarkStore"]
    - path: "src/hooks/use-modal-keyboard-nav.ts"
      provides: "Keyboard navigation hook for modal context"
      exports: ["useModalKeyboardNav"]
  key_links:
    - from: "src/stores/bookmark-store.ts"
      to: "localStorage"
      via: "_hydrate() on client mount"
      pattern: "localStorage\\.(get|set)Item"
---

<objective>
Create the bookmark store and keyboard navigation hook as foundation pieces for the detail modal.

Purpose: Establish state management and interaction patterns before building the modal UI.
Output: Two reusable modules - bookmark store with localStorage persistence and arrow key navigation hook.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-detail-modal-bookmarks/52-RESEARCH.md

# Existing store pattern to follow
@src/stores/settings-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bookmark store with localStorage persistence</name>
  <files>src/stores/bookmark-store.ts</files>
  <action>
Create a Zustand store following the established pattern in settings-store.ts.

**Interface:**
```typescript
interface BookmarkState {
  bookmarkedIds: Set<string>;
  _isHydrated: boolean;
  _hydrate: () => void;
  toggleBookmark: (videoId: string) => void;
  isBookmarked: (videoId: string) => boolean;
  getBookmarkedIds: () => string[];
}
```

**Implementation details:**
- Storage key: "virtuna-bookmarks"
- Convert Set to Array for JSON serialization (JSON.stringify doesn't serialize Sets)
- loadFromStorage returns string[] | null, hydrate converts to Set
- saveToStorage takes Array.from(set)
- toggleBookmark: add if not present, remove if present, then save
- isBookmarked: return get().bookmarkedIds.has(videoId)
- getBookmarkedIds: return Array.from(get().bookmarkedIds) - for Saved tab filtering
- Follow the _isHydrated flag pattern for SSR safety

**Critical:** Do NOT use Zustand persist middleware - follow the manual localStorage pattern established in settings-store.ts for explicit hydration control in Next.js.
  </action>
  <verify>
TypeScript compiles without errors: `pnpm exec tsc --noEmit`
  </verify>
  <done>
bookmark-store.ts exports useBookmarkStore with toggleBookmark, isBookmarked, getBookmarkedIds, and _hydrate methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create modal keyboard navigation hook</name>
  <files>src/hooks/use-modal-keyboard-nav.ts</files>
  <action>
Create a custom hook for arrow key navigation when modal is open.

**Interface:**
```typescript
interface UseModalKeyboardNavOptions {
  isOpen: boolean;
  onPrevious: () => void;
  onNext: () => void;
  hasPrevious: boolean;
  hasNext: boolean;
}

export function useModalKeyboardNav(options: UseModalKeyboardNavOptions): void
```

**Implementation details:**
- Attach window-level keydown listener only when isOpen is true
- Handle ArrowLeft (if hasPrevious, call onPrevious)
- Handle ArrowRight (if hasNext, call onNext)
- Call event.preventDefault() to stop default behavior
- Check if event target is within an iframe (skip if so - avoid TikTok player conflicts)
- Use useCallback for the handler to stabilize dependencies
- Clean up listener in useEffect return

**Skip handling:**
- Escape key (Radix Dialog already handles this)
- Tab key (Radix Dialog already handles focus trap)

**iframe check pattern:**
```typescript
const target = event.target as HTMLElement;
if (target.tagName === 'IFRAME' || target.closest('iframe')) return;
```
  </action>
  <verify>
TypeScript compiles without errors: `pnpm exec tsc --noEmit`
  </verify>
  <done>
use-modal-keyboard-nav.ts exports useModalKeyboardNav hook that attaches arrow key listeners when modal is open.
  </done>
</task>

</tasks>

<verification>
1. `pnpm exec tsc --noEmit` passes without errors
2. Bookmark store file exists at src/stores/bookmark-store.ts
3. Keyboard nav hook file exists at src/hooks/use-modal-keyboard-nav.ts
4. Both files export their main functions
</verification>

<success_criteria>
- Bookmark store matches established Zustand pattern (manual localStorage, _isHydrated flag)
- Keyboard hook handles ArrowLeft/ArrowRight only when modal is open
- No new dependencies added (uses existing zustand, react)
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/52-detail-modal-bookmarks/52-01-SUMMARY.md`
</output>
