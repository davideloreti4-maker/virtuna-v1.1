---
phase: 53-foundation-tab-shell
plan: 02
type: execute
wave: 2
depends_on: ["53-01"]
files_modified:
  - src/app/(app)/brand-deals/page.tsx
  - src/components/app/brand-deals/index.ts
  - src/components/app/brand-deals/brand-deals-page.tsx
  - src/components/app/brand-deals/brand-deals-header.tsx
  - src/components/app/brand-deals/brand-deals-tabs.tsx
  - src/components/app/sidebar.tsx
  - src/components/app/sidebar-nav-item.tsx
autonomous: false

must_haves:
  truths:
    - "Navigating to /brand-deals renders a page with three tabs (Deals / Affiliates / Earnings) and placeholder content in each"
    - "Clicking a tab updates the URL search param (?tab=deals); browser back/forward navigates between tabs correctly"
    - "Default tab is Earnings when visiting /brand-deals without a ?tab param"
    - "Sliding pill indicator animates smoothly between tabs on click"
    - "Page header shows title and tab-contextual summary stats"
    - "Sidebar Brand Deals nav item is highlighted when on /brand-deals and navigates to the page on click"
    - "Sidebar badge shows new deals count on the Brand Deals nav item"
  artifacts:
    - path: "src/app/(app)/brand-deals/page.tsx"
      provides: "Server component route for /brand-deals"
      exports: ["default (BrandDeals page)"]
    - path: "src/components/app/brand-deals/brand-deals-page.tsx"
      provides: "Client component orchestrating tabs, header, and URL sync"
      exports: ["BrandDealsPage"]
    - path: "src/components/app/brand-deals/brand-deals-header.tsx"
      provides: "Page header with title and tab-contextual stats"
      exports: ["BrandDealsHeader"]
    - path: "src/components/app/brand-deals/brand-deals-tabs.tsx"
      provides: "Pill/segment tab control with sliding Motion indicator"
      exports: ["BrandDealsTabs"]
    - path: "src/components/app/brand-deals/index.ts"
      provides: "Barrel export for brand-deals components"
      exports: ["BrandDealsPage"]
    - path: "src/components/app/sidebar.tsx"
      provides: "Updated sidebar with usePathname routing for Brand Deals"
      contains: "usePathname"
    - path: "src/components/app/sidebar-nav-item.tsx"
      provides: "Nav item with optional badge prop"
      contains: "badge"
  key_links:
    - from: "src/app/(app)/brand-deals/page.tsx"
      to: "src/components/app/brand-deals/brand-deals-page.tsx"
      via: "import and render BrandDealsPage with defaultTab prop"
      pattern: "import.*BrandDealsPage.*from"
    - from: "src/components/app/brand-deals/brand-deals-page.tsx"
      to: "src/types/brand-deals.ts"
      via: "import ValidTab type"
      pattern: "import.*from.*types/brand-deals"
    - from: "src/components/app/brand-deals/brand-deals-page.tsx"
      to: "window.history.pushState"
      via: "shallow URL sync on tab change"
      pattern: "window\\.history\\.pushState"
    - from: "src/components/app/brand-deals/brand-deals-tabs.tsx"
      to: "motion/react"
      via: "layoutId for sliding pill animation"
      pattern: "layoutId.*brand-deals-tab-pill"
    - from: "src/components/app/sidebar.tsx"
      to: "src/app/(app)/brand-deals/page.tsx"
      via: "router.push('/brand-deals') on Brand Deals nav click"
      pattern: "router\\.push.*brand-deals"
---

<objective>
Build the Brand Deals page with three-tab navigation (pill/segment control with sliding indicator), URL sync, page header with tab-contextual stats, and sidebar routing integration.

Purpose: This is the main UI deliverable of Phase 53 -- the page shell that Phases 54-56 will populate with tab content.
Output: Working `/brand-deals` route with animated tab navigation, header stats, placeholder tab content, and sidebar wiring.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/53-foundation-tab-shell/53-RESEARCH.md
@.planning/phases/53-foundation-tab-shell/53-CONTEXT.md
@.planning/phases/53-foundation-tab-shell/53-01-SUMMARY.md

# Critical source files to follow
@src/app/(app)/settings/page.tsx
@src/components/app/settings/settings-page.tsx
@src/components/app/settings/index.ts
@src/components/app/sidebar.tsx
@src/components/app/sidebar-nav-item.tsx
@src/app/(app)/layout.tsx

# Types and mock data from Plan 01
@src/types/brand-deals.ts
@src/lib/mock-brand-deals.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Brand Deals page route, client component, header, and tab control</name>
  <files>
    src/app/(app)/brand-deals/page.tsx
    src/components/app/brand-deals/index.ts
    src/components/app/brand-deals/brand-deals-page.tsx
    src/components/app/brand-deals/brand-deals-header.tsx
    src/components/app/brand-deals/brand-deals-tabs.tsx
  </files>
  <action>
**1. Server component: `src/app/(app)/brand-deals/page.tsx`**

Follow the Settings page pattern exactly (`src/app/(app)/settings/page.tsx`):
- Export Metadata: title "Brand Deals | Virtuna", description "Manage brand deals, affiliate links, and earnings"
- Interface `PageProps { searchParams: Promise<{ tab?: string }> }`
- `VALID_TABS = ["earnings", "deals", "affiliates"] as const` (earnings FIRST -- it's the default)
- Type `ValidTab = (typeof VALID_TABS)[number]`
- Async default export awaits searchParams, validates tab, defaults to "earnings"
- Renders `<BrandDealsPage defaultTab={defaultTab} />`

**2. Client component: `src/components/app/brand-deals/brand-deals-page.tsx`**

"use client" directive. This is the main orchestrator.

Props: `{ defaultTab: ValidTab }` where ValidTab is "earnings" | "deals" | "affiliates"

URL sync pattern (from RESEARCH.md Pattern 2):
- Import `useSearchParams` from "next/navigation"
- Derive `currentTab` from `searchParams.get("tab")`, falling back to `defaultTab`
- `handleTabChange(value: string)` creates new URLSearchParams, sets "tab", calls `window.history.pushState(null, "", `?${params.toString()}`)`
- Use `Tabs.Root` from `@radix-ui/react-tabs` in CONTROLLED mode: `value={currentTab}` and `onValueChange={handleTabChange}`
- Do NOT use `defaultValue` -- controlled mode only

Layout structure:
```
<div className="mx-auto max-w-5xl p-6">
  <BrandDealsHeader activeTab={currentTab} />
  <Tabs.Root value={currentTab} onValueChange={handleTabChange}>
    <BrandDealsTabs activeTab={currentTab} />
    <div className="mt-6">
      <AnimatePresence mode="wait">
        <motion.div
          key={currentTab}
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          transition={{ duration: 0.15 }}
        >
          <Tabs.Content value="earnings" forceMount={currentTab === "earnings" ? true : undefined}>
            {/* Placeholder: "Earnings content coming in Phase 56" */}
          </Tabs.Content>
          <Tabs.Content value="deals" forceMount={currentTab === "deals" ? true : undefined}>
            {/* Placeholder: "Deals content coming in Phase 54" */}
          </Tabs.Content>
          <Tabs.Content value="affiliates" forceMount={currentTab === "affiliates" ? true : undefined}>
            {/* Placeholder: "Affiliates content coming in Phase 55" */}
          </Tabs.Content>
        </motion.div>
      </AnimatePresence>
    </div>
  </Tabs.Root>
</div>
```

Import `AnimatePresence`, `motion` from "motion/react". Placeholder content for each tab should be a centered muted text string like "Earnings tab content -- Phase 56" using design system `Text` component with `text-foreground-muted`, inside a `min-h-[300px] flex items-center justify-center rounded-xl border border-border-subtle` container.

**3. Header component: `src/components/app/brand-deals/brand-deals-header.tsx`**

Props: `{ activeTab: "earnings" | "deals" | "affiliates" }`

Layout: flex row, title on left, stats on right. Use a subtle glass background (GlassPanel with blur="sm", opacity={0.3}, tint="neutral") for the header area. This counts as 1 of the 2-3 glass layers budget.

Title: Use design system `Heading` component (or h1 with appropriate classes): "Brand Deals" as main title. Subtitle below: "Manage your partnerships, links, and earnings" using `Text` with `text-foreground-muted`.

Tab-contextual stats (right side, row of 3 small stat items):
- Earnings tab: "Total Earned: $12,450" | "Pending: $1,850" | "Paid Out: $10,600"
- Deals tab: "Active Deals: 7" | "New This Week: 3" | "Applied: 2"
- Affiliates tab: "Active Links: 4" | "Total Clicks: 5,525" | "Total Earned: $2,500"

Stats should be simple label + value pairs. Label in `text-foreground-muted text-xs uppercase tracking-wider`. Value in `text-foreground text-lg font-semibold`. Format numbers with `Intl.NumberFormat("en-US")` and currency with `Intl.NumberFormat("en-US", { style: "currency", currency: "USD", minimumFractionDigits: 0 })`.

Import mock data constants from `@/lib/mock-brand-deals` to compute stat values (or hardcode for now since they're tab-contextual summary stats -- derive from mock data where possible).

**4. Tab control: `src/components/app/brand-deals/brand-deals-tabs.tsx`**

Props: `{ activeTab: string }` (receives from Tabs.Root context, but also as explicit prop for the sliding pill)

This is a Radix `Tabs.List` wrapper with pill/segment control styling:
- Container: `flex items-center gap-1 rounded-full bg-surface-elevated/50 p-1 border border-border-subtle` (dark segmented control look)
- Three `Tabs.Trigger` elements for "Earnings", "Deals", "Affiliates"
- Each trigger: `relative px-4 py-1.5 text-sm font-medium rounded-full transition-colors z-10`
- Inactive: `text-foreground-muted hover:text-foreground-secondary`
- Active: `text-foreground` (the pill background provides the active visual)

Sliding pill animation using Motion `layoutId` (from RESEARCH.md Pattern 3):
- Inside each Tabs.Trigger, conditionally render a `motion.div` with `layoutId="brand-deals-tab-pill"` ONLY when that tab is active
- Pill styles: `absolute inset-0 rounded-full bg-white/10 border border-white/10`
- Transition: `{ type: "spring", stiffness: 400, damping: 30 }`
- The pill div is `z-0`, the label span is `relative z-10`

Import `motion` from "motion/react". Import `* as Tabs` from "@radix-ui/react-tabs".

Tab labels with icons (use Phosphor icons):
- Earnings: CurrencyDollar icon + "Earnings"
- Deals: Handshake icon + "Deals"
- Affiliates: Link icon + "Affiliates"

**5. Barrel export: `src/components/app/brand-deals/index.ts`**

Follow settings pattern: `export { BrandDealsPage } from "./brand-deals-page";`
  </action>
  <verify>
1. Run `npx tsc --noEmit` -- no type errors
2. Run `pnpm build` (or `npm run build`) -- no build errors
3. Run `pnpm dev` and navigate to `http://localhost:3000/brand-deals` -- page renders
4. Click each tab -- URL updates to `?tab=earnings`, `?tab=deals`, `?tab=affiliates`
5. Use browser back/forward buttons -- tabs navigate correctly
6. Default URL `/brand-deals` (no ?tab param) shows Earnings tab
  </verify>
  <done>
Page renders at /brand-deals with three pill-style tabs. Clicking tabs updates URL search params. Browser back/forward navigates between tabs. Sliding pill animates between active tabs. Header shows tab-contextual stats. Default tab is Earnings. Placeholder content shows in each tab panel.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire sidebar Brand Deals navigation with routing and badge</name>
  <files>
    src/components/app/sidebar.tsx
    src/components/app/sidebar-nav-item.tsx
  </files>
  <action>
**1. Update SidebarNavItem to support optional badge**

Edit `src/components/app/sidebar-nav-item.tsx`:
- Add `badge?: number` to the `SidebarNavItemProps` interface
- When `badge` is defined and > 0, render a small badge after the label text
- Badge styling: `ml-auto flex h-5 min-w-5 items-center justify-center rounded-full bg-coral/20 text-coral text-xs font-medium px-1.5` (coral accent for new deals count)
- If the Badge component from `src/components/ui/badge.tsx` has a suitable small variant, use it. Otherwise, inline the badge as a span.

**2. Update Sidebar to use usePathname for Brand Deals routing**

Edit `src/components/app/sidebar.tsx`:
- Add `import { usePathname } from "next/navigation";` (useRouter is already imported)
- Add `const pathname = usePathname();` inside the Sidebar component
- Change the nav items rendering to handle Brand Deals specially:

For the navItems.map section, update the logic:
```tsx
{navItems.map((item) => {
  // Brand Deals has a real route
  if (item.id === "brand-deals") {
    return (
      <SidebarNavItem
        key={item.id}
        icon={item.icon}
        label={item.label}
        isActive={pathname.startsWith("/brand-deals")}
        onClick={() => router.push("/brand-deals")}
        badge={3}
      />
    );
  }
  // Other items keep existing useState behavior
  return (
    <SidebarNavItem
      key={item.id}
      icon={item.icon}
      label={item.label}
      isActive={activeNav === item.id}
      onClick={() => setActiveNav(item.id)}
    />
  );
})}
```

This is the hybrid approach from RESEARCH.md: `usePathname()` for routed items (Brand Deals), `useState` for non-routed items (Content Intelligence, Trending Feed). Route-based active state takes precedence.

Important: When `pathname.startsWith("/brand-deals")` is true, the `activeNav` useState should NOT show any other item as active. Add logic so that non-routed items' `isActive` check also considers whether a routed page is active: `isActive={activeNav === item.id && !pathname.startsWith("/brand-deals")}`.
  </action>
  <verify>
1. Run `npx tsc --noEmit` -- no type errors
2. Navigate to `/brand-deals` -- sidebar "Brand Deals" item is highlighted (filled icon, active background)
3. Badge with "3" appears next to "Brand Deals" label in coral accent
4. Navigate to `/dashboard` -- "Content Intelligence" is highlighted, "Brand Deals" is not
5. Click "Brand Deals" in sidebar -- navigates to `/brand-deals` route
6. Other nav items (Content Intelligence, Trending Feed) still work as before with their active states
  </verify>
  <done>
Sidebar "Brand Deals" nav item navigates to /brand-deals on click, shows active state when on that route (usePathname-based), displays a coral badge with count "3". Other nav items retain existing useState active behavior without regression.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Brand Deals page with three-tab navigation, URL sync, animated sliding pill, header with contextual stats, and sidebar integration.
  </what-built>
  <how-to-verify>
1. Open http://localhost:3000/brand-deals
2. Verify the page renders with "Brand Deals" title, subtitle, and three stats in the header
3. Verify three pill-style tabs: Earnings (default/active), Deals, Affiliates
4. Click "Deals" tab -- verify:
   - Pill slides smoothly from Earnings to Deals
   - URL updates to `?tab=deals`
   - Header stats change to deals context (Active Deals, New This Week, Applied)
   - Placeholder content shows "Deals" reference text
5. Click "Affiliates" tab -- same checks (URL: ?tab=affiliates, stats update, pill slides)
6. Use browser back button -- should return to Deals tab, then Earnings
7. Use browser forward button -- should navigate forward through tab history
8. Open sidebar -- verify "Brand Deals" is highlighted with coral badge showing "3"
9. Navigate away (click "Content Intelligence") -- verify Brand Deals loses active state
10. Click "Brand Deals" in sidebar -- navigates back to /brand-deals with Earnings as default tab
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `pnpm build` succeeds
3. `/brand-deals` route renders with three tabs and header
4. Tab clicks update URL search params
5. Browser back/forward navigates between tabs
6. Default tab is Earnings (no ?tab param)
7. Sliding pill animates between tabs
8. Header stats change per active tab
9. Sidebar Brand Deals item routes to /brand-deals with active state
10. Sidebar badge shows count in coral accent
11. No regressions on other sidebar nav items
</verification>

<success_criteria>
- /brand-deals page exists with three working tabs
- URL sync works (pushState, not router.push)
- Browser back/forward navigates tabs
- Pill/segment control with Motion sliding animation
- Header shows tab-contextual summary stats
- Sidebar navigates to /brand-deals with active state and badge
- No TypeScript errors, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/53-foundation-tab-shell/53-02-SUMMARY.md`
</output>
