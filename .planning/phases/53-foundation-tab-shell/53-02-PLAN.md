---
phase: 53-foundation-tab-shell
plan: 02
type: execute
wave: 2
depends_on: ["53-01"]
files_modified:
  - src/app/(app)/brand-deals/page.tsx
  - src/components/app/brand-deals/index.ts
  - src/components/app/brand-deals/brand-deals-page.tsx
  - src/components/app/brand-deals/brand-deals-header.tsx
  - src/components/app/brand-deals/brand-deals-tabs.tsx
  - src/components/app/sidebar.tsx
  - src/components/app/sidebar-nav-item.tsx
autonomous: false

must_haves:
  truths:
    - "Navigating to /brand-deals renders a page with three tabs (Deals / Affiliates / Earnings) and placeholder content in each"
    - "Clicking a tab updates the URL search param (?tab=deals); browser back/forward navigates between tabs correctly"
    - "Default tab is Earnings when visiting /brand-deals without a ?tab param"
    - "Sliding pill indicator animates smoothly between tabs on click"
    - "Page header shows title and tab-contextual summary stats"
    - "Sidebar Brand Deals nav item is highlighted when on /brand-deals and navigates to the page on click"
    - "Sidebar badge shows new deals count on the Brand Deals nav item"
  artifacts:
    - path: "src/app/(app)/brand-deals/page.tsx"
      provides: "Server component route for /brand-deals"
      exports: ["default (BrandDeals page)"]
    - path: "src/components/app/brand-deals/brand-deals-page.tsx"
      provides: "Client component orchestrating tabs, header, and URL sync"
      exports: ["BrandDealsPage"]
    - path: "src/components/app/brand-deals/brand-deals-header.tsx"
      provides: "Page header with title and tab-contextual stats"
      exports: ["BrandDealsHeader"]
    - path: "src/components/app/brand-deals/brand-deals-tabs.tsx"
      provides: "Pill/segment tab control with sliding Motion indicator"
      exports: ["BrandDealsTabs"]
    - path: "src/components/app/brand-deals/index.ts"
      provides: "Barrel export for brand-deals components"
      exports: ["BrandDealsPage"]
    - path: "src/components/app/sidebar.tsx"
      provides: "Updated sidebar with usePathname routing for Brand Deals"
      contains: "usePathname"
    - path: "src/components/app/sidebar-nav-item.tsx"
      provides: "Nav item with optional badge prop"
      contains: "badge"
  key_links:
    - from: "src/app/(app)/brand-deals/page.tsx"
      to: "src/components/app/brand-deals/brand-deals-page.tsx"
      via: "import and render BrandDealsPage with defaultTab prop"
      pattern: "import.*BrandDealsPage.*from"
    - from: "src/components/app/brand-deals/brand-deals-page.tsx"
      to: "src/types/brand-deals.ts"
      via: "import ValidTab type"
      pattern: "import.*from.*types/brand-deals"
    - from: "src/components/app/brand-deals/brand-deals-page.tsx"
      to: "window.history.pushState"
      via: "shallow URL sync on tab change"
      pattern: "window\\.history\\.pushState"
    - from: "src/components/app/brand-deals/brand-deals-tabs.tsx"
      to: "motion/react"
      via: "layoutId for sliding pill animation"
      pattern: "layoutId.*brand-deals-tab-pill"
    - from: "src/components/app/sidebar.tsx"
      to: "src/app/(app)/brand-deals/page.tsx"
      via: "router.push('/brand-deals') on Brand Deals nav click"
      pattern: "router\\.push.*brand-deals"
---

<objective>
Build the Brand Deals page with three-tab navigation (pill/segment control with sliding indicator), URL sync, page header with tab-contextual stats, and sidebar routing integration. Visual components are generated via v0 MCP with Brand Bible context, then integrated with functional wiring (Radix Tabs, pushState URL sync, Motion layoutId).

Purpose: This is the main UI deliverable of Phase 53 -- the page shell that Phases 54-56 will populate with tab content.
Output: Working `/brand-deals` route with animated tab navigation, header stats, placeholder tab content, and sidebar wiring.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/BRAND-BIBLE.md
@.planning/phases/53-foundation-tab-shell/53-RESEARCH.md
@.planning/phases/53-foundation-tab-shell/53-CONTEXT.md
@.planning/phases/53-foundation-tab-shell/53-01-SUMMARY.md

# Critical source files to follow
@src/app/(app)/settings/page.tsx
@src/components/app/settings/settings-page.tsx
@src/components/app/settings/index.ts
@src/components/app/sidebar.tsx
@src/components/app/sidebar-nav-item.tsx
@src/app/(app)/layout.tsx

# Types and mock data from Plan 01
@src/types/brand-deals.ts
@src/lib/mock-brand-deals.ts

# Design system primitives (for v0 prompt context)
@src/components/primitives/GlassPanel.tsx
@src/components/primitives/GlassPill.tsx
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate visual components with v0 MCP (BrandDealsTabs + BrandDealsHeader)</name>
  <files>
    src/components/app/brand-deals/brand-deals-tabs.tsx
    src/components/app/brand-deals/brand-deals-header.tsx
  </files>
  <action>
Use v0 MCP (`mcp__v0__v0_generate_ui`) to generate the two visual components. Make TWO v0 calls -- one for the tab control, one for the header.

**IMPORTANT: Before prompting v0**, read the Brand Bible at `.planning/BRAND-BIBLE.md` and include the relevant sections (Color System, Typography, Glassmorphism, Spacing) in each v0 prompt. The tokens below are the correct values -- do NOT deviate from them.

**v0 Call 1: BrandDealsTabs (pill/segment tab control)**

Prompt v0 with:

```
Create a React "BrandDealsTabs" component — a pill/segment tab control inspired by Raycast's segmented control.

Design system context (Virtuna Brand Bible):
- Dark theme, dark-mode only
- Background: #07080a (page), Surface: #18191c (cards), Surface-elevated: #222326 (popovers)
- Text primary: near-white (gray-50), Text secondary: #9c9c9d (gray-400), Text muted: #6a6b6c (gray-500)
- Borders: rgba(255,255,255,0.08)
- Accent: Coral #FF7F50 (use sparingly — NOT for the pill background, reserved for primary CTAs only)
- Font: Satoshi (font-sans) for body/UI text, 14px medium weight for tab labels
- Border radius: full (9999px) for pills
- Spacing: 4px base unit

Use these Tailwind token classes (defined in the project's theme):
- Backgrounds: bg-background, bg-surface, bg-surface-elevated
- Text: text-foreground, text-foreground-secondary, text-foreground-muted
- Borders: border-border, border-border-subtle
- Accent: text-accent, bg-accent (coral)

Visual requirements:
- Container: rounded-full bg-surface-elevated/50 with border-border-subtle, p-1 inner padding
- Three tabs: "Earnings", "Deals", "Affiliates"
- Each tab has an icon on the left and label text
  - Earnings: dollar/currency icon
  - Deals: handshake icon
  - Affiliates: link/chain icon
- Active tab: text-foreground with a sliding pill background (bg-white/10 with border border-white/10)
- Inactive tabs: text-foreground-muted, hover:text-foreground-secondary
- The active pill slides smoothly between tabs (spring animation)
- Compact feel: px-4 py-1.5 per trigger

Component props:
- activeTab: string (the currently active tab value)
- Renders as a tab list with three triggers (values: "earnings", "deals", "affiliates")

Use Phosphor icons (@phosphor-icons/react): CurrencyDollar, Handshake, Link.
Use Tailwind CSS for styling with the token classes above. Use "use client" directive.
```

**v0 Call 2: BrandDealsHeader (title + contextual stats)**

Prompt v0 with:

```
Create a React "BrandDealsHeader" component — a page header with title, subtitle, and tab-contextual summary stats.

Design system context (Virtuna Brand Bible):
- Dark theme, dark-mode only
- Background: #07080a (page), Surface: #18191c (cards), Surface-elevated: #222326 (popovers)
- Text primary: near-white (gray-50), Text secondary: #9c9c9d (gray-400), Text muted: #6a6b6c (gray-500)
- Accent: Coral #FF7F50
- Fonts: Funnel Display for headings (font-display), Satoshi for body (font-sans)
- Glass: frosted panel with subtle blur (backdrop-filter blur 8px, bg white/3-5%, border rgba(255,255,255,0.08))
- Glass border: rgba(255,255,255,0.06) for glass components
- Border radius: lg (12px) for panels, xl (16px) for large cards
- Spacing: 24px padding inside panels

Use these Tailwind token classes (defined in the project's theme):
- Text: text-foreground, text-foreground-secondary, text-foreground-muted
- Borders: border-border, border-border-subtle
- Accent: text-accent (coral #FF7F50)

Visual requirements:
- Outer container: subtle glass panel background (rounded-xl, very low opacity white background bg-white/[0.03], border border-white/[0.08])
- Apply backdrop-filter via INLINE style={{ backdropFilter: 'blur(8px)', WebkitBackdropFilter: 'blur(8px)' }} — Tailwind v4's Lightning CSS strips backdrop-filter from classes, so it MUST be inline
- Left side: "Brand Deals" as heading (font-display, text-2xl or text-3xl, font-bold, text-foreground), subtitle below: "Manage your partnerships, links, and earnings" in text-foreground-secondary, text-sm
- Right side: row of 3 small stat items, right-aligned
- Stats are tab-contextual (the component receives activeTab prop):
  - Earnings tab: "Total Earned: $12,450" | "Pending: $1,850" | "Paid Out: $10,600"
  - Deals tab: "Active Deals: 7" | "New This Week: 3" | "Applied: 2"
  - Affiliates tab: "Active Links: 4" | "Total Clicks: 5,525" | "Total Earned: $2,500"
- Each stat: label in text-foreground-muted uppercase tracking-wider text-xs, value below in text-foreground text-lg font-semibold
- Stats separated by subtle vertical dividers (border-l border-white/[0.08])
- Overall layout: flex row, items-center, justify-between, responsive (stack on mobile)

Component props:
- activeTab: "earnings" | "deals" | "affiliates"

Use Tailwind CSS for styling with the token classes above. Use "use client" directive.
```

**After v0 generates the components:**

1. Save v0's BrandDealsTabs output to `src/components/app/brand-deals/brand-deals-tabs.tsx`
2. Save v0's BrandDealsHeader output to `src/components/app/brand-deals/brand-deals-header.tsx`

3. **Replace hardcoded colors with design system token classes:**
   v0 may hardcode hex values instead of using the project's Tailwind token classes. Scan both files and replace:
   - Any hardcoded dark background hex (#07080a, #18191c, #222326, etc.) → use `bg-background`, `bg-surface`, `bg-surface-elevated`
   - Any hardcoded text color hex (#fafafa, #9c9c9d, #6a6b6c, etc.) → use `text-foreground`, `text-foreground-secondary`, `text-foreground-muted`
   - Any hardcoded border hex → use `border-border` or `border-border-subtle`
   - Any hardcoded coral hex (#FF7F50) → use `text-accent` or `bg-accent`
   - Keep `bg-white/10`, `border-white/10`, `bg-white/[0.03]`, `border-white/[0.08]` as-is (these are opacity modifiers, not tokens)

4. **Integrate functional wiring into BrandDealsTabs:**
   - Replace any custom tab buttons/container with Radix primitives: `import * as Tabs from "@radix-ui/react-tabs"`
   - Wrap the tab list in `Tabs.List`. Each tab button must be a `Tabs.Trigger` with `value="earnings"`, `value="deals"`, `value="affiliates"`
   - Add Motion `layoutId` sliding pill: inside each `Tabs.Trigger`, conditionally render a `motion.div` with `layoutId="brand-deals-tab-pill"` ONLY when `activeTab === triggerValue`. Import `motion` from `"motion/react"`.
   - Pill transition: `{ type: "spring", stiffness: 400, damping: 30 }`
   - The pill div is positioned `absolute inset-0 z-0`, the label span is `relative z-10`
   - Ensure Phosphor icon imports are correct: `import { CurrencyDollar, Handshake, Link as LinkIcon } from "@phosphor-icons/react"` (alias Link to avoid conflict with next/link)

5. **Integrate functional wiring into BrandDealsHeader:**
   - Ensure the `activeTab` prop type is `"earnings" | "deals" | "affiliates"` (or import the type from `@/types/brand-deals`)
   - Verify stat values use `Intl.NumberFormat` for formatting (or hardcode the formatted strings if v0 did so)
   - Verify backdrop-filter is applied via inline `style` prop (not Tailwind class) per the Lightning CSS workaround
   - If v0 used the GlassPanel primitive, keep it. If v0 hand-rolled the glass effect, that's fine too -- just ensure backdrop-filter is inline.
  </action>
  <verify>
1. Both files exist and export their named components
2. `npx tsc --noEmit` -- no type errors in the two new files
3. BrandDealsTabs uses Radix `Tabs.Trigger` elements (not plain buttons)
4. BrandDealsTabs has `motion.div` with `layoutId="brand-deals-tab-pill"`
5. BrandDealsHeader renders different stats based on `activeTab` prop
6. BrandDealsHeader has inline `style` with `backdropFilter` (not Tailwind class)
7. No hardcoded hex colors remain (grep for #07080a, #18191c, #222326, #9c9c9d, #6a6b6c, #FF7F50, #fafafa in both files -- should find ZERO matches). All colors must use Tailwind token classes.
  </verify>
  <done>
BrandDealsTabs and BrandDealsHeader exist as v0-generated components with functional wiring integrated: Radix Tabs.Trigger elements, Motion layoutId sliding pill, tab-contextual stats, glass header with inline backdrop-filter.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create page route, client orchestrator, and barrel export</name>
  <files>
    src/app/(app)/brand-deals/page.tsx
    src/components/app/brand-deals/brand-deals-page.tsx
    src/components/app/brand-deals/index.ts
  </files>
  <action>
**1. Server component: `src/app/(app)/brand-deals/page.tsx`**

Follow the Settings page pattern exactly (`src/app/(app)/settings/page.tsx`):
- Export Metadata: title "Brand Deals | Virtuna", description "Manage brand deals, affiliate links, and earnings"
- Interface `PageProps { searchParams: Promise<{ tab?: string }> }`
- `VALID_TABS = ["earnings", "deals", "affiliates"] as const` (earnings FIRST -- it's the default)
- Type `ValidTab = (typeof VALID_TABS)[number]`
- Async default export awaits searchParams, validates tab, defaults to "earnings"
- Renders `<BrandDealsPage defaultTab={defaultTab} />`

**2. Client component: `src/components/app/brand-deals/brand-deals-page.tsx`**

"use client" directive. This is the main orchestrator.

Props: `{ defaultTab: ValidTab }` where ValidTab is "earnings" | "deals" | "affiliates"

URL sync pattern (from RESEARCH.md Pattern 2):
- Import `useSearchParams` from "next/navigation"
- Derive `currentTab` from `searchParams.get("tab")`, falling back to `defaultTab`
- `handleTabChange(value: string)` creates new URLSearchParams, sets "tab", calls `window.history.pushState(null, "", `?${params.toString()}`)`
- Use `Tabs.Root` from `@radix-ui/react-tabs` in CONTROLLED mode: `value={currentTab}` and `onValueChange={handleTabChange}`
- Do NOT use `defaultValue` -- controlled mode only

Layout structure:
```
<div className="mx-auto max-w-5xl p-6">
  <BrandDealsHeader activeTab={currentTab} />
  <Tabs.Root value={currentTab} onValueChange={handleTabChange}>
    <BrandDealsTabs activeTab={currentTab} />
    <div className="mt-6">
      <AnimatePresence mode="wait">
        <motion.div
          key={currentTab}
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          transition={{ duration: 0.15 }}
        >
          <Tabs.Content value="earnings" forceMount={currentTab === "earnings" ? true : undefined}>
            {/* Placeholder */}
          </Tabs.Content>
          <Tabs.Content value="deals" forceMount={currentTab === "deals" ? true : undefined}>
            {/* Placeholder */}
          </Tabs.Content>
          <Tabs.Content value="affiliates" forceMount={currentTab === "affiliates" ? true : undefined}>
            {/* Placeholder */}
          </Tabs.Content>
        </motion.div>
      </AnimatePresence>
    </div>
  </Tabs.Root>
</div>
```

Import `AnimatePresence`, `motion` from "motion/react". Placeholder content for each tab should be a centered muted text string like "Earnings tab content -- Phase 56" inside a `min-h-[300px] flex items-center justify-center rounded-xl border border-border-subtle` container using `text-foreground-muted`.

**3. Barrel export: `src/components/app/brand-deals/index.ts`**

Follow settings pattern: `export { BrandDealsPage } from "./brand-deals-page";`
  </action>
  <verify>
1. `npx tsc --noEmit` -- no type errors
2. `pnpm build` (or `npm run build`) -- no build errors
3. `pnpm dev` and navigate to `http://localhost:3000/brand-deals` -- page renders
4. Click each tab -- URL updates to `?tab=earnings`, `?tab=deals`, `?tab=affiliates`
5. Use browser back/forward buttons -- tabs navigate correctly
6. Default URL `/brand-deals` (no ?tab param) shows Earnings tab
  </verify>
  <done>
Page renders at /brand-deals with three pill-style tabs. Clicking tabs updates URL search params via pushState. Browser back/forward navigates between tabs. AnimatePresence provides fade transition between tab content. Default tab is Earnings. Server component validates searchParams. Barrel export exposes BrandDealsPage.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire sidebar Brand Deals navigation with routing and badge</name>
  <files>
    src/components/app/sidebar.tsx
    src/components/app/sidebar-nav-item.tsx
  </files>
  <action>
**1. Update SidebarNavItem to support optional badge**

Edit `src/components/app/sidebar-nav-item.tsx`:
- Add `badge?: number` to the `SidebarNavItemProps` interface
- When `badge` is defined and > 0, render a small badge after the label text
- Badge styling: `ml-auto flex h-5 min-w-5 items-center justify-center rounded-full bg-coral/20 text-coral text-xs font-medium px-1.5` (coral accent for new deals count)
- If the Badge component from `src/components/ui/badge.tsx` has a suitable small variant, use it. Otherwise, inline the badge as a span.

**2. Update Sidebar to use usePathname for Brand Deals routing**

Edit `src/components/app/sidebar.tsx`:
- Add `import { usePathname } from "next/navigation";` (useRouter is already imported)
- Add `const pathname = usePathname();` inside the Sidebar component
- Change the nav items rendering to handle Brand Deals specially:

For the navItems.map section, update the logic:
```tsx
{navItems.map((item) => {
  // Brand Deals has a real route
  if (item.id === "brand-deals") {
    return (
      <SidebarNavItem
        key={item.id}
        icon={item.icon}
        label={item.label}
        isActive={pathname.startsWith("/brand-deals")}
        onClick={() => router.push("/brand-deals")}
        badge={3}
      />
    );
  }
  // Other items keep existing useState behavior
  return (
    <SidebarNavItem
      key={item.id}
      icon={item.icon}
      label={item.label}
      isActive={activeNav === item.id && !pathname.startsWith("/brand-deals")}
      onClick={() => setActiveNav(item.id)}
    />
  );
})}
```

This is the hybrid approach from RESEARCH.md: `usePathname()` for routed items (Brand Deals), `useState` for non-routed items (Content Intelligence, Trending Feed). Route-based active state takes precedence.

Important: When `pathname.startsWith("/brand-deals")` is true, the `activeNav` useState should NOT show any other item as active. The `isActive` check for non-routed items includes `&& !pathname.startsWith("/brand-deals")` to prevent dual highlighting.
  </action>
  <verify>
1. `npx tsc --noEmit` -- no type errors
2. Navigate to `/brand-deals` -- sidebar "Brand Deals" item is highlighted (filled icon, active background)
3. Badge with "3" appears next to "Brand Deals" label in coral accent
4. Navigate to `/dashboard` -- "Content Intelligence" is highlighted, "Brand Deals" is not
5. Click "Brand Deals" in sidebar -- navigates to `/brand-deals` route
6. Other nav items (Content Intelligence, Trending Feed) still work as before with their active states
  </verify>
  <done>
Sidebar "Brand Deals" nav item navigates to /brand-deals on click, shows active state when on that route (usePathname-based), displays a coral badge with count "3". Other nav items retain existing useState active behavior without regression.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Brand Deals page with three-tab navigation, URL sync, animated sliding pill, header with contextual stats, and sidebar integration. Visual components were generated via v0 MCP with Brand Bible context.
  </what-built>
  <how-to-verify>
1. Open http://localhost:3000/brand-deals
2. Verify the page renders with "Brand Deals" title, subtitle, and three stats in the header
3. Verify the header has a subtle glass panel background (frosted blur effect)
4. Verify three pill-style tabs: Earnings (default/active), Deals, Affiliates -- each with an icon
5. Click "Deals" tab -- verify:
   - Pill slides smoothly from Earnings to Deals (spring animation)
   - URL updates to `?tab=deals`
   - Header stats change to deals context (Active Deals, New This Week, Applied)
   - Placeholder content shows "Deals" reference text
6. Click "Affiliates" tab -- same checks (URL: ?tab=affiliates, stats update, pill slides)
7. Use browser back button -- should return to Deals tab, then Earnings
8. Use browser forward button -- should navigate forward through tab history
9. Verify overall aesthetic: dark theme, Raycast-quality, design tokens used (not hardcoded colors)
10. Open sidebar -- verify "Brand Deals" is highlighted with coral badge showing "3"
11. Navigate away (click "Content Intelligence") -- verify Brand Deals loses active state
12. Click "Brand Deals" in sidebar -- navigates back to /brand-deals with Earnings as default tab
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `pnpm build` succeeds
3. `/brand-deals` route renders with three tabs and header
4. Tab clicks update URL search params
5. Browser back/forward navigates between tabs
6. Default tab is Earnings (no ?tab param)
7. Sliding pill animates between tabs
8. Header stats change per active tab
9. Header has glass panel aesthetic with backdrop-filter blur
10. Sidebar Brand Deals item routes to /brand-deals with active state
11. Sidebar badge shows count in coral accent
12. No regressions on other sidebar nav items
</verification>

<success_criteria>
- /brand-deals page exists with three working tabs
- URL sync works (pushState, not router.push)
- Browser back/forward navigates tabs
- Pill/segment control with Motion sliding animation
- Header shows tab-contextual summary stats on glass panel
- Visual components generated via v0 MCP with Brand Bible alignment
- Sidebar navigates to /brand-deals with active state and badge
- No TypeScript errors, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/53-foundation-tab-shell/53-02-SUMMARY.md`
</output>
