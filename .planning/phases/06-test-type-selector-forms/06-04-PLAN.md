---
phase: 06-test-type-selector-forms
plan: 04
type: execute
wave: 3
depends_on: ["06-01", "06-02"]
files_modified:
  - src/stores/test-store.ts
  - src/types/test.ts
  - src/components/app/test-creation-flow.tsx
  - src/components/app/index.ts
autonomous: true

must_haves:
  truths:
    - "User can open test type selector from dashboard"
    - "User can select TikTok Script or Instagram Post type"
    - "User can fill form and click Simulate"
    - "Form submission triggers loading state"
    - "Mock results appear after simulation"
    - "Test is saved to history"
  artifacts:
    - path: "src/stores/test-store.ts"
      provides: "Zustand store for test state and history"
      exports: ["useTestStore"]
    - path: "src/components/app/test-creation-flow.tsx"
      provides: "Orchestrates type selector, form, and results flow"
      exports: ["TestCreationFlow"]
  key_links:
    - from: "src/components/app/test-creation-flow.tsx"
      to: "src/stores/test-store.ts"
      via: "Zustand store for state management"
      pattern: "useTestStore"
    - from: "src/components/app/test-creation-flow.tsx"
      to: "src/components/app/test-type-selector.tsx"
      via: "renders type selector modal"
      pattern: "TestTypeSelector"
    - from: "src/components/app/test-creation-flow.tsx"
      to: "src/components/app/content-form.tsx"
      via: "renders form based on type"
      pattern: "ContentForm"
---

<objective>
Create test store and wire up TikTok Script and Instagram Post functional flows

Purpose: Make TikTok and Instagram forms fully functional - select type, fill form, submit, see mock results
Output: Test store with history, TestCreationFlow component orchestrating the full flow
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-test-type-selector-forms/06-CONTEXT.md
@src/stores/society-store.ts (reference for Zustand pattern)
@src/components/app/test-type-selector.tsx
@src/components/app/content-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test store with history</name>
  <files>
    - src/stores/test-store.ts
    - src/types/test.ts
  </files>
  <action>
1. Add to `src/types/test.ts`:
   ```typescript
   export interface TestResult {
     id: string;
     testType: TestType;
     content: string;
     impactScore: number;
     attention: {
       full: number;
       partial: number;
       ignore: number;
     };
     createdAt: string;
     societyId: string;
   }

   export type TestStatus = 'idle' | 'selecting-type' | 'filling-form' | 'simulating' | 'viewing-results';
   ```

2. Create `src/stores/test-store.ts`:
   - Use same manual localStorage pattern as society-store (NOT persist middleware)
   - Storage key: 'virtuna-tests'
   - State interface:
     ```typescript
     interface TestState {
       tests: TestResult[];
       currentTestType: TestType | null;
       currentStatus: TestStatus;
       currentResult: TestResult | null;
       _isHydrated: boolean;

       // Actions
       setTestType: (type: TestType | null) => void;
       setStatus: (status: TestStatus) => void;
       submitTest: (content: string, societyId: string) => Promise<void>;
       viewResult: (testId: string) => void;
       deleteTest: (testId: string) => void;
       _hydrate: () => void;
     }
     ```
   - submitTest action:
     - Set status to 'simulating'
     - Wait 2 seconds (mock AI processing)
     - Generate mock result with random impact score (60-95)
     - Add to tests array
     - Save to localStorage
     - Set currentResult and status to 'viewing-results'
  </action>
  <verify>
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Test store exists with CRUD operations and localStorage persistence</done>
</task>

<task type="auto">
  <name>Task 2: Build TestCreationFlow orchestrator</name>
  <files>
    - src/components/app/test-creation-flow.tsx
    - src/components/app/index.ts
  </files>
  <action>
**MANDATORY: Use v0 MCP for results view design**

1. Create `src/components/app/test-creation-flow.tsx`:
   - Orchestrates the full flow: type selector -> form -> loading -> results
   - Uses useTestStore for state management
   - Props: className?, triggerButton: ReactNode (renders the "Create a new test" button)

2. Component structure based on currentStatus:
   - 'idle': Just render triggerButton (clicking sets status to 'selecting-type')
   - 'selecting-type': Render TestTypeSelector modal
   - 'filling-form': Render appropriate form (ContentForm for most, SurveyForm for survey)
   - 'simulating': Render loading state (spinner + "Simulating response...")
   - 'viewing-results': Render mock results panel

3. Query v0 MCP for results panel: "Create a simulation results panel for societies.io. Dark theme showing Impact Score (large number with circular progress), Attention breakdown (Full/Partial/Ignore percentages as horizontal bars), and a 'Run another test' button. Zinc-800/900 styling."

4. Results panel shows:
   - Impact Score: large number (e.g., "78") with label
   - Attention breakdown: three bars (Full %, Partial %, Ignore %)
   - "Run another test" button (resets to 'idle')

5. Wire up form submission:
   - Get societyId from useSocietyStore
   - Call testStore.submitTest(content, societyId)
   - Flow automatically transitions through states

6. Add export to `src/components/app/index.ts`
  </action>
  <verify>
    - `npm run build` passes
  </verify>
  <done>TestCreationFlow orchestrates full flow from type selection to results</done>
</task>

<task type="auto">
  <name>Task 3: Integrate TestCreationFlow into dashboard</name>
  <files>
    - src/app/(app)/dashboard/page.tsx
  </files>
  <action>
1. Update dashboard page to include TestCreationFlow:
   - Import TestCreationFlow from @/components/app
   - Add "Create a new test" button in appropriate location (near context bar or as floating action)
   - Pass button as triggerButton prop

2. Button styling:
   - Primary style matching societies.io
   - "Create a new test" or "+" icon
   - Position in top-right area near filter pills

3. Ensure hydration:
   - Add useEffect to call testStore._hydrate() on mount
   - Add useEffect to call societyStore._hydrate() if not already done
  </action>
  <verify>
    - `npm run dev` - click "Create a new test" button
    - Type selector opens
    - Select TikTok Script or Instagram Post
    - Fill form and click Simulate
    - Loading state appears for ~2 seconds
    - Results panel shows with mock data
  </verify>
  <done>Full flow works from dashboard: select type -> fill form -> simulate -> see results</done>
</task>

</tasks>

<verification>
- Build succeeds
- Test store persists to localStorage
- TikTok Script: select -> fill -> submit -> results (full flow)
- Instagram Post: select -> fill -> submit -> results (full flow)
- Results show impact score and attention breakdown
- "Run another test" returns to idle state
</verification>

<success_criteria>
- TEST-07 complete: TikTok Script form functional end-to-end
- TEST-08 complete: Instagram Post form functional end-to-end
- Form submits trigger mock simulation
- Results display with impact score and attention
- Tests saved to history (localStorage)
</success_criteria>

<output>
After completion, create `.planning/phases/06-test-type-selector-forms/06-04-SUMMARY.md`
</output>
