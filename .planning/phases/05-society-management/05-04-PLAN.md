---
phase: 05-society-management
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - src/components/app/sidebar.tsx
  - src/components/app/society-selector.tsx
autonomous: true

must_haves:
  truths:
    - "Create button in selector opens create modal"
    - "New society appears in selector after creation"
    - "Sidebar shows currently selected society name"
    - "Complete flow: open selector -> create -> society appears -> auto-selected"
  artifacts:
    - path: "src/components/app/sidebar.tsx"
      provides: "Sidebar with society state display"
    - path: "src/components/app/society-selector.tsx"
      provides: "Selector with create modal integration"
  key_links:
    - from: "src/components/app/sidebar.tsx"
      to: "src/components/app/society-selector.tsx"
      via: "component composition"
      pattern: "<SocietySelector"
    - from: "src/components/app/society-selector.tsx"
      to: "src/components/app/create-society-modal.tsx"
      via: "modal trigger"
      pattern: "<CreateSocietyModal"
---

<objective>
Wire up Create Society modal flow and sidebar integration

Purpose: Connect the create society button in the selector to open the create modal, and ensure the full flow works end-to-end. Update sidebar to show current society.

Output: Complete create society flow, sidebar reflects selected society
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-society-management/05-02-SUMMARY.md
@.planning/phases/05-society-management/05-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate CreateSocietyModal into SocietySelector</name>
  <files>src/components/app/society-selector.tsx</files>
  <action>
Update SocietySelector to manage the create modal state:

1. Add state for create modal: `const [createModalOpen, setCreateModalOpen] = useState(false)`
2. Update handleCreateSociety to open the modal
3. Add CreateSocietyModal component inside the SocietySelector

```typescript
// Add import
import { CreateSocietyModal } from "./create-society-modal";

// Inside component, add state
const [createModalOpen, setCreateModalOpen] = useState(false);

// Update handleCreateSociety
const handleCreateSociety = () => {
  setOpen(false); // Close selector
  setCreateModalOpen(true); // Open create modal
};

// At the end of the return, before the closing fragment or after Dialog.Root
<CreateSocietyModal
  open={createModalOpen}
  onOpenChange={setCreateModalOpen}
/>
```

Important: Close the selector dialog BEFORE opening the create modal to avoid nested dialog focus issues (as noted in 05-RESEARCH.md pitfall #2).
  </action>
  <verify>
1. TypeScript compilation: `npm run build 2>&1 | head -20`
2. Check CreateSocietyModal is imported
3. Check createModalOpen state exists
  </verify>
  <done>SocietySelector manages create modal state and triggers it from Create Target Society button</done>
</task>

<task type="auto">
  <name>Task 2: Update sidebar to show current society</name>
  <files>src/components/app/sidebar.tsx</files>
  <action>
Update the Sidebar component to display the currently selected society name:

1. Import useSocietyStore
2. Get selected society from store
3. Display current society indicator

```typescript
// Add import
import { useSocietyStore } from "@/stores/society-store";

// Inside component
const selectedSociety = useSocietyStore((s) => s.getSelectedSociety());

// After SocietySelector, add current society display
{selectedSociety && (
  <div className="mt-2 flex items-center gap-2 px-1">
    <div className="h-2 w-2 rounded-full bg-emerald-500" />
    <span className="truncate text-xs text-zinc-500">
      {selectedSociety.name}
    </span>
  </div>
)}
```

This provides visual feedback showing which society is currently active.
  </action>
  <verify>
1. TypeScript compilation: `npm run build 2>&1 | head -20`
2. Check useSocietyStore is imported
3. Check selectedSociety is used in render
  </verify>
  <done>Sidebar displays current society name with active indicator</done>
</task>

<task type="auto">
  <name>Task 3: Test complete flow and fix edge cases</name>
  <files>src/components/app/society-selector.tsx, src/components/app/sidebar.tsx</files>
  <action>
Verify and fix edge cases in the complete flow:

1. Start dev server: `npm run dev`
2. Test complete flow:
   - Open society selector
   - Click "Create Target Society"
   - Selector closes, create modal opens
   - Enter description, submit
   - Modal closes, new society appears in selector
   - New society is auto-selected
   - Sidebar shows new society name

3. Test persistence:
   - Refresh page
   - Selected society should persist
   - Created society should persist

4. Test delete:
   - Delete a society
   - Selection falls back to first remaining
   - Deleted society no longer appears

5. Edge case fixes if needed:
   - Handle empty societies array (show only create button)
   - Handle hydration: wrap store consumers in "use client" components
   - Ensure stopPropagation on menu clicks

Run build to ensure no TypeScript errors:
```bash
npm run build
```
  </action>
  <verify>
1. Build passes: `npm run build`
2. Manual testing of complete flow (document results)
  </verify>
  <done>Complete create flow works: selector -> create modal -> new society appears -> auto-selected</done>
</task>

</tasks>

<verification>
Complete flow test:
1. `npm run dev`
2. Navigate to app route (e.g., /dashboard)
3. Open society selector from sidebar
4. Click "Create Target Society"
5. Enter "Product managers in San Francisco"
6. Click "Create your society"
7. Wait for loading animation
8. Modal closes
9. Re-open selector - new society appears
10. Sidebar shows "Product managers..." as current
11. Refresh page - still selected
</verification>

<success_criteria>
- Create button opens create modal
- New society appears after creation
- New society is auto-selected
- Sidebar shows current society name
- Persistence works across refresh
- Delete works with proper fallback
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-society-management/05-04-SUMMARY.md`
</output>
