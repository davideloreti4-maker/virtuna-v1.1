---
phase: 05-society-management
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/app/society-selector.tsx
  - src/components/app/card-action-menu.tsx
  - src/components/app/index.ts
autonomous: true

must_haves:
  truths:
    - "Society selection persists across page refresh"
    - "Selected society shows in sidebar trigger button"
    - "Card menu opens with Edit/Refresh/Delete options"
    - "Delete removes society from store and UI"
  artifacts:
    - path: "src/components/app/society-selector.tsx"
      provides: "Society selector using Zustand store"
      min_lines: 200
    - path: "src/components/app/card-action-menu.tsx"
      provides: "Radix DropdownMenu for card actions"
      exports: ["CardActionMenu"]
  key_links:
    - from: "src/components/app/society-selector.tsx"
      to: "src/stores/society-store.ts"
      via: "useSocietyStore hook"
      pattern: "useSocietyStore"
    - from: "src/components/app/card-action-menu.tsx"
      to: "@radix-ui/react-dropdown-menu"
      via: "Radix import"
      pattern: "import.*DropdownMenu"
---

<objective>
Integrate Zustand store into SocietySelector and add card action menu

Purpose: Replace Phase 4's local state with global Zustand store, enabling society selection to persist and be accessible throughout the app. Add CRUD UI for managing societies.

Output: Updated SocietySelector using store, CardActionMenu component with Edit/Refresh/Delete
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-society-management/05-RESEARCH.md
@.planning/phases/05-society-management/05-01-SUMMARY.md
@src/components/app/society-selector.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CardActionMenu component</name>
  <files>src/components/app/card-action-menu.tsx</files>
  <action>
Create a Radix DropdownMenu component for card actions:

```typescript
"use client";

import * as DropdownMenu from "@radix-ui/react-dropdown-menu";
import { MoreVertical, Pencil, RefreshCw, Trash2 } from "lucide-react";
import { cn } from "@/lib/utils";

interface CardActionMenuProps {
  societyId: string;
  onEdit: (id: string) => void;
  onRefresh: (id: string) => void;
  onDelete: (id: string) => void;
  className?: string;
}

export function CardActionMenu({
  societyId,
  onEdit,
  onRefresh,
  onDelete,
  className,
}: CardActionMenuProps) {
  return (
    <DropdownMenu.Root>
      <DropdownMenu.Trigger asChild>
        <button
          type="button"
          onClick={(e) => e.stopPropagation()}
          className={cn(
            "text-zinc-500 transition-colors hover:text-zinc-400",
            className
          )}
          aria-label="More options"
        >
          <MoreVertical className="h-4 w-4" />
        </button>
      </DropdownMenu.Trigger>

      <DropdownMenu.Portal>
        <DropdownMenu.Content
          className="z-50 min-w-[140px] rounded-lg border border-zinc-700 bg-zinc-800 p-1 shadow-lg"
          sideOffset={4}
          align="end"
        >
          <DropdownMenu.Item
            onSelect={() => onEdit(societyId)}
            className="flex cursor-pointer items-center gap-2 rounded-md px-3 py-2 text-sm text-zinc-200 outline-none transition-colors hover:bg-zinc-700 focus:bg-zinc-700"
          >
            <Pencil className="h-4 w-4" />
            Edit
          </DropdownMenu.Item>

          <DropdownMenu.Item
            onSelect={() => onRefresh(societyId)}
            className="flex cursor-pointer items-center gap-2 rounded-md px-3 py-2 text-sm text-zinc-200 outline-none transition-colors hover:bg-zinc-700 focus:bg-zinc-700"
          >
            <RefreshCw className="h-4 w-4" />
            Refresh
          </DropdownMenu.Item>

          <DropdownMenu.Separator className="my-1 h-px bg-zinc-700" />

          <DropdownMenu.Item
            onSelect={() => onDelete(societyId)}
            className="flex cursor-pointer items-center gap-2 rounded-md px-3 py-2 text-sm text-red-400 outline-none transition-colors hover:bg-zinc-700 hover:text-red-300 focus:bg-zinc-700"
          >
            <Trash2 className="h-4 w-4" />
            Delete
          </DropdownMenu.Item>
        </DropdownMenu.Content>
      </DropdownMenu.Portal>
    </DropdownMenu.Root>
  );
}
```

Key points:
- stopPropagation on trigger prevents card selection when opening menu
- sideOffset and align for proper positioning
- Red color for delete action
- Consistent with reference in .reference/app/society-selector.md
  </action>
  <verify>TypeScript compilation: `npm run build 2>&1 | head -20`</verify>
  <done>CardActionMenu component created with Edit, Refresh, Delete options using Radix DropdownMenu</done>
</task>

<task type="auto">
  <name>Task 2: Refactor SocietySelector to use Zustand store</name>
  <files>src/components/app/society-selector.tsx</files>
  <action>
Refactor the existing SocietySelector to use the Zustand store instead of local state:

1. Remove MOCK_SOCIETIES constant (now in mock-societies.ts)
2. Remove local Society interface (now in types/society.ts)
3. Replace useState with useSocietyStore hooks
4. Update handleSelectSociety to use store action
5. Replace menu placeholder with CardActionMenu
6. Add state for create modal (opens in Plan 03)

Key changes:
```typescript
"use client";

import { useState } from "react";
import * as Dialog from "@radix-ui/react-dialog";
import { cn } from "@/lib/utils";
import { ChevronDown, X, Plus, Info, Briefcase, Coins } from "lucide-react";
import { useSocietyStore } from "@/stores/society-store";
import { CardActionMenu } from "./card-action-menu";
import type { Society, PersonalSociety, TargetSociety } from "@/types/society";

interface SocietySelectorProps {
  className?: string;
  onCreateClick?: () => void; // Opens create modal (handled in parent or Plan 03)
}

export function SocietySelector({ className, onCreateClick }: SocietySelectorProps) {
  const [open, setOpen] = useState(false);

  // Use Zustand store instead of local state
  const selectedSociety = useSocietyStore((s) => s.getSelectedSociety());
  const personalSocieties = useSocietyStore((s) => s.getPersonalSocieties());
  const targetSocieties = useSocietyStore((s) => s.getTargetSocieties());
  const selectSociety = useSocietyStore((s) => s.selectSociety);
  const updateSociety = useSocietyStore((s) => s.updateSociety);
  const deleteSociety = useSocietyStore((s) => s.deleteSociety);

  const handleSelectSociety = (society: Society) => {
    selectSociety(society.id);
    setOpen(false);
  };

  const handleCreateSociety = () => {
    setOpen(false);
    onCreateClick?.();
  };

  const handleEdit = (id: string) => {
    // Placeholder - edit modal not in Phase 5 scope
    console.log("Edit society:", id);
  };

  const handleRefresh = (id: string) => {
    // Simulate refresh with brief loading (no-op for mock data)
    console.log("Refresh society:", id);
  };

  const handleDelete = (id: string) => {
    deleteSociety(id);
  };

  // ... rest of component with updated props
}
```

Update PersonalSocietyCard and TargetSocietyCard to use proper typed props:
- PersonalSocietyCard receives PersonalSociety type
- TargetSocietyCard receives TargetSociety type and action handlers

Important: Keep the same visual structure and Tailwind classes. Only change state management and add action menu.
  </action>
  <verify>
1. TypeScript compilation: `npm run build 2>&1 | head -20`
2. Check society-selector.tsx uses useSocietyStore
3. Check CardActionMenu is imported and used
  </verify>
  <done>SocietySelector uses Zustand store, CardActionMenu integrated, delete action works</done>
</task>

<task type="auto">
  <name>Task 3: Update barrel exports</name>
  <files>src/components/app/index.ts</files>
  <action>
Add CardActionMenu to barrel exports:

```typescript
// Add to existing exports
export { CardActionMenu } from './card-action-menu';
```
  </action>
  <verify>Check file exports CardActionMenu: `grep "CardActionMenu" src/components/app/index.ts`</verify>
  <done>CardActionMenu exported from components/app barrel</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run build` passes without errors
2. `npm run dev` - open app
3. Open society selector modal
4. Click 3-dot menu on a society card
5. Menu shows Edit, Refresh, Delete options
6. Delete removes society from list
7. Refresh page - selection persists (localStorage)
</verification>

<success_criteria>
- SocietySelector uses Zustand store (no local MOCK_SOCIETIES)
- CardActionMenu component with Radix DropdownMenu
- Delete action removes society and updates store
- Selection persists across page refresh
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-society-management/05-02-SUMMARY.md`
</output>
