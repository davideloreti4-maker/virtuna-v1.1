---
phase: 44-verification-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - verification/playwright.config.ts
  - verification/scripts/contrast-audit.ts
  - verification/reports/contrast-audit.md
  - package.json
autonomous: true

must_haves:
  truths:
    - "WCAG AA contrast audit report exists with pass/fail for every semantic foreground/background combination"
    - "Contrast ratios extracted from browser-computed RGB values (not manual oklch conversion)"
    - "Verification directory structure created with Playwright config for screenshot-based tests"
  artifacts:
    - path: "verification/playwright.config.ts"
      provides: "Playwright config for verification scripts (3 viewports: desktop, tablet, mobile)"
    - path: "verification/scripts/contrast-audit.ts"
      provides: "Programmatic WCAG AA contrast audit script"
    - path: "verification/reports/contrast-audit.md"
      provides: "Generated WCAG AA compliance report with all results"
  key_links:
    - from: "verification/scripts/contrast-audit.ts"
      to: "src/app/globals.css"
      via: "Reads CSS custom properties via getComputedStyle in Playwright browser"
      pattern: "getComputedStyle.*getPropertyValue"
---

<objective>
Set up verification infrastructure and run WCAG AA color contrast audit.

Purpose: Create the verification directory structure, Playwright config for visual tests, and run a programmatic contrast audit of all semantic foreground/background token combinations. This produces the first verification report and establishes infrastructure for subsequent visual comparison plans.

Output: verification/ directory with Playwright config, contrast audit script, and generated WCAG AA compliance report.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-verification-documentation/44-RESEARCH.md
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create verification infrastructure + Playwright config</name>
  <files>
    verification/playwright.config.ts
    package.json
  </files>
  <action>
1. Create verification/ directory structure:
   ```
   verification/
   ├── playwright.config.ts
   ├── scripts/          (empty, populated by tasks)
   └── reports/          (empty, populated by tasks)
   ```

2. Create verification/playwright.config.ts with:
   - testDir: './scripts'
   - timeout: 60000, workers: 1, fullyParallel: false
   - reporter: [['list']]
   - outputDir: 'reports/test-results'
   - baseURL: 'http://localhost:3000'
   - 3 projects: desktop (1440x900), tablet (768x1024), mobile (375x812)
   - All projects: colorScheme 'dark', reducedMotion 'reduce'
   - CSS injection to disable animations: `*, *::before, *::after { animation-duration: 0s !important; transition-duration: 0s !important; }`

3. Install wcag-contrast and pngjs as dev dependencies:
   ```bash
   pnpm add -D wcag-contrast pngjs
   ```
   Note: @types/wcag-contrast may not exist — check npm first. If not available, create a minimal type declaration in verification/types/wcag-contrast.d.ts:
   ```typescript
   declare module 'wcag-contrast' {
     export function hex(fg: string, bg: string): number;
     export function rgb(fg: [number, number, number], bg: [number, number, number]): number;
     export function score(ratio: number): string;
   }
   ```

4. Do NOT modify the existing extraction/playwright.config.ts — verification/ is separate.
  </action>
  <verify>
    - `ls verification/playwright.config.ts` exists
    - `ls verification/scripts/ verification/reports/` directories exist
    - `pnpm list wcag-contrast` shows installed
  </verify>
  <done>Verification directory structure exists with Playwright config and wcag-contrast installed.</done>
</task>

<task type="auto">
  <name>Task 2: Run WCAG AA contrast audit and generate report</name>
  <files>
    verification/scripts/contrast-audit.ts
    verification/reports/contrast-audit.md
  </files>
  <action>
1. Create verification/scripts/contrast-audit.ts as a standalone Node script (NOT a Playwright test) that:

   a. Launches Chromium via Playwright, navigates to localhost:3000
   b. Extracts ALL semantic color token values via getComputedStyle():
      - Backgrounds: --color-background, --color-surface, --color-surface-elevated, --color-surface-hover
      - Text: --color-foreground, --color-foreground-secondary, --color-foreground-muted
      - Accent: --color-accent, --color-accent-hover, --color-accent-foreground
      - Status: --color-success, --color-warning, --color-error, --color-info
      - Border: --color-border (note: decorative, but include for completeness)
      - States: --color-focus, --color-hover
   c. Converts all extracted rgb() values to hex for wcag-contrast consumption
   d. Defines meaningful pairs to check (~30-40 combinations):
      - All 3 text colors on all 4 backgrounds
      - Accent on all backgrounds
      - Status colors on all backgrounds
      - Accent-foreground on accent background
   e. Computes contrast ratio for each pair using wcag-contrast's hex() function
   f. Determines pass/fail:
      - Normal text (< 24px / < 18.66px bold): requires 4.5:1
      - Large text (>= 24px / >= 18.66px bold): requires 3:1
      - Note both thresholds in results
   g. Generates a markdown report to verification/reports/contrast-audit.md with:
      - Header with date, standard (WCAG 2.1 AA), method description
      - Summary: X pass, Y fail out of Z combinations
      - Failures table (if any): combination, fg hex, bg hex, ratio, required ratio
      - Passes table: combination, fg hex, bg hex, ratio, score
      - Extracted token values section: table of all tokens with their computed hex values

2. Run the script:
   ```bash
   cd virtuna-v1.1
   # Start dev server in background, wait for it, run audit, stop server
   pnpm dev &
   DEV_PID=$!
   sleep 5  # Wait for dev server
   npx tsx verification/scripts/contrast-audit.ts
   kill $DEV_PID
   ```

3. The report DOCUMENTS findings — it does NOT assert or fail on contrast issues. Any failures are noted for a future fix phase.
  </action>
  <verify>
    - `cat verification/reports/contrast-audit.md` contains "WCAG" header
    - Report has both a Failures and Passes section
    - Report includes extracted hex values for all semantic tokens
  </verify>
  <done>WCAG AA contrast audit report generated at verification/reports/contrast-audit.md with pass/fail results for all semantic color combinations.</done>
</task>

</tasks>

<verification>
- verification/ directory exists with playwright.config.ts, scripts/, reports/
- wcag-contrast package installed
- contrast-audit.md report generated with all semantic color combinations audited
- Report uses browser-computed RGB values (not manual oklch conversion)
</verification>

<success_criteria>
- WCAG AA contrast audit report exists and covers all semantic foreground/background token combinations
- Verification infrastructure ready for subsequent visual comparison plans
- No component code modified (this is a read-only audit phase)
</success_criteria>

<output>
After completion, create `.planning/phases/44-verification-documentation/44-01-SUMMARY.md`
</output>
