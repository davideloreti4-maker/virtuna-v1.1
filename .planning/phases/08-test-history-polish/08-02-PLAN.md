---
phase: 08-test-history-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/app/test-history-item.tsx
  - src/components/app/test-history-list.tsx
  - src/components/app/sidebar.tsx
  - src/components/app/index.ts
autonomous: true

must_haves:
  truths:
    - "Test history displays in sidebar with newest first"
    - "Each history item shows test type icon and name"
    - "Three-dot menu opens on history item"
    - "Delete option visible in menu"
    - "Active/selected item has visual highlight"
  artifacts:
    - path: "src/components/app/test-history-item.tsx"
      provides: "Individual history item with menu"
      exports: ["TestHistoryItem"]
    - path: "src/components/app/test-history-list.tsx"
      provides: "Scrollable history list"
      exports: ["TestHistoryList"]
    - path: "src/components/app/sidebar.tsx"
      provides: "Sidebar with integrated history section"
      contains: "TestHistoryList"
  key_links:
    - from: "test-history-list.tsx"
      to: "test-store.ts"
      via: "useTestStore selector"
      pattern: "useTestStore.*tests"
    - from: "test-history-item.tsx"
      to: "@radix-ui/react-dropdown-menu"
      via: "Three-dot menu"
      pattern: "DropdownMenu\\."
---

<objective>
Build test history list components for sidebar display.

Purpose: Allow users to view and interact with their test history directly from the sidebar.
Output: TestHistoryItem and TestHistoryList components integrated into Sidebar.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-test-history-polish/08-RESEARCH.md

# Existing patterns to follow
@src/components/app/card-action-menu.tsx
@src/stores/test-store.ts
@src/lib/test-types.ts
@src/components/app/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TestHistoryItem component</name>
  <files>src/components/app/test-history-item.tsx</files>
  <action>
Create TestHistoryItem with icon, name, score, and three-dot menu:

```typescript
// src/components/app/test-history-item.tsx
'use client';

import { useState } from 'react';
import * as DropdownMenu from '@radix-ui/react-dropdown-menu';
import { MoreVertical, Trash2 } from 'lucide-react';
import {
  ClipboardList, FileText, Globe, Megaphone,
  Linkedin, Instagram, Twitter, Video, Mail, Send, Package
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { TEST_TYPES } from '@/lib/test-types';
import type { TestResult, TestTypeIcon } from '@/types/test';

// Icon map following established pattern from test-types.ts
const ICON_MAP: Record<TestTypeIcon, React.ComponentType<{ className?: string }>> = {
  ClipboardList,
  FileText,
  Globe,
  Megaphone,
  Linkedin,
  Instagram,
  Twitter,
  Video,
  Mail,
  Send,
  Package,
};

interface TestHistoryItemProps {
  test: TestResult;
  isActive: boolean;
  onClick: () => void;
  onDelete: () => void;
}

export function TestHistoryItem({
  test,
  isActive,
  onClick,
  onDelete,
}: TestHistoryItemProps) {
  const config = TEST_TYPES[test.testType];
  const IconComponent = ICON_MAP[config.icon];

  return (
    <button
      type="button"
      onClick={onClick}
      className={cn(
        'group relative flex w-full items-center gap-3 rounded-lg px-3 py-2.5 text-left text-sm transition-colors',
        isActive
          ? 'bg-zinc-800 text-white'
          : 'text-zinc-400 hover:bg-zinc-800/50 hover:text-zinc-200'
      )}
    >
      {/* Left border indicator for active */}
      {isActive && (
        <div className="absolute left-0 top-1/2 h-4 w-0.5 -translate-y-1/2 rounded-full bg-indigo-500" />
      )}

      {/* Icon */}
      <IconComponent className="h-4 w-4 shrink-0" />

      {/* Test type name - truncate if needed */}
      <span className="flex-1 truncate">{config.name}</span>

      {/* Impact score */}
      <span className="text-xs text-zinc-500">{test.impactScore}%</span>

      {/* Three-dot menu */}
      <DropdownMenu.Root>
        <DropdownMenu.Trigger asChild>
          <button
            type="button"
            onClick={(e) => e.stopPropagation()}
            className={cn(
              'rounded p-1 text-zinc-500 opacity-0 transition-all hover:bg-zinc-700 hover:text-zinc-300 group-hover:opacity-100',
              isActive && 'opacity-100'
            )}
            aria-label="More options"
          >
            <MoreVertical className="h-3.5 w-3.5" />
          </button>
        </DropdownMenu.Trigger>

        <DropdownMenu.Portal>
          <DropdownMenu.Content
            className="z-50 min-w-[120px] rounded-lg border border-zinc-700 bg-zinc-800 p-1 shadow-lg"
            sideOffset={4}
            align="end"
          >
            <DropdownMenu.Item
              onSelect={(e) => {
                e.preventDefault();
                onDelete();
              }}
              className="flex cursor-pointer items-center gap-2 rounded-md px-3 py-2 text-sm text-red-400 outline-none transition-colors hover:bg-zinc-700 hover:text-red-300 focus:bg-zinc-700"
            >
              <Trash2 className="h-4 w-4" />
              Delete
            </DropdownMenu.Item>
          </DropdownMenu.Content>
        </DropdownMenu.Portal>
      </DropdownMenu.Root>
    </button>
  );
}
```

Key patterns used:
- Icon map pattern from test-types.ts context
- stopPropagation on menu trigger (CardActionMenu pattern)
- Active state with left border indicator
- Group hover for menu visibility
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>TestHistoryItem renders test info with icon, name, score, active state, and three-dot menu</done>
</task>

<task type="auto">
  <name>Task 2: Create TestHistoryList and integrate into Sidebar</name>
  <files>src/components/app/test-history-list.tsx, src/components/app/sidebar.tsx, src/components/app/index.ts</files>
  <action>
1. Create TestHistoryList component:

```typescript
// src/components/app/test-history-list.tsx
'use client';

import { useState } from 'react';
import { useTestStore } from '@/stores/test-store';
import { TestHistoryItem } from './test-history-item';
import { DeleteTestModal } from './delete-test-modal';

interface TestHistoryListProps {
  onSelectTest: (testId: string) => void;
}

export function TestHistoryList({ onSelectTest }: TestHistoryListProps) {
  const tests = useTestStore((s) => s.tests);
  const currentResult = useTestStore((s) => s.currentResult);
  const deleteTest = useTestStore((s) => s.deleteTest);
  const _isHydrated = useTestStore((s) => s._isHydrated);

  const [deleteModalOpen, setDeleteModalOpen] = useState(false);
  const [testToDelete, setTestToDelete] = useState<string | null>(null);

  // Guard for SSR hydration
  if (!_isHydrated) {
    return (
      <div className="px-3 py-2 text-xs text-zinc-600">
        Loading history...
      </div>
    );
  }

  if (tests.length === 0) {
    return (
      <div className="px-3 py-2 text-xs text-zinc-600">
        No tests yet. Create your first test to see it here.
      </div>
    );
  }

  const handleDeleteClick = (testId: string) => {
    setTestToDelete(testId);
    setDeleteModalOpen(true);
  };

  const handleConfirmDelete = () => {
    if (testToDelete) {
      deleteTest(testToDelete);
      setTestToDelete(null);
      setDeleteModalOpen(false);
    }
  };

  return (
    <>
      <div className="flex flex-col gap-1">
        {tests.map((test) => (
          <TestHistoryItem
            key={test.id}
            test={test}
            isActive={currentResult?.id === test.id}
            onClick={() => onSelectTest(test.id)}
            onDelete={() => handleDeleteClick(test.id)}
          />
        ))}
      </div>

      {/* Delete modal as sibling (dialog sibling pattern) */}
      <DeleteTestModal
        open={deleteModalOpen}
        onOpenChange={setDeleteModalOpen}
        onConfirm={handleConfirmDelete}
      />
    </>
  );
}
```

2. Update Sidebar to include history section:

In sidebar.tsx, add TestHistoryList between "Create new test" button and bottom nav.

Find this section:
```tsx
{/* Create new test button */}
<button ... >
  <span>Create a new test</span>
  <Plus className="h-4 w-4" />
</button>

{/* Spacer */}
<div className="flex-1" />
```

Replace with:
```tsx
{/* Create new test button */}
<button ... >
  <span>Create a new test</span>
  <Plus className="h-4 w-4" />
</button>

{/* Test History Section */}
<div className="mt-4 flex flex-1 flex-col overflow-hidden">
  <label className="mb-2 block text-xs uppercase tracking-wide text-zinc-500">
    Test History
  </label>
  <div className="flex-1 overflow-y-auto">
    <TestHistoryList onSelectTest={handleViewTest} />
  </div>
</div>
```

Add import at top of sidebar.tsx:
```typescript
import { TestHistoryList } from './test-history-list';
import { useTestStore } from '@/stores/test-store';
```

Add handler in Sidebar component:
```typescript
const viewResult = useTestStore((s) => s.viewResult);

const handleViewTest = (testId: string) => {
  viewResult(testId);
};
```

3. Add exports to index.ts:
```typescript
export { TestHistoryItem } from './test-history-item';
export { TestHistoryList } from './test-history-list';
```
  </action>
  <verify>
    - `npm run build` passes
    - Sidebar shows "Test History" section with scrollable list
  </verify>
  <done>Test history list integrated into sidebar with delete flow working through modal</done>
</task>

</tasks>

<verification>
- [ ] TestHistoryItem shows icon, name, score for each test
- [ ] Three-dot menu opens with Delete option
- [ ] TestHistoryList renders all tests newest first (store order)
- [ ] Clicking item calls onSelectTest
- [ ] Delete triggers modal, confirm deletes test
- [ ] Active item has visual highlight (bg-zinc-800 + indigo border)
- [ ] Empty state shows helpful message
- [ ] SSR hydration guarded with _isHydrated check
- [ ] `npm run build` passes
</verification>

<success_criteria>
- History list scrollable in sidebar
- Items show test type icon + name + score
- Three-dot menu for delete access
- Delete modal confirmation works
- Active/selected state clearly visible
</success_criteria>

<output>
After completion, create `.planning/phases/08-test-history-polish/08-02-SUMMARY.md`
</output>
