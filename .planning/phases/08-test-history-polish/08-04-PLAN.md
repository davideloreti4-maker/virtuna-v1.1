---
phase: 08-test-history-polish
plan: 04
type: execute
wave: 3
depends_on: ["08-01", "08-02", "08-03"]
files_modified:
  - src/app/(app)/dashboard/dashboard-client.tsx
  - src/components/app/content-form.tsx
  - src/components/app/survey-form.tsx
  - src/components/app/sidebar.tsx
autonomous: false

must_haves:
  truths:
    - "Clicking history item shows that test's results immediately"
    - "Form displays content in read-only mode when viewing history"
    - "Run another test button resets to new test state"
    - "New test button in sidebar also resets state"
    - "Network visualization syncs with selected test"
  artifacts:
    - path: "src/app/(app)/dashboard/dashboard-client.tsx"
      provides: "Full history viewing integration"
      contains: "viewResult"
    - path: "src/components/app/content-form.tsx"
      provides: "Read-only mode when viewing history"
      contains: "isViewingHistory"
  key_links:
    - from: "sidebar.tsx"
      to: "test-store.ts"
      via: "viewResult action"
      pattern: "viewResult"
    - from: "content-form.tsx"
      to: "test-store.ts"
      via: "isViewingHistory selector"
      pattern: "isViewingHistory"
---

<objective>
Complete integration of history viewing with read-only forms and proper state management.

Purpose: Enable seamless browsing of past test results with proper form state handling.
Output: Fully functional history viewing flow with read-only forms and visual verification.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-test-history-polish/08-CONTEXT.md

# Prior plan outputs needed
@.planning/phases/08-test-history-polish/08-01-SUMMARY.md
@.planning/phases/08-test-history-polish/08-02-SUMMARY.md

# Files to modify
@src/app/(app)/dashboard/dashboard-client.tsx
@src/components/app/content-form.tsx
@src/components/app/survey-form.tsx
@src/components/app/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add read-only mode to forms</name>
  <files>src/components/app/content-form.tsx, src/components/app/survey-form.tsx</files>
  <action>
1. Update ContentForm to respect isViewingHistory:

Import and use the flag:
```typescript
import { useTestStore } from '@/stores/test-store';

export function ContentForm({ testType, onChangeType, onSubmit }: ContentFormProps) {
  const isViewingHistory = useTestStore((s) => s.isViewingHistory);
  const currentResult = useTestStore((s) => s.currentResult);

  // Pre-fill content when viewing history
  const [content, setContent] = useState('');

  useEffect(() => {
    if (isViewingHistory && currentResult) {
      setContent(currentResult.content);
    }
  }, [isViewingHistory, currentResult]);
  // ...
```

Make textarea and buttons read-only when viewing history:
```tsx
<textarea
  ref={textareaRef}
  value={content}
  onChange={handleChange}
  readOnly={isViewingHistory}
  placeholder={isViewingHistory ? '' : config.placeholder}
  className={cn(
    'w-full resize-none bg-transparent text-white placeholder:text-zinc-500 focus:outline-none',
    isViewingHistory && 'cursor-default text-zinc-300'
  )}
/>

{/* Hide action buttons when viewing history */}
{!isViewingHistory && (
  <div className="flex items-center gap-2">
    <button ... >Upload Images</button>
    <button ... >Help Me Craft</button>
  </div>
)}

{/* Hide submit button when viewing history */}
{!isViewingHistory && (
  <button ... disabled={!content.trim()}>
    Run Simulation
  </button>
)}
```

2. Update SurveyForm similarly:

```typescript
const isViewingHistory = useTestStore((s) => s.isViewingHistory);
const currentResult = useTestStore((s) => s.currentResult);

// Parse survey content when viewing history
useEffect(() => {
  if (isViewingHistory && currentResult) {
    // Parse content: "Q: ...\nType: ...\nOptions: ..."
    const lines = currentResult.content.split('\n');
    const questionLine = lines.find(l => l.startsWith('Q: '));
    const typeLine = lines.find(l => l.startsWith('Type: '));
    const optionsLine = lines.find(l => l.startsWith('Options: '));

    if (questionLine) setQuestion(questionLine.replace('Q: ', ''));
    if (typeLine) {
      const typeValue = typeLine.replace('Type: ', '') as QuestionType;
      if (['single-select', 'multi-select', 'open-text'].includes(typeValue)) {
        setQuestionType(typeValue);
      }
    }
    if (optionsLine) {
      setOptions(optionsLine.replace('Options: ', '').split(', '));
    }
  }
}, [isViewingHistory, currentResult]);
```

Disable all inputs and hide buttons when viewing history.
  </action>
  <verify>
    - Forms pre-fill with content when viewing history
    - Inputs are read-only (no editing)
    - Action buttons hidden in read-only mode
    - TypeScript compiles
  </verify>
  <done>Forms support read-only mode for history viewing with pre-filled content</done>
</task>

<task type="auto">
  <name>Task 2: Wire sidebar "Create new test" to reset state</name>
  <files>src/components/app/sidebar.tsx</files>
  <action>
Update the "Create a new test" button in sidebar to properly reset state and open selector:

```typescript
import { useTestStore } from '@/stores/test-store';

// In Sidebar component
const reset = useTestStore((s) => s.reset);
const setStatus = useTestStore((s) => s.setStatus);

const handleCreateTest = () => {
  reset(); // Clear any viewing state
  setStatus('selecting-type'); // Open type selector
};
```

This ensures:
1. If user is viewing history, it clears that state
2. Opens the test type selector modal
3. Ready for new test creation
  </action>
  <verify>
    - "Create a new test" button resets state and opens selector
    - Works when viewing history (exits history mode)
    - Works when idle (just opens selector)
  </verify>
  <done>Sidebar create button properly resets state before opening selector</done>
</task>

<task type="auto">
  <name>Task 3: Ensure instant swap between history results</name>
  <files>src/app/(app)/dashboard/dashboard-client.tsx</files>
  <action>
The viewResult action is already instant (no async), but ensure dashboard properly responds:

1. Verify currentResult triggers form re-render with new content
2. Add useEffect to sync form state when currentResult changes

The key is that when clicking history items, the flow is:
1. TestHistoryList calls viewResult(testId)
2. Store updates currentResult, currentTestType, currentStatus, isViewingHistory
3. Dashboard re-renders with new result
4. Forms detect isViewingHistory and show content

Ensure dashboard handles the status transition correctly:
```tsx
{(currentStatus === "filling-form" ||
  currentStatus === "simulating" ||
  currentStatus === "viewing-results") && (
  <div className="absolute bottom-6 left-1/2 z-20 w-full max-w-2xl -translate-x-1/2 px-6">
    {currentStatus === "filling-form" && currentTestType ? (
      // Form components
    ) : currentStatus === "simulating" ? (
      <LoadingPhases />
    ) : currentStatus === "viewing-results" && currentResult ? (
      <ResultsPanel
        result={currentResult}
        onRunAnother={handleRunAnother}
      />
    ) : null}
  </div>
)}
```

This is already correct - viewResult sets status to 'viewing-results', which shows ResultsPanel.

Update handleRunAnother to fully reset:
```typescript
const handleRunAnother = () => {
  reset(); // This now also clears isViewingHistory
};
```

No additional changes needed if 08-01 store enhancements are in place.
  </action>
  <verify>
    - Clicking history item immediately shows results
    - No loading state between history items
    - "Run another test" clears to idle state
    - `npm run build` passes
  </verify>
  <done>History viewing integrates seamlessly with instant result display</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete test history and polish features:
- Test history list in sidebar with delete functionality
- View selector with role level colors
- Legend pills in dashboard
- Read-only form viewing for history
- Instant swap between history results
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open http://localhost:3000/dashboard

**Test History Flow:**
3. Create a test (click "Create a new test", select type, enter content, run simulation)
4. After results show, look at sidebar - test should appear in "Test History"
5. Create another test - history should now show 2 items
6. Click an older test in history - results should show immediately
7. Click the three-dot menu on a history item - "Delete" option should appear
8. Delete a test - confirm modal appears, delete removes it from list

**View Selector & Legend:**
9. Check sidebar "Current View" dropdown - "Role Level" should show color dots
10. Check top bar - Legend pills should show Executive, Senior, Mid, Entry with colors
11. Indigo = Executive, Emerald = Senior, Pink = Mid, Orange = Entry

**Read-Only Forms:**
12. When viewing a past test result, the form content should be visible but read-only
13. No "Run Simulation" or action buttons when viewing history

**New Test Flow:**
14. Click "Create a new test" in sidebar - should clear any viewed result
15. Click "Run another test" after viewing results - should reset to type selector
  </how-to-verify>
  <resume-signal>Type "approved" if all features work, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] History items clickable and show results instantly
- [ ] Forms display read-only content when viewing history
- [ ] "Create a new test" in sidebar resets state
- [ ] "Run another test" in results panel resets state
- [ ] View selector shows role level colors
- [ ] Legend pills visible in dashboard top bar
- [ ] Delete modal works correctly
- [ ] No TypeScript errors
- [ ] All interactions responsive and smooth
</verification>

<success_criteria>
- Complete history viewing flow works end-to-end
- Read-only forms properly display past content
- State management correct for all transitions
- Visual polish matches societies.io reference
- User approves functionality in checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/08-test-history-polish/08-04-SUMMARY.md`
</output>
