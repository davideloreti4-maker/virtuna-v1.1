---
phase: 01-schedule-crons-fix-data-pipeline-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vercel.json
  - supabase/migrations/20260216000000_v2_schema_expansion.sql
  - supabase/migrations/20260217100000_seed_semantic_rule_tiers.sql
  - src/types/database.types.ts
autonomous: true

must_haves:
  truths:
    - "vercel.json declares all 7 cron routes with correct schedules"
    - "pnpm build completes with zero errors"
    - "rule_library table has evaluation_tier column with CHECK constraint"
    - "TypeScript types include evaluation_tier in rule_library Row/Insert/Update"
  artifacts:
    - path: "vercel.json"
      provides: "All 7 cron job schedules"
      contains: "scrape-trending"
    - path: "src/types/database.types.ts"
      provides: "Generated Supabase types including evaluation_tier"
      contains: "evaluation_tier"
  key_links:
    - from: "vercel.json crons[].path"
      to: "src/app/api/cron/*/route.ts"
      via: "Vercel cron dispatcher"
      pattern: "/api/cron/(scrape-trending|calculate-trends|refresh-competitors|validate-rules|retrain-ml|calibration-audit|sync-whop)"
---

<objective>
Schedule all 7 cron jobs in vercel.json and verify the evaluation_tier schema migration is applied with up-to-date TypeScript types.

Purpose: Crons are the heartbeat of the prediction engine pipeline. Without scheduling, 6 of 7 route handlers sit idle. The evaluation_tier column unblocks semantic rule evaluation in validate-rules.

Output: vercel.json with 7 cron entries, verified build, and regenerated database types including evaluation_tier.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@vercel.json
@src/types/database.types.ts
@supabase/migrations/20260216000000_v2_schema_expansion.sql
@supabase/migrations/20260217100000_seed_semantic_rule_tiers.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add all 7 cron entries to vercel.json and verify build</name>
  <files>vercel.json</files>
  <action>
Replace the current single-entry `crons` array in `vercel.json` with all 7 cron jobs. Keep any existing non-cron fields in vercel.json intact.

Add these 6 entries alongside the existing `refresh-competitors`:

| Route | Schedule | Rationale |
|-------|----------|-----------|
| `/api/cron/scrape-trending` | `0 */6 * * *` | Every 6 hours — keeps scraped data fresh |
| `/api/cron/calculate-trends` | `0 * * * *` | Hourly — frequent aggregation for near-real-time trending |
| `/api/cron/validate-rules` | `0 2 * * *` | Daily at 2 AM UTC — low-traffic hour |
| `/api/cron/retrain-ml` | `0 3 * * 1` | Weekly Monday 3 AM UTC — after a week of fresh data |
| `/api/cron/calibration-audit` | `0 4 1 * *` | Monthly 1st at 4 AM UTC — uses 90-day lookback |
| `/api/cron/sync-whop` | `0 */12 * * *` | Every 12 hours — webhook fallback |

Use numeric-only cron expressions (no `MON`/`SUN` — Vercel doesn't support named days). Order entries by frequency: hourly first, then 6h, 12h, daily, weekly, monthly.

After editing, run `pnpm build` to confirm no build errors. The build must exit 0.
  </action>
  <verify>
1. `cat vercel.json | jq '.crons | length'` returns `7`
2. `cat vercel.json | jq '.crons[].path'` lists all 7 `/api/cron/*` paths
3. `pnpm build` exits with code 0
  </verify>
  <done>vercel.json contains exactly 7 cron entries with correct paths and schedules. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Verify evaluation_tier migration and regenerate TypeScript types</name>
  <files>supabase/migrations/20260216000000_v2_schema_expansion.sql, supabase/migrations/20260217100000_seed_semantic_rule_tiers.sql, src/types/database.types.ts</files>
  <action>
**Step 1 — Verify migrations exist and are correct:**
- Read `supabase/migrations/20260216000000_v2_schema_expansion.sql` and confirm it contains `ALTER TABLE rule_library ADD COLUMN IF NOT EXISTS evaluation_tier TEXT DEFAULT 'regex' CHECK (evaluation_tier IN ('regex', 'semantic'))`.
- Read `supabase/migrations/20260217100000_seed_semantic_rule_tiers.sql` and confirm it updates 13 rules to `'semantic'`.
- Both migrations are already idempotent (`IF NOT EXISTS`, `WHERE` clauses). No changes needed to migration files.

**Step 2 — Regenerate TypeScript types:**
- Run `npx supabase gen types typescript --local > src/types/database.types.ts` to regenerate types from the local Supabase state.
- If `supabase` CLI is not available locally or the local DB is not running, manually add `evaluation_tier` to the `rule_library` type definition in `src/types/database.types.ts`:
  - In the `Row` type: add `evaluation_tier: string | null`
  - In the `Insert` type: add `evaluation_tier?: string | null`
  - In the `Update` type: add `evaluation_tier?: string | null`

**Step 3 — Remove type cast workaround:**
- Check `src/lib/engine/rules.ts` for the `as unknown as` cast used to access `evaluation_tier`. Once types are updated, this cast is no longer needed. Replace with direct property access. Only do this if the cast exists and the type now includes `evaluation_tier`.

After type changes, run `pnpm build` to confirm TypeScript compiles cleanly.
  </action>
  <verify>
1. `grep -n "evaluation_tier" src/types/database.types.ts` shows the field in Row, Insert, and Update types
2. `grep -n "as unknown" src/lib/engine/rules.ts` returns no matches (cast removed) OR the cast was never there
3. `pnpm build` exits with code 0
  </verify>
  <done>evaluation_tier column is in migrations AND reflected in TypeScript types. No type-cast workarounds remain in rules.ts. Build passes.</done>
</task>

</tasks>

<verification>
1. `jq '.crons | length' vercel.json` returns 7
2. All 7 cron paths match existing route handlers in `src/app/api/cron/*/route.ts`
3. `grep "evaluation_tier" src/types/database.types.ts` confirms the field exists in generated types
4. `pnpm build` succeeds with no TypeScript or build errors
</verification>

<success_criteria>
- vercel.json has 7 cron entries (was 1) — all paths correspond to existing route handlers
- evaluation_tier appears in database.types.ts without type cast workarounds
- `pnpm build` exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/01-schedule-crons-fix-data-pipeline-wiring/01-01-SUMMARY.md`
</output>
