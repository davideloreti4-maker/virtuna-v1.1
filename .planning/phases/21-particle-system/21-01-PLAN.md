---
phase: 21-particle-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-lock.yaml
  - src/components/visualization/particle-types.ts
  - src/lib/particle-utils.ts
autonomous: true

must_haves:
  truths:
    - "Particle types define idle and processing states"
    - "Object pooling utility allows particle reuse without GC pressure"
    - "Easing functions provide smooth state transitions"
  artifacts:
    - path: "src/components/visualization/particle-types.ts"
      provides: "Particle interface and state type definitions"
      exports: ["Particle", "ParticleState", "ParticleSystemProps"]
    - path: "src/lib/particle-utils.ts"
      provides: "Particle pooling, vector math, easing utilities"
      exports: ["createParticlePool", "resetParticle", "easeInOutCubic", "clampVelocity"]
  key_links:
    - from: "src/components/visualization/particle-types.ts"
      to: "src/lib/particle-utils.ts"
      via: "Particle interface import"
      pattern: "import.*Particle.*from"
---

<objective>
Create the particle system infrastructure â€” type definitions, object pooling utilities, and easing functions that the ParticleSystem component will use.

Purpose: Establish a clean foundation with proper TypeScript types and performance-optimized utilities before building the component.

Output: Particle types, pooling utility, and math utilities ready for the ParticleSystem component.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-particle-system/21-RESEARCH.md

Reference for established Canvas patterns:
@src/components/app/network-visualization.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install simplex-noise dependency</name>
  <files>package.json, pnpm-lock.yaml</files>
  <action>
Install the simplex-noise library for organic particle movement:

```bash
pnpm add simplex-noise
```

This library is lightweight (2kb) and provides TypeScript-native 2D/3D noise functions for flowing, organic particle paths. It's the standard choice for ambient canvas backgrounds.
  </action>
  <verify>
```bash
pnpm list simplex-noise
```
Should show simplex-noise version ^4.0.x installed.
  </verify>
  <done>simplex-noise is installed and available for import</done>
</task>

<task type="auto">
  <name>Task 2: Create particle type definitions</name>
  <files>src/components/visualization/particle-types.ts</files>
  <action>
Create the visualization directory and particle types file with these interfaces:

```typescript
// src/components/visualization/particle-types.ts

/**
 * Particle state determines behavior:
 * - idle: organic flowing motion around the orb (captivating hook)
 * - processing: particles rush toward the orb center
 */
export type ParticleState = 'idle' | 'processing';

/**
 * Individual particle in the pool.
 * Properties are mutated in-place to avoid GC pressure.
 */
export interface Particle {
  x: number;
  y: number;
  vx: number;
  vy: number;
  alpha: number;
  active: boolean;
  /** Unique ID for noise offset (prevents particles moving identically) */
  noiseOffset: number;
}

/**
 * Props for the ParticleSystem component
 */
export interface ParticleSystemProps {
  /** Current particle behavior state */
  state: ParticleState;
  /** X coordinate of the orb center (particles rush here when processing) */
  centerX: number;
  /** Y coordinate of the orb center */
  centerY: number;
  /** Number of particles to render. Defaults based on device capability */
  particleCount?: number;
  /** Additional className for the container */
  className?: string;
}
```

Key design decisions:
- `noiseOffset` per particle ensures each particle has unique flow path
- `active` flag supports object pooling pattern
- Props are minimal, focused on state and orb position
  </action>
  <verify>
```bash
pnpm exec tsc --noEmit src/components/visualization/particle-types.ts
```
No TypeScript errors.
  </verify>
  <done>Particle and ParticleSystemProps interfaces are defined and exported</done>
</task>

<task type="auto">
  <name>Task 3: Create particle utilities</name>
  <files>src/lib/particle-utils.ts</files>
  <action>
Create particle utilities for pooling, vector math, and easing:

```typescript
// src/lib/particle-utils.ts

import type { Particle } from '@/components/visualization/particle-types';

/**
 * Create a pre-allocated particle pool to avoid GC pressure.
 * All particles start inactive and are reset when spawned.
 */
export function createParticlePool(count: number): Particle[] {
  return Array.from({ length: count }, (_, i) => ({
    x: 0,
    y: 0,
    vx: 0,
    vy: 0,
    alpha: 0,
    active: false,
    noiseOffset: i * 100, // Unique offset per particle
  }));
}

/**
 * Reset a particle to spawn position with randomized properties.
 * Spawns particles in a ring around the center for the flowing effect.
 */
export function resetParticle(
  p: Particle,
  centerX: number,
  centerY: number,
  radius: number
): void {
  // Spawn in a ring around center (not inside the orb)
  const angle = Math.random() * Math.PI * 2;
  const spawnRadius = radius + 50 + Math.random() * 100; // 50-150px outside orb

  p.x = centerX + Math.cos(angle) * spawnRadius;
  p.y = centerY + Math.sin(angle) * spawnRadius;
  p.vx = (Math.random() - 0.5) * 0.5;
  p.vy = (Math.random() - 0.5) * 0.5;
  p.alpha = 0.3 + Math.random() * 0.4; // 0.3-0.7 alpha for subtle glow
  p.active = true;
}

/**
 * Cubic ease-in-out for smooth state transitions.
 * Used when transitioning between idle and processing states.
 */
export function easeInOutCubic(t: number): number {
  return t < 0.5
    ? 4 * t * t * t
    : 1 - Math.pow(-2 * t + 2, 3) / 2;
}

/**
 * Clamp particle velocity to prevent runaway speeds.
 */
export function clampVelocity(
  vx: number,
  vy: number,
  maxSpeed: number
): { vx: number; vy: number } {
  const speed = Math.sqrt(vx * vx + vy * vy);
  if (speed > maxSpeed) {
    const scale = maxSpeed / speed;
    return { vx: vx * scale, vy: vy * scale };
  }
  return { vx, vy };
}

/**
 * Get default particle count based on device capability.
 * Mobile devices get fewer particles for 60fps performance.
 */
export function getDefaultParticleCount(): number {
  if (typeof window === 'undefined') return 100;
  // Use screen width as a proxy for device capability
  return window.innerWidth < 768 ? 60 : 150;
}
```

Design notes:
- `resetParticle` spawns particles in a ring around the orb, not inside it
- `noiseOffset` is set during pool creation for unique particle paths
- `getDefaultParticleCount` follows research: 50-80 mobile, 150+ desktop
  </action>
  <verify>
```bash
pnpm exec tsc --noEmit src/lib/particle-utils.ts
```
No TypeScript errors.
  </verify>
  <done>Particle utilities are defined with proper TypeScript types and follow performance best practices</done>
</task>

</tasks>

<verification>
Run TypeScript checks on both files:
```bash
pnpm exec tsc --noEmit
```

Verify simplex-noise is available:
```bash
node -e "require('simplex-noise')"
```
</verification>

<success_criteria>
- simplex-noise dependency is installed
- Particle types are defined with idle/processing states
- Object pooling utility is ready (createParticlePool, resetParticle)
- Easing and velocity utilities are available
- All files pass TypeScript strict mode
</success_criteria>

<output>
After completion, create `.planning/phases/21-particle-system/21-01-SUMMARY.md`
</output>
