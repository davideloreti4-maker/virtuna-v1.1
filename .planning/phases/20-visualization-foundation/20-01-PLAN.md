---
phase: 20-visualization-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - next.config.ts
  - src/components/visualization/VisualizationCanvas.tsx
  - src/hooks/usePrefersReducedMotion.ts
autonomous: true

must_haves:
  truths:
    - "R3F Canvas renders without hydration errors"
    - "WebGL context initializes with high-performance mode"
    - "Camera controls work on desktop (mouse drag) and touch (pinch/drag)"
    - "prefers-reduced-motion hook detects OS setting correctly"
  artifacts:
    - path: "src/components/visualization/VisualizationCanvas.tsx"
      provides: "R3F Canvas wrapper with camera controls"
      contains: "'use client'"
      min_lines: 40
    - path: "src/hooks/usePrefersReducedMotion.ts"
      provides: "Accessibility hook for motion preferences"
      exports: ["usePrefersReducedMotion"]
      min_lines: 20
  key_links:
    - from: "src/components/visualization/VisualizationCanvas.tsx"
      to: "@react-three/fiber"
      via: "Canvas component import"
      pattern: "import.*Canvas.*@react-three/fiber"
    - from: "src/components/visualization/VisualizationCanvas.tsx"
      to: "@react-three/drei"
      via: "OrbitControls import"
      pattern: "import.*OrbitControls.*@react-three/drei"
---

<objective>
Set up React Three Fiber infrastructure with camera controls for the visualization foundation

Purpose: Establish the WebGL rendering pipeline that will host the organic blob orb. This is the foundation layer that all subsequent visualization work builds upon.

Output:
- R3F Canvas wrapper component with proper Next.js client directive
- Camera controls (OrbitControls with pan/zoom, rotation disabled for 2D feel)
- Accessibility hook for reduced motion detection
- Package dependencies installed and Next.js configured for Three.js
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-visualization-foundation/20-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install R3F dependencies and configure Next.js</name>
  <files>
    - package.json
    - next.config.ts
  </files>
  <action>
Install Three.js and React Three Fiber stack:

```bash
pnpm add three @react-three/fiber @react-three/drei simplex-noise
pnpm add -D @types/three
```

Update next.config.ts to transpile Three.js (required for proper ESM handling):

```typescript
/** @type {import('next').NextConfig} */
const nextConfig = {
  transpilePackages: ['three'],
  // ... existing config
}
```

Note: Keep existing config options, only add transpilePackages if not already present.

Do NOT remove react-zoom-pan-pinch yet - it's used by visualization-reset-button.tsx which will be updated in a later task.
  </action>
  <verify>
Run `pnpm build` - should complete without errors.
Check package.json contains: three, @react-three/fiber, @react-three/drei, simplex-noise, @types/three
  </verify>
  <done>
All R3F dependencies installed, Next.js configured to transpile Three.js, build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Create VisualizationCanvas component and reduced motion hook</name>
  <files>
    - src/components/visualization/VisualizationCanvas.tsx
    - src/hooks/usePrefersReducedMotion.ts
  </files>
  <action>
Create the usePrefersReducedMotion hook at `src/hooks/usePrefersReducedMotion.ts`:

```typescript
'use client'

import { useState, useEffect } from 'react'

const QUERY = '(prefers-reduced-motion: no-preference)'

/**
 * Detects user's motion preference from OS settings.
 * Returns true if user prefers reduced motion, false otherwise.
 * Defaults to true (reduced motion) for SSR safety.
 */
export function usePrefersReducedMotion(): boolean {
  const [prefersReducedMotion, setPrefersReducedMotion] = useState(true)

  useEffect(() => {
    const mediaQueryList = window.matchMedia(QUERY)
    // If no-preference matches, user does NOT prefer reduced motion
    setPrefersReducedMotion(!mediaQueryList.matches)

    const listener = (event: MediaQueryListEvent) => {
      setPrefersReducedMotion(!event.matches)
    }

    mediaQueryList.addEventListener('change', listener)
    return () => mediaQueryList.removeEventListener('change', listener)
  }, [])

  return prefersReducedMotion
}
```

Create the VisualizationCanvas component at `src/components/visualization/VisualizationCanvas.tsx`:

```typescript
'use client'

import { Suspense } from 'react'
import { Canvas } from '@react-three/fiber'
import { OrbitControls, PerspectiveCamera } from '@react-three/drei'
import { usePrefersReducedMotion } from '@/hooks/usePrefersReducedMotion'

interface VisualizationCanvasProps {
  children?: React.ReactNode
  className?: string
}

/**
 * VisualizationCanvas - R3F Canvas wrapper for the visualization
 *
 * Features:
 * - High-performance WebGL context
 * - OrbitControls with pan/zoom (rotation disabled for 2D feel)
 * - Transparent background for integration with dark theme
 * - Reduced motion support via context
 */
export function VisualizationCanvas({ children, className }: VisualizationCanvasProps) {
  const prefersReducedMotion = usePrefersReducedMotion()

  return (
    <div className={className}>
      <Canvas
        gl={{
          antialias: true,
          alpha: true,
          powerPreference: 'high-performance',
        }}
        dpr={[1, 2]} // Retina support with performance limit
      >
        <PerspectiveCamera makeDefault position={[0, 0, 5]} fov={45} />

        <OrbitControls
          enablePan={true}
          enableZoom={true}
          enableRotate={false} // 2D-style controls
          minDistance={2}
          maxDistance={10}
          zoomSpeed={0.5}
          panSpeed={0.5}
        />

        {/* Ambient light for basic illumination */}
        <ambientLight intensity={0.5} />

        <Suspense fallback={null}>
          {children}
        </Suspense>
      </Canvas>
    </div>
  )
}

export { usePrefersReducedMotion }
```

Create directory if needed: `src/components/visualization/`

Key decisions:
- enableRotate={false}: Keeps 2D feel as per CONTEXT.md (pan/zoom but not 3D rotation)
- minDistance/maxDistance: 2-10 provides reasonable zoom range
- dpr={[1, 2]}: Retina support capped at 2x for performance
- alpha: true: Transparent background integrates with dark theme
- powerPreference: 'high-performance': Request GPU acceleration
  </action>
  <verify>
1. Files exist at correct paths
2. TypeScript compiles without errors: `pnpm build`
3. Import works: Create a test page that imports VisualizationCanvas
  </verify>
  <done>
- VisualizationCanvas exports a functional R3F Canvas with OrbitControls
- usePrefersReducedMotion hook detects OS motion preference
- No hydration errors when used in Next.js pages
- Camera controls respond to mouse drag and scroll wheel
  </done>
</task>

<task type="auto">
  <name>Task 3: Create test page to verify R3F rendering</name>
  <files>
    - src/app/(marketing)/viz-test/page.tsx
  </files>
  <action>
Create a minimal test page to verify R3F renders correctly.

Create `src/app/(marketing)/viz-test/page.tsx`:

```typescript
import { VisualizationCanvas } from '@/components/visualization/VisualizationCanvas'

function TestSphere() {
  return (
    <mesh>
      <sphereGeometry args={[1, 32, 32]} />
      <meshStandardMaterial color="#FF6B35" />
    </mesh>
  )
}

export default function VizTestPage() {
  return (
    <main className="min-h-screen bg-background-base">
      <div className="h-screen w-full">
        <VisualizationCanvas className="h-full w-full">
          <TestSphere />
        </VisualizationCanvas>
      </div>
    </main>
  )
}
```

This page:
- Renders an orange sphere to verify WebGL works
- Uses full viewport to test canvas sizing
- Applies dark background from design tokens
- Allows testing pan/zoom controls manually

Note: This is a temporary test page. It will be removed or replaced with the actual visualization in later phases.
  </action>
  <verify>
1. Run `pnpm dev`
2. Navigate to http://localhost:3000/viz-test
3. Verify: Orange sphere visible on dark background
4. Verify: Mouse drag pans the view
5. Verify: Scroll wheel zooms in/out
6. Verify: No console errors about hydration or WebGL
7. Run `pnpm build` - should pass
  </verify>
  <done>
- Test page renders R3F canvas with sphere
- Pan/zoom controls work via mouse and touch
- No hydration or WebGL errors in console
- Build passes
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```bash
   pnpm build
   ```
   Must pass without errors.

2. **Runtime verification:**
   - Visit /viz-test in development mode
   - Sphere renders on dark background
   - Pan (drag), zoom (scroll) work
   - No console errors

3. **Dependency check:**
   ```bash
   pnpm list three @react-three/fiber @react-three/drei simplex-noise
   ```
   All packages should be installed.

4. **Type safety:**
   - No TypeScript errors in IDE
   - @types/three providing type definitions
</verification>

<success_criteria>
- [x] R3F dependencies installed (three, @react-three/fiber, @react-three/drei, simplex-noise)
- [x] Next.js transpilePackages includes 'three'
- [x] VisualizationCanvas component renders without hydration errors
- [x] OrbitControls enable pan/zoom, disable rotation
- [x] usePrefersReducedMotion hook correctly detects OS setting
- [x] Test page at /viz-test displays orange sphere
- [x] Build passes (`pnpm build`)
</success_criteria>

<output>
After completion, create `.planning/phases/20-visualization-foundation/20-01-SUMMARY.md`
</output>
