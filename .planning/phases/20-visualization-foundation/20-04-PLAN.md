---
phase: 20-visualization-foundation
plan: 04
type: execute
wave: 2
depends_on: [20-02, 20-03]
files_modified:
  - src/components/visualization/GlassOrb/index.tsx
  - src/components/visualization/GlassOrb/SplineGlassOrb.tsx
  - src/components/visualization/GlassOrb/StaticFallback.tsx
  - src/components/visualization/index.ts
  - src/app/(marketing)/viz-test/page.tsx
autonomous: true

must_haves:
  truths:
    - "Glass orb renders using Spline scene in viz-test page"
    - "Orb responds to hover with visual feedback"
    - "Orb responds to tap/click"
    - "Pan/zoom controls work for navigation"
    - "Page renders without hydration errors"
  artifacts:
    - path: "src/components/visualization/GlassOrb/index.tsx"
      provides: "Main GlassOrb export with Spline integration"
      min_lines: 20
    - path: "src/components/visualization/GlassOrb/SplineGlassOrb.tsx"
      provides: "Spline scene loader"
      min_lines: 30
    - path: "src/components/visualization/GlassOrb/StaticFallback.tsx"
      provides: "Reduced motion static fallback"
      min_lines: 15
  key_links:
    - from: "src/components/visualization/GlassOrb/SplineGlassOrb.tsx"
      to: "SplineOrb component"
      via: "import from ../SplineOrb"
      pattern: "import.*SplineOrb"
    - from: "src/app/(marketing)/viz-test/page.tsx"
      to: "GlassOrb component"
      via: "import"
      pattern: "import.*GlassOrb"
---

<objective>
Integrate the user's Spline scene into the application, create the final GlassOrb component, and wire it to the viz-test page for verification.

Purpose: Connect the designed Spline orb to React with proper loading, error handling, and reduced motion support.
Output: Working glass orb visualization at /viz-test with hover/tap interactions.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-visualization-foundation/20-RESEARCH.md
@.planning/phases/20-visualization-foundation/20-02-SUMMARY.md
@.planning/phases/20-visualization-foundation/20-03-SUMMARY.md
@src/components/visualization/SplineOrb.tsx
@src/components/visualization/VisualizationContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GlassOrb folder structure</name>
  <files>
src/components/visualization/GlassOrb/index.tsx
src/components/visualization/GlassOrb/SplineGlassOrb.tsx
src/components/visualization/GlassOrb/StaticFallback.tsx
  </files>
  <action>
Create a new `GlassOrb` folder to organize the Spline-based orb component.

**1. Create `src/components/visualization/GlassOrb/StaticFallback.tsx`:**

```typescript
'use client'

interface StaticFallbackProps {
  className?: string
}

/**
 * StaticFallback - CSS-only static orb for reduced motion preference
 *
 * Renders a gradient circle that visually represents the orb
 * without any animation or WebGL overhead.
 */
export function StaticFallback({ className }: StaticFallbackProps) {
  return (
    <div
      className={className}
      style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        width: '100%',
        height: '100%',
      }}
    >
      <div
        style={{
          width: '200px',
          height: '200px',
          borderRadius: '50%',
          background: `
            radial-gradient(
              ellipse at 30% 30%,
              rgba(255, 170, 170, 0.4) 0%,
              transparent 50%
            ),
            radial-gradient(
              circle at center,
              #FF6B35 0%,
              #E64A19 40%,
              rgba(230, 74, 25, 0.6) 60%,
              rgba(255, 170, 170, 0.3) 80%,
              transparent 100%
            )
          `,
          boxShadow: `
            0 0 60px rgba(255, 107, 53, 0.4),
            0 0 120px rgba(230, 74, 25, 0.2),
            inset 0 0 40px rgba(255, 255, 255, 0.1)
          `,
        }}
        role="img"
        aria-label="Glass orb visualization (static)"
      />
    </div>
  )
}
```

**2. Create `src/components/visualization/GlassOrb/SplineGlassOrb.tsx`:**

```typescript
'use client'

import { useCallback, useState } from 'react'
import { SplineOrb } from '../SplineOrb'

// Scene URL - update this based on 20-03 output
// Option A: Self-hosted file
// const SCENE_URL = '/spline/orb.splinecode'
// Option B: CDN URL from Spline export
const SCENE_URL = process.env.NEXT_PUBLIC_SPLINE_ORB_URL || '/spline/orb.splinecode'

interface SplineGlassOrbProps {
  /** Callback when orb is tapped/clicked */
  onTap?: () => void
  /** Additional class names */
  className?: string
}

/**
 * SplineGlassOrb - Spline-based glass orb visualization
 *
 * Loads the designed Spline scene and handles interactions.
 * The actual glass effect, animations, and materials are defined in Spline.
 */
export function SplineGlassOrb({ onTap, className }: SplineGlassOrbProps) {
  const [isLoaded, setIsLoaded] = useState(false)

  const handleLoad = useCallback(() => {
    setIsLoaded(true)
    console.log('[SplineGlassOrb] Scene loaded')
  }, [])

  const handleTap = useCallback(() => {
    console.log('[SplineGlassOrb] Orb tapped')
    onTap?.()
  }, [onTap])

  return (
    <SplineOrb
      sceneUrl={SCENE_URL}
      onLoad={handleLoad}
      onTap={handleTap}
      className={className}
    />
  )
}
```

**3. Create `src/components/visualization/GlassOrb/index.tsx`:**

```typescript
'use client'

import dynamic from 'next/dynamic'
import { useVisualization } from '../VisualizationContext'
import { StaticFallback } from './StaticFallback'

// Lazy load Spline component to reduce initial bundle
const SplineGlassOrb = dynamic(
  () => import('./SplineGlassOrb').then(mod => ({ default: mod.SplineGlassOrb })),
  {
    ssr: false,
    loading: () => <LoadingPlaceholder />,
  }
)

function LoadingPlaceholder() {
  return (
    <div className="flex items-center justify-center w-full h-full">
      <div
        className="w-32 h-32 rounded-full animate-pulse"
        style={{
          background: 'radial-gradient(circle, rgba(255,107,53,0.3) 0%, rgba(230,74,25,0.1) 70%, transparent 100%)',
        }}
      />
    </div>
  )
}

export interface GlassOrbProps {
  /** Callback when orb is tapped/clicked */
  onTap?: () => void
  /** Additional class names */
  className?: string
}

/**
 * GlassOrb - Main glass orb visualization component
 *
 * Automatically switches between:
 * - SplineGlassOrb: Full 3D visualization (default)
 * - StaticFallback: CSS gradient for reduced motion preference
 *
 * Uses dynamic import to lazy-load Spline runtime.
 */
export function GlassOrb({ onTap, className }: GlassOrbProps) {
  const { reducedMotion } = useVisualization()

  // Show static fallback for users who prefer reduced motion
  if (reducedMotion) {
    return <StaticFallback className={className} />
  }

  return <SplineGlassOrb onTap={onTap} className={className} />
}

// Re-export for convenience
export { StaticFallback } from './StaticFallback'
export { SplineGlassOrb } from './SplineGlassOrb'
```

Key implementation notes:
- Dynamic import with ssr: false (Spline needs browser APIs)
- Automatic reduced motion detection via VisualizationContext
- Scene URL configurable via environment variable for flexibility
- Loading placeholder matches orb aesthetic
  </action>
  <verify>
Run `npm run build` and confirm no TypeScript errors.
Check that all files exist with expected structure.
  </verify>
  <done>
GlassOrb folder created with:
- StaticFallback for reduced motion users
- SplineGlassOrb wrapping the SplineOrb component
- Main index.tsx with dynamic import and automatic fallback
  </done>
</task>

<task type="auto">
  <name>Task 2: Update barrel exports and viz-test page</name>
  <files>
src/components/visualization/index.ts
src/app/(marketing)/viz-test/page.tsx
  </files>
  <action>
**1. Update `src/components/visualization/index.ts`:**

```typescript
// Main visualization components
export { VisualizationCanvas } from './VisualizationCanvas'
export { VisualizationProvider, useVisualization } from './VisualizationContext'

// Spline integration
export { SplineOrb } from './SplineOrb'

// Glass Orb (Spline-based)
export { GlassOrb, StaticFallback, SplineGlassOrb } from './GlassOrb'
export type { GlassOrbProps } from './GlassOrb'

// Legacy R3F orb (deprecated - kept for reference)
// export { GlassOrb as LegacyGlassOrb } from './GlassOrb.tsx'
```

**2. Update `src/app/(marketing)/viz-test/page.tsx`:**

Replace the current test page content to use the new Spline-based GlassOrb:

```typescript
'use client'

import { VisualizationProvider } from '@/components/visualization'
import { GlassOrb } from '@/components/visualization/GlassOrb'
import { useState } from 'react'

export default function VizTestPage() {
  const [tapCount, setTapCount] = useState(0)
  const [forceReducedMotion, setForceReducedMotion] = useState(false)

  return (
    <div className="min-h-screen bg-background-base flex flex-col">
      {/* Header with controls */}
      <header className="p-4 border-b border-border-subtle">
        <h1 className="text-xl font-bold text-text-primary mb-4">
          Visualization Test â€” Spline Glass Orb
        </h1>
        <div className="flex gap-4 items-center text-sm">
          <label className="flex items-center gap-2 text-text-secondary">
            <input
              type="checkbox"
              checked={forceReducedMotion}
              onChange={(e) => setForceReducedMotion(e.target.checked)}
              className="rounded"
            />
            Force Reduced Motion
          </label>
          <span className="text-text-muted">
            Tap count: {tapCount}
          </span>
        </div>
      </header>

      {/* Visualization area */}
      <main className="flex-1 relative">
        <VisualizationProvider forceReducedMotion={forceReducedMotion}>
          <div className="absolute inset-0 flex items-center justify-center">
            <div style={{ width: '400px', height: '400px' }}>
              <GlassOrb
                onTap={() => setTapCount(c => c + 1)}
                className="w-full h-full"
              />
            </div>
          </div>
        </VisualizationProvider>
      </main>

      {/* Footer with info */}
      <footer className="p-4 border-t border-border-subtle text-sm text-text-muted">
        <p>
          This page tests the Spline-based glass orb visualization.
          Toggle "Force Reduced Motion" to see the static CSS fallback.
        </p>
        <p className="mt-2">
          <strong>Expected behavior:</strong> Orb loads with glass effect, subtle breathing animation,
          hover glow boost, tap feedback. With reduced motion, shows static gradient orb.
        </p>
      </footer>
    </div>
  )
}
```

This test page provides:
- Toggle for reduced motion testing
- Tap counter to verify interactions
- Clear visual container for the orb
- Instructions for expected behavior
  </action>
  <verify>
Run `npm run build` and confirm no errors.
Run `npm run dev` and navigate to /viz-test.
Check console for any errors.
  </verify>
  <done>
- Barrel exports updated to include new GlassOrb components
- viz-test page updated to use Spline-based orb
- Reduced motion toggle for testing
- Tap interaction verification via counter
  </done>
</task>

<task type="auto">
  <name>Task 3: Clean up old R3F shader files</name>
  <files>
src/components/visualization/GlassOrb.tsx
src/components/visualization/shaders/
  </files>
  <action>
Move the old R3F shader-based GlassOrb to an archived location (don't delete - may be useful reference).

1. Create archived folder:
```bash
mkdir -p src/components/visualization/_archived
```

2. Move old files:
```bash
mv src/components/visualization/GlassOrb.tsx src/components/visualization/_archived/GlassOrb-r3f.tsx
mv src/components/visualization/shaders src/components/visualization/_archived/shaders
```

3. Add a README to the archived folder:

Create `src/components/visualization/_archived/README.md`:

```markdown
# Archived Visualization Components

These files represent previous approaches that were replaced.

## GlassOrb-r3f.tsx + shaders/
The original R3F-based glass orb using custom GLSL shaders.

**Why archived:**
- Flat appearance (no true glass quality)
- Inner sphere artifacts (z-fighting with dual mesh approach)
- Colors wrong (magenta dominated instead of orange core)
- No internal flow effect
- Morphing too harsh

**Replaced by:** Spline 3D approach in `../GlassOrb/`

These files are kept for reference but are not used in production.
```

Do NOT delete these files - they document what was tried and why it failed.
  </action>
  <verify>
Confirm old GlassOrb.tsx no longer exists at the root of visualization folder.
Confirm files exist in _archived folder.
Run `npm run build` to ensure no broken imports.
  </verify>
  <done>
Old R3F shader files archived to _archived/ folder with explanatory README.
Codebase is clean with only the new Spline-based approach active.
  </done>
</task>

</tasks>

<verification>
1. Navigate to http://localhost:3000/viz-test
2. Orb should load and display (if Spline scene is configured)
3. Hover over orb - should see glow boost (if Spline scene has hover state)
4. Click/tap orb - tap counter should increment
5. Toggle "Force Reduced Motion" - should show static CSS gradient orb
6. `npm run build` passes without errors
7. No TypeScript errors in IDE
</verification>

<success_criteria>
- GlassOrb component renders Spline scene at /viz-test
- Reduced motion shows StaticFallback
- Tap interactions work (counter increments)
- Old R3F files archived (not deleted)
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/20-visualization-foundation/20-04-SUMMARY.md`
</output>
