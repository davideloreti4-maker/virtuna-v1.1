---
phase: 20-visualization-foundation
plan: 03
type: execute
wave: 3
depends_on: ["20-02"]
files_modified:
  - src/components/visualization/GlassOrb.tsx
  - src/components/visualization/VisualizationCanvas.tsx
  - src/app/(marketing)/viz-test/page.tsx
autonomous: false

must_haves:
  truths:
    - "Orb has ambient breathing animation (scale pulse 2-3s cycle)"
    - "Orb responds to hover with increased glow"
    - "Orb responds to tap/click with pulse feedback"
    - "prefers-reduced-motion shows static orb (no animation)"
    - "Animation timing feels organic (non-metronomic)"
  artifacts:
    - path: "src/components/visualization/GlassOrb.tsx"
      provides: "Orb with breathing animation and interaction feedback"
      contains: "uBreathingScale"
      min_lines: 80
  key_links:
    - from: "src/components/visualization/GlassOrb.tsx"
      to: "usePrefersReducedMotion"
      via: "hook import for accessibility"
      pattern: "usePrefersReducedMotion"
    - from: "src/components/visualization/GlassOrb.tsx"
      to: "useFrame"
      via: "breathing animation update"
      pattern: "uBreathingScale.*value"
---

<objective>
Add breathing animation, hover/tap feedback, and reduced motion support to the GlassOrb

Purpose: Make the orb feel alive and responsive. The breathing animation creates the ambient "AI brain" pulse, while hover/tap feedback provides interaction affordance. Reduced motion support ensures accessibility compliance.

Output:
- GlassOrb with sinusoidal breathing animation (2.5s cycle)
- Hover state with 30% glow boost
- Tap/click pulse feedback
- Static fallback for prefers-reduced-motion
- Organic non-metronomic feel via varied animation parameters
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-visualization-foundation/20-RESEARCH.md
@.planning/phases/20-visualization-foundation/20-01-SUMMARY.md
@.planning/phases/20-visualization-foundation/20-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add breathing animation and interaction states to GlassOrb</name>
  <files>
    - src/components/visualization/GlassOrb.tsx
  </files>
  <action>
Update the GlassOrb component to include breathing animation and interaction feedback.

Replace `src/components/visualization/GlassOrb.tsx` with:

```typescript
'use client'

import { useRef, useMemo, useState, useCallback } from 'react'
import { useFrame, ThreeEvent } from '@react-three/fiber'
import * as THREE from 'three'
import { orbVertexShader } from './shaders/orbVertex.glsl'
import { orbFragmentShader } from './shaders/orbFragment.glsl'

// Animation state type for external control
export type OrbState = 'idle' | 'processing' | 'revealing'

interface GlassOrbProps {
  /** Disable animation for reduced motion preference */
  reducedMotion?: boolean
  /** Orb radius (default: 1.5) */
  radius?: number
  /** Animation speed multiplier (default: 1.0) */
  animationSpeed?: number
  /** Current animation state */
  state?: OrbState
  /** Callback when orb is clicked/tapped */
  onTap?: () => void
}

// Animation constants (per STATE.md decisions)
const BREATHING_CYCLE = 2.5 // seconds
const BREATHING_AMPLITUDE = 0.03 // 3% scale variation
const HOVER_GLOW_BOOST = 1.3 // 30% increase
const TAP_PULSE_DURATION = 0.3 // seconds
const TAP_PULSE_SCALE = 1.08 // 8% scale pulse

/**
 * GlassOrb - Organic morphing orb with breathing animation and interaction feedback
 *
 * Animation features:
 * - Ambient breathing: Sinusoidal scale pulse (2.5s cycle, 3% amplitude)
 * - Hover feedback: 30% glow intensity boost
 * - Tap feedback: Quick scale pulse (8% over 0.3s)
 * - Reduced motion: Static display, no animation
 *
 * Performance:
 * - All animation via refs and useFrame (no React state in render loop)
 * - Hover/tap state via React state (infrequent updates)
 */
export function GlassOrb({
  reducedMotion = false,
  radius = 1.5,
  animationSpeed = 1.0,
  state = 'idle',
  onTap,
}: GlassOrbProps) {
  const materialRef = useRef<THREE.ShaderMaterial>(null)
  const meshRef = useRef<THREE.Mesh>(null)

  // Interaction state (React state OK - updates infrequently)
  const [isHovered, setIsHovered] = useState(false)
  const [tapTime, setTapTime] = useState<number | null>(null)

  // Memoize uniforms to prevent recreation
  const uniforms = useMemo(
    () => ({
      // Time for animation
      uTime: { value: 0 },

      // Noise parameters
      uNoiseScale: { value: 1.2 },
      uNoiseStrength: { value: 0.18 },

      // Breathing scale (animated in useFrame)
      uBreathingScale: { value: 1.0 },

      // Color gradient (orange -> coral -> magenta)
      uColorCore: { value: new THREE.Color('#FF6B35') },
      uColorMid: { value: new THREE.Color('#FF8E72') },
      uColorRim: { value: new THREE.Color('#C850C0') },

      // Fresnel parameters
      uFresnelPower: { value: 2.5 },
      uFresnelIntensity: { value: 0.9 },

      // Glow intensity (boosted on hover)
      uGlowIntensity: { value: 1.0 },
    }),
    []
  )

  // Animation loop
  useFrame(({ clock }) => {
    if (!materialRef.current) return

    const elapsed = clock.getElapsedTime()

    // Skip animation updates if reduced motion
    if (reducedMotion) {
      materialRef.current.uniforms.uBreathingScale.value = 1.0
      materialRef.current.uniforms.uGlowIntensity.value = 1.0
      return
    }

    // Update time for morphing animation
    materialRef.current.uniforms.uTime.value = elapsed * animationSpeed

    // Breathing animation: sinusoidal scale pulse
    // Using sin for smooth organic oscillation
    const breathingPhase = (elapsed / BREATHING_CYCLE) * Math.PI * 2
    let breathingScale = 1.0 + Math.sin(breathingPhase) * BREATHING_AMPLITUDE

    // Add slight secondary oscillation for non-metronomic feel
    const secondaryPhase = (elapsed / (BREATHING_CYCLE * 1.7)) * Math.PI * 2
    breathingScale += Math.sin(secondaryPhase) * (BREATHING_AMPLITUDE * 0.3)

    // Tap pulse animation
    if (tapTime !== null) {
      const tapElapsed = elapsed - tapTime
      if (tapElapsed < TAP_PULSE_DURATION) {
        // Quick ease-out pulse
        const tapProgress = tapElapsed / TAP_PULSE_DURATION
        const tapEase = 1 - Math.pow(1 - tapProgress, 3) // ease-out cubic
        const tapScale = 1 + (TAP_PULSE_SCALE - 1) * (1 - tapEase)
        breathingScale *= tapScale
      } else {
        // Clear tap time after animation completes
        setTapTime(null)
      }
    }

    materialRef.current.uniforms.uBreathingScale.value = breathingScale

    // Glow intensity: boosted on hover
    const targetGlow = isHovered ? HOVER_GLOW_BOOST : 1.0
    const currentGlow = materialRef.current.uniforms.uGlowIntensity.value

    // Smooth transition to target glow
    materialRef.current.uniforms.uGlowIntensity.value +=
      (targetGlow - currentGlow) * 0.1
  })

  // Interaction handlers
  const handlePointerEnter = useCallback(() => {
    if (!reducedMotion) {
      setIsHovered(true)
      document.body.style.cursor = 'pointer'
    }
  }, [reducedMotion])

  const handlePointerLeave = useCallback(() => {
    setIsHovered(false)
    document.body.style.cursor = 'auto'
  }, [])

  const handleClick = useCallback(
    (event: ThreeEvent<MouseEvent>) => {
      event.stopPropagation()

      if (!reducedMotion) {
        // Trigger tap pulse
        setTapTime(event.timeStamp / 1000) // Convert to seconds
      }

      onTap?.()
    },
    [reducedMotion, onTap]
  )

  return (
    <mesh
      ref={meshRef}
      onPointerEnter={handlePointerEnter}
      onPointerLeave={handlePointerLeave}
      onClick={handleClick}
    >
      <icosahedronGeometry args={[radius, 64]} />
      <shaderMaterial
        ref={materialRef}
        vertexShader={orbVertexShader}
        fragmentShader={orbFragmentShader}
        uniforms={uniforms}
        transparent
        side={THREE.DoubleSide}
        depthWrite={false}
      />
    </mesh>
  )
}
```

Key animation decisions:
- 2.5s breathing cycle (middle of 2-3s range per CONTEXT.md)
- Secondary oscillation at 1.7x period for non-metronomic feel
- 30% glow boost on hover (per STATE.md decision)
- 0.1 lerp factor for smooth glow transitions
- Tap pulse uses ease-out cubic for snappy feel
  </action>
  <verify>
1. File compiles without TypeScript errors
2. `pnpm build` passes
  </verify>
  <done>
- GlassOrb has sinusoidal breathing animation (2.5s cycle)
- Hover triggers 30% glow boost with smooth transition
- Tap/click triggers scale pulse feedback
- reducedMotion prop disables all animation
- Animation feels organic due to secondary oscillation
  </done>
</task>

<task type="auto">
  <name>Task 2: Update test page with reduced motion toggle and interaction testing</name>
  <files>
    - src/app/(marketing)/viz-test/page.tsx
  </files>
  <action>
Update the test page to allow testing all interaction states:

```typescript
'use client'

import { useState } from 'react'
import { VisualizationCanvas } from '@/components/visualization/VisualizationCanvas'
import { GlassOrb } from '@/components/visualization/GlassOrb'
import { usePrefersReducedMotion } from '@/hooks/usePrefersReducedMotion'

export default function VizTestPage() {
  const systemReducedMotion = usePrefersReducedMotion()
  const [forceReducedMotion, setForceReducedMotion] = useState(false)
  const [tapCount, setTapCount] = useState(0)

  const reducedMotion = systemReducedMotion || forceReducedMotion

  return (
    <main className="min-h-screen bg-background-base">
      {/* Controls overlay */}
      <div className="absolute top-4 left-4 z-10 p-4 rounded-lg bg-surface-elevated/80 backdrop-blur-sm space-y-2">
        <div className="text-text-primary text-sm font-medium">
          Visualization Test
        </div>

        <label className="flex items-center gap-2 text-text-secondary text-xs">
          <input
            type="checkbox"
            checked={forceReducedMotion}
            onChange={(e) => setForceReducedMotion(e.target.checked)}
            className="rounded"
          />
          Force reduced motion
        </label>

        <div className="text-text-tertiary text-xs">
          System prefers-reduced-motion: {systemReducedMotion ? 'Yes' : 'No'}
        </div>

        <div className="text-text-tertiary text-xs">
          Tap count: {tapCount}
        </div>

        <div className="text-text-tertiary text-xs mt-2">
          Test:
          <ul className="list-disc list-inside mt-1">
            <li>Hover orb for glow boost</li>
            <li>Click orb for pulse</li>
            <li>Watch breathing animation</li>
            <li>Toggle reduced motion</li>
          </ul>
        </div>
      </div>

      {/* Canvas */}
      <div className="h-screen w-full">
        <VisualizationCanvas className="h-full w-full">
          <GlassOrb
            reducedMotion={reducedMotion}
            onTap={() => setTapCount((c) => c + 1)}
          />
        </VisualizationCanvas>
      </div>
    </main>
  )
}
```

This test page allows:
- Manual toggle of reduced motion
- Display of system reduced motion preference
- Tap counter to verify click events
- Visual checklist of what to test
  </action>
  <verify>
1. Run `pnpm dev`
2. Navigate to http://localhost:3000/viz-test
3. `pnpm build` passes
  </verify>
  <done>
- Test page has controls for testing all interaction states
- Reduced motion can be toggled manually
- Tap events are tracked and displayed
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete visualization foundation with:
- Glass orb with organic blob morphing
- Gradient colors (orange -> coral -> magenta)
- Fresnel rim lighting (edge glow)
- Breathing animation (2.5s sinusoidal cycle)
- Hover feedback (30% glow boost)
- Tap/click feedback (scale pulse)
- Reduced motion support (static fallback)
  </what-built>
  <how-to-verify>
1. Navigate to http://localhost:3000/viz-test

2. **Verify blob morphing:**
   - Orb should have organic wobble/deformation
   - Vertices move smoothly (not jagged)

3. **Verify gradient colors:**
   - Orange/warm color in center
   - Coral/pink in middle areas
   - Magenta/purple at edges (rim)

4. **Verify breathing animation:**
   - Orb gently pulses (scale up/down)
   - Cycle feels organic (~2.5 seconds)
   - Not perfectly metronomic

5. **Verify hover interaction:**
   - Hover over orb
   - Edge glow should brighten noticeably
   - Cursor should change to pointer

6. **Verify tap/click interaction:**
   - Click/tap the orb
   - Should see quick scale pulse
   - Tap count increments in control panel

7. **Verify reduced motion:**
   - Check "Force reduced motion" checkbox
   - All animation should stop
   - Orb displays static (no morphing, no breathing)

8. **Verify pan/zoom still works:**
   - Drag to pan the view
   - Scroll to zoom in/out

9. **Check console for errors:**
   - No WebGL errors
   - No React errors
   - No hydration warnings
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Animation verification:**
   - Breathing animation runs at ~2.5s cycle
   - Secondary oscillation creates non-metronomic feel
   - Hover glow boost is noticeable (30%)
   - Tap pulse is snappy and responsive

2. **Accessibility verification:**
   - System prefers-reduced-motion detected correctly
   - Force toggle works
   - When reduced motion active: orb is completely static

3. **Performance verification:**
   - Animation maintains 60fps
   - No jank during hover/tap transitions
   - Pan/zoom remains smooth

4. **Build verification:**
   ```bash
   pnpm build
   ```
   Must pass without errors.
</verification>

<success_criteria>
- [x] Breathing animation: sinusoidal pulse with 2.5s cycle
- [x] Secondary oscillation for organic non-metronomic feel
- [x] Hover increases glow by 30% with smooth transition
- [x] Tap triggers scale pulse (8% over 0.3s)
- [x] reducedMotion prop disables all animation
- [x] usePrefersReducedMotion hook detects OS setting
- [x] Animation maintains 60fps
- [x] Human verification confirms visual quality matches Dribbble reference
- [x] Build passes (`pnpm build`)
</success_criteria>

<output>
After completion, create `.planning/phases/20-visualization-foundation/20-03-SUMMARY.md`
</output>
