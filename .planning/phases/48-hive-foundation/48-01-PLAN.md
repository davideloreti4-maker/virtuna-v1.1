---
phase: 48-hive-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/hive/hive-types.ts
  - src/components/hive/hive-constants.ts
  - src/components/hive/hive-layout.ts
  - src/components/hive/hive-mock-data.ts
autonomous: true

must_haves:
  truths:
    - "Layout positions are deterministic -- same data produces identical x/y coordinates across renders"
    - "1000+ nodes are positioned without overlap using d3-hierarchy separation"
    - "Radial layout places center at origin, tier-1 closest, tier-3 farthest"
    - "Mock data has realistic counts: 1 center, 10-15 tier-1, 100-150 tier-2, 1000-1200 tier-3"
  artifacts:
    - path: "src/components/hive/hive-types.ts"
      provides: "TypeScript interfaces for hive data model and layout output"
      exports: ["HiveNode", "HiveData", "LayoutNode", "LayoutLink", "LayoutResult", "TierConfig"]
    - path: "src/components/hive/hive-constants.ts"
      provides: "Visual constants -- tier colors, sizes, spacing, animation timing"
      exports: ["TIER_COLORS", "TIER_RADII", "NODE_SIZES", "LINE_OPACITY", "ANIMATION_TIMING", "HIVE_OUTER_RADIUS", "VIEWPORT_PADDING"]
    - path: "src/components/hive/hive-layout.ts"
      provides: "Pure layout computation using d3-hierarchy radial tree"
      exports: ["computeHiveLayout"]
    - path: "src/components/hive/hive-mock-data.ts"
      provides: "Mock data generator for development"
      exports: ["generateMockHiveData"]
  key_links:
    - from: "src/components/hive/hive-layout.ts"
      to: "d3-hierarchy"
      via: "import { hierarchy, tree } from 'd3-hierarchy'"
      pattern: "hierarchy.*tree"
    - from: "src/components/hive/hive-layout.ts"
      to: "src/components/hive/hive-types.ts"
      via: "import type { HiveNode, LayoutResult }"
      pattern: "import.*HiveNode.*LayoutResult"
    - from: "src/components/hive/hive-mock-data.ts"
      to: "src/components/hive/hive-types.ts"
      via: "import type { HiveData }"
      pattern: "import.*HiveData"
---

<objective>
Install d3-hierarchy, define TypeScript types and visual constants for the hive visualization, implement the deterministic radial layout computation, and create a mock data generator.

Purpose: Establish the pure-function foundation that all rendering and animation code will consume. Layout is the hardest algorithmic piece -- d3-hierarchy handles the Reingold-Tilford algorithm, but we need correct radial configuration, deterministic sort, and polar-to-cartesian conversion.

Output: Four files in `src/components/hive/` -- types, constants, layout computation, and mock data.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-hive-foundation/48-CONTEXT.md
@.planning/phases/48-hive-foundation/48-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install d3-hierarchy + create types and constants</name>
  <files>
    src/components/hive/hive-types.ts
    src/components/hive/hive-constants.ts
  </files>
  <action>
    1. Install dependencies:
       ```bash
       pnpm add d3-hierarchy
       pnpm add -D @types/d3-hierarchy
       ```

    2. Create `src/components/hive/hive-types.ts` with these interfaces:

       - `HiveNode`: Tree data node with `id: string`, `name: string`, `tier: 0 | 1 | 2 | 3` (0 = center), optional `children: HiveNode[]`, optional `meta: Record<string, unknown>` for future extensibility
       - `HiveData`: Alias for the root `HiveNode` (tier 0 with children)
       - `LayoutNode`: Computed position node with `id: string`, `tier: number`, `x: number` (cartesian), `y: number` (cartesian), `angle: number` (radians), `radius: number` (distance from center), `parentId: string | null`
       - `LayoutLink`: Connection between nodes with `source: LayoutNode`, `target: LayoutNode`
       - `LayoutResult`: Layout output with `nodes: LayoutNode[]`, `links: LayoutLink[]`, `bounds: { minX, maxX, minY, maxY }`
       - `TierConfig`: Visual config per tier with `radius: number` (node draw radius), `fill: string` (rgba color), `lineOpacity: number`
       - `CanvasSize`: `width: number` (CSS px), `height: number` (CSS px), `dpr: number`

    3. Create `src/components/hive/hive-constants.ts` with:

       - `HIVE_OUTER_RADIUS = 1200` -- logical units for outermost tier. Start at 1200 (not 800) to give 1000+ tier-3 nodes enough circumference to avoid overlap. Circumference at r=1200 is ~7540 units; 1000 nodes at 1.5px radius need ~4px each = 4000px, fits comfortably.
       - `VIEWPORT_PADDING = 60` -- pixels of padding when fitting to viewport
       - `NODE_SIZES`: `{ center: { width: 80, height: 60, borderRadius: 8 }, tier1: { radius: 8 }, tier2: { radius: 4 }, tier3: { radius: 1.5 } }`
       - `TIER_COLORS`: `{ 0: 'rgba(255, 255, 255, 0.10)', 1: 'rgba(255, 255, 255, 0.85)', 2: 'rgba(255, 255, 255, 0.45)', 3: 'rgba(255, 255, 255, 0.20)' }` -- 0 is center rect border
       - `LINE_OPACITY`: `{ 1: 0.15, 2: 0.08, 3: 0.04 }` -- tier-based steps for connection lines
       - `ANIMATION_TIMING`: `{ center: { delay: 0, duration: 300 }, tier1: { delay: 200, duration: 400 }, tier2: { delay: 500, duration: 500 }, tier3: { delay: 900, duration: 600 } }` -- progressive build stagger
       - `SKELETON_RINGS`: `[80, 200, 400]` -- radii for skeleton loading rings
       - `SKELETON_DOTS`: `[8, 24, 48]` -- dot count per skeleton ring
       - `SKELETON_DOT_RADII`: `[6, 4, 2]` -- dot radius per skeleton ring

       All constants typed with `as const` for literal types. Export a pre-built `TIER_CONFIG: Record<number, TierConfig>` that combines NODE_SIZES, TIER_COLORS, and LINE_OPACITY for renderer consumption.
  </action>
  <verify>
    - `pnpm exec tsc --noEmit` passes (types are valid)
    - `d3-hierarchy` appears in package.json dependencies
    - `@types/d3-hierarchy` appears in devDependencies
  </verify>
  <done>
    All TypeScript interfaces compile, d3-hierarchy installed, constants defined with correct values from RESEARCH.md discretion choices.
  </done>
</task>

<task type="auto">
  <name>Task 2: Layout computation + mock data generator</name>
  <files>
    src/components/hive/hive-layout.ts
    src/components/hive/hive-mock-data.ts
  </files>
  <action>
    1. Create `src/components/hive/hive-layout.ts`:

       Export a pure function `computeHiveLayout(data: HiveData, outerRadius?: number): LayoutResult`:

       a. Build d3 hierarchy from HiveData: `hierarchy(data)`
       b. Sort deterministically by id: `.sort((a, b) => a.data.id.localeCompare(b.data.id))` -- use `id` not `name` (ids are stable)
       c. Create tree layout with radial config: `tree<HiveNode>().size([2 * Math.PI, outerRadius ?? HIVE_OUTER_RADIUS])`
       d. Set separation function: `.separation((a, b) => (a.parent === b.parent ? 1 : 2) / a.depth)` -- radial density adjustment
       e. Apply layout: `treeLayout(root)`
       f. Convert polar to cartesian for each descendant:
          - `x = node.y * Math.cos(node.x - Math.PI / 2)` -- d3 tree: node.x = angle, node.y = radius
          - `y = node.y * Math.sin(node.x - Math.PI / 2)`
          - Round to integers: `Math.round(x)`, `Math.round(y)` -- prevents sub-pixel antialiasing
       g. Build LayoutNode array from descendants (include parentId from parent?.data.id)
       h. Build LayoutLink array from root.links(), mapping to LayoutNode references
       i. Compute bounds (minX, maxX, minY, maxY) by iterating nodes -- account for node radii at edges
       j. Return `{ nodes, links, bounds }`

       Also export a helper `computeFitTransform(bounds, canvasWidth, canvasHeight, padding?)`:
       - Calculate scale to fit bounds within canvas with padding (default VIEWPORT_PADDING)
       - Calculate offset to center the layout
       - Return `{ scale, offsetX, offsetY }`

       IMPORTANT: Do NOT re-export or import from d3-hierarchy at the module level beyond what's needed. Only `hierarchy` and `tree` are required. Do NOT import the full d3 package.

    2. Create `src/components/hive/hive-mock-data.ts`:

       Export `generateMockHiveData(options?): HiveData` that creates a realistic tree:
       - Default: 1 center (tier 0), 12 tier-1 children, each tier-1 has 8-12 tier-2 children (random within range, seeded), each tier-2 has 8-12 tier-3 children
       - This produces ~1 + 12 + ~120 + ~1200 = ~1333 nodes total
       - Use a simple seeded PRNG (mulberry32 or similar) for deterministic "random" counts so mock data is reproducible
       - Seed default: `42`
       - Node names: tier-1 = "Theme A", "Theme B", ...; tier-2 = "Sub A.1", "Sub A.2"; tier-3 = "Leaf A.1.1", etc.
       - Node ids: stable string ids like "center", "t1-0", "t1-1", "t2-0-0", "t3-0-0-0"
       - Optional params: `{ tier1Count?: number, tier2Range?: [number, number], tier3Range?: [number, number], seed?: number }`
  </action>
  <verify>
    - `pnpm exec tsc --noEmit` passes
    - Create a quick Node script or add a temporary console.log in mock data to verify: calling `generateMockHiveData()` produces a tree with ~1300 nodes, calling `computeHiveLayout(data)` produces a LayoutResult with the same count of nodes, all nodes have finite x/y coordinates, bounds are reasonable (not Infinity)
    - Call `computeHiveLayout` twice with the same data and verify `JSON.stringify(result1) === JSON.stringify(result2)` (deterministic)
  </verify>
  <done>
    Layout computation produces deterministic radial positions for 1000+ nodes. Mock data generates reproducible hierarchical tree structures. Both functions are pure (no side effects, no DOM access).
  </done>
</task>

</tasks>

<verification>
- `pnpm exec tsc --noEmit` passes with no errors in hive files
- d3-hierarchy is in package.json
- Layout is deterministic: same input always produces same output
- Mock data generates ~1300 nodes across 4 tiers
- All exports match the must_haves artifacts list
</verification>

<success_criteria>
- hive-types.ts exports all 7 interfaces/types
- hive-constants.ts exports all visual constants with correct values
- hive-layout.ts exports computeHiveLayout (deterministic, pure) and computeFitTransform
- hive-mock-data.ts exports generateMockHiveData with seeded PRNG
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/48-hive-foundation/48-01-SUMMARY.md`
</output>
