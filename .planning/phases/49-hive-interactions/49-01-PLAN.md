---
phase: 49-hive-interactions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/hive/hive-types.ts
  - src/components/hive/hive-constants.ts
  - src/components/hive/hive-interaction.ts
autonomous: true

must_haves:
  truths:
    - "Quadtree can be built from LayoutResult.nodes and queried with find()"
    - "Screen coordinates can be converted to layout space accounting for DPR, pan, zoom, and fit transforms"
    - "Layout space coordinates can be converted back to screen space for overlay positioning"
    - "Adjacency map provides O(1) lookup of connected node IDs"
  artifacts:
    - path: "src/components/hive/hive-interaction.ts"
      provides: "Quadtree builder, hit detection, coordinate transforms, adjacency map"
      exports: ["buildHiveQuadtree", "findHoveredNode", "screenToWorld", "worldToScreen", "buildAdjacencyMap"]
    - path: "src/components/hive/hive-types.ts"
      provides: "InteractionState, HitTestResult, Camera, FitTransform types"
      contains: "InteractionState"
    - path: "src/components/hive/hive-constants.ts"
      provides: "Interaction constants (thresholds, opacities, hit radii)"
      contains: "CLICK_DRAG_THRESHOLD"
  key_links:
    - from: "src/components/hive/hive-interaction.ts"
      to: "d3-quadtree"
      via: "import { quadtree } from 'd3-quadtree'"
      pattern: "import.*d3-quadtree"
    - from: "src/components/hive/hive-interaction.ts"
      to: "src/components/hive/hive-types.ts"
      via: "imports LayoutNode, LayoutLink, LayoutResult, Camera, FitTransform"
      pattern: "import.*hive-types"
---

<objective>
Install d3-quadtree, add interaction types/constants, and build the pure utility module for hit detection and coordinate transforms.

Purpose: All interaction logic depends on spatial indexing, coordinate conversion, and adjacency lookups. These are pure functions with no React dependency -- they form the foundation for the interaction hook and renderer augmentation in Plans 02-03.

Output: `hive-interaction.ts` (new), extended `hive-types.ts` and `hive-constants.ts`.
</objective>

<execution_context>
@/Users/davideloreti/.claude/get-shit-done/workflows/execute-plan.md
@/Users/davideloreti/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/49-hive-interactions/49-RESEARCH.md

@src/components/hive/hive-types.ts
@src/components/hive/hive-constants.ts
@src/components/hive/hive-layout.ts
@src/components/hive/HiveCanvas.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install d3-quadtree and extend types + constants</name>
  <files>
    src/components/hive/hive-types.ts
    src/components/hive/hive-constants.ts
    package.json
  </files>
  <action>
1. Install d3-quadtree:
   ```bash
   pnpm add d3-quadtree
   pnpm add -D @types/d3-quadtree
   ```

2. Add interaction types to `hive-types.ts` (append after existing types):
   ```typescript
   /** Camera state for zoom/pan -- extracted from HiveCanvas for shared use. */
   export interface Camera {
     zoom: number;
     panX: number;
     panY: number;
   }

   /** Fit-to-viewport transform computed from layout bounds. */
   export interface FitTransform {
     scale: number;
     offsetX: number;
     offsetY: number;
   }

   /** Mutable interaction state stored in refs (not React state). */
   export interface InteractionState {
     hoveredNodeId: string | null;
     selectedNodeId: string | null;
     connectedNodeIds: Set<string>;
   }

   /** Result of a hit detection query. */
   export interface HitTestResult {
     node: LayoutNode;
     screenX: number;
     screenY: number;
   }
   ```

3. Add interaction constants to `hive-constants.ts` (append after existing constants):
   ```typescript
   // ---------------------------------------------------------------------------
   // Interaction constants
   // ---------------------------------------------------------------------------

   /** Distance threshold (CSS px) to distinguish click from drag. */
   export const CLICK_DRAG_THRESHOLD = 5 as const;

   /** Hover debounce timeout (ms) for node-to-node transitions. */
   export const HOVER_DEBOUNCE_MS = 16 as const;

   /** Opacity for unrelated (dimmed) nodes during hover/selection. */
   export const DIM_OPACITY = 0.15 as const;

   /** Opacity for unrelated connection lines during hover/selection. */
   export const DIM_LINE_OPACITY = 0.03 as const;

   /** Base search radius for quadtree hit detection (layout units). */
   export const HIT_SEARCH_RADIUS = 20 as const;

   /** Minimum zoom factor for search radius scaling. */
   export const HIT_ZOOM_FLOOR = 0.3 as const;

   /** Shadow blur radius for selected node glow effect. */
   export const SELECTED_GLOW_BLUR = 12 as const;

   /** Selected node glow color (coral accent). */
   export const SELECTED_GLOW_COLOR = 'rgba(255, 127, 80, 0.6)' as const;

   /** Scale multiplier for selected node (visual emphasis). */
   export const SELECTED_SCALE = 1.3 as const;

   /** Minimum zoom level (wider range for exploration). */
   export const MIN_ZOOM = 0.2 as const;

   /** Maximum zoom level. */
   export const MAX_ZOOM = 8 as const;

   /** Zoom sensitivity per wheel delta. */
   export const ZOOM_SENSITIVITY = 0.001 as const;
   ```

   NOTE: MIN_ZOOM changes from 0.3 to 0.2 per CONTEXT.md requirement "0.2x-8x range". The old MIN_ZOOM/MAX_ZOOM/ZOOM_SENSITIVITY in HiveCanvas.tsx will be replaced by imports from hive-constants.ts in Plan 03.
  </action>
  <verify>
    - `pnpm exec tsc --noEmit` passes (types are valid)
    - `grep -r "d3-quadtree" package.json` shows dependency
    - `grep "InteractionState" src/components/hive/hive-types.ts` shows the new type
    - `grep "CLICK_DRAG_THRESHOLD" src/components/hive/hive-constants.ts` shows the new constant
  </verify>
  <done>
    d3-quadtree installed, InteractionState/Camera/FitTransform/HitTestResult types added to hive-types.ts, interaction constants (thresholds, opacities, glow params, zoom range) added to hive-constants.ts. TypeScript compiles clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create hive-interaction.ts with quadtree, hit detection, coordinate transforms, adjacency map</name>
  <files>
    src/components/hive/hive-interaction.ts
  </files>
  <action>
Create `src/components/hive/hive-interaction.ts` with these exports:

1. **`buildHiveQuadtree(layout: LayoutResult)`** -- Creates a d3 quadtree from all layout nodes using `.x(d => d.x).y(d => d.y).addAll(nodes)`. Returns `Quadtree<LayoutNode>`.

2. **`buildAdjacencyMap(links: LayoutLink[])`** -- Returns `Map<string, Set<string>>`. Iterates links, for each link adds source.id to target's set and target.id to source's set. Both directions for undirected graph.

3. **`screenToWorld(screenX, screenY, camera: Camera, canvasWidth, canvasHeight, fitTransform: FitTransform)`** -- Inverts the canvas transform chain:
   - Undo camera: `cx = (screenX - canvasWidth/2 - camera.panX) / camera.zoom + canvasWidth/2`
   - Undo fit: `worldX = (cx - fitTransform.offsetX) / fitTransform.scale`
   - Returns `{ x: worldX, y: worldY }`

4. **`worldToScreen(worldX, worldY, camera: Camera, canvasWidth, canvasHeight, fitTransform: FitTransform)`** -- Forward transform for overlay positioning:
   - Apply fit: `fittedX = worldX * fitTransform.scale + fitTransform.offsetX`
   - Apply camera: `screenX = (fittedX - canvasWidth/2) * camera.zoom + canvasWidth/2 + camera.panX`
   - Returns `{ x: screenX, y: screenY }`

5. **`findHoveredNode(tree: Quadtree<LayoutNode>, worldX, worldY, zoomLevel: number)`** -- Calls `tree.find(worldX, worldY, searchRadius)` where `searchRadius = HIT_SEARCH_RADIUS / Math.max(zoomLevel * 0.5, HIT_ZOOM_FLOOR)`. Returns `LayoutNode | undefined`.

6. **`computeOverlayPosition(nodeScreenX, nodeScreenY, overlayWidth, overlayHeight, containerWidth, containerHeight, offset = 16)`** -- Returns `{ left, top, placement }`. Prefers right placement, falls back to left, then bottom. Clamps to stay within container bounds with 8px margin.

Import types from `./hive-types` and constants from `./hive-constants`. Use `import { quadtree, type Quadtree } from 'd3-quadtree'`.

All functions are pure (no side effects, no React). Add JSDoc comments for each export.
  </action>
  <verify>
    - `pnpm exec tsc --noEmit` passes
    - File exports all 6 functions (grep for each export name)
    - `grep "d3-quadtree" src/components/hive/hive-interaction.ts` confirms quadtree import
  </verify>
  <done>
    hive-interaction.ts exports buildHiveQuadtree, buildAdjacencyMap, screenToWorld, worldToScreen, findHoveredNode, computeOverlayPosition. All pure functions, fully typed, using d3-quadtree for spatial indexing. TypeScript compiles clean.
  </done>
</task>

</tasks>

<verification>
1. `pnpm exec tsc --noEmit` passes with no errors
2. d3-quadtree is in package.json dependencies
3. hive-types.ts exports Camera, FitTransform, InteractionState, HitTestResult
4. hive-constants.ts exports CLICK_DRAG_THRESHOLD, HOVER_DEBOUNCE_MS, DIM_OPACITY, DIM_LINE_OPACITY, HIT_SEARCH_RADIUS, SELECTED_GLOW_BLUR, SELECTED_GLOW_COLOR, SELECTED_SCALE, MIN_ZOOM, MAX_ZOOM, ZOOM_SENSITIVITY
5. hive-interaction.ts exports buildHiveQuadtree, buildAdjacencyMap, screenToWorld, worldToScreen, findHoveredNode, computeOverlayPosition
6. `pnpm build` succeeds (no build errors)
</verification>

<success_criteria>
- All 6 utility functions exist and compile
- Quadtree builds from LayoutResult nodes
- Coordinate transforms invert the canvas transform chain (DPR-independent: works at screen/CSS pixel level)
- Adjacency map builds bidirectional connections from links
- Hit detection uses quadtree.find() with zoom-adjusted search radius
- Overlay positioning handles edge-clamping with fallback placement
</success_criteria>

<output>
After completion, create `.planning/phases/49-hive-interactions/49-01-SUMMARY.md`
</output>
