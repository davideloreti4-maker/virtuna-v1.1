---
milestone: v1.0
audited: 2026-02-13T14:30:00Z
status: gaps_found
scores:
  requirements: 68/70
  phases: 8/8
  integration: 35/35
  flows: 5/5
gaps:
  requirements:
    - "UX-02: Minimum 4.5s theater duration not enforced — no client-side timer, SSE phase events sent instantly before pipeline"
    - "UX-08: Analyze button routing incomplete — video-detail-modal links to /viral-predictor which doesn't exist"
  integration: []
  flows: []
tech_debt:
  - phase: 05.1
    items:
      - "viewResult() compatibility shim in test-store — sidebar/forms still read currentResult from Zustand"
      - "Delete test functionality needs API route (/api/analysis/:id DELETE)"
      - "Pre-existing TypeScript error: blur='none' not valid GlassCard prop in loading-phases.tsx"
      - "Saved tab on trending still uses mock getAllVideos() until bookmark API"
      - "Modal prev/next navigation disabled on trending video detail"
      - "Analysis history limited to 50 rows (no cursor pagination)"
  - phase: 04
    items:
      - "SSE phase events sent all at once before pipeline — phases not mapped to actual pipeline stages"
      - "/api/trending/[videoId] route has no consumer (video detail page not wired to API)"
  - phase: 06
    items:
      - "phaseMessage prop accepted by LoadingPhases but unused (prefixed _phaseMessage)"
  - phase: general
    items:
      - "/viral-predictor route referenced in video-detail-modal.tsx:131 doesn't exist"
      - "Record<string, unknown> for API history rows instead of typed mapper"
      - "Mock data files still present: trending-mock-data.ts, mock-brand-deals.ts, mock-data.ts"
      - "MOCK_EARNINGS_SUMMARY, MOCK_AFFILIATE_LINKS still used by earnings/affiliates tabs"
      - "generateMockHiveData() still used for hive visualization"
---

# Milestone Audit: v1.0 Backend Foundation

**Audited:** 2026-02-13T14:30:00Z
**Status:** GAPS FOUND (2 unsatisfied requirements, non-critical)
**Previous audit:** Superseded (contained 5 false negatives corrected by deeper code inspection)

## Executive Summary

The Backend Foundation milestone delivered **68 of 70 requirements** across 8 phases (20 plans). All cross-phase integration is verified (35/35 connections wired, 5/5 E2E flows complete). The core product — dual-model AI prediction engine, trending data pipeline, real API endpoints, TanStack Query client integration, and Intelligence UX — works end-to-end.

Two UX requirements are unsatisfied: the 4.5s minimum theater duration (UX-02) and analyze button routing from trending modals (UX-08). Neither blocks the core analysis flow.

## Requirements Coverage

### Database Foundation (10/10)

| Req | Description | Status | Evidence |
|-----|-------------|--------|----------|
| DB-01 | scraped_videos table | ✓ | Migration lines 20-42, all required columns + UNIQUE constraint |
| DB-02 | trending_sounds table | ✓ | Migration lines 57-71, velocity_score + trend_phase columns |
| DB-03 | analysis_results table | ✓ | Migration lines 84-110, includes score_weights JSONB |
| DB-04 | outcomes table | ✓ | Migration lines 124-141, UNIQUE on analysis_id |
| DB-05 | rule_library table | ✓ | Migration lines 154-170, CHECK constraint on category |
| DB-06 | RLS policies | ✓ | Migration lines 207-260, public read for scraped/trending/rules, user-scoped for analysis/outcomes |
| DB-07 | (SELECT auth.uid()) pattern | ✓ | All user-scoped RLS policies use this pattern |
| DB-08 | database.types.ts generated | ✓ | src/types/database.types.ts (880 lines) |
| DB-09 | Service client extracted | ✓ | src/lib/supabase/service.ts with service role key |
| DB-10 | Rule library seeded (15+) | ✓ | seed.sql: 25 rules across hook, retention, platform, audio, text, timing, creator |

### Content Intelligence Engine (15/15)

| Req | Description | Status | Evidence |
|-----|-------------|--------|----------|
| ENGINE-01 | Gemini Flash-Lite wrapper | ✓ | gemini.ts uses @google/genai with gemini-2.5-flash-lite |
| ENGINE-02 | DeepSeek R1 wrapper | ✓ | deepseek.ts uses openai package with OpenAI-compatible API |
| ENGINE-03 | Pipeline orchestrator | ✓ | pipeline.ts: validate → parallel(Gemini+rules+trends) → DeepSeek → aggregate |
| ENGINE-04 | Expert rule engine | ✓ | rules.ts: loadActiveRules + scoreContentAgainstRules |
| ENGINE-05 | Trend enrichment | ✓ | trends.ts: cross-references trending_sounds + scraped_videos |
| ENGINE-06 | Score aggregator | ✓ | aggregator.ts: rule*0.5 + trend*0.3 + ml*0.2 |
| ENGINE-07 | Zod validation | ✓ | GeminiResponseSchema.safeParse(), DeepSeekResponseSchema.safeParse() |
| ENGINE-08 | Gemini structured output | ✓ | gemini.ts:111 responseMimeType + responseSchema |
| ENGINE-09 | DeepSeek JSON mode | ✓ | deepseek.ts:143 response_format: { type: "json_object" } |
| ENGINE-10 | Retry logic | ✓ | MAX_RETRIES=2 (3 attempts), strips fences, re-prompts |
| ENGINE-11 | PredictionResult type | ✓ | types.ts:70-87: score, confidence, factors, suggestions, personas, variants, themes |
| ENGINE-12 | Shared engine types | ✓ | src/lib/engine/types.ts with all interfaces + Zod schemas |
| ENGINE-13 | Model IDs from env vars | ✓ | GEMINI_MODEL (gemini.ts:4), DEEPSEEK_MODEL (deepseek.ts:11) |
| ENGINE-14 | Circuit breaker | ✓ | deepseek.ts:15-59: 3 failures → 10min Gemini-only fallback |
| ENGINE-15 | Image/thumbnail analysis | ✓ | gemini.ts:142+ analyzeImage function with vision API, fileUri + mimeType |

### Trending Data Pipeline (8/8)

| Req | Description | Status | Evidence |
|-----|-------------|--------|----------|
| TREND-01 | Scraper cron route | ✓ | /api/cron/scrape-trending triggers Apify TikTok scraper |
| TREND-02 | Apify webhook handler | ✓ | /api/webhooks/apify upserts scraped_videos |
| TREND-03 | Trend calculator cron | ✓ | /api/cron/calculate-trends aggregates trending_sounds |
| TREND-04 | Rule validator cron | ✓ | /api/cron/validate-rules checks accuracy, adjusts weights |
| TREND-05 | CRON_SECRET auth | ✓ | src/lib/cron-auth.ts: verifyCronAuth with Bearer token |
| TREND-06 | vercel.json cron config | ✓ | 5 crons: scrape 6h, trends 1h, validate daily, sync weekly, retrain weekly |
| TREND-07 | Apify webhook secret | ✓ | webhooks/apify/route.ts:31 verifies APIFY_WEBHOOK_SECRET |
| TREND-08 | Stale data monitoring | ✓ | scrape-trending/route.ts:22 checks for stale data |

### API Routes (12/12)

| Req | Description | Status | Evidence |
|-----|-------------|--------|----------|
| API-01 | POST /api/analyze (SSE) | ✓ | SSE stream with phase events + PredictionResult |
| API-02 | GET /api/trending (paginated) | ✓ | Cursor-based pagination with category filter |
| API-03 | GET /api/trending/stats | ✓ | Aggregate stats per category |
| API-04 | GET /api/trending/[videoId] | ✓ | Single video detail route |
| API-05 | GET /api/deals | ✓ | Filtered deal listings |
| API-06 | GET /api/deals/[id] | ✓ | Single deal detail route |
| API-07 | POST /api/deals/[id]/apply | ✓ | Authenticated enrollment creation |
| API-08 | GET /api/deals/enrollments | ✓ | User's deal enrollments |
| API-09 | POST/GET /api/outcomes | ✓ | Submit outcome + user history |
| API-10 | maxDuration: 120 | ✓ | analyze/route.ts:6 |
| API-11 | No NEXT_PUBLIC_ for API keys | ✓ | Gemini, DeepSeek, Apify keys all server-only |
| API-12 | Cursor-based pagination | ✓ | base64url-encoded cursors on trending endpoint |

### Client Integration (10/10)

| Req | Description | Status | Evidence |
|-----|-------------|--------|----------|
| QUERY-01 | QueryClientProvider | ✓ | src/app/(app)/providers.tsx wraps app layout |
| QUERY-02 | Query key factory | ✓ | src/lib/queries/query-keys.ts with namespaced keys |
| QUERY-03 | useTrendingVideos | ✓ | Infinite query in use-trending.ts, wired to VideoGrid |
| QUERY-04 | useTrendingStats | ✓ | Query in use-trending.ts, wired to TrendingClient |
| QUERY-05 | useDeals | ✓ | Query in use-deals.ts, wired to DealsTab |
| QUERY-06 | useAnalysisHistory | ✓ | Query in use-analyze.ts, fetches /api/analysis/history (bug fixed) |
| QUERY-07 | useAnalyze mutation | ✓ | SSE mutation in use-analyze.ts, wired to DashboardClient |
| QUERY-08 | useOutcome mutation | ✓ | Mutation in use-outcomes.ts |
| QUERY-09 | Zustand stores unchanged | ✓ | Bookmarks, sidebar, society, settings stores intact |
| QUERY-10 | Cache invalidation | ✓ | analysis.history, outcomes, enrollments all invalidated |

### Intelligence UX (6/8)

| Req | Description | Status | Evidence |
|-----|-------------|--------|----------|
| UX-01 | SSE events → animation phases | ✓ | useAnalyze parses SSE, passes phase to LoadingPhases |
| UX-02 | **4.5s minimum theater duration** | **✗** | **No minimum enforced. All 4 phase events sent instantly before pipeline. No client timer.** |
| UX-03 | Phase-specific messaging | ✓ | SSE events include phase messages |
| UX-04 | Results card with real data | ✓ | ResultsPanel displays score, factors, personas, suggestions, variants |
| UX-05 | Factor color coding | ✓ | FactorProgressBar: green ≥70%, yellow ≥40%, red <40% |
| UX-06 | Crossfade transition | ✓ | Framer Motion AnimatePresence with opacity transitions |
| UX-07 | Analysis history in Supabase | ✓ | Saved via service client, queried via /api/analysis/history |
| UX-08 | **Analyze button routing** | **✗** | **video-detail-modal.tsx:131 links to /viral-predictor (non-existent route)** |

### Outcome Tracking (4/4)

| Req | Description | Status | Evidence |
|-----|-------------|--------|----------|
| TRACK-01 | Outcome submission form | ✓ | src/components/app/simulation/outcome-form.tsx |
| TRACK-02 | Predicted vs actual comparison | ✓ | outcome-form.tsx:50-52 calculates and displays delta with color coding |
| TRACK-03 | Delta calculation stored | ✓ | outcomes/route.ts:68-69 computes delta, stores in DB |
| TRACK-04 | Outcomes feed into rule validator | ✓ | validate-rules/route.ts:44 queries outcomes for accuracy |

### ML Scaffolding (3/3)

| Req | Description | Status | Evidence |
|-----|-------------|--------|----------|
| ML-01 | retrain-ml cron stub | ✓ | /api/cron/retrain-ml returns "Not enough data" |
| ML-02 | score_weights JSONB field | ✓ | Migration line 106, aggregator stores weights |
| ML-03 | ml_score defaults to rule_score | ✓ | aggregator.ts:80 confirmed |

## Cross-Phase Integration

**Integration checker: 35/35 connections verified, 0 breaks.**

| Connection | Links | Status |
|------------|-------|--------|
| DB → Engine | service client → rules + trends loaders | ✓ |
| Engine → API | /api/analyze → runPredictionPipeline | ✓ |
| API → Hooks | 9 hooks → 9 API endpoints | ✓ |
| Hooks → Pages | dashboard, trending, deals components | ✓ |
| Mappers → Pages | trending + deals converters used in components | ✓ |
| Cron → DB | scraper → webhook → calculator → validator | ✓ |
| SSE → UI | analyze → useAnalyze → LoadingPhases | ✓ |
| TanStack Query provider | wraps app layout | ✓ |
| Auth protection | all user-scoped routes | ✓ |
| Cache invalidation | all mutations | ✓ |

## E2E Flow Verification

| Flow | Steps | Status |
|------|-------|--------|
| Content Analysis (submit → SSE → theater → results → DB) | 13 | ✓ Complete |
| Trending Browse (visit → fetch → map → grid → infinite scroll) | 12 | ✓ Complete |
| Brand Deals (visit → fetch → map → filter → apply → enrollment) | 14 | ✓ Complete |
| Outcome Report (submit → validate → delta → save → cache) | 10 | ✓ Complete |
| Analysis History (fetch → auth → query → render → invalidate) | 9 | ✓ Complete |

## Unsatisfied Requirements

### UX-02: Minimum 4.5s Theater Duration

**Expected:** Theater plays ≥4.5s; extends if backend is slower, never shows results before 4.5s.

**Actual:** All 4 SSE phase events sent immediately before pipeline in `analyze/route.ts:50-56`. No client-side timer in LoadingPhases. Theater duration = pipeline time with no floor.

**Impact:** Low — dual-model pipeline typically >4.5s. Fast responses (cached/errored) would show results too quickly.

**Fix:** Small — add `await Promise.all([pipelineResult, sleep(4500)])` in useAnalyze hook, or spread SSE events across pipeline stages with `setTimeout`.

### UX-08: Analyze Button Routing

**Expected:** Analyze button on all pages routes to Content Intelligence tool with proper state.

**Actual:** `video-detail-modal.tsx:131` links to `/viral-predictor?url=...` (non-existent route). Sidebar and dashboard routing work correctly.

**Impact:** Low — only affects "Analyze" link in trending video modals. Known issue from PROJECT.md.

**Fix:** Trivial — change route to `/dashboard?url=...` and parse URL parameter in dashboard.

## Tech Debt Summary

**14 items across 4 categories:**

### Phase 05.1 (6 items)
1. `viewResult()` compatibility shim in test-store (sidebar/forms not migrated to TanStack Query)
2. Delete test functionality needs API route (`/api/analysis/:id` DELETE)
3. Pre-existing TypeScript error: `blur="none"` not valid GlassCard prop in loading-phases.tsx
4. Saved tab on trending still uses mock `getAllVideos()` (needs bookmark API)
5. Modal prev/next navigation disabled on trending video detail
6. Analysis history limited to 50 rows (no cursor pagination)

### Phase 04 (2 items)
7. SSE phase events sent all at once before pipeline (not mapped to actual stages)
8. `/api/trending/[videoId]` route has no UI consumer

### Phase 06 (1 item)
9. `phaseMessage` prop accepted by LoadingPhases but unused (prefixed `_phaseMessage`)

### General (5 items)
10. `/viral-predictor` route referenced but doesn't exist
11. `Record<string, unknown>` for API history rows instead of typed mapper
12. Mock data files still present: trending-mock-data.ts, mock-brand-deals.ts, mock-data.ts
13. MOCK_EARNINGS_SUMMARY, MOCK_AFFILIATE_LINKS still used by earnings/affiliates tabs
14. `generateMockHiveData()` still used for hive visualization

## Phase Verification Status

| Phase | VERIFICATION.md | Audit Status |
|-------|-----------------|--------------|
| 1. Database Foundation | Missing | ✓ Verified via code inspection |
| 2. Content Intelligence Engine | Missing | ✓ Verified via code inspection |
| 3. Trending Data Pipeline | Missing | ✓ Verified via code inspection |
| 4. API Routes | Missing | ✓ Verified via code inspection |
| 5. Client Integration | Missing | ✓ Verified via code inspection |
| 5.1 Wire TanStack Query | ✓ Present | ✓ PASSED (5/5 truths) |
| 6. Intelligence UX | Missing | ✓ Verified via code inspection |
| 7. ML Scaffolding | Missing | ✓ Verified via code inspection |

---

*Audited: 2026-02-13T14:30:00Z*
*Auditor: Claude (audit-milestone workflow)*
*Integration checker: gsd-integration-checker agent (35 files, 5 flows verified)*
*Corrections: ENGINE-15 ✓ (vision API found), TRACK-01/02 ✓ (outcome-form.tsx found), TREND-08 ✓ (stale check found), UX-06 ✓ (AnimatePresence crossfade found)*
